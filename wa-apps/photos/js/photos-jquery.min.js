$.wa=$.ui?$.extend(!0,$.wa,$.ui):{};
$.wa=$.extend(!0,$.wa,{data:{},get:function(a,b){return a==void 0?this.data:this.data[name]||b||null},set:function(a){if(a==void 0)return this.data;typeof a=="object"?$.extend(this.data,a):this.data[a]=value;return this.data},encodeHTML:function(a){return a&&(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},decodeHTML:function(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")},setHash:function(a){!(a instanceof String)&&a.toString&&(a=a.toString());
a=a.replace(/\/\//g,"/");a=a.replace(/^.*#/,"");$.browser.safari?parent?parent.window.location=parent.window.location.href.replace(/#.*/,"")+"#"+a:location=location.href.replace(/#.*/,"")+"#"+a:parent&&!$.browser.msie?parent.window.location.hash=a:location.hash=a;return true},back:function(a){history.length>2?typeof a=="number"&&parseInt(a)==a?history.go(-a):history.go(-1):$.browser.msie&&history.length>0?history.back():a&&this.setHash(a);return false},toggleHashParam:function(a){location.hash.search(a)==
-1?this.addToHash(a):this.removeFromHash(a)},addToHash:function(a){var b=location.hash;b.search(a)==-1&&(b=b+("/"+a+"/"));this.setHash(b)},removeFromHash:function(a){var b=location.hash;b.search(a)>-1&&(b=b.replace(a,""));this.setHash(b)},setTitle:function(a){document.title=a},array_search:function(a,b,c){var c=!!c,d;for(d in b)if(c&&b[d]===a||!c&&b[d]==a)return d;return false},dialogCreate:function(a,b){b=$.extend({content:'<h1>Loading... <i class="icon16 loading"></i></h1>',buttons:null,url:null,
post:null,small:false,onload:null,oncancel:null},b);b.content=$(b.content);b.buttons=b.buttons?$(b.buttons):$('<input type="submit" class="button gray" value="'+$_("Cancel")+'">').click(function(){b.oncancel&&b.oncancel.call(c[0]);$.wa.dialogHide()});var c=$("#"+a);c.size()<=0&&(c=$('<div class="dialog" id="'+a+'" style="display: none"><div class="dialog-background"></div><div class="dialog-window"><div class="dialog-content"><div class="dialog-content-indent"></div></div><div class="dialog-buttons"><div class="dialog-buttons-gradient"></div></div></div></div>').appendTo("body"));
c.find(".dialog-buttons-gradient").empty().append(b.buttons);c.find(".dialog-content-indent").empty().append(b.content);c.show();b.small?c.addClass("small"):c.removeClass("small");if(b.url){var d=function(a){c.find(".dialog-content-indent").html(a);$.wa.waCenterDialog(c);b.onload&&b.onload.call(c[0])};b.post?$.post(b.url,b.post,d):$.get(b.url,d)}this.waCenterDialog(c);var e=function(a){if(c.is(":visible"))if(a&&a.keyCode==27){b.oncancel&&typeof b.oncancel=="function"&&b.oncancel.call(c[0]);$.wa.dialogHide()}else $(document).one("keyup",
e)};e();$(document).one("hashchange",$.wa.dialogHide);return c},waCenterDialog:function(a){var a=$(a),a=a.find(".dialog-window"),b=a.outerWidth(true),c=a.outerHeight(true),d=$(window).width(),e=$(window).height(),c=(e-c)/2/e;a.css({left:Math.round((d-b)/2/d*100)+"%",top:Math.round(c*100)+"%"})},dialogHide:function(){$(".dialog").hide();return false},dropdownsClose:function(){var a=$(".dropdown:not(.disabled)");a.addClass("disabled");setTimeout(function(){a.removeClass("disabled")},600)},dropdownsCloseEnable:function(){$(".dropdown:not(.disabled)").live("click",
this.dropdownsClickHandler)},dropdownsCloseDisable:function(){$(".dropdown:not(.disabled)").die("click",this.dropdownsClickHandler)},dropdownsClickHandler:function(){var a=$(this);if(!a.hasClass("no-click-close")){a.addClass("disabled");setTimeout(function(){a.removeClass("disabled")},600)}},defaultInputValue:function(a,b,c){a instanceof jQuery||(a=$(a));var d=function(){var d=a.val();if(!d||d==b){a.val(b);a.addClass(c)}};d();a.blur(d);a.focus(function(){if(a.hasClass(c)){a.removeClass(c);a.val("")}})},
util:{formatFileSize:function(a){var b=-1;do{a=a/1024;b++}while(a>99);return Math.max(a,0.01).toFixed(2)+(b>=0?" "+$_(["kB","MB","GB","TB","PB","EB"][b]):"")}}});
$(document).ajaxError(function(a,b){if(200!==b.status&&b.responseText){if(!$.wa.errorHandler||$.wa.errorHandler(b))-1!=b.responseText.indexOf("Exception")?$.wa.dialogCreate("ajax-error",{content:"<div>"+b.responseText+"</div>"}):(document.open("text/html"),document.write(b.responseText),document.close(),$(window).one("hashchange",function(){window.location.reload()}))}else b.getResponseHeader("wa-session-expired")?window.location.reload():"undefined"!==typeof b.responseText&&-1!=b.responseText.indexOf("Exception")&&
$.wa.dialogCreate("ajax-error",{content:"<div>"+b.responseText+"</div>"})});$.ajaxSetup({cache:!1});$(document).ajaxSend(function(a,b,c){"POST"==c.type&&((a=(a=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))?decodeURIComponent(a[1]):"",null===c.data&&(c.data=""),"string"==typeof c.data)?-1==c.data.indexOf("_csrf=")&&(c.data+=(0<c.data.length?"&":"")+"_csrf="+a,b.setRequestHeader("Content-type","application/x-www-form-urlencoded")):"object"==typeof c.data&&(c.data._csrf=a))});
Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){var c=this.length,d=Number(b)||0,d=0>d?Math.ceil(d):Math.floor(d);for(0>d&&(d+=c);d<c;d++)if(d in this&&this[d]===a)return d;return-1});$.wa.locale=$.wa.locale||{};
$_=function(a,b){if(b){if(!$.wa.locale[b]){console&&console.log("Localization failed: "+b);return b}if(typeof $.wa.locale[b]=="string")return $.wa.locale[b];var c=a%10;return Math.floor(a/10)%10==1||c>4||c==0?$.wa.locale[b][2]:c==1?$.wa.locale[b][0]:$.wa.locale[b][1]}if($.wa.locale[a])return typeof $.wa.locale[a]=="string"?$.wa.locale[a]:$.wa.locale[a][0];console&&console.log("Localization failed: "+a);return a};jQuery.fn.waDialog=function(a){var a=jQuery.extend({loading_header:"",title:"",esc:!0,buttons:null,url:null,url_reload:!0,"class":null,content:null,width:0,height:0,"min-width":0,"min-height":0,offsetTop:null,offsetLeft:null,disableButtonsOnSubmit:!1,onLoad:null,onCancel:null,onSubmit:null},a||{}),b=$(this),c=b.attr("id");c&&!b.hasClass("dialog")&&(b.removeAttr("id"),$("#"+c).length&&(a.url?(b=$("#"+c),a.url_reload||(a.url=null)):$("#"+c).remove()));var d=a["class"]||a.className?a["class"]||a.className:
b.attr("class")||"";if(b.hasClass("dialog"))a.content&&(b.find(".dialog-content-indent").html(a.content),a.title&&b.find(".dialog-content-indent").prepend("<h1>"+a.title+"</h1>")),a.buttons&&b.find(".dialog-buttons-gradient").empty().append(a.buttons);else{var e=$(this),b=$("<div "+(c?'id = "'+c+'"':"")+' class="dialog '+d+'" style="display: none"><div class="dialog-background"></div><div class="dialog-window"></div></div>').appendTo("body");if(e.find(".dialog-content").length||e.find(".dialog-buttons").length){if($(".dialog-window",
b).append(e.show()),c=e.find(".dialog-content"),c.length&&(d=$('<div class="dialog-content-indent"></div>'),c.contents().appendTo(d),c.append(d)),c=e.find(".dialog-buttons"),c.length)d=$('<div class="dialog-buttons-gradient"></div>'),c.contents().appendTo(d),c.append(d)}else $(".dialog-window",b).append((a.onSubmit?'<form method="post" action="">':"")+'<div class="dialog-content"><div class="dialog-content-indent"></div></div><div class="dialog-buttons"><div class="dialog-buttons-gradient"></div></div>'+
(a.onSubmit?"</form>":"")),b.find(".dialog-content-indent").append(e.show());a.buttons&&b.find(".dialog-buttons-gradient").empty().append(a.buttons);a.url?b.find(".dialog-content-indent").append("<h1>"+(a.loading_header||"")+'<i class="icon16 loading"></i></h1>'):a.content&&b.find(".dialog-content-indent").append(a.content);a.title&&b.find(".dialog-content-indent").prepend("<h1>"+a.title+"</h1>")}b.find(".dialog-background").length||b.prepend('<div class="dialog-background"> </div>');b.unbind("close").bind("close",
function(){a.onClose&&a.onClose.call($(this));$(this).hide()});e=["width","height","min-width","min-height"];for(c=0;c<e.length;c++)a[e[c]]&&(("height"==e[c]&&"300px">a[e[c]]||"width"==e[c]&&"400px">a[e[c]])&&b.find("div.dialog-window").css("min-"+e[c],a[e[c]]),b.find("div.dialog-window").css(e[c],a[e[c]]));a.disableButtonsOnSubmit&&b.find("input[type=submit]").removeAttr("disabled");b.parent().length||b.appendTo("body");b.show();a.url?jQuery.get(a.url,function(c){var d=$(c);if(d.find(".dialog-content").length||
d.find(".dialog-buttons").length){d.find(".dialog-content").length&&b.find(".dialog-content-indent").empty().append(d.find(".dialog-content").contents());d.find(".dialog-buttons").length&&b.find(".dialog-buttons-gradient").empty().append(d.find(".dialog-buttons").contents())}else b.find(".dialog-content-indent").html(c);b.trigger("wa-resize");a.onLoad&&a.onLoad.call(b.get(0))}):a.onLoad&&a.onLoad.call(b.get(0));b.find(".dialog-buttons").delegate(".cancel","click",function(c){c.stopPropagation();c.preventDefault();
a.onCancel&&a.onCancel.call(b.get(0));b.trigger("close");return false});a.onSubmit&&b.find("form").unbind("submit").submit(function(){a.disableButtonsOnSubmit&&b.find("input[type=submit]").attr("disabled","disabled");return a.onSubmit.apply(this,[b])});b.unbind("wa-resize").bind("wa-resize",function(){var b=jQuery(this).find(".dialog-window"),c=b.width(),d=b.height();jQuery("body").css("min-height",d+"px");var g=jQuery(window).width(),e=jQuery(window).height()-60,c=(g-c)/2/g,d=(e-d-60)/2/e;d<0&&(d=
0);c<0&&(c=0);b.css({left:a.offsetLeft||Math.round(c*100)+"%",top:a.offsetTop||Math.round(d*100)+"%"})}).trigger("wa-resize");a.esc&&b.unbind("esc").bind("esc",function(){b.trigger("close")});return b};jQuery(window).resize(function(){jQuery(".dialog:visible").trigger("wa-resize")});jQuery(document).keyup(function(a){27==a.keyCode&&jQuery(".dialog:visible").trigger("esc")});/*
 GNU Affero General Public License - {@link http://www.gnu.org/licenses/agpl.html}
 @example Visit {@link http://jquery.com/plugins/project/jquery_history_bal} for more information.


 I would like to take this space to thank the following projects, blogs, articles and people:
 - jQuery {@link http://jquery.com/}
 - jQuery UI History - Klaus Hartl {@link http://www.stilbuero.de/jquery/ui_history/}
 - Really Simple History - Brian Dillard and Brad Neuberg {@link http://code.google.com/p/reallysimplehistory/}
 - jQuery History Plugin - Taku Sano (Mikage Sawatari) {@link http://www.mikage.to/jquery/jquery_history.html}
 - jQuery History Remote Plugin - Klaus Hartl {@link http://stilbuero.de/jquery/history/}
 - Content With Style: Fixing the back button and enabling bookmarking for ajax apps - Mike Stenhouse {@link http://www.contentwithstyle.co.uk/Articles/38/fixing-the-back-button-and-enabling-bookmarking-for-ajax-apps}
 - Bookmarks and Back Buttons {@link http://ajax.howtosetup.info/options-and-efficiencies/bookmarks-and-back-buttons/}
 - Ajax: How to handle bookmarks and back buttons - Brad Neuberg {@link http://dev.aol.com/ajax-handling-bookmarks-and-back-button}



 CHANGELOG

 v1.0.1-final, July 11, 2009
 - Restructured a little bit
 - Documented
 - Cleaned go/request

 v1.0.0-final, June 19, 2009
 - Been stable for over a year now, pushing live.

 v0.1.0-dev, July 24, 2008
 - Initial Release

*/
(function(a){"undefined"===typeof console&&(console="undefined"!==typeof window.console?window.console:{});console.log=console.log||function(){};console.debug=console.debug||console.log;console.warn=console.warn||console.log;console.error=console.error||function(){for(var a=[],c=0;c<arguments.length;c++)a.push(arguments[c]);alert(a.join("\n"))};console.trace=console.trace||console.log;console.group=console.group||console.log;console.groupEnd=console.groupEnd||console.log;console.profile=console.profile||
console.log;console.profileEnd=console.profileEnd||console.log;a.History={options:{debug:!1},state:"",$window:null,$iframe:null,handlers:{generic:[],specific:{}},format:function(a){return a=a.replace(/^.+?#/g,"").replace(/^#?\/?|\/?$/g,"")},getState:function(){return a.History.state},setState:function(b){var c=a.History,b=c.format(b);c.state=b;return c.state},getHash:function(){var b=parent&&!a.browser.msie?parent.window.location.hash:window.location.hash||location.hash;return b=a.History.format(b)},
setHash:function(b){b=a.History.format(b);b=b.replace(/^\/?|\/?(\?)|\/?$/g,"/$1");"undefined"===typeof window.location.hash&&(location.hash=b);a.browser.msie&&8>parseInt(a.browser.version,10)&&(a.History.$iframe.contentWindow.document.open(),a.History.$iframe.contentWindow.document.close())},go:function(b){var c=a.History,b=c.format(b);c.getHash()!==b?c.setHash(b):(c.setState(b),c.trigger());return!0},hashchange:function(b){var c=a.History;c.options.debug&&console.debug("History.hashchange",this,
arguments);var d=c.getHash(),e=c.getState();if(!c.$iframe&&e===d||c.$iframe&&c.hash===c.$iframe.contentWindow.document.location.hash||e===d)return!1;c.setState(d);c.trigger();return!0},bind:function(b,c){var d=a.History;c?("undefined"===typeof d.handlers.specific[b]&&(d.handlers.specific[b]=[]),d.handlers.specific[b].push(c)):d.handlers.generic.push(b);return!0},trigger:function(b){var c=a.History;"undefined"===typeof b&&(b=c.getState());var d,e,f,h;if("undefined"!==typeof c.handlers.specific[b]){h=
c.handlers.specific[b];d=0;for(e=h.length;d<e;++d)f=h[d],f(b)}h=c.handlers.generic;d=0;for(e=h.length;d<e;++d)f=h[d],f(b);return!0},construct:function(){var b=a.History;a(document).ready(function(){b.domReady()});return!0},configure:function(b){var c=a.History;c.options=a.extend(c.options,b);return!0},domReadied:!1,domReady:function(){var b=a.History;if(!b.domRedied)return b.domRedied=!0,b.$window=a(window),b.$window.bind("hashchange",this.hashchange),setTimeout(b.hashchangeLoader,200),!0},hashchangeLoader:function(){var b=
a.History;if(a.browser.msie&&8<=parseInt(a.browser.version))(c=b.getHash())&&b.$window.trigger("hashchange");else{if(a.browser.msie){b.$iframe=a('<iframe id="jquery-history-iframe" style="display: none;"></$iframe>').prependTo(document.body)[0];b.$iframe.contentWindow.document.open();b.$iframe.contentWindow.document.close();var c=b.getHash();c&&(b.$iframe.contentWindow.document.location.hash=c);c=function(){var a=b.format(b.$iframe.contentWindow.document.location.hash);b.getState()!==a&&b.setHash(b.$iframe.contentWindow.document.location.hash);
a=b.getHash();b.getState()!==a&&b.go(a)}}else c=function(){var a=b.getHash();b.getState()!==a&&b.go(a)};a.browser.msie&&8>parseInt(a.browser.version)?setInterval(c,1500):setInterval(c,200)}return!0}};a.History.construct()})(jQuery);jQuery.JSON={useHasOwn:{}.hasOwnProperty?!0:!1,pad:function(a){return 10>a?"0"+a:a},m:{"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},encodeString:function(a){return/["\\\x00-\x1f]/.test(a)?'"'+a.replace(/([\x00-\x1f\\"])/g,function(a,c){var d=jQuery.JSON.m[c];if(d)return d;d=c.charCodeAt();return"\\u00"+Math.floor(d/16).toString(16)+(d%16).toString(16)})+'"':'"'+a+'"'},encodeArray:function(a){var b=["["],c,d,e=a.length,f;for(d=0;d<e;d+=1)switch(f=a[d],typeof f){case "undefined":case "function":case "unknown":break;
default:c&&b.push(","),b.push(null===f?"null":this.encode(f)),c=!0}b.push("]");return b.join("")},encodeDate:function(a){return'"'+a.getFullYear()+"-"+pad(a.getMonth()+1)+"-"+pad(a.getDate())+"T"+pad(a.getHours())+":"+pad(a.getMinutes())+":"+pad(a.getSeconds())+'"'},encode:function(a){if("undefined"==typeof a||null===a)return"null";if(a instanceof Array)return this.encodeArray(a);if(a instanceof Date)return this.encodeDate(a);if("string"==typeof a)return this.encodeString(a);if("number"==typeof a)return isFinite(a)?
String(a):"null";if("boolean"==typeof a)return String(a);var b=["{"],c,d,e;for(d in a)if(!this.useHasOwn||a.hasOwnProperty(d))switch(e=a[d],typeof e){case "undefined":case "function":case "unknown":break;default:c&&b.push(","),b.push(this.encode(d),":",null===e?"null":this.encode(e)),c=!0}b.push("}");return b.join("")},decode:function(a){return eval("("+a+")")}};(function(a,b){a.store=function(b,d){var e=this;if("string"==typeof b)if(a.store.drivers[b])this.driver=a.store.drivers[b];else throw Error("Unknown driver "+b);else if("object"==typeof b){if(!a.isFunction(b.init)||!a.isFunction(b.get)||!a.isFunction(b.set)||!a.isFunction(b.del)||!a.isFunction(b.flush))throw Error("The specified driver does not fulfill the API requirements");this.driver=b}else a.each(a.store.drivers,function(){if(!a.isFunction(this.available)||!this.available())return!0;e.driver=
this;return!1===e.driver.init()?(e.driver=null,!0):!1});d||(d=a.store.serializers);this.serializers={};a.each(d,function(b){if(!a.isFunction(this.init))return true;e.serializers[b]=this;e.serializers[b].init(e.encoders,e.decoders)})};a.extend(a.store.prototype,{get:function(a){a=this.driver.get(a);return this.driver.encodes?a:this.unserialize(a)},set:function(a,b){this.driver.set(a,this.driver.encodes?b:this.serialize(b))},del:function(a){this.driver.del(a)},flush:function(){this.driver.flush()},
driver:b,encoders:[],decoders:[],serialize:function(b){var d=this;a.each(this.encoders,function(){var a=d.serializers[this+""];if(!a||!a.encode)return!0;try{b=a.encode(b)}catch(f){}});return b},unserialize:function(b){var d=this;if(!b)return b;a.each(this.decoders,function(){var a=d.serializers[this+""];if(!a||!a.decode)return!0;b=a.decode(b)});return b}});a.store.drivers={localStorage:{ident:"$.store.drivers.localStorage",scope:"browser",available:function(){try{return!!window.localStorage}catch(a){return!1}},
init:a.noop,get:function(a){return window.localStorage.getItem(a)},set:function(a,b){window.localStorage.setItem(a,b)},del:function(a){window.localStorage.removeItem(a)},flush:function(){window.localStorage.clear()}},userData:{ident:"$.store.drivers.userData",element:null,nodeName:"userdatadriver",scope:"browser",initialized:!1,available:function(){try{return!(!document.documentElement||!document.documentElement.addBehavior)}catch(a){return!1}},init:function(){if(!this.initialized)try{this.element=
document.createElement(this.nodeName),document.documentElement.insertBefore(this.element,document.getElementsByTagName("title")[0]),this.element.addBehavior("#default#userData"),this.initialized=!0}catch(a){return!1}},get:function(a){this.element.load(this.nodeName);return this.element.getAttribute(a)},set:function(a,b){this.element.setAttribute(a,b);this.element.save(this.nodeName)},del:function(a){this.element.removeAttribute(a);this.element.save(this.nodeName)},flush:function(){this.element.expires=
(new Date).toUTCString();this.element.save(this.nodeName)}},windowName:{ident:"$.store.drivers.windowName",scope:"window",cache:{},encodes:!0,available:function(){return!0},init:function(){this.load()},save:function(){window.name=a.store.serializers.json.encode(this.cache)},load:function(){try{this.cache=a.store.serializers.json.decode(window.name+""),"object"!=typeof this.cache&&(this.cache={})}catch(b){this.cache={},window.name="{}"}},get:function(a){return this.cache[a]},set:function(a,b){this.cache[a]=
b;this.save()},del:function(a){try{delete this.cache[a]}catch(d){this.cache[a]=b}this.save()},flush:function(){window.name="{}"}}};a.store.serializers={json:{ident:"$.store.serializers.json",init:function(a,b){a.push("json");b.push("json")},encode:"object"==typeof JSON?JSON.stringify:a.JSON.stringify,decode:"object"==typeof JSON?JSON.parse:a.JSON.parse},xml:{ident:"$.store.serializers.xml",init:function(a,b){a.unshift("xml");b.push("xml")},isXML:function(a){return(a=(a?a.ownerDocument||a:0).documentElement)?
"html"!==a.nodeName.toLowerCase():!1},encode:function(a){if(!a||a._serialized||!this.isXML(a))return a;var b={_serialized:this.ident,value:a};try{return b.value=(new XMLSerializer).serializeToString(a),b}catch(e){try{return b.value=a.xml,b}catch(f){}}return a},decode:function(a){if(!a||!a._serialized||a._serialized!=this.ident)return a;var d="DOMParser"in window&&(new DOMParser).parseFromString;!d&&window.ActiveXObject&&(d=function(a){var b=new ActiveXObject("Microsoft.XMLDOM");b.async="false";b.loadXML(a);
return b});if(!d)return b;a.value=d.call("DOMParser"in window&&new DOMParser||window,a.value,"text/xml");return this.isXML(a.value)?a.value:b}}}})(jQuery);(function(a){function b(a,b){this.path=a;"undefined"!==typeof b&&null!==b?(this.at_2x_path=b,this.perform_check=!1):(this.at_2x_path=a.replace(/\.\w+$/,function(a){return"@2x"+a}),this.perform_check=!0)}function c(d){if(!/@2x\.\w+$/.test(a(d).attr("src"))){this.el=d;this.path=new b(a(d).attr("src"),a(d).attr("data-at2x"));var c=this;this.path.check_2x_variant(function(a){a&&c.swap()})}}a.fn.retina=function(b){if(a.Retina.isRetina())return a.Retina.opts=a.extend(a.Retina.opts,b),this.each(function(){a(this).is("img")&&
new c(this)})};a.Retina=function(){};a.Retina.opts={check_mime_type:!0,force_original_dimensions:!0};a.Retina.isRetina=function(){return 1<window.devicePixelRatio||window.matchMedia&&window.matchMedia("(-webkit-min-device-pixel-ratio: 1.5),(min--moz-device-pixel-ratio: 1.5),(-o-min-device-pixel-ratio: 3/2),(min-resolution: 1.5dppx)").matches?!0:!1};b.confirmed_paths=[];b.prototype.is_external=function(){return!(!this.path.match(/^https?\:/i)||this.path.match("//"+document.domain))};b.prototype.check_2x_variant=
function(d){var c,f=this;if(this.is_external())return d(!1);if(this.perform_check||"undefined"===typeof this.at_2x_path||null===this.at_2x_path){if(this.at_2x_path in b.confirmed_paths)return d(!0);c=new XMLHttpRequest;c.open("HEAD",this.at_2x_path);c.onreadystatechange=function(){if(4==c.readyState&&200<=c.status&&399>=c.status){if(a.Retina.opts.check_mime_type){var h=c.getResponseHeader("Content-Type");if(null===h||!h.match(/^image/i))return d(!1)}b.confirmed_paths.push(f.at_2x_path);return d(!0)}return d(!1)};
c.send()}else return d(!0)};a.RetinaImage=c;c.prototype.swap=function(b){function c(){f.el.complete?(a.Retina.opts.force_original_dimensions&&(f.el.setAttribute("width",f.el.offsetWidth),f.el.setAttribute("height",f.el.offsetHeight)),f.el.setAttribute("src",b)):setTimeout(c,5)}"undefined"==typeof b&&(b=this.path.at_2x_path);var f=this;c()}})(jQuery);(function(a){var b=[],c=[];a.fn.doAutosize=function(b){var c=a(this).data("minwidth"),f=a(this).data("maxwidth"),h="",j=a(this),g=a("#"+a(this).data("tester_id"));if(h!==(h=j.val()))h=h.replace(/&/g,"&").replace(/\s/g," ").replace(/</g,"<").replace(/>/g,">"),g.html(h),g=g.width(),b=g+b.comfortZone>=c?g+b.comfortZone:c,g=j.width(),(b<g&&b>=c||b>c&&b<f)&&j.width(b)};a.fn.resetAutosize=function(b){var c=a(this).data("minwidth")||b.minInputWidth||a(this).width(),b=a(this).data("maxwidth")||b.maxInputWidth||
a(this).closest(".tagsinput").width()-b.inputPadding,f=a(this),h=a("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:f.css("fontSize"),fontFamily:f.css("fontFamily"),fontWeight:f.css("fontWeight"),letterSpacing:f.css("letterSpacing"),whiteSpace:"nowrap"}),j=a(this).attr("id")+"_autosize_tester";0<!a("#"+j).length&&(h.attr("id",j),h.appendTo("body"));f.data("minwidth",c);f.data("maxwidth",b);f.data("tester_id",j);f.css("width",c)};a.fn.addTag=function(d,e){e=jQuery.extend({focus:!1,
callback:!0},e);this.each(function(){var f=a(this).attr("id"),h=a(this).val().split(b[f]);""==h[0]&&(h=[]);d=jQuery.trim(d);var j;e.unique?(j=a(h).tagExist(d),!0==j&&a("#"+f+"_tag").addClass("not_valid")):j=!1;if(""!=d&&!0!=j&&(a("<span>").addClass("tag").append(a("<span>").text(d).append("\u00a0\u00a0"),a("<a>",{href:"#",title:"Removing tag",text:"x"}).click(function(){return a("#"+f).removeTag(escape(d))})).insertBefore("#"+f+"_addTag"),h.push(d),a("#"+f+"_tag").val(""),e.focus?a("#"+f+"_tag").focus():
a("#"+f+"_tag").blur(),a.fn.tagsInput.updateTagsField(this,h),e.callback&&(c[f]&&c[f].onAddTag)&&(j=c[f].onAddTag,j.call(this,d)),c[f]&&c[f].onChange)){var g=h.length;j=c[f].onChange;j.call(this,a(this),h[g-1])}});return!1};a.fn.removeTag=function(d){d=unescape(d);this.each(function(){var e=a(this).attr("id"),f=a(this).val().split(b[e]);a("#"+e+"_tagsinput .tag").remove();str="";for(var h=0;h<f.length;h++)f[h]!=d&&(str=str+b[e]+f[h]);a.fn.tagsInput.importTags(this,str);c[e]&&c[e].onRemoveTag&&c[e].onRemoveTag.call(this,
d)});return!1};a.fn.tagExist=function(b){return 0<=jQuery.inArray(b,a(this))};a.fn.importTags=function(b){id=a(this).attr("id");a("#"+id+"_tagsinput .tag").remove();a.fn.tagsInput.importTags(this,b)};a.fn.tagsInput=function(d){var e=jQuery.extend({interactive:!0,defaultText:"add a tag",minChars:0,width:"300px",height:"100px",autocomplete:{selectFirst:!1},hide:!0,delimiter:",",unique:!0,removeWithBackspace:!0,placeholderColor:"#666666",autosize:!0,comfortZone:20,inputPadding:12},d);this.each(function(){e.hide&&
a(this).hide();var f=a(this).attr("id"),d=jQuery.extend({pid:f,real_input:"#"+f,holder:"#"+f+"_tagsinput",input_wrapper:"#"+f+"_addTag",fake_input:"#"+f+"_tag"},e);b[f]=d.delimiter;if(e.onAddTag||e.onRemoveTag||e.onChange)c[f]=[],c[f].onAddTag=e.onAddTag,c[f].onRemoveTag=e.onRemoveTag,c[f].onChange=e.onChange;var j='<div id="'+f+'_tagsinput" class="tagsinput"><div id="'+f+'_addTag">';e.interactive&&(j=j+'<input id="'+f+'_tag" value="" data-default="'+e.defaultText+'" />');a(j+'</div><div class="tags_clear"></div></div>').insertAfter(this);
a(d.holder).css("width",e.width);a(d.holder).css("height",e.height);""!=a(d.real_input).val()&&a.fn.tagsInput.importTags(a(d.real_input),a(d.real_input).val());if(e.interactive){a(d.fake_input).val(a(d.fake_input).attr("data-default"));a(d.fake_input).css("color",e.placeholderColor);a(d.fake_input).resetAutosize(e);a(d.holder).bind("click",d,function(b){a(b.data.fake_input).focus()});a(d.fake_input).bind("focus",d,function(b){a(b.data.fake_input).val()==a(b.data.fake_input).attr("data-default")&&
a(b.data.fake_input).val("");a(b.data.fake_input).css("color","#000000")});if(void 0!=e.autocomplete_url){autocomplete_options={source:e.autocomplete_url};for(attrname in e.autocomplete)autocomplete_options[attrname]=e.autocomplete[attrname];void 0!==jQuery.Autocompleter?(a(d.fake_input).autocomplete(e.autocomplete_url,e.autocomplete),a(d.fake_input).bind("result",d,function(b,c){c&&a("#"+f).addTag(c[0]+"",{focus:!0,unique:e.unique})})):void 0!==jQuery.ui.autocomplete&&(a(d.fake_input).autocomplete(autocomplete_options),
a(d.fake_input).bind("autocompleteselect",d,function(b,c){a(b.data.real_input).addTag(c.item.value,{focus:!0,unique:e.unique});return!1}))}else a(d.fake_input).bind("blur",d,function(b){var c=a(this).attr("data-default");""!=a(b.data.fake_input).val()&&a(b.data.fake_input).val()!=c?b.data.minChars<=a(b.data.fake_input).val().length&&(!b.data.maxChars||b.data.maxChars>=a(b.data.fake_input).val().length)&&a(b.data.real_input).addTag(a(b.data.fake_input).val(),{focus:!0,unique:e.unique}):(a(b.data.fake_input).val(a(b.data.fake_input).attr("data-default")),
a(b.data.fake_input).css("color",e.placeholderColor));return!1});a(d.fake_input).bind("keypress",d,function(b){if(b.which==b.data.delimiter.charCodeAt(0)||13==b.which)return b.preventDefault(),b.data.minChars<=a(b.data.fake_input).val().length&&(!b.data.maxChars||b.data.maxChars>=a(b.data.fake_input).val().length)&&a(b.data.real_input).addTag(a(b.data.fake_input).val(),{focus:!0,unique:e.unique}),a(b.data.fake_input).resetAutosize(e),!1;b.data.autosize&&a(b.data.fake_input).doAutosize(e)});d.removeWithBackspace&&
a(d.fake_input).bind("keydown",function(b){if(8==b.keyCode&&""==a(this).val()){b.preventDefault();var b=a(this).closest(".tagsinput").find(".tag:last").text(),c=a(this).attr("id").replace(/_tag$/,""),b=b.replace(/[\s]+x$/,"");a("#"+c).removeTag(escape(b));a(this).trigger("focus")}});a(d.fake_input).blur();d.unique&&a(d.fake_input).keydown(function(b){(8==b.keyCode||String.fromCharCode(b.which).match(/\w+|[\u00e1\u00e9\u00ed\u00f3\u00fa\u00c1\u00c9\u00cd\u00d3\u00da\u00f1\u00d1,\/]+/))&&a(this).removeClass("not_valid")})}return!1});
return this};a.fn.tagsInput.updateTagsField=function(c,e){var f=a(c).attr("id");a(c).val(e.join(b[f]))};a.fn.tagsInput.importTags=function(d,e){a(d).val("");for(var f=a(d).attr("id"),h=e.split(b[f]),j=0;j<h.length;j++)a(d).addTag(h[j],{focus:!1,callback:!1});c[f]&&c[f].onChange&&c[f].onChange.call(d,d,h[j])}})(jQuery);(function(a){a.fn.extend({autocomplete:function(b,c){var d="string"==typeof b,c=a.extend({},a.Autocompleter.defaults,{url:d?b:null,data:d?null:b,delay:d?a.Autocompleter.defaults.delay:10,max:c&&!c.scroll?10:150},c);c.highlight=c.highlight||function(a){return a};c.formatMatch=c.formatMatch||c.formatItem;return this.each(function(){new a.Autocompleter(this,c)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},
setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});a.Autocompleter=function(b,c){function d(){var g=r.selected();if(!g)return!1;var d=g.result;n=d;if(c.multiple){var k=f(o.val());if(1<k.length){var e=c.multipleSeparator.length,m=a(b).selection().start,h,i=0;a.each(k,function(a,b){i+=b.length;if(m<=i)return h=a,!1;i+=e});k[h]=d;d=k.join(c.multipleSeparator)}d+=c.multipleSeparator}o.val(d);j();o.trigger("result",[g.data,g.value]);
return!0}function e(a,b){if(p==m.DEL)r.hide();else{var d=o.val();if(b||d!=n)n=d,d=h(d),d.length>=c.minChars?(o.addClass(c.loadingClass),c.matchCase||(d=d.toLowerCase()),k(d,g,j)):(o.removeClass(c.loadingClass),r.hide())}}function f(b){return!b?[""]:!c.multiple?[a.trim(b)]:a.map(b.split(c.multipleSeparator),function(g){return a.trim(b).length?a.trim(g):null})}function h(g){if(!c.multiple)return g;var d=f(g);if(1==d.length)return d[0];d=a(b).selection().start;d=d==g.length?f(g):f(g.replace(g.substring(d),
""));return d[d.length-1]}function j(){r.visible();r.hide();clearTimeout(i);o.removeClass(c.loadingClass);c.mustMatch&&o.search(function(a){a||(c.multiple?(a=f(o.val()).slice(0,-1),o.val(a.join(c.multipleSeparator)+(a.length?c.multipleSeparator:""))):(o.val(""),o.trigger("result",null)))})}function g(g,d){if(d&&d.length&&q){o.removeClass(c.loadingClass);r.display(d,g);var k=d[0].value;c.autoFill&&(h(o.val()).toLowerCase()==g.toLowerCase()&&p!=m.BACKSPACE)&&(o.val(o.val()+k.substring(h(n).length)),
a(b).selection(n.length,n.length+k.length));r.show()}else j()}function k(g,d,k){c.matchCase||(g=g.toLowerCase());var f=l.load(g);if(f&&f.length)d(g,f);else if("string"==typeof c.url&&0<c.url.length){var e={timestamp:+new Date};a.each(c.extraParams,function(a,b){e[a]="function"==typeof b?b():b});a.ajax({mode:"abort",port:"autocomplete"+b.name,dataType:c.dataType,url:c.url,data:a.extend({q:h(g),limit:c.max},e),success:function(b){var k;if(!(k=c.parse&&c.parse(b))){k=[];for(var b=b.split("\n"),f=0;f<
b.length;f++){var e=a.trim(b[f]);e&&(e=e.split("|"),k[k.length]={data:e,value:e[0],result:c.formatResult&&c.formatResult(e,e[0])||e[0]})}}l.add(g,k);d(g,k)}})}else r.emptyList(),k(g)}var m={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},o=a(b).attr("autocomplete","off").addClass(c.inputClass),i,n="",l=a.Autocompleter.Cache(c),q=0,p,t={mouseDownOnSelect:!1},r=a.Autocompleter.Select(c,b,d,t),s;a.browser.opera&&a(b.form).bind("submit.autocomplete",function(){if(s)return s=
!1});o.bind((a.browser.opera?"keypress":"keydown")+".autocomplete",function(b){q=1;p=b.keyCode;switch(b.keyCode){case m.UP:b.preventDefault();r.visible()?r.prev():e(0,!0);break;case m.DOWN:b.preventDefault();r.visible()?r.next():e(0,!0);break;case m.PAGEUP:b.preventDefault();r.visible()?r.pageUp():e(0,!0);break;case m.PAGEDOWN:b.preventDefault();r.visible()?r.pageDown():e(0,!0);break;case c.multiple&&","==a.trim(c.multipleSeparator)&&m.COMMA:case m.TAB:case m.RETURN:if(d())return b.preventDefault(),
s=!0,!1;break;case m.ESC:r.hide();break;default:clearTimeout(i),i=setTimeout(e,c.delay)}}).focus(function(){q++}).blur(function(){q=0;t.mouseDownOnSelect||(clearTimeout(i),i=setTimeout(j,200))}).click(function(){1<q++&&!r.visible()&&e(0,!0)}).bind("search",function(){function b(a,d){var c;if(d&&d.length)for(var k=0;k<d.length;k++)if(d[k].result.toLowerCase()==a.toLowerCase()){c=d[k];break}"function"==typeof g?g(c):o.trigger("result",c&&[c.data,c.value])}var g=1<arguments.length?arguments[1]:null;
a.each(f(o.val()),function(a,g){k(g,b,b)})}).bind("flushCache",function(){l.flush()}).bind("setOptions",function(b,g){a.extend(c,g);"data"in g&&l.populate()}).bind("unautocomplete",function(){r.unbind();o.unbind();a(b.form).unbind(".autocomplete")})};a.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(a){return a[0]},
formatMatch:null,autoFill:!1,width:0,multiple:!1,multipleSeparator:", ",highlight:function(a,c){return a.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+c.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180};a.Autocompleter.Cache=function(b){function c(a,d){b.matchCase||(a=a.toLowerCase());var c=a.indexOf(d);"word"==b.matchContains&&(c=a.toLowerCase().search("\\b"+d.toLowerCase()));return-1==c?!1:0==c||b.matchContains}function d(a,
d){j>b.cacheLength&&f();h[a]||j++;h[a]=d}function e(){if(!b.data)return!1;var g={},c=0;b.url||(b.cacheLength=1);g[""]=[];for(var f=0,e=b.data.length;f<e;f++){var h=b.data[f],h="string"==typeof h?[h]:h,j=b.formatMatch(h,f+1,b.data.length);if(!1!==j){var l=j.charAt(0).toLowerCase();g[l]||(g[l]=[]);h={value:j,data:h,result:b.formatResult&&b.formatResult(h)||j};g[l].push(h);c++<b.max&&g[""].push(h)}}a.each(g,function(a,g){b.cacheLength++;d(a,g)})}function f(){h={};j=0}var h={},j=0;setTimeout(e,25);return{flush:f,
add:d,populate:e,load:function(g){if(!b.cacheLength||!j)return null;if(!b.url&&b.matchContains){var d=[],f;for(f in h)if(0<f.length){var e=h[f];a.each(e,function(a,b){c(b.value,g)&&d.push(b)})}return d}if(h[g])return h[g];if(b.matchSubset)for(f=g.length-1;f>=b.minChars;f--)if(e=h[g.substr(0,f)])return d=[],a.each(e,function(a,b){c(b.value,g)&&(d[d.length]=b)}),d;return null}}};a.Autocompleter.Select=function(b,c,d,e){function f(a){for(a=a.target;a&&"LI"!=a.tagName;)a=a.parentNode;return!a?[]:a}function h(a){g.slice(k,
k+1).removeClass(j.ACTIVE);k+=a;0>k?k=g.size()-1:k>=g.size()&&(k=0);a=g.slice(k,k+1).addClass(j.ACTIVE);if(b.scroll){var d=0;g.slice(0,k).each(function(){d+=this.offsetHeight});d+a[0].offsetHeight-l.scrollTop()>l[0].clientHeight?l.scrollTop(d+a[0].offsetHeight-l.innerHeight()):d<l.scrollTop()&&l.scrollTop(d)}}var j={ACTIVE:"ac_over"},g,k=-1,m,o="",i=!0,n,l;return{display:function(h,p){i&&(n=a("<div/>").hide().addClass(b.resultsClass).css("position","absolute").appendTo(document.body),l=a("<ul/>").appendTo(n).mouseover(function(b){f(b).nodeName&&
"LI"==f(b).nodeName.toUpperCase()&&(k=a("li",l).removeClass(j.ACTIVE).index(f(b)),a(f(b)).addClass(j.ACTIVE))}).click(function(b){a(f(b)).addClass(j.ACTIVE);d();c.focus();return!1}).mousedown(function(){e.mouseDownOnSelect=!0}).mouseup(function(){e.mouseDownOnSelect=!1}),0<b.width&&n.css("width",b.width),i=!1);m=h;o=p;l.empty();for(var t=b.max&&b.max<m.length?b.max:m.length,r=0;r<t;r++)if(m[r]){var s=b.formatItem(m[r].data,r+1,t,m[r].value,o);!1!==s&&(s=a("<li/>").html(b.highlight(s,o)).addClass(0==
r%2?"ac_even":"ac_odd").appendTo(l)[0],a.data(s,"ac_data",m[r]))}g=l.find("li");b.selectFirst&&(g.slice(0,1).addClass(j.ACTIVE),k=0);a.fn.bgiframe&&l.bgiframe()},next:function(){h(1)},prev:function(){h(-1)},pageUp:function(){0!=k&&0>k-8?h(-k):h(-8)},pageDown:function(){k!=g.size()-1&&k+8>g.size()?h(g.size()-1-k):h(8)},hide:function(){n&&n.hide();g&&g.removeClass(j.ACTIVE);k=-1},visible:function(){return n&&n.is(":visible")},current:function(){return this.visible()&&(g.filter("."+j.ACTIVE)[0]||b.selectFirst&&
g[0])},show:function(){var d=a(c).offset();n.css({width:"string"==typeof b.width||0<b.width?b.width:a(c).width(),top:d.top+c.offsetHeight,left:d.left}).show();if(b.scroll&&(l.scrollTop(0),l.css({maxHeight:b.scrollHeight,overflow:"auto"}),a.browser.msie&&"undefined"===typeof document.body.style.maxHeight)){var f=0;g.each(function(){f+=this.offsetHeight});d=f>b.scrollHeight;l.css("height",d?b.scrollHeight:f);d||g.width(l.width()-parseInt(g.css("padding-left"))-parseInt(g.css("padding-right")))}},selected:function(){var b=
g&&g.filter("."+j.ACTIVE).removeClass(j.ACTIVE);return b&&b.length&&a.data(b[0],"ac_data")},emptyList:function(){l&&l.empty()},unbind:function(){n&&n.remove()}}};a.fn.selection=function(a,c){if(void 0!==a)return this.each(function(){if(this.createTextRange){var d=this.createTextRange();void 0===c||a==c?d.move("character",a):(d.collapse(!0),d.moveStart("character",a),d.moveEnd("character",c));d.select()}else this.setSelectionRange?this.setSelectionRange(a,c):this.selectionStart&&(this.selectionStart=
a,this.selectionEnd=c)});var d=this[0];if(d.createTextRange){var e=document.selection.createRange(),f=d.value,h=e.text.length;e.text="<->";e=d.value.indexOf("<->");d.value=f;this.selection(e,e+h);return{start:e,end:e+h}}if(void 0!==d.selectionStart)return{start:d.selectionStart,end:d.selectionEnd}}})(jQuery);(function(a){a.photos_sidebar={width:200,options:{},init:function(a){this.options=a||{};a.width&&(this.width=a.width);this.initCollapsible();this.initHandlers();this.initView()},initView:function(){var b=a("#p-sidebar"),c=a("#p-sidebar-width-control");c.find("a.arrow").unbind("click").bind("click",function(){var d=b.attr("class"),e=0,f=d.match(/left([\d]{2,3})px/);if(f&&f[1]&&(e=parseInt(f[1])))if(f=e+(a(this).is(".right")?50:-50),f=Math.max(Math.min(f,400),200),f!=e){c.css({width:f.toString()+"px"});
e=["left"+e+"px","left"+f+"px"];b.attr("class",d.replace(e[0],e[1]));b.css("width","");var h=a("#p-content");h.length&&(d=h.attr("class"),h.attr("class",d.replace(e[0],e[1])),h.css("margin-left",""));a.photos_sidebar.width=f;a.post("?action=sidebarSaveWidth",{width:f},"json")}return!1})},initCollapsible:function(){a("#p-sidebar").off("click",".collapse-handler").on("click",".collapse-handler",function(){a.photos_sidebar._collapseSidebarSection(this,"toggle")});a("#p-sidebar .collapse-handler").each(function(){a.photos_sidebar._collapseSidebarSection(this,
"restore")});a("#album-list-container").die("uncollapse_section").live("uncollapse_section",function(b,c){var c=a(c),d=a(this).find(">.collapse-handler"),e=c.find(">i.collapse-handler");a.photos_sidebar._collapseSidebarSection(e,"uncollapse");for(e=c.parent().parent();e.length&&e.get(0)!=this;){var f=e.find(">i.collapse-handler");if(!f.length)break;a.photos_sidebar._collapseSidebarSection(f,"uncollapse");e=e.parent().parent()}a.photos_sidebar._collapseSidebarSection(d,"uncollapse")})},initHandlers:function(){a("#p-upload-link").click(function(){a.photos.uploadDialog();
return!1});a("#album-list-container").off("click",".p-new-album").on("click",".p-new-album",function(){var b=a(this),c=0;b.is("#p-new-album")||(c=parseInt(b.parents("li:first").attr("rel"),10)||0);b=a("#album-create-dialog-acceptor");b.length||(b=a("<div id='album-create-dialog-acceptor'></div>"),a("body").append(b));b.load("?module=dialog&action=createAlbum&parent_id="+c,function(){a("#album-create-dialog").waDialog({onLoad:function(){a(this).find("input[type=text]").val("")},onSubmit:function(b){var e=
a(this);a.post(e.attr("action"),e.serialize(),function(f){if(f.status=="ok"){a.photos.onCreateAlbum(f.data,c);b.trigger("close");f.data.id&&a.photos.goToHash("/album/"+f.data.id)}},"json");return false}})});return!1})},countSubtree:function(b){var c=b.find(">.count:not(.subtree)"),d=b.find(">.subtree");d.length||(d=c.clone().addClass("subtree").hide(),c.after(d));var e=parseInt(c.text(),10)||0;b.find("li.static>.count:not(.subtree)").each(function(){var b=parseInt(a(this).text(),10)||0;e=e+b});d.hasClass("never-recount")||
d.text(e);d.show();c.hide();return e},countItem:function(a){var c=a.find(">.count:not(.subtree)").show();a.find(">.subtree").hide();return parseInt(c.text(),10)||0},_collapseSidebarSection:function(b,c){c||(c="coollapse");b=a(b);if(b.length){var d;d=b.hasClass("darr")||b.hasClass("rarr")?b:b.find(".darr, .rarr");if(d.length){var e=b.parent(),f=e.find(".hierarchical:first");f.length||(f=e.find(".collapsible-content:first"));f.length||(f=e.find("ul:first"));var h,j=b.attr("id")||b.parent().attr("id"),
g=d.hasClass("darr")?"shown":"hidden",k=function(){f.hide();d.removeClass("darr").addClass("rarr");a.photos_sidebar.countSubtree(e);h="hidden"},m=function(){f.show();d.removeClass("rarr").addClass("darr");a.photos_sidebar.countItem(e);h="shown"};switch(c){case "toggle":"shown"==g?k():m();break;case "restore":j&&("hidden"==a.storage.get("photos/collapsible/"+j)?k():m());break;case "uncollapse":m();break;default:k()}j&&h&&a.storage.set("photos/collapsible/"+j,h)}}}}})(jQuery);(function(a){function b(){var b=a.photos.getAlbum();return!b||b.type!==Album.TYPE_STATIC||!1===b.edit_rights?!1:!0}function c(){a("#hint-menu-block").hide().children().hide()}a.photos_dragndrop={helper_shift:20,init:function(){this._extendJqueryUIDragAndDrop();this._initDragPhotos();this._initDropPhotos();this._initDragAlbums();this._initDropAlbums()},_initDragPhotos:function(){var b={opacity:0.75,zIndex:9999,distance:5,appendTo:"body",cursor:"move",refreshPositions:!0,start:function(b,d){document.ondragstart=
function(){return!1};d.helper.data("scrollTop",a(document).scrollTop());a(document).bind("scroll",a.photos_dragndrop._scrolHelper);a("#album-list-container").addClass("p-drag-active")},stop:function(){document.ondragstart=null;a(document).unbind("scroll",a.photos_dragndrop._scrolHelper);a("#album-list-container").removeClass("p-drag-active");c()},drag:function(b,d){var g=b.originalEvent;d.position.left=g.pageX-a.photos_dragndrop.helper_shift;d.position.top=g.pageY}},e=b.start,f=b.stop;a("img",a("#photo-list")).liveDraggable(a.extend({},
b,{containment:[0,0,a(window).width(),{toString:function(){return a(document).height()}}],helper:function(){var b=a(this).parents("li:first"),d=a("#photo-list li.selected"),g=d.length?d.length:1,c=[b.attr("data-photo-id")],f=!1,e=b.get(0);d.each(function(){this!=e?c.push(a(this).attr("data-photo-id")):f=!0});!f&&d.length&&(b.addClass("selected").find("input:first").trigger("select",!0),++g);b.data("photo_ids",c);return'<div id="helper"><span class="indicator red">'+g+'</span><i class="icon10 no-bw" style="display:none;"></i></div>'},
handle:".p-image",start:function(b,d){e.apply(this,[b,d]);var g=a(this).parents("li:first");1==g.data("photo_ids").length&&g.addClass("selected")},stop:function(b,d){f.apply(this,[b,d]);var g=a(this).parents("li:first");1==g.data("photo_ids").length&&g.removeClass("selected")}}));a("#photo").liveDraggable(a.extend({},b,{containment:"body",start:function(b){if(!a(b.target).hasClass("ui-draggable"))return!1},helper:function(){return'<div id="helper"><span class="indicator red">1</span><i class="icon10 no-bw" style="display:none;"></i></div>'}}))},
_initDropPhotos:function(){a("li",a("#photo-list")).liveDroppable({disabled:!1,greedy:!0,tolerance:"pointer",over:function(d,e){if(e.draggable.hasClass("dr"))return!1;if(b())c();else{var f=a.photos.getOption("sort_method");if(f){var h=a("#hint-menu-block").show();h.children().hide();h.find("."+f).show()}}a.photos_dragndrop._activatePhotoListItem.call(this)},out:function(){a.photos_dragndrop._unactivatePhotoListItem.call(this)},drop:function(d,c){var f=b(),h=a.photos.getAlbum(),j=c.draggable.parents("li:first"),
g=a(this);if(j.get(0)==this||g.hasClass("selected"))return a.photos_dragndrop._unactivatePhotoListItem.call(this),!1;var k=a("#photo-list li.selected");k.length||(k=j);a.photos_dragndrop._unactivatePhotoListItem.call(this);a.photos_dragndrop._unactivatePhotoListItem.call(j);if(!f)return!1;var m=parseInt(g.attr("data-photo-id"));g.hasClass("last")?(m=null,g.after(k),g.removeClass("last"),a("#photo-list li:last").addClass("last")):(g.before(k),j.hasClass("last")&&(j.removeClass("last"),a("#photo-list li:last").addClass("last")));
k.trigger("select",!1);var o=[];k.each(function(){o.push(parseInt(a(this).attr("data-photo-id")))});a.post("?module=album&action=photoMove",{photo_id:o,album_id:h.id,before_id:m},function(b){b.status=="ok"&&a.photos.photo_stream_cache.move(o,m)},"json")}})},_initDragAlbums:function(){var b=a("#wa-app > .sidebar"),c=b.position(),f=b.width(),b=b.height();a("li.dr",a("#album-list")).liveDraggable({containment:[c.left,c.top,c.left+f+0.25*f,c.top+b],refreshPositions:!0,revert:"invalid",helper:function(){var b=
a(this).clone().addClass("ui-draggable").css({position:"absolute"}).prependTo("#album-list > ul");b.find("a:first").append('<i class="icon10 no-bw" style="margin-left: 0; margin-right: 0; display:none;"></i>');return b},cursor:"move",cursorAt:{left:5},opacity:0.75,zIndex:9999,distance:5,start:function(){document.ondragstart=function(){return!1}},stop:function(){document.ondragstart=null}})},_initDropAlbums:function(){this._initDropBetweenAlbums();this._initDropInsideAlbums()},_initDropBetweenAlbums:function(){a("li.drag-newposition",
a("#album-list")).liveDroppable({accept:"li.dr",greedy:!0,tolerance:"pointer",over:function(b,c){if("IMG"==c.draggable.get(0).tagName)return!1;a(this).addClass("active").parent().parent().addClass("drag-active")},out:function(){a(this).removeClass("active").parent().parent().removeClass("drag-active")},deactivate:function(){var b=a(this);(b.is(":animated")||b.hasClass("dragging"))&&b.stop().animate({height:"0px"},300,null,function(){b.removeClass("dragging")});a(this).removeClass("active").parent().parent().removeClass("drag-active")},
drop:function(b,c){if("IMG"==c.draggable.get(0).tagName)return!1;var f=a(this).parent("ul"),h=a(c.draggable),j=h.attr("rel"),g=a(this).prev("li");if(g.length&&g.attr("rel")==j&&!g.hasClass("ui-draggable")||this==h.next().get(0))return!1;var f=f.parent("li").length?f.parent("li").attr("rel"):0,g=a(this).next(),k=null;g.length&&(k=g.attr("rel"));a.post("?module=album&action=move",{id:j,before_id:k,parent_id:f},function(b){var g=a.photos.getAlbum(),d=b.data.album,c=b.data.counters;0>=d.status&&a.photos_dragndrop.privateDescendants(d.id)&&
a.photos.dispatch("album/"+d.id+"/");g&&g.id==d.id&&((b=b.data.frontend_link)&&a("#photo-list-frontend-link").attr("href",b).text(b),d.type==Album.TYPE_DYNAMIC&&a.photos.load("?module=album&action=photos&id="+d.id,a.photos.onLoadPhotoList));if(!a.isEmptyObject(c))for(var f in c)c.hasOwnProperty(f)&&album_list.find("li[rel="+f+"]").find(".count:first").text(c[f])},"json");f=h.parent("ul");j=f.children("li.dr[rel!="+j+"]").length;h.next().insertAfter(a(this));h.insertAfter(a(this));j||(f.parent("li").children("i").remove(),
f.remove())}})},privateDescendants:function(b,c){var c="boolean"===typeof c?c:!0,f=a("#album-list").find("li[rel="+b+"]"),h;h=c?f:a();changed=!1;h.add(f.find("li.dr")).each(function(){var b=a(this).find(">a");if(!b.find("i.lock-bw").length){var g=b.find(".pictures").next();g.length?(changed=!0,g.before('<i class="icon10 lock-bw no-overhanging"></i>')):b.append('<i class="icon10 lock-bw no-overhanging"></i>')}});return changed},_initDropInsideAlbums:function(){a("li.dr a",a("#album-list")).liveDroppable({accept:function(a){return a.is("li.dr, img#photo")||
a.closest("li[data-photo-id]").length?!0:!1},tolerance:"custom",greedy:!0,out:function(b,c){a(this).parent().removeClass("drag-newparent");c.helper.find("span").show().end().find("i").hide()},over:function(b,c){var f=a(this).parent(),h=!1;c.draggable=a.photos_dragndrop._fixUiDraggable(c.draggable);if(c.draggable.parents("#photo-list").length||c.draggable.is("#photo"))f.hasClass("static")?c.helper.find("span").show().end().find("i").hide():c.helper.find("span").hide().end().find("i").show(),h=!0;f.addClass("drag-newparent");
if(h)return!1;if(c.draggable.hasClass("static")&&!f.hasClass("static"))return c.helper.find("i.no-bw").show(),!1;c.helper.find("i.no-bw").hide();var j='.dr[rel!="'+a(c.draggable).attr("rel")+'"]',g=a(),h=function(a,b){if(0>=b.length)return a;a=a.add(b.nextUntil(j).filter("li.drag-newposition"));return 0<b.nextAll(j).length?a:arguments.callee(a,b.parent().closest("li"))},k=f.prevAll(j).first();if(0<k.length)var m=k.find(j),g=0<m.length?h(g,m.last()):h(g,k);else g=g.add(f.prevUntil(j).filter("li.drag-newposition"));
var g=0<f.children("ul").children(j).length?g.add(f.children("ul").children("li.drag-newposition:first")):h(g,f),o=a(".drag-newposition:animated, .drag-newposition.dragging").not(g);o.stop().animate({height:"0px"},300,null,function(){o.removeClass("dragging")});g.stop().animate({height:"10px"},300,null,function(){g.addClass("dragging")})},drop:function(b,c){var f=a(this).parent().removeClass("drag-newparent"),h;c.draggable=a.photos_dragndrop._fixUiDraggable(c.draggable);if(c.draggable.parents("#photo-list").length||
c.draggable.is("#photo")){h=this.href.match(/.*#\/album\/([\d]+)/);if(null===h||!parseInt(h[1],10)){console&&console.log("Link: "+this.href+" is not correct");return}h=parseInt(h[1],10);var j=null;f.hasClass("static")&&(j=c.draggable.is("#photo")?[a.photos.photo_stream_cache.getCurrent().id]:c.draggable.data("photo_ids"));j&&(a.photos.addToAlbums({photo_id:j,album_id:h}),a("#photo-list li.selected").trigger("select",!1));return!1}if(c.draggable.hasClass("static")&&!f.hasClass("static"))return!1;j=
a(c.draggable);if(f.attr("rel")==j.attr("rel"))return!1;f.hasClass("drag-newposition")?h=f.parent("ul"):f.children("ul").length?h=f.children("ul"):(h=a('<ul class="menu-v with-icons dr"><li class="drag-newposition"></li></ul>').appendTo(f),h.find(".drag-newposition").mouseover(),a('<i class="icon16 darr overhanging"></i>').insertBefore(f.children("a")));var g=j.attr("rel"),f=f.attr("rel");if(f==j.parent("ul").parent("li.dr").attr("rel"))return!1;a.post("?module=album&action=move",{id:g,parent_id:f},
function(b){var g=a.photos.getAlbum(),c=b.data.album,d=b.data.counters;c.status<=0&&a.photos_dragndrop.privateDescendants(c.id)&&a.photos.dispatch("album/"+c.id+"/");if(g&&g.id==c.id){(b=b.data.frontend_link)&&a("#photo-list-frontend-link").attr("href",b).text(b);c.type==Album.TYPE_DYNAMIC&&a.photos.load("?module=album&action=photos&id="+c.id,a.photos.onLoadPhotoList)}c=a("#album-list");if(!a.isEmptyObject(d))for(var f in d)d.hasOwnProperty(f)&&c.find("li[rel="+f+"]").find(".count:first").text(d[f])},
"json");var f=j.parent("ul"),g=f.children("li.dr[rel!="+g+"]").length,k=j.next();j.appendTo(h);k.appendTo(h);g||(f.parent("li").children("i").remove(),f.remove())}})},_scrolHelper:function(){var b=a("#helper"),c=b.data("scrollTop"),f=a(document).scrollTop();b.css("top",b.position().top+(c?f-c:50)+"px");b.data("scrollTop",f)},_dropAnimation:function(b,c){var f=[];b.each(function(){var b=a(this),c=b.offset(),g=b.clone().css({"z-index":10,position:"absolute",top:c.top,left:c.left}).insertAfter(b);b.css({opacity:0});
f.push(b.hide(300).promise());f.push(g.animate({top:c.top,left:c.left},300).promise().done(function(){a(this).remove()}))});a.when.apply(a,f).done(function(){"function"===typeof c&&c()})},_shiftToLeft:function(b){if("left"!==b.data("shifted")){var c=b.find(".p-wrapper");if(!c.length){var f=b.children(),c=a("<div class='p-wrapper' style='position:relative;'></div>").appendTo(b);c.append(f)}c.stop().animate({left:-15},200);b.data("shifted","left")}},_shiftToRight:function(b){if("right"!==b.data("shifted")){var c=
b.find(".p-wrapper");if(!c.length){var f=b.children(),c=a("<div class='p-wrapper' style='position:relative;'></div>").appendTo(b);c.append(f)}c.stop().animate({left:15},200);b.data("shifted","right")}},_shiftAtPlace:function(a){if(a.data("shifted")){var b=a.find(".p-wrapper");if(b.length){var c=b.children();b.stop().css({left:0});a.append(c);b.remove()}a.data("shifted","")}},_bindExtDragActivate:function(b,c){a(document).bind("mousemove.ext_drag_activate",function(f){a.photos_dragndrop._extDragActivate(f,
b,c)})},_unbindExtDragActivate:function(){a(document).unbind("mousemove.ext_drag_activate")},_activatePhotoListItem:function(){var c=a(this),e=b(),f=e?"drag-active":"drag-active-disabled";e&&a.photos_dragndrop._shiftToRight(c);c.hasClass("last")?a.photos_dragndrop._bindExtDragActivate(c,f):c.addClass(f)},_unactivatePhotoListItem:function(){var c=a(this),e=b(),f=e?"drag-active":"drag-active-disabled",h=f+"-last";c.hasClass("last")&&a.photos_dragndrop._unbindExtDragActivate();c.removeClass(f+" "+h);
e&&a.photos_dragndrop._shiftAtPlace(c)},_extDragActivate:function(b,c,f){var h=f+"-last";if(c.hasClass("last")){var j=b.pageX,b=b.pageY,g=c.width(),k=c.height(),m=c.position();"template-photo-thumbs"==a.photos.list_template?j>m.left+0.5*g&&j<=m.left+g?(c.removeClass(f).addClass(h),a.photos_dragndrop._shiftToLeft(c)):j>m.left&&j<=m.left+0.5*g?(c.removeClass(h).addClass(f),a.photos_dragndrop._shiftToRight(c)):a.photos_dragndrop._shiftAtPlace(c):"template-photo-descriptions"==a.photos.list_template&&
(b>m.top+0.5*k?c.removeClass(f).addClass(h):b>m.top&&c.removeClass(h).addClass(f));(b<m.top||b>m.top+k||j<m.left||j>m.left+g)&&c.removeClass(f).removeClass(h)}else c.addClass(f)},_fixUiDraggable:function(a){if(a.is("#photo"))return a;"IMG"==a.get(0).tagName&&(a=a.parents("li:first"));return a},_extendJqueryUIDragAndDrop:function(){a.fn.liveDraggable=function(b){this.each(function(){var b=a(this);b.data("init_draggable")&&b.die("mouseover",b.data("init_draggable"))});this.live("mouseover",function(){var c=
a(this);c.data("init_draggable")||c.data("init_draggable",arguments.callee).draggable(b)})};a.fn.liveDroppable=function(b){this.each(function(){var b=a(this);b.data("init_droppable")&&b.die("mouseover",b.data("init_droppable"))});var c=function(){var c=a(this);c.data("init_droppable")||(c.data("init_droppable",arguments.callee).droppable(b),c.mouseover())};c.call(this);this.die("mouseover",c).live("mouseover",c);this.live("mouseover",c)};var b=a.ui.intersect;a.ui.intersect=function(c,f,h){!a(c.element).is("#photo")&&
"custom"==h&&(h="pointer");if("custom"!=h)return b.call(a.ui,c,f,h);var h=f.offset.left,j=f.offset.top,c=c.helper.position();return a.ui.isOver(c.top,c.left+a.photos_dragndrop.helper_shift,j,h,f.proportions.height,f.proportions.width)}}}})(jQuery);(function(a){var b=function(a,d){var e=!/[^\w\-\.:]/.test(a)?b.cache[a]=b.cache[a]||b(b.load(a)):new Function(b.arg+",tmpl","var _e=tmpl.encode"+b.helper+",_s='"+a.replace(b.regexp,b.func)+"';return _s;");return d?e(d,b):function(a){return e(a,b)}};b.cache={};b.load=function(a){var b=document.getElementById(a),e=/<\\\/(\w+)/g;!b&&console&&console.log("template with id="+a+" not found");return b?("textarea"==b.tagName.toLowerCase()?b.value:document.getElementById(a).innerHTML).replace(e,"</$1"):null};
b.regexp=/([\s'\\])(?![^%]*%\})|(?:\{%(=|#)([\s\S]+?)%\})|(\{%)|(%\})/g;b.func=function(a,b,e,f,h,j){if(b)return{"\n":"\\n","\r":"\\r","\t":"\\t"," ":" "}[a]||"\\"+a;if(e)return"="===e?"'+_e("+f+")+'":"'+("+f+"||'')+'";if(h)return"';";if(j)return"_s+='"};b.encReg=/[<>&"'\x00]/g;b.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"};b.encode=function(a){return String(a||"").replace(b.encReg,function(a){return b.encMap[a]||""})};b.arg="o";b.helper=",print=function(s,e){_s+=e&&(s||'')||_e(s);},include=function(s,d){_s+=tmpl(s,d);}";
"function"===typeof define&&define.amd?define(function(){return b}):a.tmpl=b})(this);(function(a){a.fn.inlineEditable=function(b,c){function d(){m(a(this))||a(this).addClass(i.placeholderClass).text(i.placeholder)}function e(){m(a(this))==i.placeholder&&a(this).text("").removeClass(i.placeholderClass)}function f(b){return!a(b).val()?(a(this).text(i.placeholder).addClass(i.placeholderClass),!0):!1}function h(){q="edit";this.id=this.id||(""+Math.random()).slice(2);var b=this.id+"-input",c=a("#"+b);c.length||(l.after(g(b)),c=a("#"+b));var b=c,d=l,f=i.size.height||d.height(),d=i.size.width||
1.5*d.width(),f=i.minSize.height&&f<i.minSize.height?i.minSize.height:f,d=i.minSize.width&&d<i.minSize.width?i.minSize.width:d,f=i.maxSize.height&&f>i.maxSize.height?i.maxSize.height:f,d=i.maxSize.width&&d>i.maxSize.width?i.maxSize.width:d;b.height(f);b.width(d);i.placeholder&&m(a(this))==i.placeholder&&e.call(l);i.beforeMakeEditable.call(this,c);p=i.truncate?l.data("real_text"):m(l);c.val(p).show().focus();l.hide();a(i.editLink).hide();if(!o){for(var k=[],h=[],b=0,f=i.makeReadableBy.length;b<f;++b)d=
i.makeReadableBy[b],"blur"==d&&c.blur(function(){q!="read"&&j.call(this)}),"enter"==d&&k.push(13),"esc"==d&&k.push(27);b=0;for(f=i.updateBy.length;b<f;++b)d=i.updateBy[b],"alt+enter"==d&&h.push({ctrl:!1,alt:!0,shift:!1,key:13}),"ctrl+enter"==d&&h.push({ctrl:!0,alt:!1,shift:!1,key:13}),"ctrl+s"==d&&h.push({ctrl:!0,alt:!1,shift:!1,key:17});k.length&&c.keydown(function(a){~k.indexOf(a.keyCode)&&!a.ctrlKey&&!a.altKey&&!a.shiftKey&&q!="read"&&j.call(this,a.keyCode==27?p:null);if(h.length)for(var b in h){var g=
h[b];if(a.keyCode==g.key&&a.ctrlKey==g.ctrl&&a.altKey==g.alt&&a.shiftKey==g.shift){l.trigger("readable");break}}});l.bind("readable",function(b,g){if(q!="read"){var c=a("#"+(this.id+"-input"));j.call(c,c.val(),g)}});o=!0}}function j(b,g){g="undefined"===typeof g?!1:!0;void 0!=b&&null!=b?a(this).val(b):b=a(this).val();if(!(!1===g&&!1===i.beforeBackReadable.call(l.get(0),this,{changed:b!=p,old_text:p,new_text:b}))){q="read";if(!i.placeholder||!f.call(l,this))if(i.allowEmpty||b)i.truncate?(l.data("real_text",
b),l.text(b.length<i.truncate-3?b:b.substr(0,i.truncate-3)+"...")):!i.html?l.text(b):l.html(b),b||d.call(this);l.show();a(this).hide();a(i.editLink).show();!1===g&&i.afterBackReadable.call(l.get(0),this,{changed:b!=p,old_text:p})}}function g(a){switch(i.inputType){case "textarea":return'<textarea id="'+a+'" style="display:none;"></textarea>';default:return'<input type="text" id="'+a+'" style="display:none;">'}}function k(a){return function(){return a}}function m(a){return!i.html?a.text():a.html()}
var o=!1;if("string"==typeof b){if("setOption"==b){var i=this.data("inlineEditableSettings")||{};a.extend(!0,i,c);"undefined"!==typeof c.hold&&"function"!==typeof c.hold&&(i.hold=k(i.hold));this.data("inlineEditableSettings",i)}return this}var n=this.data("inlineEditableSettings");this.data("inlineEditableSettings",a.extend({inputType:"text",size:{height:null,width:null},minSize:{height:null,width:null},maxSize:{height:null,width:null},editLink:null,editOnItself:!0,placeholder:null,makeReadableBy:["blur",
"enter","esc"],updateBy:["ctrl+enter","alt+enter"],beforeBackReadable:function(){},afterBackReadable:function(){},beforeMakeEditable:function(){},placeholderClass:"hint",truncate:!1,hold:!1,html:!1,allowEmpty:!1},n,b||{}));var i=this.data("inlineEditableSettings"),l=this,q="read",p="";"function"!==typeof i.hold&&(i.hold=k(i.hold));this.data("inited")||(i.truncate&&"boolean"==typeof i.truncate&&(i.truncate=255),i.truncate&&(n=!i.placeholder||i.placeholder!==this.text()?this.text():"",this.data("real_text",
n),this.text(n.length<i.truncate-3?n:n.substr(0,i.truncate-3)+"...")),i.placeholder&&d.call(this),i.editLink&&a(i.editLink).click(function(){i.hold.call(l)||q!="edit"&&h.call(l.get(0))}),i.editOnItself&&this.click(function(){i.hold.call(l)||q!="edit"&&h.call(this)}),this.bind("editable",function(){i.hold.call(l)||q!="edit"&&h.call(this)}),this.bind("placeholder",function(b,g){g&&i.placeholder&&d.call(this);g||a(this).removeClass(i.placeholderClass)}),this.data("inited",!0));return this}})(jQuery);(function(a){a.fn.activeMenu=function(b,c,d){if("string"==typeof b){if("disable"==b||"enable"==b)return a.isArray(c)||(c=[c]),this.find("li").each(function(){var d=a(this);~c.indexOf(d.attr("data-action"))&&("disable"==b?d.hide():d.show())}),this;if("setOption"==b){var e=this.data("activeMenuSettings");if("string"===typeof c){var f={};f[c]=d;c=f}a.extend(e,c);return this}}if("string"==typeof b&&"fire"==b)return e=this.data("activeMenuSettings"),e["on"+b.substr(0,1).toUpperCase()+b.substr(1)].call(this),
this;this.data("activeMenuSettings",a.extend({beforeAnyAction:function(){},defaultAction:function(){},onInit:function(){},onFire:function(){}},b||{}));e=this.data("activeMenuSettings");var h=this;this.data("inited")||(this.click(function(b){for(var g=b.target,c=h.get(0);"LI"!=g.tagName;){if(g==c)return;g=a(g).parent().get(0)}for(var g=a(g),c=g.attr("data-action")||"default",c=c.split("-"),d=1;d<c.length;d++)c[d]=c[d][0].toUpperCase()+c[d].slice(1);c=c.join("");c+="Action";if(!e[c]||"function"!=typeof e[c])c=
"defaultAction";if(!1!==e.beforeAnyAction(g.attr("data-action")))e[c](g,b);return!1}),e.onInit(this),this.data("inited",!0));return this}})(jQuery);(function(a){a.fn.rateWidget=function(b,c,d){function e(b){var g=0;this.find("i").removeClass("star star-empty star-half star-hover").addClass("star-empty").each(function(){if(g==b)return!1;g++;g>b?0.5==g-b&&a(this).removeClass("star-empty").addClass("star-half"):a(this).removeClass("star-empty").addClass("star")});this.attr("data-rate",b)}function f(a){return function(){return a}}if("string"==typeof b){if("getOption"==b&&"rate"==c)return parseInt(this.attr("data-rate"));if("setOption"==b&&("rate"==
c&&(b=parseFloat(d)||0,e.call(this,Math.round(2*b)/2),c={rate:d}),"object"===typeof c&&c)){var h=this.data("rateWidgetSettings")||{};a.extend(h,c);"undefined"!==typeof c.hold&&"function"!==typeof c.hold&&(h.hold=f(h.hold))}return this}this.data("rateWidgetSettings",a.extend({onUpdate:function(){},rate:null,hold:!1,withClearAction:!0,alwaysUpdate:!1},b||{}));var h=this.data("rateWidgetSettings"),j=this;"function"!==typeof h.hold&&(h.hold=f(h.hold));if(!this.data("inited")){null!=h.rate&&j.attr("data-rate",
h.rate);j.find("i:lt("+j.attr("data-rate")+")").removeClass("star-empty").addClass("star");j.mouseover(function(b){if(!h.hold.call(j)){b=b.target;if(b.tagName=="I"){b=a(b);b.prevAll().removeClass("star star-half star-empty").addClass("star-hover").end().removeClass("star star-half star-empty").addClass("star-hover");b.nextAll().removeClass("star star-hover").addClass("star-empty")}}}).mouseleave(function(){h.hold.call(j)||e.call(j,j.attr("data-rate"))});j.click(function(b){if(!h.hold.call(j)){for(var g=
b.target;g.tagName!="I";)if(g==this)return;var c=j.attr("data-rate"),d=0;j.find("i").removeClass("star star-hover").addClass("star-empty").each(function(){d++;a(this).removeClass("star-empty").addClass("star");if(this==g){if(h.alwaysUpdate||c!=d){j.attr("data-rate",d);h.onUpdate(d)}return false}})}});if(h.withClearAction){var d="clear-"+a(this).attr("id"),g=a("#"+d);g.length||(j.after('<a href="javascript:void(0);" class="inline-link p-rate-clear" id="'+d+'" style="display:none;"><b><i>'+$_("clear")+
"</b></i></a>"),g=a("#"+d));g.click(function(){if(!h.hold.call(j)){var a=j.attr("data-rate");e.call(j,0);if(a!=0)h.onUpdate(0)}});var k;j.parent().mousemove(function(){if(!h.hold.call(j)){k&&clearTimeout(k);g.show(0)}}).mouseleave(function(){k=setTimeout(function(){h.hold.call(j)||g.hide(0)},150)})}this.data("inited",!0)}return this}})(jQuery);var PhotoStream=function(){var a=function(a){this._options=a||{};this._onClear=this._options.onClear||function(){};this._photo_stream=[]};$.extend(a.prototype,{getById:function(a){for(var c=0,d=this._photo_stream[0],e=this._photo_stream.length;c<e;d=this._photo_stream[++c])if(d&&d.id==a)return d;return null},updateById:function(a,c,d){if(a=this.getById(a))return $.extend(a,c),a;d&&this._photo_stream.push(c);return c},deleteById:function(a){$.isArray(a)||(a=[a]);for(var c=a,d=0,e=c.length,a=c[0];d<
e;a=c[++d])(a=this.getById(a))&&a.index&&delete this._photo_stream[a.index];for(var c=[],f=0,d=0,e=this._photo_stream.length,a=this._photo_stream[0];d<e;a=this._photo_stream[++d])a&&(a.index=f++,c.push(a));this._photo_stream=c;return this},replace:function(a,c){var d=a.index;this._photo_stream[d]=c;c.index=d;return this},push:function(a){this._photo_stream.push(a);a.index=this._photo_stream.length-1;return this},getNext:function(a){a=a||this.current;"object"!=typeof a&&(a=this.getById(a));if(!a)return null;
a=a.index+1;return this._photo_stream[a]?this._photo_stream[a]:null},getPrev:function(a){a=a||this.current;"object"!=typeof a&&(a=this.getById(a));if(!a)return null;a=a.index-1;return this._photo_stream[a]?this._photo_stream[a]:null},setCurrent:function(a){if(!a.index&&(a=this.getById(a.id),!a||"number"!==typeof a.index&&!a.index))throw Error("This photo is not in stream");this.current=a;return this},setCurrentById:function(a){a=this.getById(a);"object"===typeof a&&a&&this.setCurrent(a);return this},
getCurrent:function(){return this.current},getCurrentId:function(){return"object"===typeof this.current&&this.current?this.current.id:null},set:function(a){this._photo_stream=[];this.append(a);this.isEmpty()||this.setCurrent(this.getFirst());return this},append:function(a){for(var c=0,d=a[c],e=this._photo_stream.length,f=a.length;c<f;d=a[++c],++e)d.index=e,this._photo_stream.push(d);return this},prepend:function(a){var c=this._photo_stream||[];this._photo_stream=[];for(var d=0,e=a[d],f=a.length;d<
f;e=a[++d])e.index=d,this._photo_stream.push(e);this.append(c);return this},clear:function(){this._photo_stream=[];this._onClear();return this},length:function(){return this._photo_stream.length},getAll:function(){return this._photo_stream},getFirst:function(){return this._photo_stream[0]},getLast:function(){return this._photo_stream[this._photo_stream.length-1]},isFirst:function(a){return a&&0==a.index},isLast:function(a){return a&&a.index==this._photo_stream.length-1},isEmpty:function(){return!this._photo_stream.length},
getCurrentIndex:function(){return this.current.index},slice:function(a,c){return this._photo_stream.slice(a,c)},move:function(a,c){var d=[],e,f=this._photo_stream;if($.isArray(a))for(var h=0,j=a.length;h<j;++h)e=this.getById(a[h]),delete f[e.index],d.push(e);else e=this.getById(a),delete f[e.index],d.push(e);if(d.length){e=0;e="undefined"===typeof c||null===c?this._photo_stream.length:(e=this.getById(c))?e.index:0;Array.prototype.splice.apply(f,[e,0].concat(d));this.clear();h=d=0;for(j=f.length;h<
j;++h)e=f[h],"object"===typeof e&&e&&(e.index=d++,this._photo_stream.push(e))}}});return a}();Date.parseISO=function(a){var b=Date.parse(a);if(!isNaN(b))return b;a=a.match(/([0-9]{4})-([0-9]{2})-([0-9]{2}) ([0-9]{2}):([0-9]{2}):([0-9]{2})/);b=new Date(a[1],0,1);a[2]&&b.setMonth(a[2]-1);a[3]&&b.setDate(a[3]);a[4]&&b.setHours(a[4]);a[5]&&b.setMinutes(a[5]);a[6]&&b.setSeconds(a[6]);return+b};
function replaceImg(a,b,c,d){d=d||a.attr("id")||(""+Math.random()).slice(2);replaceImg.loading_map=replaceImg.loading_map||{};replaceImg.loading_map[d]=b;a.unbind("load");null===c?a.attr("src",b):$("<img>").attr("src",b).load(function(){setTimeout(function(){replaceImg.loading_map[d]==b&&(a.attr("src",b),"function"==typeof c&&c.call(a));$(this).remove()},100)});return d}
String.prototype.truncate=function(a,b){var c="";("undefined"===typeof b||b)&&(c=this.replace(/<\/?[\s\S]+?\/?>/g,""));c.length>a-3&&3<a&&(c=c.substr(0,a-3)+"...");return c};function parseSize(a){var b="unknown",a=(""+a).split("x"),c=a[0]&&0!=a[0]?a[0]:null,d=a[1]&&0!=a[1]?a[1]:null;1==a.length?(b="max",d=c):c==d?b="crop":c&&d?b="rectangle":null===c?b="height":null===d&&(b="width");return{type:b,width:c,height:d}}
function getRealSizesOfThumb(a,b){var c=parseInt(a.width,10),d=parseInt(a.height,10),e=c/d,f=d/c,h;if(isNaN(e)||isNaN(f))return null;h="object"!==typeof b?parseSize(b):b;var j=h.width,g=h.height;switch(h.type){case "max":c>d?(e=j,f*=e):(f=j,e*=f);break;case "crop":e=f=j;break;case "rectangle":e=j;f=g;break;case "width":e=j;f*=e;break;case "height":f=g;e*=f;break;default:e=f=null}e=Math.round(e);f=Math.round(f);return c<e&&d<f?{width:a.width,height:a.height}:{width:e,height:f}};(function(a){a.fn.photoStreamSlider=function(b){var c=a.extend({duration:200},b||{}),d=this,e=function(b){function m(){e.execution=!1;var a="on"+j.charAt(0).toUpperCase()+j.slice(1),a=c[a];"function"==typeof a&&a.call(d);a=b.fn;"function"==typeof a&&a.call(d)}"string"==typeof b&&(b={direction:b,animate:!0});var j=b.direction||"forward",i=b.steps||h.length;if(!e.execution){e.execution=!0;var n=h.filter(":first").outerWidth()*i,s=h.length;if("forward"==j){var u=h.filter(":last").nextAll(":lt("+i+")"),
i=u.length,u=u.filter(":last");i&&(h.removeClass("visible"),u.prevAll(":lt("+(s-1)+")").addClass("visible"),u.addClass("visible"))}else u=h.filter(":first").prevAll(":lt("+i+")"),i=u.length,u=u.filter(":last"),i&&(h.removeClass("visible"),u.nextAll(":lt("+(s-1)+")").addClass("visible").show(),u.addClass("visible"));h=a("li.visible",f);s=f.position().left;"forward"==j?(i=k-g-o,s-=n,s=s>-i?s:-i):(s+=n,s=s<o?s:o);b.animate?f.animate({left:s},c.duration,m):(f.css({left:s}),m())}},f=d.find(c.photoStream),
h=a("li.visible",f),j=a("li",f),g=h.filter(":first").outerWidth()*h.length,k=j.filter(":first").outerWidth()*j.length,b=j.filter(":first").outerHeight();f.parent().css({overflow:"hidden",height:b,position:"relative",padding:"4px 0",margin:0,width:g});for(var b=f.find("li:first"),m=h.filter(":first"),o=(m.outerWidth()-m.width())/2,i=0,n=b.outerWidth(),m=m.get(0);b.length&&b.get(0)!=m;)i+=n,b=b.next();f.css({position:"absolute",left:-(i-o),width:k});a(c.forwardLink).click(function(){e("forward");return!1});
a(c.backwardLink).click(function(){e("backward");return!1});d.bind("append prepend",function(b,g){if("append"==b.type){for(var c=f.find("li:last"),h=a();c.hasClass("dummy");)h=h.add(c),c=c.prev("li");h.remove();f.append(g)}else{var c=a("<div></div>").html(g),h=c.find("li"),m=h.length*n;c.remove();for(var c=f.find("li:first"),e=a();c.hasClass("dummy");)e=e.add(c),c=c.next("li");e.remove();f.prepend(h)}j=f.find("li");k=j.filter(":first").outerWidth()*j.length;f.css("width",k);"prepend"==b.type&&(f.is(":animated")&&
f.stop(!1,!0),f.css("left",parseInt(f.css("left"))-m));f.find("li.selected").hasClass("visible")&&d.trigger("home",[null,!1])});d.bind("forward backward",function(a,b){e({direction:a.type,steps:b.steps,animate:"undefined"!==typeof b.animate?b.animate:!0,fn:b.fn});var g=f.find("li.selected"),c="forward"==a.type?g.next("li:not(.dummy)"):g.prev("li:not(.dummy)");c.length&&(g.removeClass("selected"),c.addClass("selected"))});d.bind("home",function(b,g,c){var b=parseInt(h.length/2),b=h.filter(":eq("+b+
")"),d=b.nextAll(".selected:first"),f=b.prevAll(".selected:first"),k=0,m="";"function"!==typeof g&&(c=g);c="undefined"!==typeof c?c:!0;d.length?(m="forward",b.nextAll().each(function(){++k;if(a(this).hasClass("selected"))return!1})):f.length&&(m="backward",b.prevAll().each(function(){++k;if(a(this).hasClass("selected"))return!1}));m&&k?e({direction:m,steps:k,fn:g,animate:c}):"function"==typeof g&&g();return!1})}})(jQuery);(function(a){a.storage=new a.store;var b=function(c){var d=c.target.type,c=c.keyCode;if(!b.hold&&!("text"==d||"textarea"==d||37!=c&&39!=c)){if(39==c){if(d=a.photos.photo_stream_cache.getNext())a.photos.goToHash(a.photos.getHashByPhotoId(d.id),!1),a.photos.shift_next=!0;b.hold=!0}if(37==c){if(d=a.photos.photo_stream_cache.getPrev())a.photos.goToHash(a.photos.getHashByPhotoId(d.id),!1),a.photos.shift_next=!0;b.hold=!0}}},c=function(){b.hold=!1},d=function(b){var c=b.target.type,b=b.keyCode;if(!d.hold&&
!("text"==c||"textarea"==c)){var e;switch(b){case 48:case 96:c=0;break;case 49:case 97:c=1;break;case 50:case 98:c=2;break;case 51:case 99:c=3;break;case 52:case 100:c=4;break;case 53:case 101:c=5;break;default:c=null}e=c;"number"===typeof e&&(d.hold=!0,a("#photo").length?(c=a.photos.photo_stream_cache.getCurrent(),c.edit_rights&&a.photos.saveField(c.id,"rate",e,function(b){"ok"==b.status&&b.data.count&&(a("#rated-count").text(0<b.data.count?b.data.count:""),a("#photo-rate").rateWidget("setOption",
"rate",e))})):(c=a("input[name^=photo_id]").map(function(){return this.checked?{name:"id[]",value:this.value}:null}).toArray(),c.length&&a.photos.saveField({id:c,name:"rate",value:e,fn:function(b){if("ok"==b.status){var c=b.data.allowed_photo_id&&!a.isArray(b.data.allowed_photo_id)?b.data.allowed_photo_id:{};a("#photo-list li.selected").each(function(){var b=a(this);c[b.attr("data-photo-id")]&&a.photos.updateThumbRate(b,e)}).find("input:first").trigger("select",!1);b.data.count&&a("#rated-count").text(0<
b.data.count?b.data.count:"");b.data.alert_msg&&alert(b.data.alert_msg)}}})))}},e=function(){d.hold=!1};a.photos={load_from_hash:0,hash:"",options:{},shift_next:!1,anchor:"",album:null,total_count:null,photos_per_page:null,list_template:"template-photo-thumbs",photo_list_string:{},init:function(b){"undefined"!=typeof a.History&&(a.History.bind(function(){a.photos.dispatch()}),a.History.unbind=function(b,c){c?a.History.handlers.specific[b]&&a.each(a.History.handlers.specific[b],function(g,d){if(d===
c)return a.History.handlers.specific[b].splice(g,1),!1}):(c=b,a.each(a.History.handlers.generic,function(b,d){if(d===c)return a.History.handlers.generic.splice(b,1),!1}))},a.History.one=function(b,c){c||(c=b,b=null);var g=function(){c.call(this);a.History.unbind.apply(a.History,b?[b,g]:[g])};a.History.bind.apply(a.History,b?[b,g]:[g])});a.wa.errorHandler=function(b){a.storage.del("photos/hash");if(b.status===403){a("#content").html('<div class="content left'+a.photos_sidebar.width+'px"><div class="block double-padded">'+
b.responseText+"</div></div>");return false}if(a.photos.load_from_hash){a.wa.setHash("#/");return false}return true};this.options=b;(b=window.location.hash||a.storage.get("photos/hash"))&&b!=window.location.hash?(this.load_from_hash=2,a.wa.setHash("#/"+b)):this.dispatch()},dispatch:function(b){if(a.photos.ignore_dispatch)a.photos.ignore_dispatch--;else if(a.photos.hash="",void 0==b&&(b=window.location.hash),b=b.replace(/^[^#]*#\/*/,""))if(b=b.split("/"),b[0]){for(var c="",d=b.length,g=0;g<b.length;g++){var k=
b[g];if(2>g)if(0===g)c=k;else if("tag"==c||"search"==c||"plugins"==c||"pages"==c||"app"==c){d=g;break}else if(parseInt(k,10)!=k&&-1==k.indexOf("="))c+=k.substr(0,1).toUpperCase()+k.substr(1);else{d=g;break}else{d=g;break}}d=b.slice(d);a.photos.hash="/"+b.slice(0,2).join("/");~a.photos.hash.indexOf("photo")&&(a.photos.hash="");this.beforeAnyAction(c,d);this[c+"Action"]?(this.load_from_hash&&this.load_from_hash--,this[c+"Action"].apply(this,d),a.storage.set("photos/hash",a.photos.hash)):(a.storage.del("photos/hash"),
console&&console.log("Invalid action name:",c+"Action"))}else this.beforeAnyAction(),this.defaultAction();else this.beforeAnyAction(),this.defaultAction()},ignore_dispatch:0,forceHash:function(b){b!=window.location.hash&&(a.photos.ignore_dispatch=1,window.location.hash=b)},menu:{stack:{list:[],photo:[]},extend_stack:{list:[],photo:[]},register:function(a,b,c){this.stack[a]&&this.stack[a].push(new ToolbarMenu(b,c))},get:function(b,c){if(this.stack[b]&&a.isArray(this.stack[b]))for(var d=0;d<this.stack[b].length;d++)if(this.stack[b][d].is(c))return this.stack[b][d];
return null},init:function(a){var b="";if(this.stack[a]){for(;b=this.extend_stack[a].shift();)for(var c=0;c<this.stack[a].length;c++)if(this.stack[a][c].is(b.selector)){for(var g in b.actions)this.stack[a][c].setAction(g,b.actions[g]);break}for(c=0;c<this.stack[a].length;c++)this.stack[a][c].init()}},enable:function(a,b,c){b=b||"*";if(this.stack[a])for(var g=0;g<this.stack[a].length;g++){var d=this.stack[a][g];(!b||d.is(b))&&d.enable(c)}},disable:function(a,b,c){b=b||"*";if(this.stack[a])for(var g=
0;g<this.stack[a].length;g++){var d=this.stack[a][g];(!b||d.is(b))&&d.disable(c)}},extend:function(a,b,c){this.stack[a]&&this.extend_stack[a].push({selector:b,actions:c});return this}},setOption:function(a,b){this.options[a]=b},getOption:function(a){return this.options[a]},beforeAnyAction:function(){},initClearance:function(){a.photos.toggleFullScreen();a.photos.highlightSidebarItem();a.photos.hotkey_manager.unset();a.photos.unsetLazyLoad();a.photos.photo_stream_cache.clear();a.photos.photo_stack_cache.clear();
delete a.photos.photo_stream_cache.hash},defaultAction:function(){window.location.hash||!a("#album-list ul li.dr").length?(a.storage.set("photos/hash","photos/"),this.photosAction()):(a.storage.set("photos/hash","albums/"),this.albumsAction())},photosAction:function(){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=photo&action=list",a.photos.onLoadPhotoList)})},albumsAction:function(){a.photos.loadDispatch(arguments,function(){a.photos.load("?action=albums")})},albumAction:function(b){a.photos.loadDispatch(arguments,
function(){a.photos.load("?module=album&action=photos&id="+b,a.photos.onLoadPhotoList)})},searchAction:function(b){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=search&action=photos",{q:b},a.photos.onLoadPhotoList)})},tagAction:function(b){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=tag&action=photos&tag="+b,a.photos.onLoadPhotoList)})},appAction:function(b){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=photo&action=list&app_id="+b,a.photos.onLoadPhotoList)})},
settingsAction:function(){a.photos.initClearance();a.photos.load("?module=settings",a.photos.onLoadSettings)},pagesAction:function(b){a("#wa-page-container").length?waLoadPage(b):(a.photos.initClearance(),a.photos.load("?module=pages",a.photos.onLoadPages,'<div class="content left'+a.photos_sidebar.width+'px"></div>'))},designAction:function(b){a.photos.initClearance();b?a("#wa-design-container").length?(a.photos.setTitle($_("Themes")),a.photos.scrollTop(),waDesignLoad()):a.photos.load("?module=design",
function(){waDesignLoad(b);a.photos.setTitle($_("Themes"));a.photos.scrollTop()},'<div class="content left'+a.photos_sidebar.width+'px"></div>'):a.photos.load("?module=design",function(){waDesignLoad("");a.photos.setTitle($_("Design"));a.photos.scrollTop()},'<div class="content left'+a.photos_sidebar.width+'px"></div>')},designThemesAction:function(){a.photos.initClearance();a("#wa-design-container").length?(a.photos.setTitle($_("Themes")),a.photos.scrollTop(),waDesignLoad()):a.photos.load("?module=design",
function(){waDesignLoad();a.photos.setTitle($_("Themes"));a.photos.scrollTop()},'<div class="content left'+a.photos_sidebar.width+'px"></div>')},pluginsAction:function(b){a.photos.initClearance();var c=function(){1<a("#plugin-list li").length&&(b=b||a.storage.get("photos/plugin_id")||a("#plugin-list li:first").attr("id").replace(/^plugin-/,""),plugin_li=a("#plugin-"+b),plugin_li.length?(a.storage.set("photos/plugin_id",b),a("#plugin-list li.selected").removeClass("selected"),a("#plugin-"+b).addClass("selected")):
a("#plugin-list li[id^=plugin-]").length?(b=a("#plugin-list li.selected").attr("id").replace("plugin-",""),a.storage.set("photos/plugin_id",b)):b=null);a.photos.loadPluginSettings(b,a.photos.onLoadPlugins)};a("#photos-plugins").length?c():a.photos.load("?module=plugins",c)},loadPluginSettings:function(b,c){a.photos.initClearance();if(b){var d=a("#plugin-"+b).attr("data-settings")?"?plugin="+b+"&module=settings":"?module=plugins&id="+b;a("#photos-plugins-content").load(d,function(){c(b)})}else a("#photos-plugins-content span").html("")},
photoAction:function(b){a.photos.loadPhoto(b)},loadDispatch:function(b,c){for(var d=Array.prototype.slice.call(b,1),g=0;g<d.length;g++)if("photo"==d[g]&&g<d.length-1){this.loadPhoto(d[g+1]);return}"function"==typeof c&&c(b[0]);a.photos.initClearance()},onLoadSettings:function(){a.photos.setTitle($_("Settings"));a.photos.scrollTop()},onLoadPlugins:function h(b){a.photos.setTitle($_("Plugins"));a("#plugins-settings-form").submit(function(){a("#plugins-settings-form-status").fadeIn(400);a("#plugins-settings-iframe").one("load",
function(){var c=a.parseJSON(a(this).contents().find("body").html());a("#plugins-settings-form-status").fadeOut(200,function(){"ok"==c.status?a.photos.loadPluginSettings(b,h):(a("#plugins-settings-form-status").html(c.errors?c.errors:c).css("color","red"),a("#plugins-settings-form-status").fadeIn("slow"))})})});a.photos.scrollTop()},onLoadPages:function(){a.photos.setTitle($_("Pages"));a.photos.scrollTop()},renderPhotoList:function(){var b=a("#photo-list");b.empty();a.photos.renderPhotoListChunk(b,
0);a.photos.photo_stream_cache.length()&&(!a.photos.total_count||a.photos.total_count>a.photos.photo_stream_cache.length())&&a.photos.setLazyLoad()},renderPhotoListChunk:function(b,c,g,d){var e=a.photos.options.photo_list_render_chunk||10,o=a.photos.photo_stream_cache.length(),g=g||{};g.hide_name||(g.hide_name=a.storage.get("photos/list/hide_name",!1));b.append(tmpl(a.photos.list_template,{photos:a.photos.photo_stream_cache.slice(c,c+=e),hash:a.photos.hash,last_login_time:a.photos.options.last_login_time,
options:g,selected:!!a("#selector-menu").find("[data-action=select-photos]").data("checked")}));if(c<o)setTimeout(function(){a.photos.renderPhotoListChunk(b,c,g,d)},100);else if("function"==typeof d&&d(),e=g.string||a.photos.photo_list_string||!1)a(".lazyloading-wrapper").html(tmpl("template-photo-counter",{count:o,total_count:a.photos.total_count,string:e})),a.photos.photo_list_string=e;a.Retina&&a.photos.options.retina_2x_enabled&&b.find("img").retina()},selectPhotoListView:function(b){b=b.replace(/-view$/,
"");a.photos.list_template="template-photo-"+b;var c=a.photos.getAlbum();c&&("thumbs"==b?a.storage.del("photos/list/view/"+c.id):a.storage.set("photos/list/view/"+c.id,b));a.photos.menu.enable("list","."+b+"-view-menu");a.photos.menu.disable("list",":not(."+b+"-view-menu)");c=a("#photo-list");c.removeClass(c.attr("class"));switch(b){case "thumbs":c.addClass("thumbs li250px");break;case "descriptions":c.addClass("p-descriptions")}a("#p-block .p-content-control li.selected").removeClass("selected");
a('#p-block .p-content-control a[data-action="'+b+'-view"]').parents("li").addClass("selected")},onLoadPhotoList:function(){var b=a.photos.getAlbum(),c=null;if(b){c=a.storage.get("photos/list/view/"+b.id);"thumbs"!=c&&"descriptions"!=c&&(c="thumbs");var g=a("#album-list li[rel="+b.id+"]");g.find(".count:first").text(b.count);g.find(".count-new:first").text("");a("#album-list-container").trigger("uncollapse_section",g);if(b.edit_rights)a("#photo-list").on("click",".make-key-photo-link",function(){a("#photo-list .key-photo").removeClass("key-photo");
$li=a(this).closest("li").addClass("key-photo");b.key_photo_id=$li.data("photo-id");a.post("?module=album&action=keyPhoto",{album_id:b.id,photo_id:b.key_photo_id})})}c||(c="thumbs");a("#template-photo-"+c).length?(a.photos.list_template="template-photo-"+c,a.photos.renderPhotoList(),a.photos.fixRightToolbar(),a.photos.setTitle(a("#photo-list-name").text()),a.photos.menu.init("list"),a.photos.selectPhotoListView(c),a.Retina&&a.photos.options.retina_2x_enabled&&a("#album-thumbs-list img").retina(),
a("#p-block .p-content-control li a.album-view").click(function(){var b=a(this).attr("data-action");b!=c&&(c=b.replace(/-view$/,""),a.photos.list_template="template-photo-"+c,a.photos.renderPhotoList(),a.photos.selectPhotoListView(c));return!1}),a("#photo-list .p-description div").live("click",function(){a(this);a(this).height();var b=$_("add description");a(this).inlineEditable({inputType:"textarea",makeReadableBy:["esc"],updateBy:["ctrl+enter"],placeholder:b,placeholderClass:"gray",minSize:{height:40},
html:!0,allowEmpty:!0,beforeMakeEditable:function(b){var c=a(this),g=c.parent().find(".full-description:first").html(),d=c.css("font-size"),k=c.css("line-height");b.css("font-size",d).css("line-height",k);c.html(g);g=Math.max(c.parents("li:first").find("img").width(),c.width());b.width(g);g=this.id+"-button";d=a("#"+g);d.length||(b.after('<br><input type="button" id="'+g+'" value="'+$_("Save")+'"> <em class="hint" id="'+this.id+'-hint">Ctrl+Enter</em>'),a("#"+g).click(function(){c.trigger("readable")}));
a("#"+this.id+"-hint").show();d.show()},afterBackReadable:function(b,c){var g=a("#"+(this.id+"-button")),d=a(this),k=a(b).val(),e=d.parents("li:first").find(".p-image a").attr("href"),e=/(\d+)[\/]*$/.exec(e),h=null;g.hide();a("#"+this.id+"-hint").hide();k?(d.text(k.truncate(255)),d.parent().find(".full-description:first").html(k)):d.parent().find(".full-description:first").html("");e&&c.changed&&(h=e[1],a.photos.saveField({id:h,type:"photo",name:"description",value:k,fn:function(){}}))},hold:function(){return!this.hasClass("editable")}}).trigger("editable")}),
g=a("#photo-list-name"),g.hasClass("editable")&&g.inlineEditable({minSize:{width:350},maxSize:{width:600},size:{height:30},afterBackReadable:function(b,c){if(!c.changed)return!1;var g=a(b).val(),d=a.photos.getAlbum();d&&a.photos.saveField({id:d.id,type:"album",name:"name",value:g,fn:function(b){"ok"==b.status&&(b=b.data.album,a("#album-list li[rel="+b.id+"] > a > .album-name").html(b.name),a("#p-upload-step2 select[name=album_id] option[value="+b.id+"]").html(b.name),a.photos.setTitle(b.not_escaped_name))}})},
hold:function(){return!this.hasClass("editable")}}),g=a("#photo-album-note"),g.hasClass("editable")&&g.inlineEditable({placeholder:"("+$_("subtitle")+")",placeholderClass:"gray",minSize:{width:350},maxSize:{width:600},size:{height:22},afterBackReadable:function(b,c){if(!c.changed)return!1;var g=a(b).val(),d=a.photos.getAlbum();d&&a.photos.saveField({id:d.id,type:"album",name:"note",value:g})},hold:function(){return!this.hasClass("editable")}}),a("#share-menu-block, #organize-menu-block").bind("recount",
function(){var b=a("#photo-list li.selected").length;0<b?a(".count:first",a(this)).text(b).show():a(".count:first",a(this)).hide()}),a("#p-album-settings").click(function(){var b=a.photos.getAlbum(),c=b?b.id:0,b=a("#album-settings-dialog-acceptor");b.length||(b=a("<div id='album-settings-dialog-acceptor'></div>"),a("body").append(b));b.load("?module=dialog&action=albumSettings&id="+c,function(){a("#album-settings-dialog").waDialog({onSubmit:function(b){var g=a(this);b.trigger("change_loading_status",
true);a.post(g.attr("action"),g.serializeArray(),function(g){if(g.status=="ok"){var d=g.data.total_count,k=g.data.status,e=g.data.groups,h=g.data.count,i=function(c){a.post("?module=album&action=savePhotosAccess",c,function(){c.offset=c.offset+h;if(c.offset<=d)i(c);else{b.trigger("change_loading_status",false);location.reload()}})};if(h<d)i({id:c,status:k,groups:e,count:h,offset:h});else{b.trigger("change_loading_status",false);location.reload()}}else if(g.status=="fail"){b.trigger("change_loading_status",
false);g=g.errors;for(k in g)g.hasOwnProperty(k)&&b.find("input[name="+k+"]").addClass("error").parent().find(".errormsg").text(g[k])}},"json");return false}})});return!1}),a("#p-album-delete").click(function(){var b=a.photos.getAlbum(),c=b?b.id:0;a.photos.confirmDialog({url:"?module=dialog&action=confirmDeleteAlbum&id="+c,onSubmit:function(b){var g=parseInt(a("input[name=delete-photos]:checked",b).val());b.trigger("close");a.photos.setCover();a.photos.deleteAlbum(c,g,function(){a.photos.unsetCover()});
return!1}});return!1}),a("#photo-list").find(".p-description textarea, .p-photo-details textarea, .p-photo-details input").live("select",function(){return!1}),a.photos.hotkey_manager.set("rate"),a.photos.hash!=a.photos.photo_stream_cache.hash&&a.photos.scrollTop(),a("#content").trigger("photos_list_load")):(a("#content").empty(),a.wa.setHash("#/"))},loadPhoto:function(b){if(a.photos.photo_stream_cache.hash!=a.photos.hash)a.photos.loadNewPhoto(b);else{var c=a.photos.photo_stream_cache.getById(b);c?
(a.photos.setTitle(c.name_not_escaped),a.photos.loadPhotoCompletly(c)):(c=a.photos.photo_stack_cache.getById(b))?(a.photos.setTitle(c.name_not_escaped),a.photos.loadPhotoInStack(c)):a.photos.loadNewPhoto(b)}},loadPhotoInStack:function j(b){a.photos.abortPrevLoading();a.photos.hooks_manager.trigger("beforeLoadPhoto",b);a.photos.photo_stack_cache.setCurrent(b);var c=a.photos._chooseProperThumb(b);"object"===typeof c.size&&c.size&&a("#photo").width(c.size.width).height(c.size.height);replaceImg(a("#photo"),
b.thumb.url+(b.edit_datetime?"?"+Date.parseISO(b.edit_datetime):""),null);a.photos.setNextPhotoLink();c=a.post("?module=photo&action=load",{id:b.id,in_stack:1},function(b){var b=b.data,c=b.photo,c=a.photos.photo_stack_cache.updateById(c.id,c);b.photo=c;a.photos.updateViewChildPhoto(b);a.photos.hooks_manager.trigger("afterLoadPhoto",c);delete j.xhr},"json");j.xhr=c;a("#photo-name").html(b.name)},updateViewChildPhoto:function(b){var c=b.author,d=b.albums,e=b.exif,b=b.photo;a.photos.renderPhotoImg(b);
a("#photo-author").html(tmpl("template-photo-author",{photo:b,author:c}));a.photos.updatePhotoOriginalBlock(b);a("#photo-exif").html(tmpl("template-photo-exif",{exif:e}));a.photos.renderMap(e.GPSLatitude,e.GPSLongitude,b.name);a("#photo-albums").html(tmpl("template-photo-albums",{albums:d}));a.photos.initPhotoContentControlWidget({frontend_link_template:frontend_link_template,photo:b})},loadNewPhoto:function(b){a.photos.initClearance();a.photos.widget.loupe.init();a.post("?module=photo&action=load",
{id:b,hash:a.photos.hash},function(b){var b=b.data,c=b.photo;a.photos.renderViewPhoto(b);var d=a.photos.photo_stream_cache.getNext();d&&a.photos.preloadPhoto(d);b.album&&a.photos.setAlbum(b.album);a.photos.hooks_manager.trigger("afterLoadPhoto",c)},"json")},renderViewPhoto:function(b){var c=b.photo,d=b.author,e=b.exif,o=b.stack,i=b.albums,n=b.hooks,l=b.frontend_link_template,b=b.photo_stream;a.photos.setTitle(c.name_not_escaped);a("#content").html(tmpl("template-p-block"));a.photos.initPhotoToolbar({photo:c,
author:d,exif:e,stack:o});a.photos.renderPhotoBlock({photo:c,hash:a.photos.hash,albums:i,hooks:n,frontend_link_template:l});a.photos.initPhotoWidgets({photo:c,stack:o,exif:e,photo_stream:b,hash:a.photos.hash});a.photos.anchor?(a.photos.goToAnchor(a.photos.anchor),a.photos.anchor=""):a.photos.scrollTop();a.photos.setNextPhotoLink()},loadPhotoCompletly:function(b){a.photos.photo_stream_cache.setCurrent(b);a.photos.updatePhotoStreamWidget({shift:b.id,fn:function(){a.photos._loadPhotoCompletly(b)}})},
_loadPhotoCompletly:function g(b){a.photos.abortPrevLoading();a.photos.hooks_manager.trigger("beforeLoadPhoto",b);a.photos.setNextPhotoLink();a.photos.updatePhotoName(b.name);a.photos.updatePhotoDescription(b.description);a.photos.updatePhotoRate(b.rate);a("#photo-frontend-url").html(b.url);a("#stack-stream").hide();a("#photo-hook-bottom").html("");var c=a.photos.isPhotoPreloaded(b);if(c)a.photos.renderPhotoImg(b);else{var d=a.photos._chooseProperThumb(b);"object"===typeof d.size&&d.size&&a("#photo").width(d.size.width).height(d.size.height);
replaceImg(a("#photo"),b.thumb.url+(b.edit_datetime?"?"+Date.parseISO(b.edit_datetime):""),null)}a.photos.updatePhotoTags(b.tags);(d=a.photos.photo_stream_cache.getNext())&&a.photos.preloadPhoto(d);b=a.post("?module=photo&action=load",{id:b.id},function(b){if("ok"==b.status){var b=b.data,d=b.photo,d=a.photos.photo_stream_cache.updateById(d.id,d);b.photo=d;a.photos.updateViewPhoto(b,c);a.photos.hooks_manager.trigger("afterLoadPhoto",d);delete g.xhr}},"json");g.xhr=b},updateViewPhoto:function(b,c){var d=
b.author,e=b.albums,i=b.exif,n=b.frontend_link_template,l=b.hooks,q=b.stack,p=b.photo;c||a.photos.renderPhotoImg(p);a.photos.updateViewPhotoMenu(0!=p.parent_id||0<p.stack_count,p.edit_rights);a.photos.updatePhotoName(p.name,p.edit_rights);a.photos.updatePhotoDescription(p.description,p.edit_rights);a.photos.updatePhotoRate(p.rate,p.edit_rights);a.photos.updatePhotoTags(p.tags);a("#photo-author").html(tmpl("template-photo-author",{photo:p,author:d}));a.photos.updatePhotoOriginalBlock(p);a("#photo-exif").html(tmpl("template-photo-exif",
{exif:i}));a.photos.renderMap(i.GPSLatitude,i.GPSLongitude,p.name);a("#photo-albums").html(tmpl("template-photo-albums",{albums:e}));a.photos.initPhotoContentControlWidget({frontend_link_template:n,photo:p});q?(a("#stack-stream").html(tmpl("template-photo-stack",{stack:q,photo_id:p.id,hash:a.photos.hash})).show(),a.photos.photo_stack_cache.set(q),a.photos.initPhotoStackWidget()):a.photos.photo_stack_cache.clear();var d="",t;for(t in l.backend_photo)l.backend_photo[t].bottom&&(d+=l.backend_photo[t].bottom);
a("#photo-hook-bottom").html(d);d="";for(t in l.backend_photo)l.backend_photo[t].after_rate&&(d+=l.backend_photo[t].after_rate);d&&(a("#photo-rate").nextAll().remove(),a("#photo-rate").after(d));a.photos.anchor&&(a.photos.goToAnchor(a.photos.anchor),a.photos.anchor="")},renderPhotoImg:function(b){var c=a.photos._chooseProperThumb(b);replaceImg(a("#photo"),c.url+(b.edit_datetime?"?"+Date.parseISO(b.edit_datetime):""),function(){"object"===typeof c.size&&c.size&&a(this).width(c.size.width).height(c.size.height);
a.photos.hooks_manager.trigger("afterRenderImg",this,b,c)})},updateViewPhotoMenu:function(b,c){b?a.photos.menu.enable("photo","#photo-organize-menu","unstack"):a.photos.menu.disable("photo","#photo-organize-menu","unstack");c?(a.photos.menu.enable("photo","#photo-organize-menu"),a.photos.menu.enable("photo","#edit-menu"),a("#photo-tags").parent().show()):(a.photos.menu.disable("photo","#photo-organize-menu"),a.photos.menu.disable("photo","#edit-menu"),a("#photo-tags").parent().hide())},preloadPhoto:function(b){var c=
a("#preload-photo");c.attr("data-photo-id","");replaceImg(c,b.thumb_big.url,function(){c.attr("data-photo-id",b.id)})},isPhotoPreloaded:function(b){return a("#preload-photo").attr("data-photo-id")==b.id},abortPrevLoading:function(){"object"===typeof a.photos._loadPhotoCompletly.xhr&&"function"===typeof a.photos._loadPhotoCompletly.xhr.abort&&(a.photos._loadPhotoCompletly.xhr.abort(),a.photos.hooks_manager.trigger("onAbortPrevLoading"));"object"===typeof a.photos.loadPhotoInStack.xhr&&"function"===
typeof a.photos.loadPhotoInStack.xhr.abort&&(a.photos.loadPhotoInStack.xhr.abort(),a.photos.hooks_manager.trigger("onAbortPrevLoading"))},updateThumbRate:function(b,c){var d=b.find(".p-details .p-rate");(c=Math.round(2*c)/2)?(d.find("i").filter(function(){return~this.className.indexOf("star")}).removeClass("star star-empty star-half").addClass("star-empty").each(function(b){b+=1;b>c?0.5==b-c&&a(this).removeClass("star-empty").addClass("star-half"):a(this).removeClass("star-empty").addClass("star")}),
d.show()):d.hide()},showManageAccessDialog:function(b,c){var d=a("#manage-access-dialog-acceptor"),e="?module=dialog&action=manageAccess";d.length||(d=a("<div id='manage-access-dialog-acceptor'></div>"),a("body").append(d));if(b)if(a.isArray(b))for(var i=0,n=b.length;i<n;++i)var l=b[i],e=e+("&"+l.name+"="+l.value);else e+="&"+b;d.load(e,function(){a("#manage-access-dialog").waDialog({onSubmit:c})})},initPhotoNameWidget:function(b){b="undefined"===typeof b?!1:b;a("#photo-name").inlineEditable({placeholder:a("#photo-name").text()?
null:$_("Edit title..."),placeholderClass:"gray",afterBackReadable:function(b,c){if(c.changed){var g=a(b).val();g.length&&a.photos.saveField({id:a.photos.getPhotoId(),type:"photo",name:"name",value:g,fn:function(b){a("#photo-name").inlineEditable("setOption",{placeholder:null});"ok"==b.status&&a.photos.setTitle(b.data.value)}})}},minSize:{width:350},maxSize:{width:600},size:{height:30},hold:function(){return!this.hasClass("editable")}});a.photos.updatePhotoName(b)},initPhotoDescriptionWidget:function(b){b=
"undefined"===typeof b?!1:b;a("#photo-description").inlineEditable({placeholder:$_("add description"),placeholderClass:"gray",makeReadableBy:["esc"],updateBy:["ctrl+enter"],html:!0,allowEmpty:!0,beforeMakeEditable:function(b){var c=a("#photo-description-save");if(!c.length){var g=a(this);b.after('<br><input type="button" id="photo-description-save" value="'+$_("Save")+'"> <em class="hint" id="'+this.id+'-hint">Ctrl+Enter</em>');c=a("#photo-description-save");c.click(function(){g.trigger("readable")})}a("#"+
this.id+"-hint").show();c.show().prev("br").show()},afterBackReadable:function(b,c){a("#photo-description-save").hide().prev("br").hide();a("#"+this.id+"-hint").hide();if(!c.changed)return!1;a(b).val();a.photos.saveField({id:a.photos.photo_stream_cache.getCurrent().id,type:"photo",name:"description",value:a(b).val(),fn:function(){}})},minSize:{height:50,width:600},size:{width:a("#photo").width()},inputType:"textarea",editLink:"#photo-description-edit-link",hold:function(){return!this.hasClass("editable")}});
a.photos.updatePhotoDescription(b)},initPhotoRateWidget:function(b){b="undefined"===typeof b?!1:b;a("#photo-rate").rateWidget({onUpdate:function(b){a.photos.saveField(a.photos.photo_stream_cache.getCurrent().id,"rate",b,function(b){"ok"==b.status&&b.data.count&&a("#rated-count").text(0<b.data.count?b.data.count:"")})},hold:function(){return this.hasClass("hold")}});a.photos.updatePhotoRate(b)},initPhotoStackWidget:function(b){"object"===typeof b&&b&&a("#stack-stream").html(tmpl("template-photo-stack",
b)).show();b=a("#stack-stream li.dr:first a").attr("href");(b=/(\d+)[\/]*$/.exec(b))&&(parent_id=b[1]);a("#stack-stream").data("parent_id",parent_id);a("#stack-stream").sortable({distance:5,helper:"clone",items:"li.dr",opacity:0.75,tolerance:"pointer",start:function(){document.ondragstart=function(){return!1}},stop:function(b,c){document.ondragstart=null;var g=a(c.item),d=parseInt(g.attr("data-photo-id")),g=g.next(),e=null;g.length&&(e=parseInt(g.attr("data-photo-id")));a.post("?module=stack&action=photoMove",
{id:d,before_id:e},function(b){if("ok"==b.status&&b.data.stack){var c=b.data.stack,b=a("#stack-stream").data("parent_id"),c=c[0],g=c.id;b!=g&&(b=a.photos.photo_stream_cache.getById(b),c.tags=b.tags,a.photos.photo_stream_cache.replace(b,c),a("#stack-stream").data("parent_id",g),a.photos.updatePhotoStreamWidget({current_photo:c}))}},"json")}});if(a("#stack-stream").data("inited"))return!1;a("#stack-stream li.dr").live("click",function(){a("#stack-stream li.dr.selected").removeClass("selected");a(this).addClass("selected")});
a("#stack-stream").data("inited",!0)},initPhotoTagsWidget:function(b){var c=a("#photo-tags"),d=$_("add a tag");"undefined"!==typeof b&&("object"===typeof b&&b&&(b=a.photos.joinObject(b,",")),c.importTags(b));c.data("current_value",c.val());try{c.tagsInput({autocomplete_url:"?module=tag&action=list",height:120,width:150,defaultText:d})}catch(e){}a("#photo-save-tags").click(function(){var b=a("#photo-tags_tag");b.length&&b.val()!=d&&b.trigger(a.Event("keypress",{which:13}));if(c.data("current_value")!==
c.val()){c.data("current_value",c.val());a("#photo-save-tags-status").html('<i style="vertical-align: middle" class="icon16 yes"></i>'+$_("Saving")).fadeIn("slow");a.photos.assignTags({photo_id:a.photos.photo_stream_cache.getCurrent().id,tags:a("#photo-tags").val(),fn:function(){a("#photo-save-tags-status").html('<i style="vertical-align: middle" class="icon16 yes"></i>'+$_("Saved")).fadeOut("slow")},onDeniedExist:function(){alert($_("You don't have sufficient access rights"))}})}})},initPhotoContentControlWidget:function(b){"object"===
typeof b&&b?(a("#photo-content-control").html(tmpl("template-photo-content-control",b)),edit_rights=b.photo.edit_rights):edit_rights=b;edit_rights="undefined"===typeof edit_rights?!1:edit_rights;var c=a("#photo-frontend-url"),d=c.parents("li:first").find("i.new-window"),e=a("#photo-frontend-link").nextAll("span.slash:first");c.length&&c.inlineEditable({inputType:"input",editLink:"#photo-frontend-url-edit-link",editOnItself:!1,minSize:{width:100},beforeMakeEditable:function(b){var c=a(this),g=c.text().replace(/\/$/,
"");c.text(g);e.show();d.hide();b.removeClass("error");a("#photo-content-control").find(".errormsg").text("").hide()},beforeBackReadable:function(b,g){function l(){q.text(p);e.hide();d.show();a(b).removeClass("error");a("#photo-content-control").find(".errormsg").text("").hide()}var q=a(this),p=q.text()+"/",t=a.photos.getPhotoId(),r=a(b).val();if(g.changed){a.photos.saveField(t,"url",r,function(g){if(g.status=="ok"){g=a("#photo-frontend-link").text();a("#photo-frontend-link").attr("href",g);l();c.trigger("readable",
true)}else if(g.status=="fail"){a(b).addClass("error");a("#photo-content-control").find(".errormsg").text(g.errors.url).show()}});return false}l()},hold:function(){return this.hasClass("hold")}});a.photos.updatePhotoFrontendUrl(edit_rights)},renderMap:function(b,c,d){b&&c?(a("#photo-map").show(),b=new google.maps.LatLng(b,c),c={zoom:11,center:b,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,style:google.maps.ZoomControlStyle.SMALL}},
map=new google.maps.Map(a("#photo-map").get(0),c),new google.maps.Marker({position:b,map:map,title:d})):a("#photo-map").hide()},joinObject:function(a,b){var c="",d=0,b=b||"",e;for(e in a)a.hasOwnProperty(e)&&(0<d++&&(c+=b),c+=a[e]);return c},initPhotoStreamWidget:function(b){var c=b.photos,c=[null].concat(c,[null]);a("#photo-stream").html(tmpl("template-photo-stream",{photos:c,current_photo:b.current_photo||null,hash:a.photos.hash}));var d=!1,e=!1;a("#photo-stream ul.photostream:first").photoStreamSlider({backwardLink:"#photo-stream .rewind",
forwardLink:"#photo-stream .ff",photoStream:"ul",duration:400,onForward:function n(){if(!d){var b=this,c=b.find("ul").find("li:not(.dummy)"),g=c.filter(".visible"),c=c.filter(":last");15>g.filter(":last").nextAll().length&&"object"!=typeof n.xhr&&(g=c.attr("data-photo-id"),n.xhr=a.post("?module=photo&action=loadList",{id:g,direction:1,hash:a.photos.hash},function(c){if("ok"==c.status){c=c.data.photos;if(0<c.length)a.photos.photo_stream_cache.append(c);else{d=!0;return}c.push(null);b.trigger("append",
tmpl("template-photo-stream-list",{photos:c}))}delete n.xhr},"json"))}},onBackward:function l(){if(!e){var b=this,c=b.find("ul").find("li:not(.dummy)"),g=c.filter(".visible"),c=c.filter(":first");15>g.filter(":first").prevAll().length&&"object"!=typeof l.xhr&&(g=c.attr("data-photo-id"),l.xhr=a.post("?module=photo&action=loadList",{id:g,direction:-1,hash:a.photos.hash},function(c){if("ok"==c.status){c=c.data.photos;if(0<c.length)a.photos.photo_stream_cache.prepend(c);else{e=!0;return}c.unshift(null);
b.trigger("prepend",tmpl("template-photo-stream-list",{photos:c}))}delete l.xhr},"json"))}}})},updatePhotoStreamWidget:function(b){var c=a("#photo-stream ul.photostream:first");if(b.current_photo){var d=c.find("li.selected"),e=b.current_photo;d.attr("data-photo-id",e.id);d.find("a").attr("href","#/photo/"+e.id);d.find("img").attr("src",e.thumb_crop.url)}b.shift&&(c.find("li.selected").removeClass("selected"),c.find("li[data-photo-id="+b.shift+"]").addClass("selected"),c.trigger("home",[b.fn||function(){},
!a.photos.shift_next]),a.photos.shift_next=!1)},updatePhotoName:function(b,c){if("boolean"===typeof b||"undefined"===typeof b)c=b,b=null;var d=a("#photo-name");null!==b&&d.html(b);c?d.addClass("editable"):d.removeClass("editable")},updatePhotoDescription:function(b,c){if("boolean"===typeof b||"undefined"===typeof b)c=b,b=a("#photo-description").html();var d=a("#photo-description"),e=null,i=$_("add description");c?(d.addClass("editable"),e=i,a("#photo-description-edit-link").show()):(e=null,b=b!==
i?b:"",d.removeClass("editable"),a("#photo-description-edit-link").hide());d.inlineEditable("setOption",{placeholder:e}).html(b).trigger("placeholder",!!e)},updatePhotoRate:function(b,c){if("boolean"===typeof b||"undefined"===typeof b)c=b,b=null;var d=a("#photo-rate");null!==b&&d.rateWidget("setOption","rate",b);c?d.removeClass("hold").show():(d.addClass("hold"),(b=d.rateWidget("getOption","rate"))||d.hide())},updatePhotoTags:function(b){var c=a("#photo-tags");c.data("current_value",c.val());"undefined"!==
typeof b&&("object"===typeof b&&b&&(b=a.photos.joinObject(b,",")),c.importTags(b))},updatePhotoFrontendUrl:function(b){var c=a("#photo-frontend-url");b?(c.removeClass("hold"),a("#photo-frontend-url-edit-link").show()):(c.addClass("hold"),a("#photo-frontend-url-edit-link").hide())},updatePhotoOriginalBlock:function(b){a("#photo-original").html(tmpl("template-photo-original",{photo:b}))},initPhotoToolbar:function(b){a("#p-toolbar").html(tmpl("template-photo-toolbar",b)).addClass("rendered");a.photos.menu.init("photo");
var c=a("#photos-photo-popular-tags");c.data("inited")||c.off("click.photos","a").on("click.photos","a",function(){var b=a(this).text(),c=a("#photo-tags");c.removeTag(b);c.addTag(b)}).data("inited",!0);a.photos.updateViewPhotoMenu(a.isArray(b.stack)&&b.stack.length,b.photo.edit_rights)},renderPhotoBlock:function(b){var c=b.photo,d=a.photos._chooseProperThumb(c),e=c.thumb.size;"object"===typeof d.size&&d.size&&(c.thumb.size={width:d.size.width,height:d.size.height});a("#p-block").html(tmpl("template-photo",
b)).addClass("rendered");"object"===typeof e&&e&&(c.thumb.size={width:e.width,height:e.height});replaceImg(a("#photo"),d.url+(c.edit_datetime?"?"+Date.parseISO(c.edit_datetime):""),function(){a.photos.hooks_manager.trigger("afterRenderImg",this,c,d)})},initPhotoWidgets:function(b){var c=b.photo,d=b.exif,e=b.stack,b=b.photo_stream,i=a.photos.hash;a.photos.initPhotoNameWidget(c.edit_rights);a.photos.initPhotoDescriptionWidget(c.edit_rights);a.photos.initPhotoRateWidget(c.edit_rights);a.photos.initPhotoTagsWidget(c.tags);
a.photos.initPhotoContentControlWidget(c.edit_rights);a.photos.hotkey_manager.set();a.photos.renderMap(d.GPSLatitude,d.GPSLongitude,c.name);a.isArray(e)&&e.length&&(a.photos.photo_stack_cache.set(e).setCurrentById(c.id),a.photos.initPhotoStackWidget({stack:e,photo_id:c.id,hash:a.photos.hash}));c=a.photos.photo_stream_cache;c.hash=i;c.set(b.photos).setCurrentById(b.current_photo_id);a.photos.initPhotoStreamWidget({photos:b.photos,current_photo:c.getCurrent()});a("#p-block .p-one-photo > .p-image-nav").click(function(){var b=
a(this).hasClass("p-rewind")?a.photos.photo_stream_cache.getPrev():a.photos.photo_stream_cache.getNext();if(b){a.photos.goToHash(a.photos.getHashByPhotoId(b.id),false);a.photos.shift_next=true}})},_chooseProperThumb:function(b){var c=b.thumb_big,b=b.thumb_middle,d,e=a("#p-block").width();d=c;"object"===typeof c.size&&c.size?(parseInt(c.size.height,10)>parseInt(b.bound.height,10)&&parseInt(c.size.height,10)>a(window).height()&&(d=b),parseInt(d.size.width,10)>e&&(d.size.height=Math.round(e/parseInt(d.size.width,
10)*parseInt(d.size.height,10)),d.size.width=e)):d.size={width:e,height:""};if("object"!==typeof d.size||!d.size)d.size={widht:e,height:""};return d},setNextPhotoLink:function(){var b=a("#photo").parents("a:first"),c=a.photos.photo_stream_cache.getNext();c?(b.attr("title",$_("Next \u2192")),b.attr("href","#"+a.photos.hash+"/photo/"+c.id+"/")):(b.attr("title",""),b.attr("href","javascript:void(0);"))},setTitle:function(b){b&&(document.title=b+a.photos.options.title_suffix)},ignore_scrolltop:!1,scrollTop:function(){a.photos.ignore_scrolltop?
a.photos.ignore_scrolltop=!1:a(document).scrollTop(0)},load:function(b,c,d,e){var i=a("#content");"function"==typeof c&&(e=d||null);e&&(i.empty().append(e),i=i.find(":last-child"));"function"==typeof c?i.load(b,c):i.load(b,c,d)},setCover:function(){a.photos.centralizeLoadingIcon();a("#cover").show()},unsetCover:function(){a("#cover").hide()},centralizeLoadingIcon:function(){var b=a("#cover"),c=a("#cover .loading"),d=b.width(),e=c.width(),b=b.height(),c=c.height();a(".loading").css({position:"absolute",
left:parseInt((d-e)/2)+"px",top:parseInt((b-c)/2)+"px"})},saveField:function(b,c,d,e){var i="photo";1==arguments.length&&(i=a.extend({type:i,fn:function(){}},b),b=i.id,c=i.name,d=i.value,e=i.fn,i=i.type);if(!~["photo","album"].indexOf(i))throw"Unknown type";a.isArray(b)||(b=[{name:"id[]",value:parseInt(b)}]);var n=[].concat(b,{name:"name",value:c},{name:"value",value:d});a.post("?module="+i+"&action=saveField",n,function(i){if(i.status=="ok"){var n={};n[c]=d;if(i.data.parent_id)b=i.data.parent_id;
a.photos._updateStreamCache(b,n);typeof e=="function"&&e(i)}else i.status=="fail"&&typeof e=="function"&&e(i)},"json")},saveFields:function(b){a.post("?module=photo&action=saveFields",{data:b},function(b){if("ok"==b.status)for(var c in b.data.update){var d=b.data.update[c].id;a.isArray(d)||(d=[d]);var g=b.data.update[c].data;c=0;for(var e=d.length;c<e;++c)a.photos.photo_stream_cache.updateById(d[c],g)}},"json")},_updateStreamCache:function(b,c){a.isArray(b)||(b=[{value:b}]);for(var d=0,e=b.length;d<
e;++d)a.photos.photo_stream_cache.updateById(b[d].value,c)},restoreOriginal:function(b,c){c=c||function(){};a.post("?module=photo&action=restore",{id:b},function(d){"ok"==d.status&&(d=d.data.photo,d=0==d.parent_id?a.photos.photo_stream_cache.updateById(b,d):a.photos.photo_stack_cache.updateById(b,d),a.photos.updatePhotoOriginalBlock(d),a.photos.updatePhotoImgs(d,c))},"json")},rotate:function(b,c,d){d=d||function(){};a.post("?module=photo&action=rotate",{id:b,direction:c},function(c){"ok"==c.status&&
(c=c.data.photo,c=0==c.parent_id?a.photos.photo_stream_cache.updateById(b,c):a.photos.photo_stack_cache.updateById(b,c),a.photos.updatePhotoOriginalBlock(c),a.photos.updatePhotoImgs(c,d))},"json").error(function(b){a.photos.showServerError(b.responseText);"function"==typeof d&&d()})},updatePhotoImgs:function(b,c){var d=a.photos._chooseProperThumb(b),e=b.edit_datetime?"?"+Date.parseISO(b.edit_datetime):"";replaceImg(a("#photo"),d.url+e,function(){a("#photo").width(d.size.width).height(d.size.height);
a("#photo-stream .selected img, #stack-stream .selected img").each(function(){var c=a(this);c.hasClass("thumb")?c.attr("src",b.thumb.url+e):c.attr("src",b.thumb_crop.url+e)});"function"==typeof c&&c();a.photos.hooks_manager.trigger("afterRenderImg",this,b,d)})},deletePhotos:function(b,c){a.post("?module=photo&action=resolution",a.isArray(b)?b:{photo_id:b},function(d){if("ok"==d.status){for(var e=d.data.photo_id,d=[],i=[],n=0,l=e.length;n<l;++n)d.push({name:"photo_id[]",value:e[n]});a.photos.massPost({photo_id:d,
url:"?module=photo&action=delete",dataType:"json",data:{photos_length:a.isArray(b)?b.length:1},success:function(a,b){if("ok"==a.status){i=i.concat(a.data.denied_photo_id);for(var c=0,d=i.length;c<d;++c)b.push({name:"denied_photo_id[]",value:i[c]})}},fullSuccess:function(d){var m;if("ok"==d.status)if(a.isArray(b)){d.data.alert_msg&&alert(d.data.alert_msg);var l={};a.each(e,function(a,b){l[b]=b});d.data.denied_photo_id&&d.data.denied_photo_id.length&&a.each(d.data.denied_photo_id,function(a,b){delete l[b]});
l=a.map(l,function(b,c){a.photos.photo_stream_cache.deleteById(e[b]);return c});a("#photo-list li.selected").trigger("select",!1);l.length?a.photos.makeDeleteAnimation(l,function(){c&&c(d)}):c&&c(d)}else{i.length&&alert($_("You don't have sufficient access rights"));if(d.data.parent_id)m=a.photos.getHashByPhotoId(d.data.parent_id),a.photos.photo_stack_cache.deleteById(e);else{var n=a.photos.photo_stream_cache;m=(m=n.getNext(b))?a.photos.getHashByPhotoId(m.id):n.hash;n.deleteById(e)}a.wa.setHash(m);
c&&c(d)}else c&&c(d)}})}},"json")},deleteAlbum:function(b,c,d){c?a.photos._deleteAlbumWithPhotos(b,d):a.post("?module=album&action=delete",{album_id:b},function(c){"ok"==c.status&&(a.photos.onDeleteAlbum(b),a.photos.goToHash(""),"function"==typeof d&&d())},"json")},_deleteAlbumWithPhotos:function(b,c){a.post("?module=photo&action=resolution",{album_id:b},function(d){if("ok"==d.status){for(var d=d.data.photo_id,e=[],i=0,n=d.length;i<n;++i)e.push({name:"photo_id[]",value:d[i]});e.length?a.photos.massPost({url:"?module=photo&action=delete",
photo_id:e,dataType:"json",fullSuccess:function(d){"ok"==d.status?a.photos.deleteAlbum(b,0,c):console&&console.log("Error while delete album")}}):a.photos.deleteAlbum(b,0,c)}},"json")},serializeData:function(b,c){if("object"===typeof b&&!a.isArray(b)&&"undefined"===typeof c){var d=[];for(c in b)b.hasOwnProperty(c)&&d.push({name:c,value:b[c]});return d}a.isArray(b)||(b=[b]);for(var d=0,e=b.length,i=b[0];d<e;i=b[++d])"object"!=typeof i&&(i={name:c,value:i}),b[d]=i;return b},saveAccess:function(b){function c(b){for(var d=
[],g=[],k=[],m=0,r=b.length;m<r;++m)d.push({name:"photo_id[]",value:b[m]});a.photos.massPost({photo_id:d,url:"?module=photo&action=manageAccessSave",dataType:"json",data:e,success:function(a,b){if("ok"==a.status){g=g.concat(a.data.denied_photo_id);for(var c=0,d=g.length;c<d;++c)b.push({name:"denied_photo_id[]",value:g[c]});k=a.data.allowed_photo_id;c=0;for(d=k.length;c<d;++c)b.push({name:"allowed_photo_id[]",value:k[c]})}},fullSuccess:function(a){"ok"==a.status&&a.data.alert_msg&&onDeniedExist(a.data.alert_msg);
"function"===typeof i&&i(a,k)}})}var d=b.photo_id||[],e=b.data||[],i=b.fn;onDeniedExist=b.onDeniedExist||function(a){alert(a)};resolution="boolean"===typeof b.resolution?b.resolution:!0;"object"===typeof e&&!a.isArray(e)&&(e=a.photos.serializeData(e));e.push({name:"photos_length",value:d.length});resolution?a.post("?module=photo&action=resolution",a.isArray(d)?d:{photo_id:d},function(a){"ok"==a.status&&c(a.data.photo_id)},"json"):c(a.isArray(d)?d:[d])},addToAlbums:function(b){var c=b.photo_id||[],
d=b.album_id||[],e=void 0==b.copy?1:b.copy,i=b.fn,n=b.onDeniedExist||function(a){alert(a)},c=a.photos.serializeData(c,"photo_id[]"),d=a.photos.serializeData(d,"album_id[]"),b=c.concat(d);b.push({name:"copy",value:+e});a.post("?module=photo&action=addToAlbums",b,function(b){if("ok"==b.status){for(var c=[].concat(b.data.albums||[],b.data.old_albums||[]),d=0,g=c.length;d<g;++d){var e=c[d];a("#album-list li[rel="+e.id+"]").find(".count:first").text(e.count).end().find(".count-new:first").text(0<e.count_new?
"+"+e.count_new:"")}b.data.alert_msg&&n(b.data.alert_msg)}"function"==typeof i&&i(b)},"json")},assignTags:function(b){var c=b.photo_id||[],d=b.tags||[],e=b.delete_tags||[],i=b.fn,n=b.onDeniedExist||function(a){alert(a)},b=[],b=a.isArray(c)?c:b.concat([{name:"photo_id[]",value:c},{name:"one_photo",value:1}]);!a.isArray(d)||!d.length?(b.push({name:"tags",value:d}),e.length&&(b=b.concat(e))):b=b.concat(d);a.post("?module=photo&action=assignTags",b,function(b){if(b.status=="ok"){var c=b.data.cloud,d=
a("#tag-cloud-block");if(a.isArray(c)&&!c.length||!c)d.hide();else{a("#tag-cloud").html(tmpl("template-tag-cloud",{cloud:c}));d.show()}var c=b.data.tags||{},e;for(e in c)if(c.hasOwnProperty(e)){d=c[e];a.photos._updateStreamCache(e,{tags:d})}a("#album-create-dialog").remove();b.data.alert_msg&&n(b.data.alert_msg)}typeof i=="function"&&i(b)},"json")},makeStack:function(b){var c=b.shift();a.post("?module=photo&action=resolution",b,function(d){if("ok"==d.status){for(var d=d.data.photo_id,e=[],i=[],n=
0,l=d.length;n<l;++n)d[n]!=c.value&&e.push({name:"photo_id[]",value:d[n]});a.photos.massPost({photo_id:e,data:{parent_id:c.value,photos_length:b.length},url:"?module=stack&action=make",dataType:"json",success:function(a,b){if("ok"==a.status&&"ok"==a.status){i=i.concat(a.data.denied_photo_ids);for(var c=0,d=i.length;c<d;++c)b.push({name:"denied_photo_id[]",value:i[c]})}},fullSuccess:function(d){if("ok"==d.status){d.data.alert_msg&&alert(d.data.alert_msg);for(var e=0,i=b.length;e<i;++e)a.photos.photo_stream_cache.deleteById(b[e].value);
a.photos.photo_stream_cache.updateById(d.data.parent_id,d.data.photo);a("#photo-list li.selected").trigger("select",!1);a.photos.makeStackAnimation([c].concat(b))}}})}},"json")},makeStackAnimation:function(b,c){var d=b[0].value,e=a('li[data-photo-id="'+d+'"]'),i=e.offset(),n=a(window);(i.top<n.scrollTop()||i.top>n.scrollTop()+n.height())&&a("html, body").animate({scrollTop:i.top},300);for(var n=[],l=1;l<b.length;l++){var q=b[l].value,p=a('li[data-photo-id="'+q+'"]'),t=p.offset(),t=p.clone().css({"z-index":10,
position:"absolute",top:t.top,left:t.left}).insertAfter(p);p.css({opacity:0});n.push(p.hide(300).promise());a.photos.photo_stream_cache.deleteById(q);n.push(t.animate({top:i.top,left:i.left},300).promise().done(function(){a(this).remove()}))}a.when.apply(a,n).done(function(){var b=e.hasClass("last");e.replaceWith(tmpl(a.photos.list_template,{photos:[a.photos.photo_stream_cache.getById(d)],hash:a.photos.hash,last_login_time:a.photos.options.last_login_time,options:{}}));b||a('li[data-photo-id="'+d+
'"]').removeClass("last");a('li[data-photo-id="'+d+'"]').addClass("highlighted");"function"===typeof c&&c()})},makeDeleteAnimation:function(b,c){var d={};a.each(b,function(a,b){d[b]=!0});var e=a("#photo-list").children().filter(function(){return!!d[a(this).data("photo-id")]}).animate({width:0},function(){e.remove();c&&c()})},highlightSidebarItem:function(){var b=a.photos.hash;a("#p-sidebar li.selected").removeClass("selected");var c=a('#p-sidebar li a[href="#'+(b||"/")+'"]');c.length||(c=a('#p-sidebar li a[href^="#'+
(b||"/")+'"]'));c.length&&c.parents("li:first").addClass("selected")},toggleFullScreen:function(){a.storage.get("photos/maximize_photo")?a("#wa-app").addClass("p-full-screen"):a("#wa-app").removeClass("p-full-screen")},hotkey_manager:{set:function(g){"undefined"===typeof g?a(document).bind("keydown",b).bind("keyup",c).bind("keydown",d).bind("keyup",e):"rate"===g&&a(document).bind("keydown",d).bind("keyup",e)},unset:function(){a(document).unbind("keydown",b).unbind("keyup",c).unbind("keyup",d).unbind("keyup",
e)}},getHashByPhotoId:function(b){return a.photos.hash+"/photo/"+b},setLazyLoad:function(){var b=null;a(window).lazyLoad({container:"#photo-list",load:function(){b=b||a("#photo-list li").length;a(window).lazyLoad("sleep");a(".lazyloading-wrapper .lazyloading-progress").show();a(".lazyloading-wrapper .lazyloading-link").hide();a.post("?module=photo&action=loadList",{offset:b,hash:a.photos.hash},function(c){if(c.data.hash==a.photos.hash){var d=a("#photo-list");if(c.data.photos.length){var e=a.photos.photo_stream_cache.length();
a.photos.photo_stream_cache.append(c.data.photos);d.find("li.last").removeClass("last");a.photos.renderPhotoListChunk(d,e,{string:c.data.string},function(){!a.photos.total_count||a.photos.total_count>a.photos.photo_stream_cache.length()?a(window).lazyLoad("wake"):(a(".lazyloading-wrapper .lazyloading-progress").hide(),a(".lazyloading-wrapper .lazyloading-link").hide(),a(window).lazyLoad("stop"))});b+=c.data.photos.length}else a(".lazyloading-wrapper .lazyloading-progress").hide(),a(".lazyloading-wrapper .lazyloading-link").hide(),
a(window).lazyLoad("stop")}},"json")}});a(".lazyloading-wrapper a.lazyloading-link").die("click.lazyloading").live("click.lazyloading",function(){a(window).lazyLoad("force");return!1})},unsetLazyLoad:function(){a(window).lazyLoad&&a(window).lazyLoad("stop");a(".lazyloading-wrapper a.lazyloading-link").die("click.lazyloading")},getAlbum:function(){return this.album=this.album||null},setAlbum:function(a){this.album=a},unsetAlbum:function(){this.album=null},getPhotoId:function(){var a=/photo\/(\d+)[\/]*$/.exec(location.href);
return a?parseInt(a[1]):null},isCurrentPhotoStack:function(){var a=this.getPhotoId();return!a?!1:(a=this.photo_stream_cache.getById(a))&&0<a.stack_count},goToHash:function(b,c){c="undefined"===typeof c?!0:c;b=b.replace(/^\/*/,"").replace(/\/*\s*$/,"");location.hash.replace(/^[^#]*#\/*/,"").replace(/\/*\s*$/,"")==b&&c?(a.photos.ignore_scrolltop=!0,a.photos.dispatch()):location.hash=b?"/"+b+"/":"/"},goToAnchor:function(b){b=a("a[name="+b+"]");b.length&&a(document).scrollTop(b.position().top)},photo_stream_cache:new PhotoStream,
onCreateAlbum:function(b,c){var d=tmpl("template-album-list-item",b),e=a("#album-list"),i;if(c){var n=e.find("li[rel="+c+"]");i=n.find("ul:first");i.length||(n.append('<ul class="menu-v with-icons"></ul>'),i=n.find("ul:first"),n.find(".count:first").after('<i class="icon16 darr overhanging collapse-handler" id="album-'+c+'-handler"></i>'));i.prepend(d)}else i=e.find("ul:first"),i.length||(e.find(".p-empty-album-list").hide(),e.prepend('<ul class="menu-v with-icons"><li class="drag-newposition"></li></ul>').find("ul:first")),
e.find("ul:first").prepend(d);e.find(".new-item").removeClass("new-item").mouseover();b.type||(d=a("#p-upload-step2 select[name=album_id]"),c?(d=d.find("option[value="+c+"]"),e=d.text().replace(/[^-]/g,"")+"-",d.after('<option value="'+b.id+'">'+e+" "+b.name+"</option>")):d.find("optgroup").prepend('<option value="'+b.id+'">'+b.name+"</option>"))},onDeleteAlbum:function(b){var c=a("#album-list"),d=c.find("li[rel="+b+"]"),e=d.find("ul:first"),i=d.parents("ul:first"),n;d.hide();e.length?(d.prev(".drag-newposition:first").remove(),
d.next(".drag-newposition:first").remove(),n=e.children("li"),n.hide().insertAfter(d),e.remove(),d.remove(),n.show()):d.next(".drag-newposition:first").remove().end().remove();i.length&&!i.find("li:not(.drag-newposition)").length&&(d=i.parent("li"),d.length&&d.find("i.collapse-handler").remove(),i.remove());c.find("ul:first").length||c.find(".p-empty-album-list").show();a("#p-upload-step2 select[name=album_id]").find("option[value="+b+"]").remove()},fixRightToolbar:function(){a.photos.fixRightToolbar._handler=
function k(){var b=a("#p-toolbar");b.length&&(b.hasClass("rendered")?b.removeClass("p-fixed"):(k.top||(k.top=b.children(":first").position().top),a(this).scrollTop()>k.top?b.addClass("p-fixed"):b.removeClass("p-fixed")))};a.photos.fixRightToolbar._handler.call(document);a(document).bind("scroll",a.photos.fixRightToolbar._handler)},photo_stack_cache:new PhotoStream,isSelectedAnyPhoto:function(){return!!a("#photo-list li.selected:first").length},getRatingHtml:function(a,b,c){b=b||10;a=Math.round(2*
a)/2;if(!a&&!c)return"";for(var c="",d=1;5>=d;d+=1)c+='<i class="icon'+b+" star",d>a&&(c=0.5==d-a?c+"-half":c+"-empty"),c+='"></i>';return c},uploadDialog:function(){a("#p-uploader").waDialog({onLoad:a.photos.onUploadDialog,onClose:a.photos.dialogClearSteps,onSubmit:function(){a("#p-start-upload-button").click();return!1}})},dialogClearSteps:function(){a("#p-upload-step2").hide();a("#p-upload-step2-buttons").hide();a("#p-upload-step3").hide();a("#p-upload-step3-buttons").hide();a("#p-upload-step1").show();
a("#p-upload-step1-buttons").show()},onUploadDialog:function(){a(this);a(this).find(".files").empty();var b=a.storage.get("photos/hash"),c=a("#p-upload-step2 select[name=album_id]");!b||!~b.indexOf("album")?c.find("option:first").attr("selected",!0):(b=parseInt(b.replace(/\/?album\//,"")),b=c.find("optgroup option[value="+b+"]"),b.length?b.attr("selected",!0):c.find("option:first").attr("selected",!0))},massPost:function(b){function c(k){l?(q?(e=q.splice(0,d),b.data=i.concat(e)):b.data=i,l-=d,l=0<
l?l:0,a.ajax(b)):"function"==typeof b.fullSuccess&&b.fullSuccess(k)}var d=b.chunk_count||25,e,i=[];if(a.isArray(b.data))i=i.concat(b.data);else if("object"==typeof b.data)for(var n in b.data)i.push({name:n,value:b.data[n]});b.type="post";var l=parseInt(b.count)||0,q=b.photo_id;if(b.photo_id){q=b.photo_id;if(a.isArray(q))q=[].concat(q);else{i.push({name:"photo_id",value:q});b.data=i;b.success=b.fullSuccess;a.ajax(b);return}l=q.length}if("function"==typeof b.success){var p=b.success;b.success=function(a){p(a,
i);c(a)}}else b.success=c;c()},confirmDialog:function(b){var c=a("#confirm-dialog");c.length||(c=a('<div id="confirm-dialog"></div>'),a("body").append(c));b.url&&c.load(b.url,function(){var d=a.extend({},b);delete d.url;var e=a(this),i=d.onLoad;d.onLoad=function(){c.find("input[type=submit]").focus();typeof i==="function"&&i()};e.find("div:first").waDialog(d)})},showServerError:function(a){a?(console&&console.log("Server error occurred:\n"+a),alert(a)):console&&console.log("Server error occurred")},
initAlbumThumbsDragAndDrop:function(b,c){b.sortable({handle:"img",distance:5,tolerance:"pointer",stop:function(b,d){a.post("?module=album&action=move",{id:d.item.data("album-id"),before_id:d.item.next().data("album-id")||0,parent_id:c})}})},hooks_manager:{handlers:{},bind:function(a,b,c){if(1==arguments.length&&arguments[0]&&"object"===typeof arguments[0]){var d=arguments[0];for(a in d)d.hasOwnProperty(a)&&this.bind(a,d[a])}else return c=c||(""+Math.random()).slice(2),this.handlers[a]=this.handlers[a]||
{},this.handlers[a][c]=b,b.handler_name=c},unbind:function(a,b){var c=b;"undefined"===typeof b?this.handlers[a]={}:("function"===typeof b&&(c=b.handler_name),"function"===typeof this.handlers[a][c]&&delete this.handlers[a][c])},trigger:function(a){var b=this.handlers[a];if(b&&"object"===typeof b){var c=Array.prototype.slice.call(arguments,1),d;for(d in b)b.hasOwnProperty(d)&&"function"===typeof b[d]&&b[d].apply(null,c)}}}}})(jQuery);
$(function(){$(".p-one-photo .next").live("click",function(){$.photos.shift_next=!0});$(".dialog").die().live("change_loading_status",function(a,b){var b=b||!1,c=$(this).find("input[type=submit]");b?c.attr("disabled",!0).after('<i style="vertical-align: middle" class="icon16 loading"></i>'):c.attr("disabled",!1).next("i").remove()});var a=!1;$(document).on("selectstart","#photo-list",function(){return!a});$(document).keydown(function(b){16==b.keyCode&&(a=!0)}).keyup(function(b){16==b.keyCode&&(a=
!1)});$("#photo-list li").live("select",function(a,b,c){c=void 0!==c?c:!0;(void 0!==b?b:1)?$(this).addClass("selected").find("input:first").attr("checked",!0):(a=$("#selector-menu").find('[data-action="select-photos"]'),a.data("checked")&&a.data("checked",!1).find(".unchecked").show().end().find(".checked").hide(),$(this).removeClass("selected").find("input:first").attr("checked",!1));c&&$("#share-menu-block, #organize-menu-block").trigger("recount")});var b=function(a,b,c){if(a&&b&&a[0]&&b[0]&&!a.is(b[0])){var d=
!1;b.parent().children().each(function(g,k){if(d){if(a.is(k)||b.is(k))return!1;var m=$(k).find(".p-details input:checkbox");m.prop("checked")!=c&&m.prop("checked",c).change()}else if(a.is(k)||b.is(k))d=!0})}},c=null,d=null;$("#content").on("click","#photo-list li .p-details input:checkbox, #photo-list li .p-details label",function(a){var f=$(this).closest("li"),h=f.find(".p-details input:checkbox"),j;h.is(a.target)?j=h.prop("checked"):(j=!h.prop("checked"),h.prop("checked",j).change());j?(a.shiftKey&&
c&&b(c,f,!0),c=f,d=null):(a.shiftKey&&d&&b(d,f,!1),c=null,d=f)});$("#photo-list li input").live("change",function(){this.checked?$(this).closest("li").addClass("selected"):$(this).closest("li").removeClass("selected");$("#share-menu-block, #organize-menu-block").trigger("recount")});$.photos.hooks_manager.bind("afterLoadPhoto",function(){$.photos.photo_stream_cache.getPrev()?$("#p-block .p-one-photo > .p-image-nav.p-rewind").show():$("#p-block .p-one-photo > .p-image-nav.p-rewind").hide();$.photos.photo_stream_cache.getNext()?
$("#p-block .p-one-photo > .p-image-nav.p-ff").show():$("#p-block .p-one-photo > .p-image-nav.p-ff").hide()});$.photos_dragndrop.init()});
function ToolbarMenu(a,b){var c=null;return{init:function(){c=$(a);c.length&&c.activeMenu(b);return this},enable:function(a){a?c.activeMenu("enable",a):(c.parents("div:first").show(),c.activeMenu("fire"));return this},disable:function(a){a?c.activeMenu("disable",a):c.parents("div:first").hide();return this},setAction:function(a,e){b[a]=e;c&&c.activeMenu("setOption",a,e);return this},getAction:function(a){return b[a]},is:function(b){return c?c.is(b):$(a).is(b)}}};(function(a){a.photos.menu.register("list","#organize-menu",{addToAlbumAction:function(){var b=a("#choose-albums");b.length&&b.parent().remove();a("<div></div>").appendTo("body").load("?module=dialog&action=albums",function(){a("#choose-albums").waDialog({onLoad:function(){a(this).find("h1:first span:first").text("("+a("#photo-list li.selected").length+")")},onSubmit:function(b){var d=a("input[name^=photo_id]").serializeArray(),e=a(this).serializeArray();if(!e.length)return alert($_("Please select at least one album")),
!1;if(!d.length)return b.trigger("close"),!1;b.trigger("change_loading_status",!0);a.photos.addToAlbums({photo_id:d,album_id:e,copy:1,fn:function(){a("#photo-list li.selected").trigger("select",!1);b.trigger("change_loading_status",!1).trigger("close")}});return!1}})})},assignTagsAction:function(){var b=$_("add a tag");a("#photo-list-tags-dialog").waDialog({onLoad:function(){var c=a("#photo-list-tags-dialog #photos-list-tags");a("#photo-list-tags-dialog .tagsinput").length||c.tagsInput({autocomplete_url:"?module=tag&action=list",
height:200,width:"100%",defaultText:b});c.importTags("");a("#photo-list-tags-dialog .js-selected-counter").text("("+a("input[name^=photo_id]:checked").length+")");var d=[];a("input[name^=photo_id]:checked").each(function(){d.push(a(this).val())});for(var e={},f=a.photos.photo_stream_cache.getAll(),h=0,j=a.photos.photo_stream_cache.length();h<j;h++){var g=f[h];if(-1!=a.inArray(g.id,d)&&(g=g.tags,!a.isEmptyObject(g)))if(a.isEmptyObject(e))e=g;else for(var k in g)g.hasOwnProperty(k)&&(e[k]=g[k])}a("#photos-tags-remove-list").empty();
if(jQuery.isEmptyObject(e))a("#photo-tags-remove").hide();else for(k in a("#photo-tags-remove").show(),e)a("#photos-tags-remove-list").append(a("<label></label>").text(e[k]).prepend('<input name="delete_tags[]" value="'+k+'" type="checkbox"> ')).append("<br>");a("#photo-list-tags-dialog .dialog-window").height(a("#photo-list-tags-dialog .dialog-content-indent").outerHeight());a("#photos-popular-tags").off("click.photos","a").on("click.photos","a",function(){var b=a(this).text();c.removeTag(b);c.addTag(b)})},
onSubmit:function(c){var d=a("#photos-list-tags_tag");if(d.length&&d.val()!=b){var e=jQuery.Event("keypress",{which:13});d.trigger(e)}var d=a("input[name^=photo_id]:checked").serializeArray(),e=a("#photo-list-tags-dialog #photos-list-tags").val(),f=a("#photos-tags-remove-list input[name^=delete_tags]:checked").serializeArray();if(!e.length&&!f.length)return alert($_("Please select at least one tag")),!1;if(!d.length)return c.trigger("close"),!1;c.trigger("change_loading_status",!0);a.photos.assignTags({photo_id:d,
tags:e,delete_tags:f,fn:function(b){if("ok"==b.status){var b=b.data.tags,d=a("#photo-list li.selected"),e,f;for(f in b)b.hasOwnProperty(f)&&(e=tmpl("template-photo-list-photo-tags",{tags:b[f]}),d.filter("[data-photo-id="+f+"]:first").find(".tags>span").html(e));d.trigger("select",!1);c.trigger("change_loading_status",!1).trigger("close")}}});return!1}})},deleteFromAlbumAction:function(){var b=a("input[name^=photo_id]").serializeArray();if(b.length){var c=a.photos.getAlbum().id;a.post("?module=photo&action=deleteFromAlbum&id="+
c,b,function(){a.photos.dispatch()},"json")}},deletePhotosAction:function(){var b=a("input[name^=photo_id]").serializeArray();b.length&&a.photos.confirmDialog({url:"?module=dialog&action=confirmDeletePhotos&cnt="+b.length,onSubmit:function(c){c.trigger("change_loading_status",!0);a.photos.deletePhotos(b,function(){a.photos.unsetCover();c.trigger("change_loading_status",!1).trigger("close");a("#photo-list li.selected").trigger("select",!1)});return!1}})},setRateAction:function(){var b=a('<div id="set-rate"></div>').waDialog({url:"?module=dialog&action=rates",
className:"width300px height200px",onLoad:function(c){b.find(".p-rate-photo-counter").text("("+a("input[name^=photo_id]:checked").length+")");a("#photos-rate",c).rateWidget({withClearAction:!1,onUpdate:function(c){var e=b,c=a("#photos-rate",e).rateWidget("getOption","rate"),f=a("input[name^=photo_id]").map(function(){return this.checked?{name:"id[]",value:this.value}:null}).toArray();if(!f.length)return e.trigger("close"),!1;a.photos.saveField({id:f,name:"rate",value:c,fn:function(b){if("ok"==b.status){var f=
b.data.allowed_photo_id&&!a.isArray(b.data.allowed_photo_id)?b.data.allowed_photo_id:{};a("#photo-list li.selected").each(function(){var b=a(this);f[b.attr("data-photo-id")]&&a.photos.updateThumbRate(b,c)}).find("input:first").trigger("select",!1);b.data.count&&a("#rated-count").text(0<b.data.count?b.data.count:"");b.data.alert_msg&&alert(b.data.alert_msg);e.trigger("close")}}});return!1}})}})},makeStackAction:function(){var b=a("input[name^=photo_id]").serializeArray();if(2>b.length)return alert($_("Please select at least two photos")),
!1;a.photos.makeStack(b);return!1},manageAccessAction:function(){var b=a("input[name^=photo_id]").serializeArray();a.photos.showManageAccessDialog(b,function(c){var d=a(this),e=d.serializeArray(),f=d.find("input[name=status]:checked").val();if(!b.length)return c.trigger("close"),!1;c.trigger("change_loading_status",!0);a.photos.saveAccess({photo_id:b,data:e,fn:function(b,d){for(var e=a("#photo-list li.selected"),k=0,m=d.length;k<m;++k){var o=e.filter("[data-photo-id="+d[k]+"]:first").find(".p-image-corner.top.left");
o.find(".lock-bw").remove();0>=f&&o.append('<i class="icon16 lock-bw p-private-photo" title="'+$_("Private photo")+'"></i>')}a.photos._updateStreamCache(d,{status:f});a("#photo-list li.selected").trigger("select",!1);c.trigger("change_loading_status",!1).trigger("close")}});return!1});return!1},beforeAnyAction:function(b){if("make-stack"!=b&&!a.photos.isSelectedAnyPhoto())return alert($_("Please select at least one photo")),!1},onFire:function(){a("#organize-menu").trigger("recount")}});a.photos.menu.register("list",
"#selector-menu",{selectPhotosAction:function(b){var c=a("#share-menu-block, #organize-menu-block").find(".count");b.data("checked")?(b.data("checked",!1),b.find(".unchecked").show().end().find(".checked").hide(),c.text("").hide()):(b.data("checked",!0),b.find(".checked").show().end().find(".unchecked").hide(),c.text(a.photos.total_count).show());a("#photo-list li").trigger("select",[!!b.data("checked"),!1])}});a.photos.menu.register("list","#share-menu",{embedAction:function(){var b=a("#embed-photo-list-dialog"),
c=a.storage.get("photos/embed_size"),d=a("#photo-list li.selected").map(function(){var b=a(this).attr("data-photo-id"),c=a.photos.photo_stream_cache.getById(b);0>=c.status&&(b+=":"+c.hash);return b}).toArray().join(","),e=a.photos.getAlbum(),f=a.photos.hash,h={photo_ids:d,hash:f,size:c};e&&0>=e.status&&(f=f.replace(/\/*$/,"")+":"+e.hash+"/",h.hash=f);e="?module=dialog&action=embedPhotoList&photo_ids="+d+"&hash="+f;c&&(e+="&size="+c);b.length||(b=a('<div id="embed-photo-list-dialog"></div>'),a("body").append(b));
b.load(e,function(){b.find("div:first").waDialog({onLoad:function(){function e(c){var d=e.data,h=false,m;for(m in d)if(d.hasOwnProperty(m)&&d[m]!==c[m]){h=true;break}e.data=a.extend({},c);if(h){b.find("h1").find(".loading").parent().show();a.post("?module=photo&action=embedList",c,function(c){if(c.status=="ok"){var d=c.data.context;b.find("input[name=link]").val(d.link);b.find("a.link").attr("href",d.link);b.find("textarea[name=urls]").val(d.urls);b.find("#embed-photo-list-html").val(d.html);b.find("#embed-photo-list-html-with-descriptions").val(d.html_with_descriptions);
b.find("textarea[name=smarty_code]").val(d.smarty_code);b.find("h1 span:first").text("("+d.count+")");d.all_public?b.find(".exclamation-message").hide():b.find(".exclamation-message").show();d.domains=d.domains||{};o.children().each(function(){var b=a(this),c=b.attr("value");b.data("frontend-url",(d.domains[c]||{}).frontend_url||"")});f();k()}b.find("h1").find(".loading").parent().hide()},"json")}}function f(){a.each(["textarea[name=urls]","#embed-photo-list-html","#embed-photo-list-html-with-descriptions"],
function(b,c){var d=a(c);d.data("context_data",d.val())})}function k(){if(!o.length)return false;a.each(["textarea[name=urls]","#embed-photo-list-html","#embed-photo-list-html-with-descriptions"],function(b,c){var d=a(c);d.val(d.data("context_data").split(o.data("original-domain")).join(o.val()))});var c=o.children(":selected");if(c.data("frontend-url")){b.find("input[name=link]").val(c.data("frontend-url")).closest(".field").slideDown();b.find("a.link").attr("href",c.data("frontend-url"))}else b.find("input[name=link]").closest(".field").slideUp()}
var m=b.find("select[name=size]");m.val(c);m.change(function(){var b=a(this).val();h.size=b;e(h);a.storage.set("photos/embed_size",b)});b.find("input[name=description]").click(function(){if(this.checked){a("#embed-photo-list-html-with-descriptions").show().attr("disabled",false);a("#embed-photo-list-html").hide().attr("disabled",true)}else{a("#embed-photo-list-html").show().attr("disabled",false);a("#embed-photo-list-html-with-descriptions").hide().attr("disabled",true)}});b.find("input[name=link], textarea[name=urls], textarea[name=html], textarea[name=smarty_code]").click(function(){a(this).getSelection().length||
a(this).select()});b.find("input[name=link]").focus().select();b.find(".switcher").activeMenu({selectedPhotosAction:function(){h.size=b.find("select[name=size]").val();h.photo_ids=d;e(h)},allListPhotosAction:function(){h.size=b.find("select[name=size]").val();h.photo_ids="";e(h)}}).find("li").click(function(){a(this).parent().find(".selected").removeClass("selected").end().end().addClass("selected")});e.data=e.data||a.extend({},h);var o=b.find("select[name=domain]");if(o.length){f();k();o.change(k)}},
onSubmit:function(){return false}})});return!1},beforeAnyAction:function(b){if(!a.photos.isSelectedAnyPhoto()&&"blog-post"!=b&&"embed"!=b)return alert($_("Please select at least one photo")),!1},blogPostAction:function(){for(var b=a("#blog-post-form"),c=a("#photo-list li.selected").map(function(){return a(this).attr("data-photo-id")}).toArray(),d=[0,0],e=0;e<c.length;e++){var f=a.photos.photo_stream_cache.getById(c[e]);f||(f=a.photos.photo_stack_cache.getById(c[e]));f&&(f.hash&&(c[e]+=":"+f.hash),
++d[f.status])}var e=a.photos.getAlbum(),f=a.photos.hash,h={photo_ids:c.join(","),hash:f,size:obligatory_size};e&&0>=e.status&&(f=f.replace(/\/*$/,"")+":"+e.hash+"/",h.hash=f);h.hash=null;a("#photo-blog-dialog :submit").attr("disabled",!0);a.post("?module=photo&action=embedList",h,function(c){if(c.status=="ok"){c=c.data.context;b.find('[name="title"]:input').val(a("#photo-list-name").text());b.find('[name="text"]:input').val(blog_smarty_enabled?c.smarty_code:c.html_with_descriptions);d[0]?a("#photo-blog-dialog :submit").attr("disabled",
false):b.submit()}},"json");d[0]&&a("#photo-blog-dialog").waDialog({onLoad:function(){a("#photo-blog-dialog :submit").attr("disabled",true);var b=a("#photo-blog-dialog p"),e=[d[0],c.length];b.html(b.html().replace(/(%d)/g,function(){return e.shift()}))},onSubmit:function(){b.submit();return false}});return!1},onFire:function(){a("#share-menu").trigger("recount")}});a("#p-sidebar a, #wa-header a, a.album-view, #photo-list div.p-image a").live("click",function(b){if(a("#save-menu-block").is(":visible")&&
a("#save-menu-block input.button").hasClass("yellow")&&!confirm($_("Unsaved changes will be lost if you leave this page now. Are you sure?")))return b.preventDefault(),!1});a.photos.menu.register("list","#save-menu",{saveDescriptionAction:function(){var b={},c,d,e;a("#photo-list.p-descriptions :text,#photo-list.p-descriptions textarea").each(function(){if(this.defaultValue!=this.value&&(c=a(this).attr("name").match(/^photo\[(\d+)\]\[(\w+)\]$/))){d=c[1];e=c[2];var f=a.photos.photo_stream_cache.getById(d);
if(!f||this.value!=f[e])b[d]||(b[d]={id:d}),b[d][e]=this.value}});a.photos.saveFields(b);a("#photo-list.p-descriptions :text.highlighted,#photo-list.p-descriptions textarea.highlighted").each(function(){a(this).removeClass("highlighted")});var f=a("#save-menu-block .count.indicator");f.length&&(f.text(0),a("#save-menu-block input.button").removeClass("yellow").addClass("green"),f.hide());return!1},hideNameAction:function(b,c){var d=b.find(":checkbox"),e=d.prop("checked");"INPUT"!=c.target.tagName&&
(e=!e);e?(a('#photo-list li :text[name$="[name]"]').hide(),a('#photo-list li textarea[name$="[description]"].js-small').css("height","+=27").removeClass("js-small").addClass("js-big")):(a('#photo-list li :text[name$="[name]"]').show(),a('#photo-list li textarea[name$="[description]"].js-big').css("height","-=27").removeClass("js-big").addClass("js-small"));setTimeout(function(){d.attr("checked",e)},50);a.storage.set("photos/list/hide_name",e)},onFire:function(){var b=a("#save-menu-block .count.indicator");
b.length&&(b.text("0"),a("#save-menu-block input.button").removeClass("yellow").addClass("green"),b.hide())},onInit:function(b){b.find('[data-action="hide-name"] :checkbox').prop("checked",a.storage.get("photos/list/hide_name",!1));a("#photo-list.p-descriptions :text,#photo-list.p-descriptions textarea").live("change, keyup",function(){var b=[],d;a("#photo-list.p-descriptions :text,#photo-list.p-descriptions textarea").each(function(){if(this.defaultValue!=this.value&&(d=a(this).attr("name").match(/^photo\[(\d+)\]\[(\w+)\]$/))){var e=
d[1];if(0>b.indexOf(e)){var f=a.photos.photo_stream_cache.getById(e);!f||this.value!=f[d[2]]?(a(this).addClass("highlighted"),b.push(e)):a(this).hasClass("highlighted")&&a(this).removeClass("highlighted")}}else a(this).hasClass("highlighted")&&a(this).removeClass("highlighted")});var e=a("#save-menu-block .count.indicator"),f=b.length;e.length&&e.text(f);f?(a("#save-menu-block input.button").removeClass("green").addClass("yellow"),e.show()):(a("#save-menu-block input.button").removeClass("yellow").addClass("green"),
e.hide())})}})})(jQuery);(function(a){a.photos.menu.register("photo","#photo-organize-menu",{addToAlbumAction:function(){a('<div id="choose-albums-photo"></div>').waDialog({url:"?module=dialog&action=albums&id="+a.photos.getPhotoId(),className:"width600px height400px",onSubmit:function(b){var c=a.photos.photo_stream_cache.getCurrent().id;a.photos.addToAlbums({photo_id:c,album_id:a(this).serializeArray(),copy:0,fn:function(d){if("ok"==d.status){var e=d.data.old_albums||[],f=a.photos.getAlbum(),d=d.data.albums;if(f)for(var h=
0,j=e.length;h<j;++h)if(f.id==e[h].id){d.length?a.photos.goToHash("/album/"+d[0].id+"/photo/"+c):a.photos.goToHash("/photo/"+c);b.trigger("close");return}a("#photo-albums").html(tmpl("template-photo-albums",{albums:d}));b.trigger("close")}}});return!1}})},deletePhotoAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=confirmDeletePhoto&id="+a.photos.getPhotoId(),onSubmit:function(b){b.trigger("close");a.photos.setCover();a.photos.deletePhotos(a.photos.getPhotoId(),function(){a.photos.unsetCover()});
return!1}})},unstackAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=confirmUnstack&cnt="+a.photos.photo_stack_cache.length(),onSubmit:function(b){b.trigger("close");b=a.photos.photo_stream_cache.getCurrent().id;a.post("?module=stack&action=unmake&id="+b,{},function(){a.photos.goToHash(a.photos.hash)},"json");return!1}})},manageAccessAction:function(){var b=a.photos.photo_stream_cache.getCurrent().id;a.photos.showManageAccessDialog("photo_id="+b,function(b){var d=a(this).serializeArray();
d.push({name:"one_photo",value:1});a.photos.saveAccess({photo_id:a.photos.photo_stream_cache.getCurrent().id,data:d,fn:function(d){var f=d.data.photo,h=d.data.stack;if(f)f=a.photos.photo_stream_cache.updateById(f.id,f),a.photos.initPhotoContentControlWidget({frontend_link_template:d.data.frontend_link_template,photo:f}),a.photos.updatePhotoImgs(f);else if(h&&a.isArray(h)&&h.length){for(var f=a.photos.photo_stack_cache,j=f.getCurrent(),g=0,k=h.length;g<k;++g)f.updateById(h[g].id,h[g]);a.photos.initPhotoContentControlWidget({frontend_link_template:d.data.frontend_link_template,
photo:j});a.photos.updatePhotoImgs(j)}b.trigger("close")},onDeniedExist:function(){alert($_("You don't have sufficient access rights"))}});return!1});return!1}});a.photos.menu.register("photo","#edit-menu",{beforeAnyAction:function(){a.photos.setCover()},rotateLeftAction:function(){a.photos.rotate(a.photos.getPhotoId(),"left",function(){a.photos.unsetCover()})},rotateRightAction:function(){a.photos.rotate(a.photos.getPhotoId(),"right",function(){a.photos.unsetCover()})},onInit:function(){a(window).resize(a.photos.centralizeLoadingIcon)}});
a.photos.menu.register("photo","#share-menu",{embedAction:function(){var b=a("#embed-photo-dialog"),c=a.photos.getPhotoId(),d=a.photos.hash,e=a.storage.get("photos/embed_size"),c="?module=dialog&action=embedPhoto&photo_id="+c+"&hash="+d;e&&(c+="&size="+e);b.length||(b=a('<div id="embed-photo-dialog"></div>'),a("body").append(b));b.load(c,function(){b.find("div:first").waDialog({onLoad:function(){function c(){g.length&&a.each(["textarea[name=html]","input[name=url]"],function(b,c){var d=a(c);d.data("context_data",
d.val())})}function d(){if(!g.length)return false;a.each(["textarea[name=html]","input[name=url]"],function(b,c){var d=a(c);d.val(d.data("context_data").split(g.data("original-domain")).join(g.val()))});var c=g.children(":selected");if(c.data("frontend-url")){b.find("input[name=link]").val(c.data("frontend-url")).closest(".field").slideDown();b.find("a.link").attr("href",c.data("frontend-url"))}else b.find("input[name=link]").closest(".field").slideUp()}var j=b.find("select[name=size]");j.val(e);
j.change(function(){var e=a(this).val(),g=b.data("contexts")[e];b.find("textarea[name=html]").val(g.html);b.find("input[name=url]").val(g.url);a.storage.set("photos/embed_size",e);c();d()});var g=b.find("select[name=domain]");if(g.length){c();d();g.change(d)}b.find("input[name=url], textarea[name=html], input[name=link]").click(function(){a(this).getSelection().length||a(this).select()});b.find("input[name=link]").focus().select()},onSubmit:function(){return false}})});return!1},blogPostAction:function(){var b=
a("#blog-post-form"),c=a.photos.getPhotoId(),d=a.photos.photo_stream_cache.getById(c);d||(d=a.photos.photo_stack_cache.getById(c));d&&(c=d.id,d.hash&&(c+=":"+d.hash),c={photo_ids:c,hash:null,size:obligatory_size},a("#photo-blog-dialog :submit").attr("disabled",!0),a.post("?module=photo&action=embedList",c,function(c){"ok"==c.status&&(c=c.data.context,b.find('[name="title"]:input').val(d.name),c=c.html_with_descriptions,b.find('[name="text"]:input').val(c.replace(/^<p>(.*)<\/p>$/mi,"$1")),parseInt(d.status)?
b.submit():a("#photo-blog-dialog :submit").attr("disabled",!1))},"json"),parseInt(d.status)||a("#photo-blog-dialog").waDialog({onLoad:function(){a("#photo-blog-dialog :submit").attr("disabled",!0);var b=a("#photo-blog-dialog p"),c=[1,1];b.html(b.html().replace(/(%d)/g,function(){return c.shift()}))},onSubmit:function(){b.submit();return!1}}));return!1}});a("#restore-original").live("click",function(){confirm($_("This will reset all changes you applied to the image after upload, and will restore the image to its original. Are you sure?"))&&
(a.photos.setCover(),a.photos.restoreOriginal(a.photos.getPhotoId(),function(){a.photos.unsetCover()}))})})(jQuery);$.photos=$.photos||{};$.photos.widget=$.photos.widget||{};
$.photos.widget.loupe={options:{animate:!0,debug:!1},css:{init:{width:null,"max-width":null,"margin-left":0,"margin-top":0,height:null}},drag:!1,loaded:!1,photo_data:null,thumb_data:null,container:null,helper:null,link:null,offset:{},status:"thumb",init:function(a){this.options=$.extend(this.options,a||{});var b=this;b.trace("init");$.photos.hooks_manager.bind("afterRenderImg",function(a,d,e){b.trace("afterRenderImg");b.prepare(a,d,e)});$.photos.hooks_manager.bind("beforeLoadPhoto",function(){b.trace("beforeLoadPhoto");
b.stop()});$.photos.hooks_manager.bind("onAbortPrevLoading",function(){b.trace("onAbortPrevLoading");b.stop()})},trace:function(a){console&&this.options.debug&&console.log(a)},prepare:function(a,b,c){var d=this;$(".p-one-photo a.next").die("click.loupe").live("click.loupe",function(a){return d.clickNextHandler.apply(d,[this,a])});this.trace("prepare, status="+this.status);this.photo_data=b;this.container=a;this.thumb_data={height:c.size.height,width:c.size.width,src:c.url};"thumb"!=this.status&&this.stop();
this.loaded=!1;this.reset()},reset:function(){this.trace("reset, status="+this.status);this.link=$("#photo-loupe-link");$("div.photo-loupe-wrapper").length&&(this.container.css({width:this.thumb_data.width+"px","max-width":"",height:this.thumb_data.height+"px","margin-left":"","margin-top":""}),this.container.unwrap());this.status="thumb";this.link.find(".minimize").hide();this.thumb_data.width&&this.thumb_data.width<this.photo_data.width||this.thumb_data.height&&this.thumb_data.height<this.photo_data.height?
(this.link.find(".maximize").show(),this.options.animate=this.thumb_data.height&&this.thumb_data.width?!0:!1):this.link.find(".maximize").hide();var a=this;this.link.unbind(".loupe").bind("click.loupe",function(b){return a.clickHandler.apply(a,[this,b])}).show()},clickHandler:function(){this.trace("clickHandler, status="+this.status);switch(this.status){case "loading":this.container.stop();case "maximized":this.status="unloading";this.link.find(".minimize").hide();this.link.find(".maximize").show();
this.decrease();break;case "thumb":this.status="loading",this.link.find(".minimize").hide(),this.link.find(".maximize").hide(),this.enlarge()}return!1},clickNextHandler:function(a,b){var c="thumb"==this.status?!0:!1;c||b.preventDefault();this.trace("clickNextHandler "+c);return c},interaction:function(a,b,c){c=c.parents("body");switch(b.type){case "mouseup":this.drag&&(b.preventDefault(),this.drag=!1,$("div.photo-loupe-wrapper").css("cursor","auto"),$("body").css("cursor",""),c.unbind(".loupe-move"));
break;case "mousedown":case "click":this.clickNextHandler(a,b);if(!this.drag){$("div.photo-loupe-wrapper").css("cursor","move");this.drag=!0;this.offset.mouseX=b.pageX;this.offset.mouseY=b.pageY;var d=this;c.bind("mouseover.loupe-move mousemove.loupe-move",function(a){return d.watch.apply(d,[this,a])})}break;case "mouseleave":this.drag&&(b.preventDefault(),$("div.photo-loupe-wrapper").css("cursor","auto"),this.drag=!1,c.unbind(".loupe-move"))}},enlarge:function(){this.drag=!1;var a=this;this.trace("enlarge, status="+
this.status);$("#photo").removeClass("ui-draggable").closest(".p-image").addClass("p-image-maximized");this.offset=this.container.offset();this.offset.x=Math.round((this.thumb_data.width-this.photo_data.width)/2);this.offset.y=Math.round((this.thumb_data.height-this.photo_data.height)/2);this.container.wrap('<div class="photo-loupe-wrapper" style="height:'+this.thumb_data.height+"px;width:"+this.thumb_data.width+'px;position: relative;"/>');this.container.removeAttr("width").removeAttr("height").css({width:this.thumb_data.width+
"px",height:this.thumb_data.height+"px","margin-left":0,"margin-top":0,"max-width":this.photo_data.width+"px",display:"inline-block"});this.options.animate?this.container.animate({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"},function(){return a.enlargeComplete.apply(a,[this])}):(this.container.css({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+
"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"}),this.enlargeComplete());this.link.find(".minimize").show();this.bind(this.container);if(!this.helper){var b=$("#photo-loupe");this.helper=b.length?b.first():$('<img id="photo-loupe"/>');this.helper.load(function(){a.loaded=true})}this.helper.attr("src","?module=photo&action=download&photo_id="+this.photo_data.id+"&attach="+(this.photo_data.edit_datetime||this.photo_data.upload_datetime))},enlargeComplete:function(){if(this.loaded)this.trace("enlargeComplete, status="+
this.status),this.helper.css({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"}).show(),this.container.before(this.helper).hide(),this.container.unbind(".loupe .loupe-move"),this.bind(this.helper),this.container.css({width:this.thumb_data.width+"px","max-width":"",height:this.thumb_data.height+"px","margin-left":"","margin-top":""}),this.link.find(".minimize").show(),this.status=
"maximized";else{var a=this;setTimeout(function(){return a.enlargeComplete.apply(a,[this])},50)}},bind:function(a){this.trace("bind, status="+this.status);var b=this;a.bind("mousedown.loupe",function(c){return b.interaction.apply(b,[this,c,a])});$(document).bind("mouseup.loupe",function(c){return b.interaction.apply(b,[this,c,a])})},stop:function(){this.trace("stop at status="+this.status);var a=this.status;this.status="stop";switch(a){case "loading":this.container.stop();this.decrease(!0);break;
case "maximized":this.decrease(!0);break;case "unloading":this.helper&&this.helper.stop(),this.decreaseComplete(!0)}this.container&&this.container.find("*").unbind(".loupe .loupe-move");$(document).unbind(".loupe .loupe-move");a=$("div.photo-loupe-wrapper");$("#photo-loupe-link img:visible").hide();$("body").css("cursor","");a.length&&this.container.unwrap();this.helper&&(this.helper.remove(),this.helper=null);this.status="thumb"},decrease:function(a){this.trace("decrease, status="+this.status);this.loaded=
!1;var b=this,c={width:this.thumb_data.width+"px",height:this.thumb_data.height+"px","margin-left":0,"margin-top":0};a||!this.options.animate?(this.helper.css(c),b.decreaseComplete()):this.helper.animate(c,function(){b.decreaseComplete()});return!1},decreaseComplete:function(a){this.trace("decreaseComplete, status="+this.status);$("#photo").addClass("ui-draggable").closest(".p-image").removeClass("p-image-maximized");this.container.css(this.css.init).show();this.helper.hide();a||this.reset()},watch:function(a,
b){this.drag&&(b.preventDefault(),this.offset.x=Math.min(0,Math.max(this.thumb_data.width-this.photo_data.width,Math.round(this.offset.x-this.offset.mouseX+b.pageX))),this.offset.y=Math.min(0,Math.max(this.thumb_data.height-this.photo_data.height,Math.round(this.offset.y-this.offset.mouseY+b.pageY))),this.offset.mouseX=b.pageX,this.offset.mouseY=b.pageY,("loading"==this.status?this.container:this.helper).css({"margin-left":this.offset.x+"px","margin-top":this.offset.y+"px"}))}};(function(){jQuery.each({getSelection:function(){var a=this.jquery?this[0]:this;return("selectionStart"in a&&function(){var b=a.selectionEnd-a.selectionStart;return{start:a.selectionStart,end:a.selectionEnd,length:b,text:a.value.substr(a.selectionStart,b)}}||document.selection&&function(){a.focus();var b=document.selection.createRange();if(null===b)return{start:0,end:a.value.length,length:0};var c=a.createTextRange(),d=c.duplicate();c.moveToBookmark(b.getBookmark());d.setEndPoint("EndToStart",c);
return{start:d.text.length,end:d.text.length+b.text.length,length:b.text.length,text:b.text}}||function(){return null})()},replaceSelection:function(a){var b="function"==typeof this.id?this.get(0):this,c=a||"";return("selectionStart"in b&&function(){b.value=b.value.substr(0,b.selectionStart)+c+b.value.substr(b.selectionEnd,b.value.length);return this}||document.selection&&function(){b.focus();document.selection.createRange().text=c;return this}||function(){b.value+=c;return jQuery(b)})()}},function(a){jQuery.fn[a]=
this})})();
