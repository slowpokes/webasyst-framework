var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,b,d){a instanceof String&&(a=String(a));for(var f=a.length,g=0;g<f;g++){var c=a[g];if(b.call(d,c,g,a))return{i:g,v:c}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.SIMPLE_FROUND_POLYFILL=!1;
$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,d){a!=Array.prototype&&a!=Object.prototype&&(a[b]=d.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.polyfill=function(a,b,d,f){if(b){d=$jscomp.global;a=a.split(".");for(f=0;f<a.length-1;f++){var g=a[f];g in d||(d[g]={});d=d[g]}a=a[a.length-1];f=d[a];b=b(f);b!=f&&null!=b&&$jscomp.defineProperty(d,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,d){return $jscomp.findInternal(this,a,d).v}},"es6","es3");$.wa=$.ui?$.extend(!0,$.wa,$.ui):{};
$.wa=$.extend(!0,$.wa,{data:{},content:!1,get:function(a,b){return void 0==a?this.data:this.data[name]||b||null},set:function(a,b){if(void 0==a)return this.data;"object"==typeof a?$.extend(this.data,a):this.data[a]=value;return this.data},encodeHTML:function(a){return a&&(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},decodeHTML:function(a){return a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">")},setHash:function(a){a instanceof String||!a.toString||(a=a.toString());
a=a.replace(/\/\//g,"/");a=a.replace(/^.*#/,"");$.browser&&$.browser.safari?parent?parent.window.location=parent.window.location.href.replace(/#.*/,"")+"#"+a:window.location=location.href.replace(/#.*/,"")+"#"+a:!parent||$.browser&&$.browser.msie?location.hash=a:parent.window.location.hash=a;return!0},back:function(a){2<history.length?"number"==typeof a&&parseInt(a)==a?history.go(-a):history.go(-1):$.browser.msie&&0<history.length?history.back():a&&this.setHash(a);return!1},toggleHashParam:function(a){-1==
location.hash.search(a)?this.addToHash(a):this.removeFromHash(a)},addToHash:function(a){var b=location.hash;-1==b.search(a)&&(b+="/"+a+"/");this.setHash(b)},removeFromHash:function(a){var b=location.hash;-1<b.search(a)&&(b=b.replace(a,""));this.setHash(b)},setTitle:function(a){document.title=a},array_search:function(a,b,d){d=!!d;for(var f in b)if(d&&b[f]===a||!d&&b[f]==a)return f;return!1},dialogCreate:function(a,b){b=$.extend({content:'<h1>Loading... <i class="icon16 loading"></i></h1>',buttons:null,
url:null,post:null,small:!1,onload:null,oncancel:null},b);b.content=$(b.content);b.buttons=b.buttons?$(b.buttons):$('<input type="submit" class="button gray" value="'+$_("Cancel")+'">').click(function(){b.oncancel&&b.oncancel.call(d[0]);$.wa.dialogHide()});var d=$("#"+a);0>=d.size()&&(d=$('<div class="dialog" id="'+a+'" style="display: none"><div class="dialog-background"></div><div class="dialog-window"><div class="dialog-content"><div class="dialog-content-indent"></div></div><div class="dialog-buttons"><div class="dialog-buttons-gradient"></div></div></div></div>').appendTo("body"));
d.find(".dialog-buttons-gradient").empty().append(b.buttons);d.find(".dialog-content-indent").empty().append(b.content);d.show();b.small?d.addClass("small"):d.removeClass("small");b.url&&(a=function(a){d.find(".dialog-content-indent").html(a);$.wa.waCenterDialog(d);b.onload&&b.onload.call(d[0])},b.post?$.post(b.url,b.post,a):$.get(b.url,a));this.waCenterDialog(d);var f=function(a){if(d.is(":visible"))if(a&&27==a.keyCode)b.oncancel&&"function"==typeof b.oncancel&&b.oncancel.call(d[0]),$.wa.dialogHide();
else $(document).one("keyup",f)};f();$(document).one("hashchange",$.wa.dialogHide);return d},waCenterDialog:function(a){a=$(a);a=a.find(".dialog-window");var b=a.outerWidth(!0),d=a.outerHeight(!0),f=$(window).width(),g=$(window).height();a.css({left:Math.round((f-b)/2/f*100)+"%",top:Math.round((g-d)/2/g*100)+"%"})},dialogHide:function(){$(".dialog").hide();return!1},dropdownsClose:function(){var a=$(".dropdown:not(.disabled)");a.addClass("disabled");setTimeout(function(){a.removeClass("disabled")},
600)},dropdownsCloseEnable:function(){$(document).on("click",".dropdown:not(.disabled)",this.dropdownsClickHandler)},dropdownsCloseDisable:function(){$(document).off("click",".dropdown:not(.disabled)",this.dropdownsClickHandler)},dropdownsClickHandler:function(a){var b=$(this);b.hasClass("no-click-close")||(b.addClass("disabled"),setTimeout(function(){b.removeClass("disabled")},600))},defaultInputValue:function(a,b,d){a instanceof jQuery||(a=$(a));var f=function(){var f=a.val();f&&f!=b||(a.val(b),
a.addClass(d))};f();a.blur(f);a.focus(function(){a.hasClass(d)&&(a.removeClass(d),a.val(""))})},loadFiles:function(a){$.isArray(a)||(a="object"!==typeof a||$.isArray(a)?[].slice.apply(arguments):$.map(a,function(a,b){return a?b:null}));var b=a.map(function(a){return a?"string"!=typeof a?"object"===typeof a&&"function"===typeof a.then?a:null:a.match(/\.css(\?.*)?$/)?($("<link>").appendTo("head").attr({type:"text/css",rel:"stylesheet",href:a}),null):$.ajax({cache:!0,dataType:"script",url:a}):null}).filter(function(a){return!!a});
return $.when.apply($,b)},determineTimezone:function(a,b){var d=!1;$.each(document.cookie.split(/;\s*/g),function(a,c){c=c.split("=",2);if("tz"==c[0])return d=!0,b&&b(c[1]),!1});if(!d){var f={};f[a+"wa-content/js/jstz/jstz.min.js"]=!window.jstz;$.wa.loadFiles(f).then(function(){var a=window.jstz.determine().name();document.cookie="tz="+jstz.determine().name();var c=new Date;c.setTime(c.getTime()+12096E5);document.cookie="oldtz="+a+"; expires="+c.toUTCString();b&&b(a)})}},util:{formatFileSize:function(a){var b=
-1;do a/=1024,b++;while(99<a);return Math.max(a,.01).toFixed(2)+(0<=b?" "+$_("kB MB GB TB PB EB".split(" ")[b]):"")}}});
window.wa_skip_ajax_setup||($.ajaxSetup({cache:!1}),$(document).ajaxError(function(a,b,d,f){if(502===b.status&&"abort"==f||d.url&&0<=d.url.indexOf("background_process")||d.data&&0<=d.data.indexOf("background_process"))console&&console.log&&console.log("Notice: XHR failed on load: "+d.url);else if(200!==b.status&&b.responseText){if(!$.wa.errorHandler||$.wa.errorHandler(b))-1!=b.responseText.indexOf("Exception")?$.wa.dialogCreate("ajax-error",{content:"<div>"+b.responseText+"</div>"}):(document.open("text/html"),
document.write(b.responseText),document.close(),$(window).one("hashchange",function(){window.location.reload()}))}else b.getResponseHeader("wa-session-expired")?window.location.reload():"undefined"!==typeof b.responseText&&-1!=b.responseText.indexOf("Exception")&&$.wa.dialogCreate("ajax-error",{content:"<div>"+b.responseText+"</div>"})}));
window.wa_skip_csrf_prefilter||$.ajaxPrefilter(function(a,b,d){a.crossDomain||"POST"!==(a.type||"").toUpperCase()||(b=document.cookie.match(/(?:^|; )_csrf=([^;]*)/))&&b[1]&&(b=decodeURIComponent(b[1]),a.data||0===a.data||(a.data=""),"string"==typeof a.data?-1==a.data.indexOf("_csrf=")&&(a.data+=(0<a.data.length?"&":"")+"_csrf="+b,d.setRequestHeader("Content-type","application/x-www-form-urlencoded")):"object"==typeof a.data&&(window.FormData&&a.data instanceof window.FormData?"function"==typeof a.data.set?
a.data.set("_csrf",b):a.data.append("_csrf",b):a.data._csrf=b))});Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){var d=this.length;b=Number(b)||0;b=0>b?Math.ceil(b):Math.floor(b);for(0>b&&(b+=d);b<d;b++)if(b in this&&this[b]===a)return b;return-1});$.wa.locale=$.wa.locale||{};
$_=function(a,b){if(!$||!$.wa||!$.wa.locale)return console.log("JS localization failed: empty $.wa.locale"),"string"===typeof b?b:a;if(b){if(!$.wa.locale[b])return console&&console.log("JS localization failed: "+b),b;if("string"==typeof $.wa.locale[b])return $.wa.locale[b];var d=a%10;return 1==Math.floor(a/10)%10||4<d||0==d?$.wa.locale[b][2]:1==d?$.wa.locale[b][0]:$.wa.locale[b][1]}if($.wa.locale[a])return"string"==typeof $.wa.locale[a]?$.wa.locale[a]:$.wa.locale[a][0];console&&console.log("JS localization failed: "+
a);return a};jQuery.fn.waDialog=function(a){a=jQuery.extend({loading_header:"",title:"",esc:!0,buttons:null,url:null,url_reload:!0,"class":null,content:null,width:0,height:0,"min-width":0,"min-height":0,offsetTop:null,offsetLeft:null,disableButtonsOnSubmit:!1,onLoad:null,onCancel:null,onSubmit:null},a||{});var b=$(this),d=b.attr("id");d&&!b.hasClass("dialog")&&(b.removeAttr("id"),$("#"+d).length&&(a.url?(b=$("#"+d),a.url_reload||(a.url=null)):$("#"+d).remove()));var f=a["class"]||a.className?a["class"]||a.className:
b.attr("class")||"";if(b.hasClass("dialog"))a.content&&(b.find(".dialog-content-indent").html(a.content),a.title&&b.find(".dialog-content-indent").prepend("<h1>"+a.title+"</h1>")),a.buttons&&b.find(".dialog-buttons-gradient").empty().append(a.buttons);else{var g=$(this),c=b.parent();c.length&&c.is(":visible")||(c=$("body"));b=$("<div "+(d?'id = "'+d+'"':"")+' class="dialog '+f+'" style="display: none"><div class="dialog-background"></div><div class="dialog-window"></div></div>').appendTo(c);g.find(".dialog-content").length||
g.find(".dialog-buttons").length?($(".dialog-window",b).append(g.show()),d=g.find(".dialog-content"),d.length&&(f=$('<div class="dialog-content-indent"></div>'),d.contents().appendTo(f),d.append(f)),d=g.find(".dialog-buttons"),d.length&&(f=$('<div class="dialog-buttons-gradient"></div>'),d.contents().appendTo(f),d.append(f))):($(".dialog-window",b).append((a.onSubmit?'<form method="post" action="">':"")+'<div class="dialog-content"><div class="dialog-content-indent"></div></div><div class="dialog-buttons"><div class="dialog-buttons-gradient"></div></div>'+
(a.onSubmit?"</form>":"")),b.find(".dialog-content-indent").append(g.show()));a.buttons&&b.find(".dialog-buttons-gradient").empty().append(a.buttons);a.url?b.find(".dialog-content-indent").append("<h1>"+(a.loading_header||"")+'<i class="icon16 loading"></i></h1>'):a.content&&b.find(".dialog-content-indent").append(a.content);a.title&&b.find(".dialog-content-indent").prepend("<h1>"+a.title+"</h1>")}b.find(".dialog-background").length||b.prepend('<div class="dialog-background"> </div>');b.unbind("close").bind("close",
function(){a.onClose&&a.onClose.call($(this));$(this).hide()});g=["width","height","min-width","min-height"];for(d=0;d<g.length;d++)a[g[d]]&&(("height"==g[d]&&"300px">a[g[d]]||"width"==g[d]&&"400px">a[g[d]])&&b.find("div.dialog-window").css("min-"+g[d],a[g[d]]),b.find("div.dialog-window").css(g[d],a[g[d]]));a.disableButtonsOnSubmit&&b.find("input[type=submit]").removeAttr("disabled");b.parent().length||b.appendTo("body");b.show();a.url?jQuery.get(a.url,function(c){var e=$(c);e.find(".dialog-content").length||
e.find(".dialog-buttons").length?(e.find(".dialog-content").length&&b.find(".dialog-content-indent").empty().append(e.find(".dialog-content").contents()),e.find(".dialog-buttons").length&&b.find(".dialog-buttons-gradient").empty().append(e.find(".dialog-buttons").contents())):b.find(".dialog-content-indent").html(c);b.trigger("wa-resize");a.onLoad&&a.onLoad.call(b.get(0))}):a.onLoad&&a.onLoad.call(b.get(0));b.find(".dialog-buttons").delegate(".cancel","click",function(c){c.stopPropagation();c.preventDefault();
a.onCancel&&a.onCancel.call(b.get(0));b.trigger("close");return!1});a.onSubmit&&b.find("form").unbind("submit").submit(function(c){a.disableButtonsOnSubmit&&b.find("input[type=submit]").attr("disabled","disabled");try{return a.onSubmit.apply(this,[b,c])}catch(h){throw c.preventDefault(),h;}});b.unbind("wa-resize").bind("wa-resize",function(){var c=jQuery(this).find(".dialog-window"),b=c.width(),d=c.height();jQuery("body").css("min-height",d+"px");var f=jQuery(window).width(),g=jQuery(window).height()-
60;b=(f-b)/2/f;d=(g-d-60)/2/g;0>d&&(d=0);0>b&&(b=0);c.css({left:a.offsetLeft||Math.round(100*b)+"%",top:a.offsetTop||Math.round(100*d)+"%"})}).trigger("wa-resize");a.esc&&b.unbind("esc").bind("esc",function(){b.trigger("close")});return b};jQuery(window).resize(function(){jQuery(".dialog:visible").trigger("wa-resize")});jQuery(document).keyup(function(a){27==a.keyCode&&jQuery(".dialog:visible").trigger("esc")});/*
 (c) 2008-2009 Benjamin Arthur Lupton {@link http://www.balupton.com}
 @license GNU Affero General Public License - {@link http://www.gnu.org/licenses/agpl.html}
 @example Visit {@link http://jquery.com/plugins/project/jquery_history_bal} for more information.


 I would like to take this space to thank the following projects, blogs, articles and people:
 - jQuery {@link http://jquery.com/}
 - jQuery UI History - Klaus Hartl {@link http://www.stilbuero.de/jquery/ui_history/}
 - Really Simple History - Brian Dillard and Brad Neuberg {@link http://code.google.com/p/reallysimplehistory/}
 - jQuery History Plugin - Taku Sano (Mikage Sawatari) {@link http://www.mikage.to/jquery/jquery_history.html}
 - jQuery History Remote Plugin - Klaus Hartl {@link http://stilbuero.de/jquery/history/}
 - Content With Style: Fixing the back button and enabling bookmarking for ajax apps - Mike Stenhouse {@link http://www.contentwithstyle.co.uk/Articles/38/fixing-the-back-button-and-enabling-bookmarking-for-ajax-apps}
 - Bookmarks and Back Buttons {@link http://ajax.howtosetup.info/options-and-efficiencies/bookmarks-and-back-buttons/}
 - Ajax: How to handle bookmarks and back buttons - Brad Neuberg {@link http://dev.aol.com/ajax-handling-bookmarks-and-back-button}

*
**
 CHANGELOG
*
 v1.0.1-final, July 11, 2009
 - Restructured a little bit
 - Documented
 - Cleaned go/request

 v1.0.0-final, June 19, 2009
 - Been stable for over a year now, pushing live.

 v0.1.0-dev, July 24, 2008
 - Initial Release

*/
(function(a){"undefined"===typeof console&&(console="undefined"!==typeof window.console?window.console:{});console.log=console.log||function(){};console.debug=console.debug||console.log;console.warn=console.warn||console.log;console.error=console.error||function(){for(var a=[],d=0;d<arguments.length;d++)a.push(arguments[d]);alert(a.join("\n"))};console.trace=console.trace||console.log;console.group=console.group||console.log;console.groupEnd=console.groupEnd||console.log;console.profile=console.profile||
console.log;console.profileEnd=console.profileEnd||console.log;a.History={options:{debug:!1},state:"",$window:null,$iframe:null,handlers:{generic:[],specific:{}},format:function(a){return a=a.replace(/^.+?#/g,"").replace(/^#?\/?|\/?$/g,"")},getState:function(){return a.History.state},setState:function(b){var d=a.History;b=d.format(b);d.state=b;return d.state},getHash:function(){var b=parent&&!a.browser.msie?parent.window.location.hash:window.location.hash||location.hash;return b=a.History.format(b)},
setHash:function(b){b=a.History.format(b);b=b.replace(/^\/?|\/?(\?)|\/?$/g,"/$1");"undefined"===typeof window.location.hash&&(location.hash=b);a.browser.msie&&8>parseInt(a.browser.version,10)&&(a.History.$iframe.contentWindow.document.open(),a.History.$iframe.contentWindow.document.close())},go:function(b){var d=a.History;b=d.format(b);d.getHash()!==b?d.setHash(b):(d.setState(b),d.trigger());return!0},hashchange:function(b){var d=a.History;d.options.debug&&console.debug("History.hashchange",this,
arguments);var f=d.getHash(),g=d.getState();if(!d.$iframe&&g===f||d.$iframe&&d.hash===d.$iframe.contentWindow.document.location.hash||g===f)return!1;d.setState(f);d.trigger();return!0},bind:function(b,d){var f=a.History;d?("undefined"===typeof f.handlers.specific[b]&&(f.handlers.specific[b]=[]),f.handlers.specific[b].push(d)):f.handlers.generic.push(b);return!0},trigger:function(b){var d=a.History;"undefined"===typeof b&&(b=d.getState());var f;if("undefined"!==typeof d.handlers.specific[b]){var g=
d.handlers.specific[b];var c=0;for(f=g.length;c<f;++c){var e=g[c];e(b)}}g=d.handlers.generic;c=0;for(f=g.length;c<f;++c)e=g[c],e(b);return!0},construct:function(){var b=a.History;a(document).ready(function(){b.domReady()});return!0},configure:function(b){var d=a.History;d.options=a.extend(d.options,b);return!0},domReadied:!1,domReady:function(){var b=a.History;if(!b.domRedied)return b.domRedied=!0,b.$window=a(window),b.$window.bind("hashchange",this.hashchange),setTimeout(b.hashchangeLoader,200),
!0},hashchangeLoader:function(){var b=a.History;if(a.browser.msie&&8<=parseInt(a.browser.version))(d=b.getHash())&&b.$window.trigger("hashchange");else{if(a.browser.msie){b.$iframe=a('<iframe id="jquery-history-iframe" style="display: none;"></$iframe>').prependTo(document.body)[0];b.$iframe.contentWindow.document.open();b.$iframe.contentWindow.document.close();var d=b.getHash();d&&(b.$iframe.contentWindow.document.location.hash=d);d=function(){var a=b.format(b.$iframe.contentWindow.document.location.hash);
b.getState()!==a&&b.setHash(b.$iframe.contentWindow.document.location.hash);a=b.getHash();b.getState()!==a&&b.go(a)}}else d=function(){var a=b.getHash();b.getState()!==a&&b.go(a)};a.browser.msie&&8>parseInt(a.browser.version)?setInterval(d,1500):setInterval(d,200)}return!0}};a.History.construct()})(jQuery);jQuery.JSON={useHasOwn:{}.hasOwnProperty?!0:!1,pad:function(a){return 10>a?"0"+a:a},m:{"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},encodeString:function(a){return/["\\\x00-\x1f]/.test(a)?'"'+a.replace(/([\x00-\x1f\\"])/g,function(a,d){if(a=jQuery.JSON.m[d])return a;a=d.charCodeAt();return"\\u00"+Math.floor(a/16).toString(16)+(a%16).toString(16)})+'"':'"'+a+'"'},encodeArray:function(a){var b=["["],d,f=a.length;for(d=0;d<f;d+=1){var g=a[d];switch(typeof g){case "undefined":case "function":case "unknown":break;
default:c&&b.push(",");b.push(null===g?"null":this.encode(g));var c=!0}}b.push("]");return b.join("")},encodeDate:function(a){return'"'+a.getFullYear()+"-"+pad(a.getMonth()+1)+"-"+pad(a.getDate())+"T"+pad(a.getHours())+":"+pad(a.getMinutes())+":"+pad(a.getSeconds())+'"'},encode:function(a){if("undefined"==typeof a||null===a)return"null";if(a instanceof Array)return this.encodeArray(a);if(a instanceof Date)return this.encodeDate(a);if("string"==typeof a)return this.encodeString(a);if("number"==typeof a)return isFinite(a)?
String(a):"null";if("boolean"==typeof a)return String(a);var b=["{"],d;for(d in a)if(!this.useHasOwn||a.hasOwnProperty(d)){var f=a[d];switch(typeof f){case "undefined":case "function":case "unknown":break;default:g&&b.push(",");b.push(this.encode(d),":",null===f?"null":this.encode(f));var g=!0}}b.push("}");return b.join("")},decode:function(a){return eval("("+a+")")}};(function(a,b){a.store=function(b,f){var d=this;if("string"==typeof b)if(a.store.drivers[b])this.driver=a.store.drivers[b];else throw Error("Unknown driver "+b);else if("object"==typeof b){if(!(a.isFunction(b.init)&&a.isFunction(b.get)&&a.isFunction(b.set)&&a.isFunction(b.del)&&a.isFunction(b.flush)))throw Error("The specified driver does not fulfill the API requirements");this.driver=b}else a.each(a.store.drivers,function(){if(!a.isFunction(this.available)||!this.available())return!0;d.driver=this;
return!1===d.driver.init()?(d.driver=null,!0):!1});f||(f=a.store.serializers);this.serializers={};a.each(f,function(c,b){if(!a.isFunction(this.init))return!0;d.serializers[c]=this;d.serializers[c].init(d.encoders,d.decoders)})};a.extend(a.store.prototype,{get:function(a){a=this.driver.get(a);return this.driver.encodes?a:this.unserialize(a)},set:function(a,b){this.driver.set(a,this.driver.encodes?b:this.serialize(b))},del:function(a){this.driver.del(a)},flush:function(){this.driver.flush()},driver:b,
encoders:[],decoders:[],serialize:function(b){var d=this;a.each(this.encoders,function(){var a=d.serializers[this+""];if(!a||!a.encode)return!0;try{b=a.encode(b)}catch(c){}});return b},unserialize:function(b){var d=this;if(!b)return b;a.each(this.decoders,function(){var a=d.serializers[this+""];if(!a||!a.decode)return!0;b=a.decode(b)});return b}});a.store.drivers={localStorage:{ident:"$.store.drivers.localStorage",scope:"browser",available:function(){try{return!!window.localStorage}catch(d){return!1}},
init:a.noop,get:function(a){return window.localStorage.getItem(a)},set:function(a,b){window.localStorage.setItem(a,b)},del:function(a){window.localStorage.removeItem(a)},flush:function(){window.localStorage.clear()}},userData:{ident:"$.store.drivers.userData",element:null,nodeName:"userdatadriver",scope:"browser",initialized:!1,available:function(){try{return!(!document.documentElement||!document.documentElement.addBehavior)}catch(d){return!1}},init:function(){if(!this.initialized)try{this.element=
document.createElement(this.nodeName),document.documentElement.insertBefore(this.element,document.getElementsByTagName("title")[0]),this.element.addBehavior("#default#userData"),this.initialized=!0}catch(d){return!1}},get:function(a){this.element.load(this.nodeName);return this.element.getAttribute(a)},set:function(a,b){this.element.setAttribute(a,b);this.element.save(this.nodeName)},del:function(a){this.element.removeAttribute(a);this.element.save(this.nodeName)},flush:function(){this.element.expires=
(new Date).toUTCString();this.element.save(this.nodeName)}},windowName:{ident:"$.store.drivers.windowName",scope:"window",cache:{},encodes:!0,available:function(){return!0},init:function(){this.load()},save:function(){window.name=a.store.serializers.json.encode(this.cache)},load:function(){try{this.cache=a.store.serializers.json.decode(window.name+""),"object"!=typeof this.cache&&(this.cache={})}catch(d){this.cache={},window.name="{}"}},get:function(a){return this.cache[a]},set:function(a,b){this.cache[a]=
b;this.save()},del:function(a){try{delete this.cache[a]}catch(f){this.cache[a]=b}this.save()},flush:function(){window.name="{}"}}};a.store.serializers={json:{ident:"$.store.serializers.json",init:function(a,b){a.push("json");b.push("json")},encode:"object"==typeof JSON?JSON.stringify:a.JSON.stringify,decode:"object"==typeof JSON?JSON.parse:a.JSON.parse},xml:{ident:"$.store.serializers.xml",init:function(a,b){a.unshift("xml");b.push("xml")},isXML:function(a){return(a=(a?a.ownerDocument||a:0).documentElement)?
"html"!==a.nodeName.toLowerCase():!1},encode:function(a){if(!a||a._serialized||!this.isXML(a))return a;var b={_serialized:this.ident,value:a};try{return b.value=(new XMLSerializer).serializeToString(a),b}catch(g){try{return b.value=a.xml,b}catch(c){}}return a},decode:function(a){if(!a||!a._serialized||a._serialized!=this.ident)return a;var d="DOMParser"in window&&(new DOMParser).parseFromString;!d&&window.ActiveXObject&&(d=function(a){var b=new ActiveXObject("Microsoft.XMLDOM");b.async="false";b.loadXML(a);
return b});if(!d)return b;a.value=d.call("DOMParser"in window&&new DOMParser||window,a.value,"text/xml");return this.isXML(a.value)?a.value:b}}}})(jQuery);(function(a){function b(a,b){this.path=a;"undefined"!==typeof b&&null!==b?(this.at_2x_path=b,this.perform_check=!1):(this.at_2x_path=a.replace(/\.\w+$/,function(a){return"@2x"+a}),this.perform_check=!0)}function d(d){if(!/@2x\.\w+$/.test(a(d).attr("src"))){this.el=d;this.path=new b(a(d).attr("src"),a(d).attr("data-at2x"));var f=this;this.path.check_2x_variant(function(a){a&&f.swap()})}}a.fn.retina=function(b){if(a.Retina.isRetina())return a.Retina.opts=a.extend(a.Retina.opts,b),this.each(function(){a(this).is("img")&&
new d(this)})};a.Retina=function(){};a.Retina.opts={check_mime_type:!0,force_original_dimensions:!0};a.Retina.isRetina=function(){return 1<window.devicePixelRatio||window.matchMedia&&window.matchMedia("(-webkit-min-device-pixel-ratio: 1.5),(min--moz-device-pixel-ratio: 1.5),(-o-min-device-pixel-ratio: 3/2),(min-resolution: 1.5dppx)").matches?!0:!1};b.confirmed_paths=[];b.prototype.is_external=function(){return!(!this.path.match(/^(https?:|\/\/)/i)||this.path.match("//"+document.domain+"/"))};b.prototype.check_2x_variant=
function(d){var f=this;if(this.is_external()||!this.perform_check&&"undefined"!==typeof this.at_2x_path&&null!==this.at_2x_path||this.at_2x_path in b.confirmed_paths)return d(!0);var c=new XMLHttpRequest;c.open("HEAD",this.at_2x_path);c.onreadystatechange=function(){if(4==c.readyState&&200<=c.status&&399>=c.status){if(a.Retina.opts.check_mime_type){var e=c.getResponseHeader("Content-Type");if(null===e||!e.match(/^image/i))return d(!1)}b.confirmed_paths.push(f.at_2x_path);return d(!0)}return d(!1)};
c.send()};a.RetinaImage=d;d.prototype.swap=function(b){function d(){if(c.el.complete){a.Retina.opts.force_original_dimensions&&(c.el.setAttribute("width",c.el.offsetWidth),c.el.setAttribute("height",c.el.offsetHeight));var e=c.el.src;c.el.setAttribute("src",b);a(c.el).one("error",function(){c.el.setAttribute("src",e)})}else setTimeout(d,5)}"undefined"==typeof b&&(b=this.path.at_2x_path);var c=this;d()}})(jQuery);(function(a){var b=[],d=[];a.fn.doAutosize=function(b){var d=a(this).data("minwidth"),c=a(this).data("maxwidth"),e="",f=a(this),k=a("#"+a(this).data("tester_id"));e!==(e=f.val())&&(e=e.replace(/&/g,"&").replace(/\s/g," ").replace(/</g,"<").replace(/>/g,">"),k.html(e),k=k.width(),b=k+b.comfortZone>=d?k+b.comfortZone:d,k=f.width(),(b<k&&b>=d||b>d&&b<c)&&f.width(b))};a.fn.resetAutosize=function(b){var d=a(this).data("minwidth")||b.minInputWidth||a(this).width();b=a(this).data("maxwidth")||b.maxInputWidth||
a(this).closest(".tagsinput").width()-b.inputPadding;var c=a(this),e=a("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:c.css("fontSize"),fontFamily:c.css("fontFamily"),fontWeight:c.css("fontWeight"),letterSpacing:c.css("letterSpacing"),whiteSpace:"nowrap"}),f=a(this).attr("id")+"_autosize_tester";0< !a("#"+f).length&&(e.attr("id",f),e.appendTo("body"));c.data("minwidth",d);c.data("maxwidth",b);c.data("tester_id",f);c.css("width",d)};a.fn.addTag=function(f,g){g=jQuery.extend({focus:!1,
callback:!0},g);this.each(function(){var c=a(this).attr("id"),e=a(this).val().split(b[c]);""==e[0]&&(e=[]);f=jQuery.trim(f);if(g.unique){var h=a(e).tagExist(f);1==h&&a("#"+c+"_tag").addClass("not_valid")}else h=!1;if(""!=f&&1!=h&&(a("<span>").addClass("tag").append(a("<span>").text(f).append("\u00a0\u00a0"),a("<a>",{href:"#",title:"Removing tag",text:"x"}).click(function(){return a("#"+c).removeTag(escape(f))})).insertBefore("#"+c+"_addTag"),e.push(f),a("#"+c+"_tag").val(""),g.focus?a("#"+c+"_tag").focus():
a("#"+c+"_tag").blur(),a.fn.tagsInput.updateTagsField(this,e),g.callback&&d[c]&&d[c].onAddTag&&(h=d[c].onAddTag,h.call(this,f)),d[c]&&d[c].onChange)){var k=e.length;h=d[c].onChange;h.call(this,a(this),e[k-1])}});return!1};a.fn.removeTag=function(f){f=unescape(f);this.each(function(){var g=a(this).attr("id"),c=a(this).val().split(b[g]);a("#"+g+"_tagsinput .tag").remove();str="";for(var e=0;e<c.length;e++)c[e]!=f&&(str=str+b[g]+c[e]);a.fn.tagsInput.importTags(this,str);d[g]&&d[g].onRemoveTag&&d[g].onRemoveTag.call(this,
f)});return!1};a.fn.tagExist=function(b){return 0<=jQuery.inArray(b,a(this))};a.fn.importTags=function(b){id=a(this).attr("id");a("#"+id+"_tagsinput .tag").remove();a.fn.tagsInput.importTags(this,b)};a.fn.tagsInput=function(f){var g=jQuery.extend({interactive:!0,defaultText:"add a tag",minChars:0,width:"300px",height:"100px",autocomplete:{selectFirst:!1},hide:!0,delimiter:",",unique:!0,removeWithBackspace:!0,placeholderColor:"#666666",autosize:!0,comfortZone:20,inputPadding:12},f);this.each(function(){g.hide&&
a(this).hide();var c=a(this).attr("id"),e=jQuery.extend({pid:c,real_input:"#"+c,holder:"#"+c+"_tagsinput",input_wrapper:"#"+c+"_addTag",fake_input:"#"+c+"_tag"},g);b[c]=e.delimiter;if(g.onAddTag||g.onRemoveTag||g.onChange)d[c]=[],d[c].onAddTag=g.onAddTag,d[c].onRemoveTag=g.onRemoveTag,d[c].onChange=g.onChange;var f='<div id="'+c+'_tagsinput" class="tagsinput"><div id="'+c+'_addTag">';g.interactive&&(f=f+'<input id="'+c+'_tag" value="" data-default="'+g.defaultText+'" />');a(f+'</div><div class="tags_clear"></div></div>').insertAfter(this);
a(e.holder).css("width",g.width);a(e.holder).css("height",g.height);""!=a(e.real_input).val()&&a.fn.tagsInput.importTags(a(e.real_input),a(e.real_input).val());if(g.interactive){a(e.fake_input).val(a(e.fake_input).attr("data-default"));a(e.fake_input).css("color",g.placeholderColor);a(e.fake_input).resetAutosize(g);a(e.holder).bind("click",e,function(b){a(b.data.fake_input).focus()});a(e.fake_input).bind("focus",e,function(b){a(b.data.fake_input).val()==a(b.data.fake_input).attr("data-default")&&
a(b.data.fake_input).val("");a(b.data.fake_input).css("color","#000000")});if(void 0!=g.autocomplete_url){autocomplete_options={source:g.autocomplete_url};for(attrname in g.autocomplete)autocomplete_options[attrname]=g.autocomplete[attrname];void 0!==jQuery.Autocompleter?(a(e.fake_input).autocomplete(g.autocomplete_url,g.autocomplete),a(e.fake_input).bind("result",e,function(b,e,d){e&&a("#"+c).addTag(e[0]+"",{focus:!0,unique:g.unique})})):void 0!==jQuery.ui.autocomplete&&(a(e.fake_input).autocomplete(autocomplete_options),
a(e.fake_input).bind("autocompleteselect",e,function(b,c){a(b.data.real_input).addTag(c.item.value,{focus:!0,unique:g.unique});return!1}))}else a(e.fake_input).bind("blur",e,function(b){var c=a(this).attr("data-default");""!=a(b.data.fake_input).val()&&a(b.data.fake_input).val()!=c?b.data.minChars<=a(b.data.fake_input).val().length&&(!b.data.maxChars||b.data.maxChars>=a(b.data.fake_input).val().length)&&a(b.data.real_input).addTag(a(b.data.fake_input).val(),{focus:!0,unique:g.unique}):(a(b.data.fake_input).val(a(b.data.fake_input).attr("data-default")),
a(b.data.fake_input).css("color",g.placeholderColor));return!1});a(e.fake_input).bind("keypress",e,function(b){if(b.which==b.data.delimiter.charCodeAt(0)||13==b.which)return b.preventDefault(),b.data.minChars<=a(b.data.fake_input).val().length&&(!b.data.maxChars||b.data.maxChars>=a(b.data.fake_input).val().length)&&a(b.data.real_input).addTag(a(b.data.fake_input).val(),{focus:!0,unique:g.unique}),a(b.data.fake_input).resetAutosize(g),!1;b.data.autosize&&a(b.data.fake_input).doAutosize(g)});e.removeWithBackspace&&
a(e.fake_input).bind("keydown",function(b){if(8==b.keyCode&&""==a(this).val()){b.preventDefault();b=a(this).closest(".tagsinput").find(".tag:last").text();var c=a(this).attr("id").replace(/_tag$/,"");b=b.replace(/[\s]+x$/,"");a("#"+c).removeTag(escape(b));a(this).trigger("focus")}});a(e.fake_input).blur();e.unique&&a(e.fake_input).keydown(function(b){(8==b.keyCode||String.fromCharCode(b.which).match(/\w+|[\u00e1\u00e9\u00ed\u00f3\u00fa\u00c1\u00c9\u00cd\u00d3\u00da\u00f1\u00d1,\/]+/))&&a(this).removeClass("not_valid")})}return!1});
return this};a.fn.tagsInput.updateTagsField=function(d,g){var c=a(d).attr("id");a(d).val(g.join(b[c]))};a.fn.tagsInput.importTags=function(f,g){a(f).val("");var c=a(f).attr("id");g=g.split(b[c]);for(var e=0;e<g.length;e++)a(f).addTag(g[e],{focus:!1,callback:!1});d[c]&&d[c].onChange&&d[c].onChange.call(f,f,g[e])}})(jQuery);(function(a){a.fn.extend({autocomplete:function(b,d){var f="string"==typeof b;d=a.extend({},a.Autocompleter.defaults,{url:f?b:null,data:f?null:b,delay:f?a.Autocompleter.defaults.delay:10,max:d&&!d.scroll?10:150},d);d.highlight=d.highlight||function(a){return a};d.formatMatch=d.formatMatch||d.formatItem;return this.each(function(){new a.Autocompleter(this,d)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},
setOptions:function(a){return this.trigger("setOptions",[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});a.Autocompleter=function(b,d){function f(){var e=u.selected();if(!e)return!1;var f=e.result;r=f;if(d.multiple){var g=c(m.val());if(1<g.length){var k=d.multipleSeparator.length,l=a(b).selection().start,n,p=0;a.each(g,function(a,b){p+=b.length;if(l<=p)return n=a,!1;p+=k});g[n]=f;f=g.join(d.multipleSeparator)}f+=d.multipleSeparator}m.val(f);h();m.trigger("result",[e.data,e.value]);
return!0}function g(a,b){if(x==n.DEL)u.hide();else if(a=m.val(),b||a!=r)r=a,a=e(a),a.length>=d.minChars?(m.addClass(d.loadingClass),d.matchCase||(a=a.toLowerCase()),l(a,k,h)):(m.removeClass(d.loadingClass),u.hide())}function c(b){return b?d.multiple?a.map(b.split(d.multipleSeparator),function(c){return a.trim(b).length?a.trim(c):null}):[a.trim(b)]:[""]}function e(e){if(!d.multiple)return e;var f=c(e);if(1==f.length)return f[0];f=a(b).selection().start;f=f==e.length?c(e):c(e.replace(e.substring(f),
""));return f[f.length-1]}function h(){u.visible();u.hide();clearTimeout(p);m.removeClass(d.loadingClass);d.mustMatch&&m.search(function(a){a||(d.multiple?(a=c(m.val()).slice(0,-1),m.val(a.join(d.multipleSeparator)+(a.length?d.multipleSeparator:""))):(m.val(""),m.trigger("result",null)))})}function k(c,f){f&&f.length&&t?(m.removeClass(d.loadingClass),u.display(f,c),f=f[0].value,d.autoFill&&e(m.val()).toLowerCase()==c.toLowerCase()&&x!=n.BACKSPACE&&(m.val(m.val()+f.substring(e(r).length)),a(b).selection(r.length,
r.length+f.length)),u.show()):h()}function l(c,f,g){d.matchCase||(c=c.toLowerCase());var h=q.load(c);if(h&&h.length)f(c,h);else if("string"==typeof d.url&&0<d.url.length){var k={timestamp:+new Date};a.each(d.extraParams,function(a,b){k[a]="function"==typeof b?b():b});a.ajax({mode:"abort",port:"autocomplete"+b.name,dataType:d.dataType,url:d.url,data:a.extend({q:e(c),limit:d.max},k),success:function(b){var e;if(!(e=d.parse&&d.parse(b))){e=[];b=b.split("\n");for(var g=0;g<b.length;g++){var h=a.trim(b[g]);
h&&(h=h.split("|"),e[e.length]={data:h,value:h[0],result:d.formatResult&&d.formatResult(h,h[0])||h[0]})}}q.add(c,e);f(c,e)}})}else u.emptyList(),g(c)}var n={UP:38,DOWN:40,DEL:46,TAB:9,RETURN:13,ESC:27,COMMA:188,PAGEUP:33,PAGEDOWN:34,BACKSPACE:8},m=a(b).attr("autocomplete","off").addClass(d.inputClass),p,r="",q=a.Autocompleter.Cache(d),t=0,x,w={mouseDownOnSelect:!1},u=a.Autocompleter.Select(d,b,f,w),y;a.browser.opera&&a(b.form).bind("submit.autocomplete",function(){if(y)return y=!1});m.bind((a.browser.opera?
"keypress":"keydown")+".autocomplete",function(b){t=1;x=b.keyCode;switch(b.keyCode){case n.UP:b.preventDefault();u.visible()?u.prev():g(0,!0);break;case n.DOWN:b.preventDefault();u.visible()?u.next():g(0,!0);break;case n.PAGEUP:b.preventDefault();u.visible()?u.pageUp():g(0,!0);break;case n.PAGEDOWN:b.preventDefault();u.visible()?u.pageDown():g(0,!0);break;case d.multiple&&","==a.trim(d.multipleSeparator)&&n.COMMA:case n.TAB:case n.RETURN:if(f())return b.preventDefault(),y=!0,!1;break;case n.ESC:u.hide();
break;default:clearTimeout(p),p=setTimeout(g,d.delay)}}).focus(function(){t++}).blur(function(){t=0;w.mouseDownOnSelect||(clearTimeout(p),p=setTimeout(h,200))}).click(function(){1<t++&&!u.visible()&&g(0,!0)}).bind("search",function(){function b(a,b){if(b&&b.length)for(var c=0;c<b.length;c++)if(b[c].result.toLowerCase()==a.toLowerCase()){var d=b[c];break}"function"==typeof e?e(d):m.trigger("result",d&&[d.data,d.value])}var e=1<arguments.length?arguments[1]:null;a.each(c(m.val()),function(a,c){l(c,
b,b)})}).bind("flushCache",function(){q.flush()}).bind("setOptions",function(b,c){a.extend(d,c);"data"in c&&q.populate()}).bind("unautocomplete",function(){u.unbind();m.unbind();a(b.form).unbind(".autocomplete")})};a.Autocompleter.defaults={inputClass:"ac_input",resultsClass:"ac_results",loadingClass:"ac_loading",minChars:1,delay:400,matchCase:!1,matchSubset:!0,matchContains:!1,cacheLength:10,max:100,mustMatch:!1,extraParams:{},selectFirst:!0,formatItem:function(a){return a[0]},formatMatch:null,autoFill:!1,
width:0,multiple:!1,multipleSeparator:", ",highlight:function(a,d){return a.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+d.replace(/([\^\$\(\)\[\]\{\}\*\.\+\?\|\\])/gi,"\\$1")+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>")},scroll:!0,scrollHeight:180};a.Autocompleter.Cache=function(b){function d(a,c){b.matchCase||(a=a.toLowerCase());var e=a.indexOf(c);"word"==b.matchContains&&(e=a.toLowerCase().search("\\b"+c.toLowerCase()));return-1==e?!1:0==e||b.matchContains}function f(a,d){h>b.cacheLength&&
c();e[a]||h++;e[a]=d}function g(){if(!b.data)return!1;var c={},e=0;b.url||(b.cacheLength=1);c[""]=[];for(var d=0,g=b.data.length;d<g;d++){var h=b.data[d];h="string"==typeof h?[h]:h;var r=b.formatMatch(h,d+1,b.data.length);if(!1!==r){var q=r.charAt(0).toLowerCase();c[q]||(c[q]=[]);h={value:r,data:h,result:b.formatResult&&b.formatResult(h)||r};c[q].push(h);e++<b.max&&c[""].push(h)}}a.each(c,function(a,c){b.cacheLength++;f(a,c)})}function c(){e={};h=0}var e={},h=0;setTimeout(g,25);return{flush:c,add:f,
populate:g,load:function(c){if(!b.cacheLength||!h)return null;if(!b.url&&b.matchContains){var f=[],g;for(g in e)if(0<g.length){var k=e[g];a.each(k,function(a,b){d(b.value,c)&&f.push(b)})}return f}if(e[c])return e[c];if(b.matchSubset)for(g=c.length-1;g>=b.minChars;g--)if(k=e[c.substr(0,g)])return f=[],a.each(k,function(a,b){d(b.value,c)&&(f[f.length]=b)}),f;return null}}};a.Autocompleter.Select=function(b,d,f,g){function c(){r&&(q=a("<div/>").hide().addClass(b.resultsClass).css("position","absolute").appendTo(document.body),
t=a("<ul/>").appendTo(q).mouseover(function(b){e(b).nodeName&&"LI"==e(b).nodeName.toUpperCase()&&(n=a("li",t).removeClass(k.ACTIVE).index(e(b)),a(e(b)).addClass(k.ACTIVE))}).click(function(b){a(e(b)).addClass(k.ACTIVE);f();d.focus();return!1}).mousedown(function(){g.mouseDownOnSelect=!0}).mouseup(function(){g.mouseDownOnSelect=!1}),0<b.width&&q.css("width",b.width),r=!1)}function e(a){for(a=a.target;a&&"LI"!=a.tagName;)a=a.parentNode;return a?a:[]}function h(a){l.slice(n,n+1).removeClass(k.ACTIVE);
n+=a;0>n?n=l.size()-1:n>=l.size()&&(n=0);a=l.slice(n,n+1).addClass(k.ACTIVE);if(b.scroll){var c=0;l.slice(0,n).each(function(){c+=this.offsetHeight});c+a[0].offsetHeight-t.scrollTop()>t[0].clientHeight?t.scrollTop(c+a[0].offsetHeight-t.innerHeight()):c<t.scrollTop()&&t.scrollTop(c)}}var k={ACTIVE:"ac_over"},l,n=-1,m,p="",r=!0,q,t;return{display:function(e,d){c();m=e;p=d;t.empty();e=m.length;e=b.max&&b.max<e?b.max:e;for(d=0;d<e;d++)if(m[d]){var f=b.formatItem(m[d].data,d+1,e,m[d].value,p);!1!==f&&
(f=a("<li/>").html(b.highlight(f,p)).addClass(0==d%2?"ac_even":"ac_odd").appendTo(t)[0],a.data(f,"ac_data",m[d]))}l=t.find("li");b.selectFirst&&(l.slice(0,1).addClass(k.ACTIVE),n=0);a.fn.bgiframe&&t.bgiframe()},next:function(){h(1)},prev:function(){h(-1)},pageUp:function(){0!=n&&0>n-8?h(-n):h(-8)},pageDown:function(){n!=l.size()-1&&n+8>l.size()?h(l.size()-1-n):h(8)},hide:function(){q&&q.hide();l&&l.removeClass(k.ACTIVE);n=-1},visible:function(){return q&&q.is(":visible")},current:function(){return this.visible()&&
(l.filter("."+k.ACTIVE)[0]||b.selectFirst&&l[0])},show:function(){var c=a(d).offset();q.css({width:"string"==typeof b.width||0<b.width?b.width:a(d).width(),top:c.top+d.offsetHeight,left:c.left}).show();if(b.scroll&&(t.scrollTop(0),t.css({maxHeight:b.scrollHeight,overflow:"auto"}),a.browser.msie&&"undefined"===typeof document.body.style.maxHeight)){var e=0;l.each(function(){e+=this.offsetHeight});c=e>b.scrollHeight;t.css("height",c?b.scrollHeight:e);c||l.width(t.width()-parseInt(l.css("padding-left"))-
parseInt(l.css("padding-right")))}},selected:function(){var b=l&&l.filter("."+k.ACTIVE).removeClass(k.ACTIVE);return b&&b.length&&a.data(b[0],"ac_data")},emptyList:function(){t&&t.empty()},unbind:function(){q&&q.remove()}}};a.fn.selection=function(a,d){if(void 0!==a)return this.each(function(){if(this.createTextRange){var b=this.createTextRange();void 0===d||a==d?b.move("character",a):(b.collapse(!0),b.moveStart("character",a),b.moveEnd("character",d));b.select()}else this.setSelectionRange?this.setSelectionRange(a,
d):this.selectionStart&&(this.selectionStart=a,this.selectionEnd=d)});var b=this[0];if(b.createTextRange){var g=document.selection.createRange(),c=b.value,e=g.text.length;g.text="<->";g=b.value.indexOf("<->");b.value=c;this.selection(g,g+e);return{start:g,end:g+e}}if(void 0!==b.selectionStart)return{start:b.selectionStart,end:b.selectionEnd}}})(jQuery);(function(a){a.photos_sidebar={width:200,options:{},init:function(a){var b=this;this.options=a||{};a.width&&(this.width=a.width);this.initCollapsible();this.initHandlers();this.initView();setTimeout(function(){b.initFixedSidebar()},1E3)},initFixedSidebar:function(){var b=a(window),d=a("#wa-app"),f=d.find(".p-sidebar-wrapper"),g=f.find(".p-sidebar-block"),c=b.height(),e=g.offset().top,h=!1,k=!1,l=!1,n=0;b.on("scroll",function(){var a=b.scrollTop(),p=g.outerHeight(),r=d.height(),q=g.offset().top,t=
n>a?1:-1,x=a-e,w=g.width(),u=p+parseInt(f.css("padding-top"))+parseInt(f.css("padding-bottom"))>=r;if(r>c&&!u)if(p<c)0<x?((h||!k||l)&&g.removeAttr("style").width(w).addClass("fixed-to-top"),l=!0):g.removeAttr("style").removeClass("fixed-to-bottom").removeClass("fixed-to-top");else if(a<=e){if(h||k||l)g.removeAttr("style").removeClass("fixed-to-bottom").removeClass("fixed-to-top"),h=k=l=!1}else if(a<=q&&q>=e)if(0<t){if(h||!l||k)g.removeAttr("style").width(w).removeClass("fixed-to-bottom").addClass("fixed-to-top"),
h=k=!1,l=!0}else{if(!h||l||k)g.css("top",q-e).removeClass("fixed-to-top").removeClass("fixed-to-bottom"),h=!0,l=k=!1}else if(a+c>=q+p)if(0<t){if(!h||l||k)g.css("top",q-e).removeClass("fixed-to-top").removeClass("fixed-to-bottom"),h=!0,l=k=!1}else{if(h||l||!k)g.removeAttr("style").width(w).removeClass("fixed-to-top").addClass("fixed-to-bottom"),h=l=!1,k=!0}else{if(!h||l||k)g.css("top",q-e).removeClass("fixed-to-top").removeClass("fixed-to-bottom"),h=!0,l=k=!1}else if(h||l||k)g.removeAttr("style").removeClass("fixed-to-bottom").removeClass("fixed-to-top"),
h=l=k=!1;n=a})},initView:function(){var b=a("#p-sidebar"),d=a("#p-sidebar-width-control");d.find("a.arrow").unbind("click").bind("click",function(){var f=b.attr("class"),g=0,c=f.match(/left([\d]{2,3})px/);if(c&&c[1]&&(g=parseInt(c[1]))&&(c=g+(a(this).is(".right")?50:-50),c=Math.max(Math.min(c,400),200),c!=g)){d.css({width:c.toString()+"px"});g=["left"+g+"px","left"+c+"px"];b.attr("class",f.replace(g[0],g[1]));b.css("width","");var e=a("#p-content");e.length&&(f=e.attr("class"),e.attr("class",f.replace(g[0],
g[1])),e.css("margin-left",""));a.photos_sidebar.width=c;a.post("?action=sidebarSaveWidth",{width:c},"json")}return!1})},initCollapsible:function(){a("#p-sidebar").off("click",".collapse-handler").on("click",".collapse-handler",function(){a.photos_sidebar._collapseSidebarSection(this,"toggle")});a("#p-sidebar .collapse-handler").each(function(){a.photos_sidebar._collapseSidebarSection(this,"restore")});a("#album-list-container").die("uncollapse_section").live("uncollapse_section",function(b,d){d=
a(d);b=a(this).find(">.collapse-handler");var f=d.find(">i.collapse-handler");a.photos_sidebar._collapseSidebarSection(f,"uncollapse");for(d=d.parent().parent();d.length&&d.get(0)!=this;){f=d.find(">i.collapse-handler");if(!f.length)break;a.photos_sidebar._collapseSidebarSection(f,"uncollapse");d=d.parent().parent()}a.photos_sidebar._collapseSidebarSection(b,"uncollapse")})},initHandlers:function(){a("#p-upload-link").click(function(){a.photos.uploadDialog();return!1});a("#album-list-container").off("click",
".p-new-album").on("click",".p-new-album",function(){var b=a(this),d=0;b.is("#p-new-album")||(d=parseInt(b.parents("li:first").attr("rel"),10)||0);b=a("#album-create-dialog-acceptor");b.length||(b=a("<div id='album-create-dialog-acceptor'></div>"),a("body").append(b));b.load("?module=dialog&action=createAlbum&parent_id="+d,function(){a("#album-create-dialog").waDialog({onLoad:function(b){a(this).find("input[type=text]").val("")},onSubmit:function(b){var f=a(this);a.post(f.attr("action"),f.serialize(),
function(c){"ok"==c.status&&(a.photos.onCreateAlbum(c.data,d),b.trigger("close"),c.data.id&&a.photos.goToHash("/album/"+c.data.id))},"json");return!1}})});return!1})},countSubtree:function(b){var d=b.find(">.count:not(.subtree)"),f=b.find(">.subtree");f.length||(f=d.clone().addClass("subtree").hide(),d.after(f));var g=parseInt(d.text(),10)||0;b.find("li.static>.count:not(.subtree)").each(function(){var b=parseInt(a(this).text(),10)||0;g+=b});f.hasClass("never-recount")||f.text(g);f.show();d.hide();
return g},countItem:function(a){var b=a.find(">.count:not(.subtree)").show();a.find(">.subtree").hide();return parseInt(b.text(),10)||0},_collapseSidebarSection:function(b,d){d||(d="coollapse");b=a(b);if(b.length){var f=b.hasClass("darr")||b.hasClass("rarr")?b:b.find(".darr, .rarr");if(f.length){var g=b.parent(),c=g.find(".hierarchical:first");c.length||(c=g.find(".collapsible-content:first"));c.length||(c=g.find("ul:first"));var e;b=b.attr("id")||b.parent().attr("id");var h=f.hasClass("darr")?"shown":
"hidden",k=function(){c.hide();f.removeClass("darr").addClass("rarr");a.photos_sidebar.countSubtree(g);e="hidden"},l=function(){c.show();f.removeClass("rarr").addClass("darr");a.photos_sidebar.countItem(g);e="shown"};switch(d){case "toggle":"shown"==h?k():l();break;case "restore":b&&("hidden"==a.storage.get("photos/collapsible/"+b)?k():l());break;case "uncollapse":l();break;default:k()}b&&e&&a.storage.set("photos/collapsible/"+b,e)}}}}})(jQuery);(function(a){function b(){var b=a.photos.getAlbum();return b&&b.type===Album.TYPE_STATIC&&!1!==b.edit_rights?!0:!1}function d(){a("#hint-menu-block").hide().children().hide()}a.photos_dragndrop={helper_shift:20,init:function(){this._extendJqueryUIDragAndDrop();this._initDragPhotos();this._initDropPhotos();this._initDragAlbums();this._initDropAlbums()},_initDragPhotos:function(){var b={opacity:.75,zIndex:9999,distance:5,appendTo:"body",cursor:"move",refreshPositions:!0,start:function(b,c){document.ondragstart=
function(){return!1};c.helper.data("scrollTop",a(document).scrollTop());a(document).bind("scroll",a.photos_dragndrop._scrolHelper);a("#album-list-container").addClass("p-drag-active")},stop:function(b,c){document.ondragstart=null;a(document).unbind("scroll",a.photos_dragndrop._scrolHelper);a("#album-list-container").removeClass("p-drag-active");d()},drag:function(b,c){b=b.originalEvent;c.position.left=b.pageX-a.photos_dragndrop.helper_shift;c.position.top=b.pageY}},g=b.start,c=b.stop;a("img",a("#photo-list")).liveDraggable(a.extend({},
b,{containment:[0,0,a(window).width(),{toString:function(){return a(document).height()}}],helper:function(b){b=a(this).parents("li:first");var c=a("#photo-list li.selected"),e=c.length?c.length:1,d=[b.attr("data-photo-id")],f=!1,g=b.get(0);c.each(function(){this!=g?d.push(a(this).attr("data-photo-id")):f=!0});!f&&c.length&&(b.addClass("selected").find("input:first").trigger("select",!0),++e);b.data("photo_ids",d);return'<div id="helper"><span class="indicator red">'+e+'</span><i class="icon10 no-bw" style="display:none;"></i></div>'},
handle:".p-image",start:function(b,c){g.apply(this,[b,c]);b=a(this).parents("li:first");1==b.data("photo_ids").length&&b.addClass("selected")},stop:function(b,d){c.apply(this,[b,d]);b=a(this).parents("li:first");1==b.data("photo_ids").length&&b.removeClass("selected")}}));a("#photo").liveDraggable(a.extend({},b,{containment:"body",start:function(b,c){if(!a(b.target).hasClass("ui-draggable"))return!1},helper:function(){return'<div id="helper"><span class="indicator red">1</span><i class="icon10 no-bw" style="display:none;"></i></div>'}}))},
_initDropPhotos:function(){a("li",a("#photo-list")).liveDroppable({disabled:!1,greedy:!0,tolerance:"pointer",over:function(f,g){if(g.draggable.hasClass("dr"))return!1;if(b())d();else if(f=a.photos.getOption("sort_method"))g=a("#hint-menu-block").show(),g.children().hide(),g.find("."+f).show();a.photos_dragndrop._activatePhotoListItem.call(this)},out:function(b,d){a.photos_dragndrop._unactivatePhotoListItem.call(this)},drop:function(d,g){d=b();var c=a.photos.getAlbum();g=g.draggable.parents("li:first");
var e=a(this);if(g.get(0)==this||e.hasClass("selected"))return a.photos_dragndrop._unactivatePhotoListItem.call(this),!1;var f=a("#photo-list li.selected");f.length||(f=g);a.photos_dragndrop._unactivatePhotoListItem.call(this);a.photos_dragndrop._unactivatePhotoListItem.call(g);if(!d)return!1;var k=parseInt(e.attr("data-photo-id"));e.hasClass("last")?(k=null,e.after(f),e.removeClass("last"),a("#photo-list li:last").addClass("last")):(e.before(f),g.hasClass("last")&&(g.removeClass("last"),a("#photo-list li:last").addClass("last")));
f.trigger("select",!1);var l=[];f.each(function(){l.push(parseInt(a(this).attr("data-photo-id")))});a.post("?module=album&action=photoMove",{photo_id:l,album_id:c.id,before_id:k},function(b){"ok"==b.status&&a.photos.photo_stream_cache.move(l,k)},"json")}})},_initDragAlbums:function(){var b=a("#wa-app > .sidebar"),d=b.position(),c=b.width();b=b.height();a("li.dr",a("#album-list")).liveDraggable({containment:[d.left,d.top,d.left+c+.25*c,d.top+b],refreshPositions:!0,revert:"invalid",helper:function(){var b=
a(this).clone().addClass("ui-draggable").css({position:"absolute"}).prependTo("#album-list > ul");b.find("a:first").append('<i class="icon10 no-bw" style="margin-left: 0; margin-right: 0; display:none;"></i>');return b},cursor:"move",cursorAt:{left:5},opacity:.75,zIndex:9999,distance:5,start:function(a,b){document.ondragstart=function(){return!1}},stop:function(){document.ondragstart=null}})},_initDropAlbums:function(){this._initDropBetweenAlbums();this._initDropInsideAlbums()},_initDropBetweenAlbums:function(){a("li.drag-newposition",
a("#album-list")).liveDroppable({accept:"li.dr",greedy:!0,tolerance:"pointer",over:function(b,d){if("IMG"==d.draggable.get(0).tagName)return!1;a(this).addClass("active").parent().parent().addClass("drag-active")},out:function(b,d){a(this).removeClass("active").parent().parent().removeClass("drag-active")},deactivate:function(b,d){var c=a(this);(c.is(":animated")||c.hasClass("dragging"))&&c.stop().animate({height:"0px"},300,null,function(){c.removeClass("dragging")});a(this).removeClass("active").parent().parent().removeClass("drag-active")},
drop:function(b,d){if("IMG"==d.draggable.get(0).tagName)return!1;var c=a(this).parent("ul");d=a(d.draggable);b=d.attr("rel");var e=a(this).prev("li");if(e.length&&e.attr("rel")==b&&!e.hasClass("ui-draggable")||this==d.next().get(0))return!1;c=c.parent("li").length?c.parent("li").attr("rel"):0;e=a(this).next();var f=null;e.length&&(f=e.attr("rel"));a.post("?module=album&action=move",{id:b,before_id:f,parent_id:c},function(b){var c=a.photos.getAlbum(),e=b.data.album,d=b.data.counters;0>=e.status&&a.photos_dragndrop.privateDescendants(e.id)&&
a.photos.dispatch("album/"+e.id+"/");c&&c.id==e.id&&((b=b.data.frontend_link)&&a("#photo-list-frontend-link").attr("href",b).text(b),e.type==Album.TYPE_DYNAMIC&&a.photos.load("?module=album&action=photos&id="+e.id,a.photos.onLoadPhotoList));if(!a.isEmptyObject(d))for(var f in d)d.hasOwnProperty(f)&&album_list.find("li[rel="+f+"]").find(".count:first").text(d[f])},"json");c=d.parent("ul");b=c.children("li.dr[rel!="+b+"]").length;d.next().insertAfter(a(this));d.insertAfter(a(this));b||(c.parent("li").children("i").remove(),
c.remove())}})},privateDescendants:function(b,d){d="boolean"===typeof d?d:!0;b=a("#album-list").find("li[rel="+b+"]");d=d?b:a();changed=!1;d.add(b.find("li.dr")).each(function(){var b=a(this).find(">a");if(!b.find("i.lock-bw").length){var e=b.find(".pictures").next();e.length?(changed=!0,e.before('<i class="icon10 lock-bw no-overhanging"></i>')):b.append('<i class="icon10 lock-bw no-overhanging"></i>')}});return changed},_initDropInsideAlbums:function(){a("li.dr a",a("#album-list")).liveDroppable({accept:function(a){return a.is("li.dr, img#photo")||
a.closest("li[data-photo-id]").length?!0:!1},tolerance:"custom",greedy:!0,out:function(b,d){a(this).parent().removeClass("drag-newparent");d.helper.find("span").show().end().find("i").hide()},over:function(b,d){b=a(this).parent();var c=!1;d.draggable=a.photos_dragndrop._fixUiDraggable(d.draggable);if(d.draggable.parents("#photo-list").length||d.draggable.is("#photo"))b.hasClass("static")?d.helper.find("span").show().end().find("i").hide():d.helper.find("span").hide().end().find("i").show(),c=!0;b.addClass("drag-newparent");
if(c)return!1;if(d.draggable.hasClass("static")&&!b.hasClass("static"))return d.helper.find("i.no-bw").show(),!1;d.helper.find("i.no-bw").hide();var e='.dr[rel!="'+a(d.draggable).attr("rel")+'"]',f=a(),g=function(a,b){if(0>=b.length)return a;a=a.add(b.nextUntil(e).filter("li.drag-newposition"));return 0<b.nextAll(e).length?a:g(a,b.parent().closest("li"))};d=b.prevAll(e).first();0<d.length?(c=d.find(e),f=0<c.length?g(f,c.last()):g(f,d)):f=f.add(b.prevUntil(e).filter("li.drag-newposition"));f=0<b.children("ul").children(e).length?
f.add(b.children("ul").children("li.drag-newposition:first")):g(f,b);var l=a(".drag-newposition:animated, .drag-newposition.dragging").not(f);l.stop().animate({height:"0px"},300,null,function(){l.removeClass("dragging")});f.stop().animate({height:"10px"},300,null,function(){f.addClass("dragging")})},drop:function(b,d){b=a(this).parent().removeClass("drag-newparent");d.draggable=a.photos_dragndrop._fixUiDraggable(d.draggable);if(d.draggable.parents("#photo-list").length||d.draggable.is("#photo")){var c=
this.href.match(/.*#\/album\/([\d]+)/);if(null===c||!parseInt(c[1],10)){console&&console.log("Link: "+this.href+" is not correct");return}c=parseInt(c[1],10);var e=null;b.hasClass("static")&&(e=d.draggable.is("#photo")?[a.photos.photo_stream_cache.getCurrent().id]:d.draggable.data("photo_ids"));e&&(a.photos.addToAlbums({photo_id:e,album_id:c}),a("#photo-list li.selected").trigger("select",!1));return!1}if(d.draggable.hasClass("static")&&!b.hasClass("static"))return!1;c=a(d.draggable);if(b.attr("rel")==
c.attr("rel"))return!1;b.hasClass("drag-newposition")?d=b.parent("ul"):b.children("ul").length?d=b.children("ul"):(d=a('<ul class="menu-v with-icons dr"><li class="drag-newposition"></li></ul>').appendTo(b),d.find(".drag-newposition").mouseover(),a('<i class="icon16 darr overhanging"></i>').insertBefore(b.children("a")));e=c.attr("rel");b=b.attr("rel");if(b==c.parent("ul").parent("li.dr").attr("rel"))return!1;a.post("?module=album&action=move",{id:e,parent_id:b},function(b){var c=a.photos.getAlbum(),
d=b.data.album,e=b.data.counters;0>=d.status&&a.photos_dragndrop.privateDescendants(d.id)&&a.photos.dispatch("album/"+d.id+"/");c&&c.id==d.id&&((b=b.data.frontend_link)&&a("#photo-list-frontend-link").attr("href",b).text(b),d.type==Album.TYPE_DYNAMIC&&a.photos.load("?module=album&action=photos&id="+d.id,a.photos.onLoadPhotoList));d=a("#album-list");if(!a.isEmptyObject(e))for(var f in e)e.hasOwnProperty(f)&&d.find("li[rel="+f+"]").find(".count:first").text(e[f])},"json");b=c.parent("ul");e=b.children("li.dr[rel!="+
e+"]").length;var f=c.next();c.appendTo(d);f.appendTo(d);e||(b.parent("li").children("i").remove(),b.remove())}})},_scrolHelper:function(b){b=a("#helper");var d=b.data("scrollTop"),c=a(document).scrollTop();d=d?c-d:50;b.css("top",b.position().top+d+"px");b.data("scrollTop",c)},_dropAnimation:function(b,d){var c=[];b.each(function(){var b=a(this),d=b.offset(),f=b.clone().css({"z-index":10,position:"absolute",top:d.top,left:d.left}).insertAfter(b);b.css({opacity:0});c.push(b.hide(300).promise());c.push(f.animate({top:d.top,
left:d.left},300).promise().done(function(){a(this).remove()}))});a.when.apply(a,c).done(function(){"function"===typeof d&&d()})},_shiftToLeft:function(b){if("left"!==b.data("shifted")){var d=b.find(".p-wrapper");if(!d.length){var c=b.children();d=a("<div class='p-wrapper' style='position:relative;'></div>").appendTo(b);d.append(c)}d.stop().animate({left:-15},200);b.data("shifted","left")}},_shiftToRight:function(b){if("right"!==b.data("shifted")){var d=b.find(".p-wrapper");if(!d.length){var c=b.children();
d=a("<div class='p-wrapper' style='position:relative;'></div>").appendTo(b);d.append(c)}d.stop().animate({left:15},200);b.data("shifted","right")}},_shiftAtPlace:function(a){if(a.data("shifted")){var b=a.find(".p-wrapper");if(b.length){var c=b.children();b.stop().css({left:0});a.append(c);b.remove()}a.data("shifted","")}},_bindExtDragActivate:function(b,d){a(document).bind("mousemove.ext_drag_activate",function(c){a.photos_dragndrop._extDragActivate(c,b,d)})},_unbindExtDragActivate:function(){a(document).unbind("mousemove.ext_drag_activate")},
_activatePhotoListItem:function(){var d=a(this),g=b(),c=g?"drag-active":"drag-active-disabled";g&&a.photos_dragndrop._shiftToRight(d);d.hasClass("last")?a.photos_dragndrop._bindExtDragActivate(d,c):d.addClass(c)},_unactivatePhotoListItem:function(d){d=a(this);var f=b(),c=f?"drag-active":"drag-active-disabled",e=c+"-last";d.hasClass("last")&&a.photos_dragndrop._unbindExtDragActivate();d.removeClass(c+" "+e);f&&a.photos_dragndrop._shiftAtPlace(d)},_extDragActivate:function(b,d,c){var e=c+"-last";if(d.hasClass("last")){var f=
b.pageX;b=b.pageY;var g=d.width(),l=d.height(),n=d.position();"template-photo-thumbs"==a.photos.list_template?f>n.left+.5*g&&f<=n.left+g?(d.removeClass(c).addClass(e),a.photos_dragndrop._shiftToLeft(d)):f>n.left&&f<=n.left+.5*g?(d.removeClass(e).addClass(c),a.photos_dragndrop._shiftToRight(d)):a.photos_dragndrop._shiftAtPlace(d):"template-photo-descriptions"==a.photos.list_template&&(b>n.top+.5*l?d.removeClass(c).addClass(e):b>n.top&&d.removeClass(e).addClass(c));(b<n.top||b>n.top+l||f<n.left||f>
n.left+g)&&d.removeClass(c).removeClass(e)}else d.addClass(c)},_fixUiDraggable:function(a){if(a.is("#photo"))return a;"IMG"==a.get(0).tagName&&(a=a.parents("li:first"));return a},_extendJqueryUIDragAndDrop:function(){a.fn.liveDraggable=function(b){this.each(function(b,c){b=a(this);b.data("init_draggable")&&b.die("mouseover",b.data("init_draggable"))});var c;this.live("mouseover",c=function(){var d=a(this);d.data("init_draggable")||d.data("init_draggable",c).draggable(b)})};a.fn.liveDroppable=function(b){this.each(function(b,
c){b=a(this);b.data("init_droppable")&&b.die("mouseover",b.data("init_droppable"))});var c=function(){var d=a(this);d.data("init_droppable")||(d.data("init_droppable",c).droppable(b),d.mouseover())};c.call(this);this.die("mouseover",c).live("mouseover",c);this.live("mouseover",c)};var b=a.ui.intersect;a.ui.intersect=function(d,c,e){a(d.element).is("#photo")||"custom"!=e||(e="pointer");if("custom"!=e)return b.call(a.ui,d,c,e);e=c.offset.left;var f=c.offset.top;d=d.helper.position();return a.ui.isOver(d.top,
d.left+a.photos_dragndrop.helper_shift,f,e,c.proportions.height,c.proportions.width)}}}})(jQuery);(function(a){var b=function(a,f){var d=/[^\w\-\.:]/.test(a)?new Function(b.arg+",tmpl","var _e=tmpl.encode"+b.helper+",_s='"+a.replace(b.regexp,b.func)+"';return _s;"):b.cache[a]=b.cache[a]||b(b.load(a));return f?d(f,b):function(a){return d(a,b)}};b.cache={};b.load=function(a){var b=document.getElementById(a),d=/<\\\/(\w+)/g;!b&&console&&console.log("template with id="+a+" not found");return b?("textarea"==b.tagName.toLowerCase()?b.value:document.getElementById(a).innerHTML).replace(d,"</$1"):null};
b.regexp=/([\s'\\])(?![^%]*%\})|(?:\{%(=|#)([\s\S]+?)%\})|(\{%)|(%\})/g;b.func=function(a,b,g,c,e,h){if(b)return{"\n":"\\n","\r":"\\r","\t":"\\t"," ":" "}[a]||"\\"+a;if(g)return"="===g?"'+_e("+c+")+'":"'+("+c+"||'')+'";if(e)return"';";if(h)return"_s+='"};b.encReg=/[<>&"'\x00]/g;b.encMap={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&#39;"};b.encode=function(a){return String(a||"").replace(b.encReg,function(a){return b.encMap[a]||""})};b.arg="o";b.helper=",print=function(s,e){_s+=e&&(s||'')||_e(s);},include=function(s,d){_s+=tmpl(s,d);}";
"function"===typeof define&&define.amd?define(function(){return b}):a.tmpl=b})(this);(function(a){a.fn.inlineEditable=function(b,d){function f(){l(a(this))||a(this).addClass(m.placeholderClass).text(m.placeholder)}function g(){r="edit";this.id=this.id||(""+Math.random()).slice(2);var b=this.id+"-input",d=a("#"+b);d.length||(p.after(e(b)),d=a("#"+b));h(d,p);m.placeholder&&l(a(this))==m.placeholder&&l(a(p))==m.placeholder&&a(p).text("").removeClass(m.placeholderClass);m.beforeMakeEditable.call(this,d);q=m.truncate?p.data("real_text"):l(p);d.val(q).show().focus();p.hide();a(m.editLink).hide();
if(!n){b=[];for(var f=[],g=0,k=m.makeReadableBy.length;g<k;++g){var v=m.makeReadableBy[g];"blur"==v&&d.blur(function(){"read"!=r&&c.call(this)});"enter"==v&&b.push(13);"esc"==v&&b.push(27)}g=0;for(k=m.updateBy.length;g<k;++g)v=m.updateBy[g],"alt+enter"==v&&f.push({ctrl:!1,alt:!0,shift:!1,key:13}),"ctrl+enter"==v&&f.push({ctrl:!0,alt:!1,shift:!1,key:13}),"ctrl+s"==v&&f.push({ctrl:!0,alt:!1,shift:!1,key:17});b.length&&function(a){d.keydown(function(b){!~a.indexOf(b.keyCode)||b.ctrlKey||b.altKey||b.shiftKey||
"read"!=r&&c.call(this,27==b.keyCode?q:null);if(f.length)for(var d in f){var e=f[d];if(b.keyCode==e.key&&b.ctrlKey==e.ctrl&&b.altKey==e.alt&&b.shiftKey==e.shift){p.trigger("readable");break}}})}(b);p.bind("readable",function(b,d){"read"!=r&&(b=a("#"+(this.id+"-input")),c.call(b,b.val(),d))});n=!0}}function c(b,c){c="undefined"===typeof c?!1:!0;void 0!=b&&null!=b?a(this).val(b):b=a(this).val();if(!1!==c||!1!==m.beforeBackReadable.call(p.get(0),this,{changed:b!=q,old_text:q,new_text:b})){r="read";var d;
(d=!m.placeholder)||(a(this).val()?d=!1:(a(p).text(m.placeholder).addClass(m.placeholderClass),d=!0),d=!d);if(d&&(m.allowEmpty||b)){if(m.truncate)p.data("real_text",b),p.text(b.length<m.truncate-3?b:b.substr(0,m.truncate-3)+"...");else{d=p;var e=b;m.html?d.html(e):d.text(e)}b||f.call(this)}p.show();a(this).hide();a(m.editLink).show();!1===c&&m.afterBackReadable.call(p.get(0),this,{changed:b!=q,old_text:q})}}function e(a){switch(m.inputType){case "textarea":return'<textarea id="'+a+'" style="display:none;"></textarea>';
default:return'<input type="text" id="'+a+'" style="display:none;">'}}function h(a,b){var c=m.size.height||b.height();b=m.size.width||1.5*b.width();c=m.minSize.height&&c<m.minSize.height?m.minSize.height:c;b=m.minSize.width&&b<m.minSize.width?m.minSize.width:b;c=m.maxSize.height&&c>m.maxSize.height?m.maxSize.height:c;b=m.maxSize.width&&b>m.maxSize.width?m.maxSize.width:b;a.height(c);a.width(b)}function k(a){return function(){return a}}function l(a){return m.html?a.html():a.text()}var n=!1;if("string"==
typeof b){if("setOption"==b){var m=this.data("inlineEditableSettings")||{};a.extend(!0,m,d);"undefined"!==typeof d.hold&&"function"!==typeof d.hold&&(m.hold=k(m.hold));this.data("inlineEditableSettings",m)}return this}d=this.data("inlineEditableSettings");this.data("inlineEditableSettings",a.extend({inputType:"text",size:{height:null,width:null},minSize:{height:null,width:null},maxSize:{height:null,width:null},editLink:null,editOnItself:!0,placeholder:null,makeReadableBy:["blur","enter","esc"],updateBy:["ctrl+enter",
"alt+enter"],beforeBackReadable:function(){},afterBackReadable:function(){},beforeMakeEditable:function(){},placeholderClass:"hint",truncate:!1,hold:!1,html:!1,allowEmpty:!1},d,b||{}));m=this.data("inlineEditableSettings");var p=this,r="read",q="";"function"!==typeof m.hold&&(m.hold=k(m.hold));(function(){if(!this.data("inited")){m.truncate&&"boolean"==typeof m.truncate&&(m.truncate=255);if(m.truncate){var b=m.placeholder&&m.placeholder===this.text()?"":this.text();this.data("real_text",b);this.text(b.length<
m.truncate-3?b:b.substr(0,m.truncate-3)+"...")}m.placeholder&&f.call(this);m.editLink&&a(m.editLink).click(function(){m.hold.call(p)||"edit"!=r&&g.call(p.get(0))});m.editOnItself&&this.click(function(){m.hold.call(p)||"edit"!=r&&g.call(this)});this.bind("editable",function(){m.hold.call(p)||"edit"!=r&&g.call(this)});this.bind("placeholder",function(b,c){c&&m.placeholder&&f.call(this);c||a(this).removeClass(m.placeholderClass)});this.data("inited",!0)}}).call(this);return this}})(jQuery);(function(a){a.fn.activeMenu=function(b,d,f){if("string"==typeof b){if("disable"==b||"enable"==b)return a.isArray(d)||(d=[d]),this.find("li").each(function(){var c=a(this);~d.indexOf(c.attr("data-action"))&&("disable"==b?c.hide():c.show())}),this;if("setOption"==b){var g=this.data("activeMenuSettings");if(!g)return;if("string"===typeof d){var c={};c[d]=f;d=c}a.extend(g,d);return this}}if("string"==typeof b&&"fire"==b){g=this.data("activeMenuSettings");if(!g)return;g["on"+b.substr(0,1).toUpperCase()+
b.substr(1)].call(this);return this}this.data("activeMenuSettings",a.extend({beforeAnyAction:function(){},defaultAction:function(){},onInit:function(){},onFire:function(){}},b||{}));if(g=this.data("activeMenuSettings"))return function(){var b=this;this.data("inited")||(this.bind("click.photos-active-menu",function(c){for(var d=c.target,e=b.get(0);"LI"!=d.tagName;){if(d==e)return;d=a(d).parent().get(0)}d=a(d);e=d.attr("data-action")||"default";e=e.split("-");for(var f=1;f<e.length;f++)e[f]=e[f][0].toUpperCase()+
e[f].slice(1);e=e.join("");e+="Action";g[e]&&"function"==typeof g[e]||(e="defaultAction");if(!1!==g.beforeAnyAction(d.attr("data-action")))g[e](d,c);c.preventDefault()}),g.onInit(this),this.data("inited",!0))}.call(this),this}})(jQuery);(function(a){a.fn.rateWidget=function(b,d,f){function g(b){var c=0;this.find("i").removeClass("star star-empty star-half star-hover").addClass("star-empty").each(function(){if(c==b)return!1;c++;c>b?.5==c-b&&a(this).removeClass("star-empty").addClass("star-half"):a(this).removeClass("star-empty").addClass("star")});this.attr("data-rate",b)}function c(a){return function(){return a}}if("string"==typeof b){if("getOption"==b&&"rate"==d)return parseInt(this.attr("data-rate"));if("setOption"==b&&("rate"==
d&&(b=parseFloat(f)||0,g.call(this,Math.round(2*b)/2),d={rate:f}),"object"===typeof d&&d)){var e=this.data("rateWidgetSettings")||{};a.extend(e,d);"undefined"!==typeof d.hold&&"function"!==typeof d.hold&&(e.hold=c(e.hold))}return this}this.data("rateWidgetSettings",a.extend({onUpdate:function(){},rate:null,hold:!1,withClearAction:!0,alwaysUpdate:!1},b||{}));e=this.data("rateWidgetSettings");var h=this;"function"!==typeof e.hold&&(e.hold=c(e.hold));(function(){if(!this.data("inited")){null!=e.rate&&
h.attr("data-rate",e.rate);h.find("i:lt("+h.attr("data-rate")+")").removeClass("star-empty").addClass("star");h.mouseover(function(b){e.hold.call(h)||(b=b.target,"I"==b.tagName&&(b=a(b),b.prevAll().removeClass("star star-half star-empty").addClass("star-hover").end().removeClass("star star-half star-empty").addClass("star-hover"),b.nextAll().removeClass("star star-hover").addClass("star-empty")))}).mouseleave(function(){e.hold.call(h)||g.call(h,h.attr("data-rate"))});h.click(function(b){if(!e.hold.call(h)){for(var c=
b.target;"I"!=c.tagName;)if(c==this)return;var d=h.attr("data-rate"),f=0;h.find("i").removeClass("star star-hover").addClass("star-empty").each(function(){f++;a(this).removeClass("star-empty").addClass("star");if(this==c){if(e.alwaysUpdate||d!=f)h.attr("data-rate",f),e.onUpdate(f);return!1}})}});if(e.withClearAction){var b="clear-"+a(this).attr("id"),c=a("#"+b);c.length||(h.after('<a href="javascript:void(0);" class="inline-link p-rate-clear" id="'+b+'" style="display:none;"><b><i>'+$_("clear")+"</b></i></a>"),
c=a("#"+b));c.click(function(){if(!e.hold.call(h)){var a=h.attr("data-rate");g.call(h,0);if(0!=a)e.onUpdate(0)}});var d;h.parent().mousemove(function(){e.hold.call(h)||(d&&clearTimeout(d),c.show(0))}).mouseleave(function(){d=setTimeout(function(){e.hold.call(h)||c.hide(0)},150)})}this.data("inited",!0)}}).call(this);return this}})(jQuery);var PhotoStream=function(){var a=function(a){this._options=a||{};this._onClear=this._options.onClear||function(){};this._photo_stream=[]};$.extend(a.prototype,{getById:function(a){for(var b=0,f=this._photo_stream[0],g=this._photo_stream.length;b<g;f=this._photo_stream[++b])if(f&&f.id==a)return f;return null},updateById:function(a,d,f){if(a=this.getById(a))return $.extend(a,d),a;f&&this._photo_stream.push(d);return d},deleteById:function(a){$.isArray(a)||(a=[a]);var b=a,f=0,g=b.length;for(a=b[0];f<
g;a=b[++f])(a=this.getById(a))&&a.index&&delete this._photo_stream[a.index];b=[];var c=0;f=0;g=this._photo_stream.length;for(a=this._photo_stream[0];f<g;a=this._photo_stream[++f])a&&(a.index=c++,b.push(a));this._photo_stream=b;return this},replace:function(a,d){a=a.index;this._photo_stream[a]=d;d.index=a;return this},push:function(a){this._photo_stream.push(a);a.index=this._photo_stream.length-1;return this},getNext:function(a){a=a||this.current;"object"!=typeof a&&(a=this.getById(a));if(!a)return null;
a=a.index+1;return this._photo_stream[a]?this._photo_stream[a]:null},getPrev:function(a){a=a||this.current;"object"!=typeof a&&(a=this.getById(a));if(!a)return null;a=a.index-1;return this._photo_stream[a]?this._photo_stream[a]:null},setCurrent:function(a){if(!a.index&&(a=this.getById(a.id),!a||"number"!==typeof a.index&&!a.index))throw Error("This photo is not in stream");this.current=a;return this},setCurrentById:function(a){a=this.getById(a);"object"===typeof a&&a&&this.setCurrent(a);return this},
getCurrent:function(){return this.current},getCurrentId:function(){return"object"===typeof this.current&&this.current?this.current.id:null},set:function(a){this._photo_stream=[];this.append(a);this.isEmpty()||this.setCurrent(this.getFirst());return this},append:function(a){for(var b=0,f=a[b],g=this._photo_stream.length,c=a.length;b<c;f=a[++b],++g)f.index=g,this._photo_stream.push(f);return this},prepend:function(a){var b=this._photo_stream||[];this._photo_stream=[];for(var f=0,g=a[f],c=a.length;f<
c;g=a[++f])g.index=f,this._photo_stream.push(g);this.append(b);return this},clear:function(){this._photo_stream=[];this._onClear();return this},length:function(){return this._photo_stream.length},getAll:function(){return this._photo_stream},getFirst:function(){return this._photo_stream[0]},getLast:function(){return this._photo_stream[this._photo_stream.length-1]},isFirst:function(a){return a&&0==a.index},isLast:function(a){return a&&a.index==this._photo_stream.length-1},isEmpty:function(){return!this._photo_stream.length},
getCurrentIndex:function(){return this.current.index},slice:function(a,d){return this._photo_stream.slice(a,d)},move:function(a,d){var b=[],g=this._photo_stream;if($.isArray(a))for(var c=0,e=a.length;c<e;++c){var h=this.getById(a[c]);delete g[h.index];b.push(h)}else h=this.getById(a),delete g[h.index],b.push(h);if(b.length)for(h="undefined"===typeof d||null===d?this._photo_stream.length:(h=this.getById(d))?h.index:0,Array.prototype.splice.apply(g,[h,0].concat(b)),this.clear(),c=b=0,e=g.length;c<e;++c)h=
g[c],"object"===typeof h&&h&&(h.index=b++,this._photo_stream.push(h))}});return a}();Date.parseISO=function(a){var b=Date.parse(a);if(!isNaN(b))return b;a=a.match(/([0-9]{4})-([0-9]{2})-([0-9]{2}) ([0-9]{2}):([0-9]{2}):([0-9]{2})/);b=new Date(a[1],0,1);a[2]&&b.setMonth(a[2]-1);a[3]&&b.setDate(a[3]);a[4]&&b.setHours(a[4]);a[5]&&b.setMinutes(a[5]);a[6]&&b.setSeconds(a[6]);return+b};
function replaceImg(a,b,d,f){f=f||a.attr("id")||(""+Math.random()).slice(2);replaceImg.loading_map=replaceImg.loading_map||{};replaceImg.loading_map[f]=b;a.unbind("load");null===d?a.attr("src",b):$("<img>").attr("src",b).load(function(){setTimeout(function(){replaceImg.loading_map[f]==b&&(a.attr("src",b),"function"==typeof d&&d.call(a));$(this).remove()},100)});return f}
String.prototype.truncate=function(a,b){var d="";if("undefined"===typeof b||b)d=this.replace(/<\/?[\s\S]+?\/?>/g,"");d.length>a-3&&3<a&&(d=d.substr(0,a-3)+"...");return d};function parseSize(a){var b="unknown";a=(""+a).split("x");var d=a[0]&&0!=a[0]?a[0]:null,f=a[1]&&0!=a[1]?a[1]:null;1==a.length?(b="max",f=d):d==f?b="crop":d&&f?b="rectangle":null===d?b="height":null===f&&(b="width");return{type:b,width:d,height:f}}
function getRealSizesOfThumb(a,b){var d=parseInt(a.width,10),f=parseInt(a.height,10),g=d/f,c=f/d;if(isNaN(g)||isNaN(c))return null;var e="object"!==typeof b?parseSize(b):b;var h=e.width;b=e.height;switch(e.type){case "max":d>f?(g=h,c*=g):(c=h,g*=c);break;case "crop":g=c=h;break;case "rectangle":g=h;c=b;break;case "width":g=h;c*=g;break;case "height":c=b;g*=c;break;default:g=c=null}g=Math.round(g);c=Math.round(c);return d<g&&f<c?{width:a.width,height:a.height}:{width:g,height:c}};(function(a){a.fn.photoStreamSlider=function(b){var d=a.extend({duration:200},b||{}),f=this;(function(){function b(g){function h(){b.execution=!1;var a="on"+m.charAt(0).toUpperCase()+m.slice(1);a=d[a];"function"==typeof a&&a.call(f);a=g.fn;"function"==typeof a&&a.call(f)}"string"==typeof g&&(g={direction:g,animate:!0});var m=g.direction||"forward",n=g.steps||e.length;if(!b.execution){b.execution=!0;var r=e.filter(":first").outerWidth()*n,q=e.length;if("forward"==m){var t=e.filter(":last").nextAll(":lt("+
n+")");n=t.length;t=t.filter(":last");n&&(e.removeClass("visible"),t.prevAll(":lt("+(q-1)+")").addClass("visible"),t.addClass("visible"))}else t=e.filter(":first").prevAll(":lt("+n+")"),n=t.length,t=t.filter(":last"),n&&(e.removeClass("visible"),t.nextAll(":lt("+(q-1)+")").addClass("visible").show(),t.addClass("visible"));e=a("li.visible",c);q=c.position().left;"forward"==m?(n=l-k-p,q-=r,q=q>-n?q:-n):(q+=r,q=q<p?q:p);g.animate?c.animate({left:q},d.duration,h):(c.css({left:q}),h())}}var c=f.find(d.photoStream),
e=a("li.visible",c),h=a("li",c),k=e.filter(":first").outerWidth()*e.length,l=h.filter(":first").outerWidth()*h.length,n=h.filter(":first").outerHeight();c.parent().css({overflow:"hidden",height:n,position:"relative",padding:"4px 0",margin:0,width:k});n=c.find("li:first");var m=e.filter(":first"),p=(m.outerWidth()-m.width())/2,r=0,q=n.outerWidth();for(m=m.get(0);n.length&&n.get(0)!=m;)r+=q,n=n.next();c.css({position:"absolute",left:-(r-p),width:l});a(d.forwardLink).click(function(){b("forward");return!1});
a(d.backwardLink).click(function(){b("backward");return!1});f.bind("append prepend",function(b,d){if("append"==b.type){for(var e=c.find("li:last"),g=a();e.hasClass("dummy");)g=g.add(e),e=e.prev("li");g.remove();c.append(d)}else{e=a("<div></div>").html(d);d=e.find("li");var k=d.length*q;e.remove();e=c.find("li:first");for(g=a();e.hasClass("dummy");)g=g.add(e),e=e.next("li");g.remove();c.prepend(d)}h=c.find("li");l=h.filter(":first").outerWidth()*h.length;c.css("width",l);"prepend"==b.type&&(c.is(":animated")&&
c.stop(!1,!0),c.css("left",parseInt(c.css("left"))-k));c.find("li.selected").hasClass("visible")&&f.trigger("home",[null,!1])});f.bind("forward backward",function(a,d){b({direction:a.type,steps:d.steps,animate:"undefined"!==typeof d.animate?d.animate:!0,fn:d.fn});d=c.find("li.selected");a="forward"==a.type?d.next("li:not(.dummy)"):d.prev("li:not(.dummy)");a.length&&(d.removeClass("selected"),a.addClass("selected"))});f.bind("home",function(c,d,f){c=parseInt(e.length/2);c=e.filter(":eq("+c+")");var g=
c.nextAll(".selected:first"),h=c.prevAll(".selected:first"),k=0,l="";"function"!==typeof d&&(f=d);f="undefined"!==typeof f?f:!0;g.length?(l="forward",c.nextAll().each(function(){++k;if(a(this).hasClass("selected"))return!1})):h.length&&(l="backward",c.prevAll().each(function(){++k;if(a(this).hasClass("selected"))return!1}));l&&k?b({direction:l,steps:k,fn:d,animate:f}):"function"==typeof d&&d();return!1})})()}})(jQuery);(function(a){a.storage=new a.store;a.photos={namespace:".photos",load_from_hash:0,hash:"",raw_hash:"",options:{},shift_next:!1,anchor:"",album:null,total_count:null,photos_per_page:null,list_template:"template-photo-thumbs",photo_list_string:{},init:function(b){"undefined"!=typeof a.History&&(a.History.bind(function(){a.photos.dispatch()}),a.History.unbind=function(b,f){f?a.History.handlers.specific[b]&&a.each(a.History.handlers.specific[b],function(d,c){if(c===f)return a.History.handlers.specific[b].splice(d,
1),!1}):(f=b,a.each(a.History.handlers.generic,function(b,c){if(c===f)return a.History.handlers.generic.splice(b,1),!1}))},a.History.one=function(b,f){f||(f=b,b=null);var d=function(){f.call(this);a.History.unbind.apply(a.History,b?[b,d]:[d])};a.History.bind.apply(a.History,b?[b,d]:[d])});a.wa.errorHandler=function(b){a.storage.del("photos/hash");return 403===b.status?(a("#content").html('<div class="content left'+a.photos_sidebar.width+'px"><div class="block double-padded">'+b.responseText+"</div></div>"),
!1):a.photos.load_from_hash?(a.wa.setHash("#/"),!1):!0};this.options=b;(b=window.location.hash||a.storage.get("photos/hash"))&&b!=window.location.hash?(this.load_from_hash=2,a.wa.setHash("#/"+b)):this.dispatch()},dispatch:function(b){if(a.photos.ignore_dispatch)a.photos.ignore_dispatch--;else if(a.photos.hash="",void 0==b&&(b=window.location.hash),b=b.replace(/^[^#]*#\/*/,""),a.photos.raw_hash=b)if(b=b.split("/"),b[0]){for(var d="",f=b.length,g=0;g<b.length;g++){var c=b[g];if(2>g)if(0===g)d=c;else if("tag"==
d||"search"==d||"plugins"==d||"pages"==d||"app"==d){f=g;break}else if(parseInt(c,10)!=c&&-1==c.indexOf("="))d+=c.substr(0,1).toUpperCase()+c.substr(1);else{f=g;break}else{f=g;break}}f=b.slice(f);a.photos.hash="/"+b.slice(0,2).join("/");~a.photos.hash.indexOf("photo")&&(a.photos.hash="");this.beforeAnyAction(d,f);this[d+"Action"]?(this.load_from_hash&&this.load_from_hash--,this[d+"Action"].apply(this,f),a.storage.set("photos/hash",a.photos.hash)):(a.storage.del("photos/hash"),console&&console.log("Invalid action name:",
d+"Action"))}else this.beforeAnyAction(),this.defaultAction();else this.beforeAnyAction(),this.defaultAction()},ignore_dispatch:0,forceHash:function(b){b!=window.location.hash&&(a.photos.ignore_dispatch=1,window.location.hash=b)},menu:{stack:{list:[],photo:[]},extend_stack:{list:[],photo:[]},register:function(a,d,f){this.stack[a]&&this.stack[a].push(new ToolbarMenu(d,f))},get:function(b,d){if(this.stack[b]&&a.isArray(this.stack[b]))for(var f=0;f<this.stack[b].length;f++)if(this.stack[b][f].is(d))return this.stack[b][f];
return null},init:function(a){var b;if(this.stack[a]){for(;b=this.extend_stack[a].shift();)for(var f=0;f<this.stack[a].length;f++)if(this.stack[a][f].is(b.selector)){for(var g in b.actions)this.stack[a][f].setAction(g,b.actions[g]);break}for(f=0;f<this.stack[a].length;f++)this.stack[a][f].init()}},enable:function(a,d,f){d=d||"*";if(this.stack[a])for(var b=0;b<this.stack[a].length;b++){var c=this.stack[a][b];d&&!c.is(d)||c.enable(f)}},disable:function(a,d,f){d=d||"*";if(this.stack[a])for(var b=0;b<
this.stack[a].length;b++){var c=this.stack[a][b];d&&!c.is(d)||c.disable(f)}},extend:function(a,d,f){this.stack[a]&&this.extend_stack[a].push({selector:d,actions:f});return this}},setOption:function(a,d){this.options[a]=d},getOption:function(a){return this.options[a]},beforeAnyAction:function(){},initClearance:function(){a.photos.toggleFullScreen();a.photos.highlightSidebarItem();a.photos.hotkey_manager.unset();a.photos.unsetLazyLoad();a.photos.photo_stream_cache.clear();a.photos.photo_stack_cache.clear();
delete a.photos.photo_stream_cache.hash},defaultAction:function(){window.location.hash||!a("#album-list ul li.dr").length?(a.storage.set("photos/hash","photos/"),this.photosAction()):(a.storage.set("photos/hash","albums/"),this.albumsAction())},photosAction:function(){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=photo&action=list",a.photos.onLoadPhotoList)})},albumsAction:function(){a.photos.loadDispatch(arguments,function(){a.photos.load("?action=albums")})},albumAction:function(b){a.photos.loadDispatch(arguments,
function(){a.photos.load("?module=album&action=photos&id="+b,a.photos.onLoadPhotoList)})},searchAction:function(b){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=search&action=photos",{q:b},a.photos.onLoadPhotoList)})},tagAction:function(b){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=tag&action=photos&tag="+b,a.photos.onLoadPhotoList)})},appAction:function(b){a.photos.loadDispatch(arguments,function(){a.photos.load("?module=photo&action=list&app_id="+b,a.photos.onLoadPhotoList)})},
settingsAction:function(){a.photos.initClearance();a.photos.load("?module=settings",a.photos.onLoadSettings)},pagesAction:function(b){a("#wa-page-container").length?waLoadPage(b):(a.photos.initClearance(),a.photos.load("?module=pages",a.photos.onLoadPages,'<div class="content left'+a.photos_sidebar.width+'px"></div>'))},designAction:function(b){a.photos.initClearance();b?a("#wa-design-container").length?(a.photos.setTitle($_("Themes")),a.photos.scrollTop(),waDesignLoad()):a.photos.load("?module=design",
function(){waDesignLoad(b);a.photos.setTitle($_("Themes"));a.photos.scrollTop()},'<div class="content left'+a.photos_sidebar.width+'px"></div>'):a.photos.load("?module=design",function(){waDesignLoad("");a.photos.setTitle($_("Design"));a.photos.scrollTop()},'<div class="content left'+a.photos_sidebar.width+'px"></div>')},designThemesAction:function(b){a.photos.initClearance();a("#wa-design-container").length?(a.photos.setTitle($_("Themes")),a.photos.scrollTop(),waDesignLoad()):a.photos.load("?module=design",
function(){waDesignLoad();a.photos.setTitle($_("Themes"));a.photos.scrollTop()},'<div class="content left'+a.photos_sidebar.width+'px"></div>')},pluginsAction:function(b){a.photos.initClearance();a("#p-sidebar li.selected").removeClass("selected");a("#p-sidebar #sidebar-plugins").addClass("selected");a("#wa-plugins-container").length?a.plugins.dispatch("#/plugins/"+b):a.photos.load("?module=plugins")},photoAction:function(b){a.photos.loadPhoto(b)},loadDispatch:function(b,d){for(var f=Array.prototype.slice.call(b,
1),g=0;g<f.length;g++)if("photo"==f[g]&&g<f.length-1){this.loadPhoto(f[g+1]);return}"function"==typeof d&&d(b[0]);a.photos.initClearance()},onLoadSettings:function(){a.photos.setTitle($_("Settings"));a.photos.scrollTop()},onLoadPlugins:function f(d){a.photos.setTitle($_("Plugins"));a("#plugins-settings-form").submit(function(){a("#plugins-settings-form-status").fadeIn(400);a("#plugins-settings-iframe").one("load",function(){var g=a.parseJSON(a(this).contents().find("body").html());a("#plugins-settings-form-status").fadeOut(200,
function(){"ok"==g.status?a.photos.loadPluginSettings(d,f):(a("#plugins-settings-form-status").html(g.errors?g.errors:g).css("color","red"),a("#plugins-settings-form-status").fadeIn("slow"))})})});a.photos.scrollTop()},onLoadPages:function(){a.photos.setTitle($_("Pages"));a.photos.scrollTop()},renderPhotoList:function(){var d=a("#photo-list");d.empty();a.photos.renderPhotoListChunk(d,0);a.photos.photo_stream_cache.length()&&(!a.photos.total_count||a.photos.total_count>a.photos.photo_stream_cache.length())&&
a.photos.setLazyLoad()},renderPhotoListChunk:function(d,f,g,c){var e=a.photos.options.photo_list_render_chunk||10,h=a.photos.photo_stream_cache.length();g=g||{};g.hide_name||(g.hide_name=a.storage.get("photos/list/hide_name",!1));e=a.photos.photo_stream_cache.slice(f,f+=e);e={photos:e,hash:a.photos.hash,last_login_time:a.photos.options.last_login_time,options:g,selected:!!a("#selector-menu").find("[data-action=select-photos]").data("checked"),view:(a.photos.list_template||"").replace("template-photo-",
"")};d.append(tmpl(a.photos.list_template,e));a("#content").trigger("photos_list_chunk_render",[e]);if(f<h)setTimeout(function(){a.photos.renderPhotoListChunk(d,f,g,c)},100);else if("function"==typeof c&&c(),e=g.string||a.photos.photo_list_string||!1)a(".lazyloading-wrapper").html(tmpl("template-photo-counter",{count:h,total_count:a.photos.total_count,string:e})),a.photos.photo_list_string=e;a.Retina&&a.photos.options.retina_2x_enabled&&d.find("img").retina()},selectPhotoListView:function(d){d=d.replace(/-view$/,
"");a.photos.list_template="template-photo-"+d;var f=a.photos.getAlbum();f&&("thumbs"==d?a.storage.del("photos/list/view/"+f.id):a.storage.set("photos/list/view/"+f.id,d));a.photos.menu.enable("list","."+d+"-view-menu");a.photos.menu.disable("list",":not(."+d+"-view-menu)");f=a("#photo-list");f.removeClass(f.attr("class"));switch(d){case "thumbs":f.addClass("thumbs li250px");break;case "descriptions":f.addClass("p-descriptions")}a("#p-block .p-content-control li.selected").removeClass("selected");
a('#p-block .p-content-control a[data-action="'+d+'-view"]').parents("li").addClass("selected")},onLoadPhotoList:function(){var d=a.photos.getAlbum(),f=null;if(d){f=a.storage.get("photos/list/view/"+d.id);"thumbs"!=f&&"descriptions"!=f&&(f="thumbs");var g=a("#album-list li[rel="+d.id+"]");g.find(".count:first").text(d.count);g.find(".count-new:first").text("");a("#album-list-container").trigger("uncollapse_section",g);if(d.edit_rights)a("#photo-list").on("click",".make-key-photo-link",function(){a("#photo-list .key-photo").removeClass("key-photo");
$li=a(this).closest("li").addClass("key-photo");d.key_photo_id=$li.data("photo-id");a.post("?module=album&action=keyPhoto",{album_id:d.id,photo_id:d.key_photo_id})})}f||(f="thumbs");a("#template-photo-"+f).length?(a.photos.list_template="template-photo-"+f,a.photos.renderPhotoList(),a.photos.fixRightToolbar(),a.photos.setTitle(a("#photo-list-name").text()),a.photos.menu.init("list"),a.photos.selectPhotoListView(f),a.Retina&&a.photos.options.retina_2x_enabled&&a("#album-thumbs-list img").retina(),
a("#p-block .p-content-control li a.album-view").click(function(){var c=a(this).attr("data-action");c!=f&&(f=c.replace(/-view$/,""),a.photos.list_template="template-photo-"+f,a.photos.renderPhotoList(),a.photos.selectPhotoListView(f));return!1}),a("#photo-list .p-description div").live("click",function(){a(this);a(this).height();var c=$_("add description");a(this).inlineEditable({inputType:"textarea",makeReadableBy:["esc"],updateBy:["ctrl+enter"],placeholder:c,placeholderClass:"gray",minSize:{height:40},
html:!0,allowEmpty:!0,beforeMakeEditable:function(c){var d=a(this),e=d.parent().find(".full-description:first").html(),f=d.css("font-size"),g=d.css("line-height");c.css("font-size",f).css("line-height",g);d.html(e);e=Math.max(d.parents("li:first").find("img").width(),d.width());c.width(e);e=this.id+"-button";f=a("#"+e);f.length||(c.after('<br><input type="button" id="'+e+'" value="'+$_("Save")+'"> <em class="hint" id="'+this.id+'-hint">Ctrl+Enter</em>'),a("#"+e).click(function(){d.trigger("readable")}));
a("#"+this.id+"-hint").show();f.show()},afterBackReadable:function(c,d){var e=a("#"+(this.id+"-button")),f=a(this);c=a(c).val();var g=f.parents("li:first").find(".p-image a").attr("href");g=/(\d+)[\/]*$/.exec(g);var h=null;e.hide();a("#"+this.id+"-hint").hide();c?(f.text(c.truncate(255)),f.parent().find(".full-description:first").html(c)):f.parent().find(".full-description:first").html("");g&&d.changed&&(h=g[1],a.photos.saveField({id:h,type:"photo",name:"description",value:c,fn:function(){}}))},hold:function(){return!this.hasClass("editable")}}).trigger("editable")}),
g=a("#photo-list-name"),g.hasClass("editable")&&g.inlineEditable({minSize:{width:350},maxSize:{width:600},size:{height:30},afterBackReadable:function(c,d){if(!d.changed)return!1;c=a(c).val();(d=a.photos.getAlbum())&&a.photos.saveField({id:d.id,type:"album",name:"name",value:c,fn:function(c){"ok"==c.status&&(c=c.data.album,a("#album-list li[rel="+c.id+"] > a > .album-name").html(c.name),a("#p-upload-step2 select[name=album_id] option[value="+c.id+"]").html(c.name),a.photos.setTitle(c.not_escaped_name))}})},
hold:function(){return!this.hasClass("editable")}}),g=a("#photo-album-note"),g.hasClass("editable")&&g.inlineEditable({placeholder:"("+$_("subtitle")+")",placeholderClass:"gray",minSize:{width:350},maxSize:{width:600},size:{height:22},afterBackReadable:function(c,d){if(!d.changed)return!1;c=a(c).val();(d=a.photos.getAlbum())&&a.photos.saveField({id:d.id,type:"album",name:"note",value:c})},hold:function(){return!this.hasClass("editable")}}),a("#share-menu-block, #organize-menu-block").bind("recount",
function(){var c=a("#photo-list li.selected").length;0<c?a(".count:first",a(this)).text(c).show():a(".count:first",a(this)).hide()}),a("#p-album-settings").click(function(){var c=a.photos.getAlbum(),d=c?c.id:0;c=a("#album-settings-dialog-acceptor");c.length||(c=a("<div id='album-settings-dialog-acceptor'></div>"),a("body").append(c));c.load("?module=dialog&action=albumSettings&id="+d,function(){a("#album-settings-dialog").waDialog({onSubmit:function(c){var e=a(this);c.trigger("change_loading_status",
!0);a.post(e.attr("action"),e.serializeArray(),function(e){if("ok"==e.status){var f=function(d){a.post("?module=album&action=savePhotosAccess",d,function(){d.offset+=l;d.offset<=g?f(d):(c.trigger("change_loading_status",!1),location.reload())})},g=e.data.total_count,h=e.data.status,k=e.data.groups,l=e.data.count;e=l;l<g?f({id:d,status:h,groups:k,count:l,offset:e}):(c.trigger("change_loading_status",!1),location.reload())}else if("fail"==e.status)for(h in c.trigger("change_loading_status",!1),e=e.errors,
e)e.hasOwnProperty(h)&&c.find("input[name="+h+"]").addClass("error").parent().find(".errormsg").text(e[h])},"json");return!1}})});return!1}),a("#p-album-delete").click(function(){var c=a.photos.getAlbum(),d=c?c.id:0;a.photos.confirmDialog({url:"?module=dialog&action=confirmDeleteAlbum&id="+d,onSubmit:function(c){var e=parseInt(a("input[name=delete-photos]:checked",c).val()),f;(f=a("input[name=delete-offspring]:checked",c).val())?(f=f.split(",").reverse(),f.push(d)):f=[d];c.trigger("close");a.photos.setCover();
a.photos.deleteAllAlbums(f,e,function(){a.photos.unsetCover()});return!1}});return!1}),a("#photo-list").find(".p-description textarea, .p-photo-details textarea, .p-photo-details input").live("select",function(){return!1}),a.photos.hotkey_manager.set("rate"),a.photos.hash!=a.photos.photo_stream_cache.hash&&a.photos.scrollTop(),a("#content").trigger("photos_list_load")):(a("#content").empty(),a.wa.setHash("#/"))},loadPhoto:function(d){if(a.photos.photo_stream_cache.hash!=a.photos.hash)a.photos.loadNewPhoto(d);
else{var f=a.photos.photo_stream_cache.getById(d);f?(a.photos.setTitle(f.name_not_escaped),a.photos.loadPhotoCompletly(f)):(f=a.photos.photo_stack_cache.getById(d))?(a.photos.setTitle(f.name_not_escaped),a.photos.loadPhotoInStack(f)):a.photos.loadNewPhoto(d)}},loadPhotoInStack:function g(f){a.photos.abortPrevLoading();a.photos.hooks_manager.trigger("beforeLoadPhoto",f);a.photos.photo_stack_cache.setCurrent(f);var c=a.photos._chooseProperThumb(f);"object"===typeof c.size&&c.size&&a("#photo").width(c.size.width).height(c.size.height);
replaceImg(a("#photo"),f.thumb.url+(f.edit_datetime?"?"+Date.parseISO(f.edit_datetime):""),null);a.photos.setNextPhotoLink();c=a.post("?module=photo&action=load",{id:f.id,in_stack:1},function(c){c=c.data;var e=c.photo;e=a.photos.photo_stack_cache.updateById(e.id,e);c.photo=e;a.photos.updateViewChildPhoto(c);a.photos.hooks_manager.trigger("afterLoadPhoto",e);delete g.xhr},"json");g.xhr=c;a("#photo-name").html(f.name)},updateViewChildPhoto:function(f){var g=f.author,c=f.albums,e=f.exif;f=f.photo;a.photos.renderPhotoImg(f);
a("#photo-author").html(tmpl("template-photo-author",{photo:f,author:g}));a.photos.updatePhotoOriginalBlock(f);a("#photo-exif").html(tmpl("template-photo-exif",{exif:e}));a.photos.renderMap(e.GPSLatitude,e.GPSLongitude,f.name);a("#photo-albums").html(tmpl("template-photo-albums",{albums:c}));a.photos.initPhotoContentControlWidget({frontend_link_template:frontend_link_template,photo:f})},loadNewPhoto:function c(g){a.photos.initClearance();a.photos.widget.loupe.init();c.xhr_map=c.xhr_map||{};c.xhr_map[g]&&
c.xhr_map[g].abort();c.xhr_map[g]=a.post("?module=photo&action=load",{id:g,hash:a.photos.hash},function(e){c.xhr_map[g]=null;e=e.data;var h=e.photo;a.photos.renderViewPhoto(e);var k=a.photos.photo_stream_cache.getNext();k&&a.photos.preloadPhoto(k);e.album&&a.photos.setAlbum(e.album);a.photos.hooks_manager.trigger("afterLoadPhoto",h)},"json")},renderViewPhoto:function(g){var c=g.photo,e=g.author,h=g.exif,k=g.stack,l=g.albums,n=g.album,m=g.hooks,p=g.frontend_link_template;g=g.photo_stream;var r=g.in_collection,
q=!1;if(n&&!r){if(n.type==Album.TYPE_STATIC){a.photos.goToHash("album/"+n.id+"/");return}q=!0}a.photos.setTitle(c.name_not_escaped);a("#content").html(tmpl("template-p-block"));a.photos.initPhotoToolbar({photo:c,author:e,exif:h,stack:k});a.photos.renderPhotoBlock({photo:c,hash:a.photos.hash,albums:l,hooks:m,frontend_link_template:p});a.photos.initPhotoWidgets({photo:c,stack:k,exif:h,photo_stream:g,hash:a.photos.hash});a.photos.anchor?(a.photos.goToAnchor(a.photos.anchor),a.photos.anchor=""):a.photos.scrollTop();
a("#p-warning-not-in-album").hide();q?(a("#p-warning-not-in-album").show(),a.photos.setNextPhotoLink(a.photos.photo_stream_cache.getCurrent())):a.photos.setNextPhotoLink()},loadPhotoCompletly:function(g){a.photos.photo_stream_cache.setCurrent(g);a.photos.updatePhotoStreamWidget({shift:g.id,fn:function(){a.photos._loadPhotoCompletly(g)}})},_loadPhotoCompletly:function e(c){a.photos.abortPrevLoading();a.photos.hooks_manager.trigger("beforeLoadPhoto",c);a("#p-warning-not-in-album").hide();a.photos.setNextPhotoLink();
a.photos.updatePhotoName(c.name);a.photos.updatePhotoDescription(c.description);a.photos.updatePhotoRate(c.rate);a("#photo-frontend-url").html(c.url);a("#stack-stream").hide();a("#photo-hook-bottom").html("");var h=a.photos.isPhotoPreloaded(c);if(h)a.photos.renderPhotoImg(c);else{var k=a.photos._chooseProperThumb(c);"object"===typeof k.size&&k.size&&a("#photo").width(k.size.width).height(k.size.height);replaceImg(a("#photo"),c.thumb.url+(c.edit_datetime?"?"+Date.parseISO(c.edit_datetime):""),null)}a.photos.updatePhotoTags(c.tags);
(k=a.photos.photo_stream_cache.getNext())&&a.photos.preloadPhoto(k);c=a.post("?module=photo&action=load",{id:c.id},function(c){if("ok"==c.status){c=c.data;var k=c.album,l=c.photo,p=c.photo_stream.in_collection,r=!1;if(k&&!p){if(k.type==Album.TYPE_STATIC){a.photos.goToHash("album/"+k.id+"/");return}r=!0}r?(a("#p-warning-not-in-album").show(),a.photos.setNextPhotoLink(a.photos.photo_stream_cache.getCurrent())):a.photos.setNextPhotoLink();l=a.photos.photo_stream_cache.updateById(l.id,l);c.photo=l;a.photos.updateViewPhoto(c,
h);a.photos.hooks_manager.trigger("afterLoadPhoto",l);delete e.xhr}},"json");e.xhr=c},updateViewPhoto:function(c,e){var h=c.author,k=c.albums,l=c.exif,n=c.frontend_link_template,m=c.hooks,p=c.stack;c=c.photo;e||a.photos.renderPhotoImg(c);a.photos.updateViewPhotoMenu(0!=c.parent_id||0<c.stack_count,c.edit_rights);a.photos.updatePhotoName(c.name,c.edit_rights);a.photos.updatePhotoDescription(c.description,c.edit_rights);a.photos.updatePhotoRate(c.rate,c.edit_rights);a.photos.updatePhotoTags(c.tags);
a("#photo-author").html(tmpl("template-photo-author",{photo:c,author:h}));a.photos.updatePhotoOriginalBlock(c);a("#photo-exif").html(tmpl("template-photo-exif",{exif:l}));a.photos.renderMap(l.GPSLatitude,l.GPSLongitude,c.name);a("#photo-albums").html(tmpl("template-photo-albums",{albums:k}));a.photos.initPhotoContentControlWidget({frontend_link_template:n,photo:c});p?(a("#stack-stream").html(tmpl("template-photo-stack",{stack:p,photo_id:c.id,hash:a.photos.hash})).show(),a.photos.photo_stack_cache.set(p),
a.photos.initPhotoStackWidget()):a.photos.photo_stack_cache.clear();e="";for(var r in m.backend_photo)m.backend_photo[r].bottom&&(e+=m.backend_photo[r].bottom);a("#photo-hook-bottom").html(e);e="";for(r in m.backend_photo)m.backend_photo[r].after_rate&&(e+=m.backend_photo[r].after_rate);e&&(a("#photo-rate").nextAll().remove(),a("#photo-rate").after(e));a.photos.anchor&&(a.photos.goToAnchor(a.photos.anchor),a.photos.anchor="")},renderPhotoImg:function(c){var e=a.photos._chooseProperThumb(c);replaceImg(a("#photo"),
e.url+(c.edit_datetime?"?"+Date.parseISO(c.edit_datetime):""),function(){"object"===typeof e.size&&e.size&&a(this).width(e.size.width).height(e.size.height);a.photos.hooks_manager.trigger("afterRenderImg",this,c,e)})},updateViewPhotoMenu:function(c,e){c?a.photos.menu.enable("photo","#photo-organize-menu","unstack"):a.photos.menu.disable("photo","#photo-organize-menu","unstack");e?(a.photos.menu.enable("photo","#photo-organize-menu"),a.photos.menu.enable("photo","#edit-menu"),a("#photo-tags").parent().show()):
(a.photos.menu.disable("photo","#photo-organize-menu"),a.photos.menu.disable("photo","#edit-menu"),a("#photo-tags").parent().hide())},preloadPhoto:function(c){var e=a("#preload-photo");e.attr("data-photo-id","");replaceImg(e,c.thumb_big.url,function(){e.attr("data-photo-id",c.id)})},isPhotoPreloaded:function(c){return a("#preload-photo").attr("data-photo-id")==c.id},abortPrevLoading:function(){"object"===typeof a.photos._loadPhotoCompletly.xhr&&"function"===typeof a.photos._loadPhotoCompletly.xhr.abort&&
(a.photos._loadPhotoCompletly.xhr.abort(),a.photos.hooks_manager.trigger("onAbortPrevLoading"));"object"===typeof a.photos.loadPhotoInStack.xhr&&"function"===typeof a.photos.loadPhotoInStack.xhr.abort&&(a.photos.loadPhotoInStack.xhr.abort(),a.photos.hooks_manager.trigger("onAbortPrevLoading"))},updateThumbRate:function(c,e){c=c.find(".p-details .p-rate");(e=Math.round(2*e)/2)?(c.find("i").filter(function(){return~this.className.indexOf("star")}).removeClass("star star-empty star-half").addClass("star-empty").each(function(c){c+=
1;c>e?.5==c-e&&a(this).removeClass("star-empty").addClass("star-half"):a(this).removeClass("star-empty").addClass("star")}),c.show()):c.hide()},showManageAccessDialog:function(c,e){var h=a("#manage-access-dialog-acceptor"),k="?module=dialog&action=manageAccess";h.length||(h=a("<div id='manage-access-dialog-acceptor'></div>"),a("body").append(h));if(c)if(a.isArray(c))for(var l=0,n=c.length;l<n;++l){var m=c[l];k+="&"+m.name+"="+m.value}else k+="&"+c;h.load(k,function(){a("#manage-access-dialog").waDialog({onSubmit:e})})},
initPhotoNameWidget:function(c){c="undefined"===typeof c?!1:c;a("#photo-name").inlineEditable({placeholder:a("#photo-name").text()?null:$_("Edit title..."),placeholderClass:"gray",afterBackReadable:function(c,h){h.changed&&(c=a(c).val(),c.length&&a.photos.saveField({id:a.photos.getPhotoId(),type:"photo",name:"name",value:c,fn:function(c){a("#photo-name").inlineEditable("setOption",{placeholder:null});"ok"==c.status&&a.photos.setTitle(c.data.value)}}))},minSize:{width:350},maxSize:{width:600},size:{height:30},
hold:function(){return!this.hasClass("editable")}});a.photos.updatePhotoName(c)},initPhotoDescriptionWidget:function(c){c="undefined"===typeof c?!1:c;a("#photo-description").inlineEditable({placeholder:$_("add description"),placeholderClass:"gray",makeReadableBy:["esc"],updateBy:["ctrl+enter"],html:!0,allowEmpty:!0,beforeMakeEditable:function(c){var e=a("#photo-description-save");if(!e.length){var k=a(this);c.after('<br><input type="button" id="photo-description-save" value="'+$_("Save")+'"> <em class="hint" id="'+
this.id+'-hint">Ctrl+Enter</em>');e=a("#photo-description-save");e.click(function(){k.trigger("readable")})}a("#"+this.id+"-hint").show();e.show().prev("br").show()},afterBackReadable:function(c,h){a("#photo-description-save").hide().prev("br").hide();a("#"+this.id+"-hint").hide();if(!h.changed)return!1;a(c).val();a.photos.saveField({id:a.photos.photo_stream_cache.getCurrent().id,type:"photo",name:"description",value:a(c).val(),fn:function(){}})},minSize:{height:50,width:600},size:{width:a("#photo").width()},
inputType:"textarea",editLink:"#photo-description-edit-link",hold:function(){return!this.hasClass("editable")}});a.photos.updatePhotoDescription(c)},initPhotoRateWidget:function(c){c="undefined"===typeof c?!1:c;a("#photo-rate").rateWidget({onUpdate:function(c){a.photos.saveField(a.photos.photo_stream_cache.getCurrent().id,"rate",c,function(c){"ok"==c.status&&c.data.count&&a("#rated-count").text(0<c.data.count?c.data.count:"")})},hold:function(){return this.hasClass("hold")}});a.photos.updatePhotoRate(c)},
initPhotoStackWidget:function(c){"object"===typeof c&&c&&a("#stack-stream").html(tmpl("template-photo-stack",c)).show();c=a("#stack-stream li.dr:first a").attr("href");(c=/(\d+)[\/]*$/.exec(c))&&(parent_id=c[1]);a("#stack-stream").data("parent_id",parent_id);a("#stack-stream").sortable({distance:5,helper:"clone",items:"li.dr",opacity:.75,tolerance:"pointer",start:function(){document.ondragstart=function(){return!1}},stop:function(c,h){document.ondragstart=null;h=a(h.item);c=parseInt(h.attr("data-photo-id"));
h=h.next();var e=null;h.length&&(e=parseInt(h.attr("data-photo-id")));a.post("?module=stack&action=photoMove",{id:c,before_id:e},function(c){if("ok"==c.status&&c.data.stack){var e=c.data.stack;c=a("#stack-stream").data("parent_id");e=e[0];var h=e.id;c!=h&&(c=a.photos.photo_stream_cache.getById(c),e.tags=c.tags,a.photos.photo_stream_cache.replace(c,e),a("#stack-stream").data("parent_id",h),a.photos.updatePhotoStreamWidget({current_photo:e}))}},"json")}});if(a("#stack-stream").data("inited"))return!1;
a("#stack-stream li.dr").live("click",function(){a("#stack-stream li.dr.selected").removeClass("selected");a(this).addClass("selected")});a("#stack-stream").data("inited",!0)},initPhotoTagsWidget:function(c){var e=a("#photo-tags"),h=$_("add a tag");"undefined"!==typeof c&&("object"===typeof c&&c&&(c=a.photos.joinObject(c,",")),e.importTags(c));e.data("current_value",e.val());var k=function(){e.data("current_value")!==e.val()&&(e.data("current_value",e.val()),a("#photo-save-tags-status").html('<i style="vertical-align: middle" class="icon16 yes"></i>'+
$_("Saving")).fadeIn("slow"),a.photos.assignTags({photo_id:a.photos.getPhotoId(),tags:a("#photo-tags").val(),fn:function(){a("#photo-save-tags-status").html('<i style="vertical-align: middle" class="icon16 yes"></i>'+$_("Saved")).fadeOut("slow")},onDeniedExist:function(){alert($_("You don't have sufficient access rights"))}}))};try{e.tagsInput({autocomplete_url:"?module=tag&action=list",height:120,width:150,defaultText:h,onChange:function(){},onAddTag:function(){k()},onRemoveTag:function(){k()}})}catch(l){}},
initPhotoContentControlWidget:function(c){"object"===typeof c&&c?(a("#photo-content-control").html(tmpl("template-photo-content-control",c)),edit_rights=c.photo.edit_rights):edit_rights=c;edit_rights="undefined"===typeof edit_rights?!1:edit_rights;var e=a("#photo-frontend-url"),h=e.parents("li:first").find("i.new-window"),k=a("#photo-frontend-link").nextAll("span.slash:first");e.length&&e.inlineEditable({inputType:"input",editLink:"#photo-frontend-url-edit-link",editOnItself:!1,minSize:{width:100},
beforeMakeEditable:function(c){var e=a(this),l=e.text().replace(/\/$/,"");e.text(l);k.show();h.hide();c.removeClass("error");a("#photo-content-control").find(".errormsg").text("").hide()},beforeBackReadable:function(c,n){function l(){p.text(r);k.hide();h.show();a(c).removeClass("error");a("#photo-content-control").find(".errormsg").text("").hide()}var p=a(this),r=p.text()+"/",q=a.photos.getPhotoId(),t=a(c).val();if(n.changed)return a.photos.saveField(q,"url",t,function(h){"ok"==h.status?(h=a("#photo-frontend-link").text(),
a("#photo-frontend-link").attr("href",h),l(),e.trigger("readable",!0)):"fail"==h.status&&(a(c).addClass("error"),a("#photo-content-control").find(".errormsg").text(h.errors.url).show())}),!1;l()},hold:function(){return this.hasClass("hold")}});a.photos.updatePhotoFrontendUrl(edit_rights)},renderMap:function(c,e,h){var k=this.options.map_options||{},l=function(){};c&&e?(l="google"===k.type?function(){window.initPhotosGoogleMap=function(){if(window.google){a("#photo-map").show();var k=new google.maps.LatLng(c,
e),l={zoom:11,center:k,mapTypeId:google.maps.MapTypeId.ROADMAP,disableDefaultUI:!0,zoomControlOptions:{position:google.maps.ControlPosition.TOP_LEFT,style:google.maps.ZoomControlStyle.SMALL}};l=new google.maps.Map(a("#photo-map").get(0),l);new google.maps.Marker({position:k,map:l,title:h})}else a("#photo-map").hide()};if(window.google)initPhotosGoogleMap();else{var l="https://maps.googleapis.com/maps/api/js?sensor=false&key=:KEY&lang=:LOCALE&callback=initPhotosGoogleMap".replace(":KEY",k.key||"").replace(":LOCALE",
k.locale||"");a.getScript(l)}}:"yandex"===k.type?function(){var h=function(){window.ymaps?ymaps.ready(function(){a("#photo-map").show();var h=[c,e],k=new ymaps.Map("photo-map",{center:h,zoom:11,controls:["zoomControl","fullscreenControl"]});k.setCenter(h);k.geoObjects.add(new ymaps.Placemark(h,{balloonContent:""}))}):a("#photo-map").hide()};if(window.ymaps)h();else{var l="https://api-maps.yandex.ru/2.1/?lang="+(k.locale||"ru_RU");k.key&&(l+="&apikey="+k.key);a.getScript(l,h)}}:function(){a("#photo-map").hide()},
l()):a("#photo-map").hide()},joinObject:function(a,e){var c="",k=0;e=e||"";for(var l in a)a.hasOwnProperty(l)&&(0<k++&&(c+=e),c+=a[l]);return c},initPhotoStreamWidget:function(c){var e=c.photos;e=[null].concat(e,[null]);a("#photo-stream").html(tmpl("template-photo-stream",{photos:e,current_photo:c.current_photo||null,hash:a.photos.hash}));var h=!1,k=!1;a("#photo-stream ul.photostream:first").photoStreamSlider({backwardLink:"#photo-stream .rewind",forwardLink:"#photo-stream .ff",photoStream:"ul",duration:400,
onForward:function n(){if(!h){var c=this,e=c.find("ul").find("li:not(.dummy)"),k=e.filter(".visible");e=e.filter(":last");15>k.filter(":last").nextAll().length&&"object"!=typeof n.xhr&&(k=e.attr("data-photo-id"),n.xhr=a.post("?module=photo&action=loadList",{id:k,direction:1,hash:a.photos.hash},function(e){if("ok"==e.status){e=e.data.photos;if(0<e.length)a.photos.photo_stream_cache.append(e);else{h=!0;return}e.push(null);c.trigger("append",tmpl("template-photo-stream-list",{photos:e}))}delete n.xhr},
"json"))}},onBackward:function m(){if(!k){var c=this,e=c.find("ul").find("li:not(.dummy)"),h=e.filter(".visible");e=e.filter(":first");15>h.filter(":first").prevAll().length&&"object"!=typeof m.xhr&&(h=e.attr("data-photo-id"),m.xhr=a.post("?module=photo&action=loadList",{id:h,direction:-1,hash:a.photos.hash},function(e){if("ok"==e.status){e=e.data.photos;if(0<e.length)a.photos.photo_stream_cache.prepend(e);else{k=!0;return}e.unshift(null);c.trigger("prepend",tmpl("template-photo-stream-list",{photos:e}))}delete m.xhr},
"json"))}}})},updatePhotoStreamWidget:function(c){var e=a("#photo-stream ul.photostream:first");if(c.current_photo){var h=e.find("li.selected"),k=c.current_photo;h.attr("data-photo-id",k.id);h.find("a").attr("href","#/photo/"+k.id);h.find("img").attr("src",k.thumb_crop.url)}c.shift&&(e.find("li.selected").removeClass("selected"),e.find("li[data-photo-id="+c.shift+"]").addClass("selected"),e.trigger("home",[c.fn||function(){},!a.photos.shift_next]),a.photos.shift_next=!1)},updatePhotoName:function(c,
e){if("boolean"===typeof c||"undefined"===typeof c)e=c,c=null;var h=a("#photo-name");null!==c&&h.html(c);e?h.addClass("editable"):h.removeClass("editable")},updatePhotoDescription:function(c,e){if("boolean"===typeof c||"undefined"===typeof c)e=c,c=a("#photo-description").html();var h=a("#photo-description"),k=$_("add description");e?(h.addClass("editable"),e=k,a("#photo-description-edit-link").show()):(e=null,c=c!==k?c:"",h.removeClass("editable"),a("#photo-description-edit-link").hide());h.inlineEditable("setOption",
{placeholder:e}).html(c).trigger("placeholder",!!e)},updatePhotoRate:function(c,e){if("boolean"===typeof c||"undefined"===typeof c)e=c,c=null;var h=a("#photo-rate");null!==c&&h.rateWidget("setOption","rate",c);e?h.removeClass("hold").show():(h.addClass("hold"),(c=h.rateWidget("getOption","rate"))||h.hide())},updatePhotoTags:function(c){var e=a("#photo-tags");e.data("current_value",e.val());"undefined"!==typeof c&&("object"===typeof c&&c&&(c=a.photos.joinObject(c,",")),e.importTags(c))},updatePhotoFrontendUrl:function(c){var e=
a("#photo-frontend-url");c?(e.removeClass("hold"),a("#photo-frontend-url-edit-link").show()):(e.addClass("hold"),a("#photo-frontend-url-edit-link").hide())},updatePhotoOriginalBlock:function(c){a("#photo-original").html(tmpl("template-photo-original",{photo:c}))},initPhotoToolbar:function(c){a("#p-toolbar").html(tmpl("template-photo-toolbar",c)).addClass("rendered");a.photos.menu.init("photo");var e=a("#photos-photo-popular-tags");e.data("inited")||e.off("click.photos","a").on("click.photos","a",
function(){var c=a(this).text(),e=a("#photo-tags");e.removeTag(c);e.addTag(c)}).data("inited",!0);a.photos.updateViewPhotoMenu(a.isArray(c.stack)&&c.stack.length,c.photo.edit_rights)},renderPhotoBlock:function(c){var e=c.photo,h=a.photos._chooseProperThumb(e),k=e.thumb.size;"object"===typeof h.size&&h.size&&(e.thumb.size={width:h.size.width,height:h.size.height});a("#p-block").html(tmpl("template-photo",c)).addClass("rendered");"object"===typeof k&&k&&(e.thumb.size={width:k.width,height:k.height});
replaceImg(a("#photo"),h.url+(e.edit_datetime?"?"+Date.parseISO(e.edit_datetime):""),function(){a.photos.hooks_manager.trigger("afterRenderImg",this,e,h)})},initPhotoWidgets:function(c){var e=c.photo,h=c.exif,k=c.stack;c=c.photo_stream;var l=a.photos.hash;a.photos.initPhotoNameWidget(e.edit_rights);a.photos.initPhotoDescriptionWidget(e.edit_rights);a.photos.initPhotoRateWidget(e.edit_rights);a.photos.initPhotoTagsWidget(e.tags);a.photos.initPhotoContentControlWidget(e.edit_rights);a.photos.hotkey_manager.set();
a.photos.renderMap(h.GPSLatitude,h.GPSLongitude,e.name);a.isArray(k)&&k.length&&(a.photos.photo_stack_cache.set(k).setCurrentById(e.id),a.photos.initPhotoStackWidget({stack:k,photo_id:e.id,hash:a.photos.hash}));e=a.photos.photo_stream_cache;e.hash=l;e.set(c.photos).setCurrentById(c.current_photo_id);a.photos.initPhotoStreamWidget({photos:c.photos,current_photo:e.getCurrent()});a("#p-block .p-one-photo > .p-image-nav").click(function(){if(a(this).hasClass("p-rewind")){var c=a.photos.photo_stream_cache.getPrev();
c&&(a.photos.goToHash(a.photos.getHashByPhotoId(c.id),!1),a.photos.shift_next=!0)}else if(c=a.photos.photo_stream_cache.getNext())a.photos.goToHash(a.photos.getHashByPhotoId(c.id),!1),a.photos.shift_next=!0})},_chooseProperThumb:function(c){var e=c.thumb_big;c=c.thumb_middle;var h=a("#p-block").width();var k=e;"object"===typeof e.size&&e.size?(parseInt(e.size.height,10)>parseInt(c.bound.height,10)&&parseInt(e.size.height,10)>a(window).height()&&(k=c),parseInt(k.size.width,10)>h&&(k.size.height=Math.round(h/
parseInt(k.size.width,10)*parseInt(k.size.height,10)),k.size.width=h)):k.size={width:h,height:""};"object"===typeof k.size&&k.size||(k.size={widht:h,height:""});return k},setNextPhotoLink:function(c){var e=a("#photo").parents("a:first");(c=c?c:a.photos.photo_stream_cache.getNext())?(e.attr("title",$_("Next \u2192")),e.attr("href","#"+a.photos.hash+"/photo/"+c.id+"/")):(e.attr("title",""),e.attr("href","javascript:void(0);"))},setTitle:function(c){c&&(document.title=c+a.photos.options.title_suffix)},
ignore_scrolltop:!1,scrollTop:function(){a.photos.ignore_scrolltop?a.photos.ignore_scrolltop=!1:a(document).scrollTop(0)},load:function(c,e,h,k){var l=a("#content");"function"==typeof e&&(k=h||null);k&&(l.empty().append(k),l=l.find(":last-child"));"function"==typeof e?l.load(c,e):l.load(c,e,h)},setCover:function(){a.photos.centralizeLoadingIcon();a("#cover").show()},unsetCover:function(){a("#cover").hide()},centralizeLoadingIcon:function(){var c=a("#cover"),e=a("#cover .loading"),h=c.width(),k=e.width();
c=c.height();e=e.height();a(".loading").css({position:"absolute",left:parseInt((h-k)/2)+"px",top:parseInt((c-e)/2)+"px"})},saveField:function(c,e,h,k){var l="photo";1==arguments.length&&(l=a.extend({type:l,fn:function(){}},c),c=l.id,e=l.name,h=l.value,k=l.fn,l=l.type);if(!~["photo","album"].indexOf(l))throw"Unknown type";a.isArray(c)||(c=[{name:"id[]",value:parseInt(c)}]);var n=[].concat(c,{name:"name",value:e},{name:"value",value:h});a.post("?module="+l+"&action=saveField",n,function(l){if("ok"==
l.status){var n={};n[e]=h;l.data.parent_id&&(c=l.data.parent_id);a.photos._updateStreamCache(c,n);"function"==typeof k&&k(l)}else"fail"==l.status&&"function"==typeof k&&k(l)},"json")},saveFields:function(c,e,h){a.post("?module=photo&action=saveFields",{data:c},function(c){if("ok"==c.status)for(var e in c.data.update){var h=c.data.update[e].id;a.isArray(h)||(h=[h]);var k=c.data.update[e].data;e=0;for(var p=h.length;e<p;++e)a.photos.photo_stream_cache.updateById(h[e],k)}},"json")},_updateStreamCache:function(c,
e){a.isArray(c)||(c=[{value:c}]);for(var h=0,k=c.length;h<k;++h)a.photos.photo_stream_cache.updateById(c[h].value,e)},restoreOriginal:function(c,e){e=e||function(){};a.post("?module=photo&action=restore",{id:c},function(h){"ok"==h.status&&(h=h.data.photo,h=0==h.parent_id?a.photos.photo_stream_cache.updateById(c,h):a.photos.photo_stack_cache.updateById(c,h),a.photos.updatePhotoOriginalBlock(h),a.photos.updatePhotoImgs(h,e))},"json")},rotate:function(c,e,h){h=h||function(){};a.post("?module=photo&action=rotate",
{id:c,direction:e},function(e){"ok"==e.status&&(e=e.data.photo,e=0==e.parent_id?a.photos.photo_stream_cache.updateById(c,e):a.photos.photo_stack_cache.updateById(c,e),a.photos.updatePhotoOriginalBlock(e),a.photos.updatePhotoImgs(e,h))},"json").error(function(c){a.photos.showServerError(c.responseText);"function"==typeof h&&h()})},updatePhotoImgs:function(c,e){var h=a.photos._chooseProperThumb(c),k=c.edit_datetime?"?"+Date.parseISO(c.edit_datetime):"";replaceImg(a("#photo"),h.url+k,function(){a("#photo").width(h.size.width).height(h.size.height);
a("#photo-stream .selected img, #stack-stream .selected img").each(function(){var e=a(this);e.hasClass("thumb")?e.attr("src",c.thumb.url+k):e.attr("src",c.thumb_crop.url+k)});"function"==typeof e&&e();a.photos.hooks_manager.trigger("afterRenderImg",this,c,h)})},deletePhotos:function(c,e){a.post("?module=photo&action=resolution",a.isArray(c)?c:{photo_id:c},function(h){if("ok"==h.status){var k=h.data.photo_id;h=[];for(var l=[],n=0,m=k.length;n<m;++n)h.push({name:"photo_id[]",value:k[n]});a.photos.massPost({photo_id:h,
url:"?module=photo&action=delete",dataType:"json",data:{photos_length:a.isArray(c)?c.length:1},success:function(a,c){if("ok"==a.status){l=l.concat(a.data.denied_photo_id);a=0;for(var e=l.length;a<e;++a)c.push({name:"denied_photo_id[]",value:l[a]})}},fullSuccess:function(h){if("ok"==h.status)if(a.isArray(c)){h.data.alert_msg&&alert(h.data.alert_msg);var n={};a.each(k,function(a,c){n[c]=c});h.data.denied_photo_id&&h.data.denied_photo_id.length&&a.each(h.data.denied_photo_id,function(a,c){delete n[c]});
n=a.map(n,function(c,e){a.photos.photo_stream_cache.deleteById(k[c]);return e});a("#photo-list li.selected").trigger("select",!1);n.length?a.photos.makeDeleteAnimation(n,function(){e&&e(h)}):e&&e(h)}else{l.length&&alert($_("You don't have sufficient access rights"));if(h.data.parent_id){var m=a.photos.getHashByPhotoId(h.data.parent_id);a.photos.photo_stack_cache.deleteById(k)}else{var p=a.photos.photo_stream_cache;m=(m=p.getNext(c))?a.photos.getHashByPhotoId(m.id):p.hash;p.deleteById(k)}a.wa.setHash(m);
e&&e(h)}else e&&e(h)}})}},"json")},deleteAllAlbums:function(c,e,h){if(!c.length)return h&&h();var k=c.shift();a.photos.deleteAlbum(k,e,function(){a.photos.deleteAllAlbums(c,e,h)})},deleteAlbum:function(c,e,h){e?a.photos._deleteAlbumWithPhotos(c,h):a.post("?module=album&action=delete",{album_id:c},function(e){"ok"==e.status&&(a.photos.onDeleteAlbum(c),a.photos.goToHash(""),"function"==typeof h&&h())},"json")},_deleteAlbumWithPhotos:function(c,e){a.post("?module=photo&action=resolution",{album_id:c},
function(h){if("ok"==h.status){h=h.data.photo_id;for(var k=[],l=0,n=h.length;l<n;++l)k.push({name:"photo_id[]",value:h[l]});k.length?a.photos.massPost({url:"?module=photo&action=delete",photo_id:k,dataType:"json",fullSuccess:function(h){"ok"==h.status?a.photos.deleteAlbum(c,0,e):console&&console.log("Error while delete album")}}):a.photos.deleteAlbum(c,0,e)}},"json")},serializeData:function(c,e){if("object"===typeof c&&!a.isArray(c)&&"undefined"===typeof e){var h=[];for(e in c)c.hasOwnProperty(e)&&
h.push({name:e,value:c[e]});return h}a.isArray(c)||(c=[c]);h=0;for(var k=c.length,l=c[0];h<k;l=c[++h])"object"!=typeof l&&(l={name:e,value:l}),c[h]=l;return c},saveAccess:function(c){function e(c){for(var e=[],h=[],n=[],q=0,t=c.length;q<t;++q)e.push({name:"photo_id[]",value:c[q]});a.photos.massPost({photo_id:e,url:"?module=photo&action=manageAccessSave",dataType:"json",data:k,success:function(a,c){if("ok"==a.status){h=h.concat(a.data.denied_photo_id);for(var e=0,k=h.length;e<k;++e)c.push({name:"denied_photo_id[]",
value:h[e]});n=a.data.allowed_photo_id;e=0;for(k=n.length;e<k;++e)c.push({name:"allowed_photo_id[]",value:n[e]})}},fullSuccess:function(a){"ok"==a.status&&a.data.alert_msg&&onDeniedExist(a.data.alert_msg);"function"===typeof l&&l(a,n)}})}var h=c.photo_id||[],k=c.data||[],l=c.fn;onDeniedExist=c.onDeniedExist||function(a){alert(a)};resolution="boolean"===typeof c.resolution?c.resolution:!0;"object"!==typeof k||a.isArray(k)||(k=a.photos.serializeData(k));k.push({name:"photos_length",value:h.length});
resolution?a.post("?module=photo&action=resolution",a.isArray(h)?h:{photo_id:h},function(a){"ok"==a.status&&e(a.data.photo_id)},"json"):e(a.isArray(h)?h:[h])},addToAlbums:function(c){var e=c.photo_id||[],h=c.album_id||[],k=void 0==c.copy?1:c.copy,l=c.fn,n=c.onDeniedExist||function(a){alert(a)};e=a.photos.serializeData(e,"photo_id[]");h=a.photos.serializeData(h,"album_id[]");c=e.concat(h);c.push({name:"copy",value:+k});a.post("?module=photo&action=addToAlbums",c,function(c){if("ok"==c.status){for(var e=
[].concat(c.data.albums||[],c.data.old_albums||[]),h=0,k=e.length;h<k;++h){var m=e[h];a("#album-list li[rel="+m.id+"]").find(".count:first").text(m.count).end().find(".count-new:first").text(0<m.count_new?"+"+m.count_new:"")}c.data.alert_msg&&n(c.data.alert_msg)}"function"==typeof l&&l(c)},"json")},assignTags:function(c){var e=c.photo_id||[],h=c.tags||[],k=c.delete_tags||[],l=c.fn,n=c.onDeniedExist||function(a){alert(a)};c=[];c=a.isArray(e)?e:c.concat([{name:"photo_id[]",value:e},{name:"one_photo",
value:1}]);a.isArray(h)&&h.length?c=c.concat(h):(c.push({name:"tags",value:h}),k.length&&(c=c.concat(k)));a.post("?module=photo&action=assignTags",c,function(c){if("ok"==c.status){var e=c.data.cloud,h=a("#tag-cloud-block");a.isArray(e)&&!e.length||!e?h.hide():(a("#tag-cloud").html(tmpl("template-tag-cloud",{cloud:e})),h.show());e=c.data.tags||{};for(var k in e)e.hasOwnProperty(k)&&(h=e[k],a.photos._updateStreamCache(k,{tags:h}));a("#album-create-dialog").remove();c.data.alert_msg&&n(c.data.alert_msg)}"function"==
typeof l&&l(c)},"json")},makeStack:function(c,e){var h=c.shift();a.post("?module=photo&action=resolution",c,function(e){if("ok"==e.status){e=e.data.photo_id;for(var k=[],n=[],m=0,p=e.length;m<p;++m)e[m]!=h.value&&k.push({name:"photo_id[]",value:e[m]});a.photos.massPost({photo_id:k,data:{parent_id:h.value,photos_length:c.length},url:"?module=stack&action=make",dataType:"json",success:function(a,c){if("ok"==a.status&&"ok"==a.status){n=n.concat(a.data.denied_photo_ids);a=0;for(var e=n.length;a<e;++a)c.push({name:"denied_photo_id[]",
value:n[a]})}},fullSuccess:function(e){if("ok"==e.status){e.data.alert_msg&&alert(e.data.alert_msg);for(var k=0,l=c.length;k<l;++k)a.photos.photo_stream_cache.deleteById(c[k].value);a.photos.photo_stream_cache.updateById(e.data.parent_id,e.data.photo);a("#photo-list li.selected").trigger("select",!1);a.photos.makeStackAnimation([h].concat(c))}}})}},"json")},makeStackAnimation:function(c,e){var h=c[0].value,k=a('li[data-photo-id="'+h+'"]'),l=k.offset(),n=a(window);(l.top<n.scrollTop()||l.top>n.scrollTop()+
n.height())&&a("html, body").animate({scrollTop:l.top},300);n=[];for(var m=1;m<c.length;m++){var p=c[m].value,r=a('li[data-photo-id="'+p+'"]'),q=r.offset();q=r.clone().css({"z-index":10,position:"absolute",top:q.top,left:q.left}).insertAfter(r);r.css({opacity:0});n.push(r.hide(300).promise());a.photos.photo_stream_cache.deleteById(p);n.push(q.animate({top:l.top,left:l.left},300).promise().done(function(){a(this).remove()}))}a.when.apply(a,n).done(function(){var c=k.hasClass("last");k.replaceWith(tmpl(a.photos.list_template,
{photos:[a.photos.photo_stream_cache.getById(h)],hash:a.photos.hash,last_login_time:a.photos.options.last_login_time,options:{}}));c||a('li[data-photo-id="'+h+'"]').removeClass("last");a('li[data-photo-id="'+h+'"]').addClass("highlighted");"function"===typeof e&&e()})},makeDeleteAnimation:function(c,e){var h={};a.each(c,function(a,c){h[c]=!0});var k=a("#photo-list").children().filter(function(){return!!h[a(this).data("photo-id")]}).animate({width:0},function(){k.remove();e&&e()})},highlightSidebarItem:function(){var c=
decodeURIComponent(a.photos.hash);a("#p-sidebar li.selected").removeClass("selected");var e=a('#p-sidebar li a[href="#'+(c||"/")+'"]');e.length||(e=a('#p-sidebar li a[href^="#'+(c||"/")+'"]'));e.length&&e.parents("li:first").addClass("selected")},toggleFullScreen:function(){a.storage.get("photos/maximize_photo")?a("#wa-app").addClass("p-full-screen"):a("#wa-app").removeClass("p-full-screen")},hotkey_manager:function(){function c(e){var h=e.target.type;e=e.keyCode;if(!(c.hold||"text"==h||"textarea"==
h||37!=e&&39!=e)){if(39==e){if(h=a.photos.photo_stream_cache.getNext())a.photos.goToHash(a.photos.getHashByPhotoId(h.id),!1),a.photos.shift_next=!0;c.hold=!0}if(37==e){if(h=a.photos.photo_stream_cache.getPrev())a.photos.goToHash(a.photos.getHashByPhotoId(h.id),!1),a.photos.shift_next=!0;c.hold=!0}}}function e(a){c.hold=!1}function h(a){switch(a){case 48:case 96:a=0;break;case 49:case 97:a=1;break;case 50:case 98:a=2;break;case 51:case 99:a=3;break;case 52:case 100:a=4;break;case 53:case 101:a=5;break;
default:a=null}return a}function k(c){var e=c.target.type;if(!k.hold&&"text"!=e&&"textarea"!=e){var l=h(c.keyCode);"number"===typeof l&&(k.hold=!0,a("#photo").length?(c=a.photos.photo_stream_cache.getCurrent(),c.edit_rights&&a.photos.saveField(c.id,"rate",l,function(c){"ok"==c.status&&c.data.count&&(a("#rated-count").text(0<c.data.count?c.data.count:""),a("#photo-rate").rateWidget("setOption","rate",l))})):(c=a("input[name^=photo_id]").map(function(){return this.checked?{name:"id[]",value:this.value}:
null}).toArray(),c.length&&a.photos.saveField({id:c,name:"rate",value:l,fn:function(c){if("ok"==c.status){var e=c.data.allowed_photo_id&&!a.isArray(c.data.allowed_photo_id)?c.data.allowed_photo_id:{};a("#photo-list li.selected").each(function(){var c=a(this);e[c.attr("data-photo-id")]&&a.photos.updateThumbRate(c,l)}).find("input:first").trigger("select",!1);c.data.count&&a("#rated-count").text(0<c.data.count?c.data.count:"");c.data.alert_msg&&alert(c.data.alert_msg)}}})))}}function l(){k.hold=!1}
return{set:function(h){"undefined"===typeof h?a(document).bind("keydown",c).bind("keyup",e).bind("keydown",k).bind("keyup",l):"rate"===h&&a(document).bind("keydown",k).bind("keyup",l)},unset:function(){a(document).unbind("keydown",c).unbind("keyup",e).unbind("keyup",k).unbind("keyup",l)}}}(),getHashByPhotoId:function(c){return a.photos.hash+"/photo/"+c},setLazyLoad:function(){var c=null;a(window).lazyLoad({container:"#photo-list",load:function(){c=c||a("#photo-list li").length;a(window).lazyLoad("sleep");
a(".lazyloading-wrapper .lazyloading-progress").show();a(".lazyloading-wrapper .lazyloading-link").hide();a.post("?module=photo&action=loadList",{offset:c,hash:a.photos.hash},function(e){if(e.data.hash==a.photos.hash){var h=a("#photo-list");if(e.data.photos.length){var k=a.photos.photo_stream_cache.length();a.photos.photo_stream_cache.append(e.data.photos);h.find("li.last").removeClass("last");a.photos.renderPhotoListChunk(h,k,{string:e.data.string},function(){!a.photos.total_count||a.photos.total_count>
a.photos.photo_stream_cache.length()?a(window).lazyLoad("wake"):(a(".lazyloading-wrapper .lazyloading-progress").hide(),a(".lazyloading-wrapper .lazyloading-link").hide(),a(window).lazyLoad("stop"))});c+=e.data.photos.length}else a(".lazyloading-wrapper .lazyloading-progress").hide(),a(".lazyloading-wrapper .lazyloading-link").hide(),a(window).lazyLoad("stop")}},"json")}});a(".lazyloading-wrapper a.lazyloading-link").die("click.lazyloading").live("click.lazyloading",function(){a(window).lazyLoad("force");
return!1})},unsetLazyLoad:function(){a(window).lazyLoad&&a(window).lazyLoad("stop");a(".lazyloading-wrapper a.lazyloading-link").die("click.lazyloading")},getAlbum:function(){return this.album=this.album||null},setAlbum:function(a){this.album=a},unsetAlbum:function(){this.album=null},getPhotoId:function(){var a=/photo\/(\d+)[\/]*$/.exec(location.href);return a?parseInt(a[1]):null},isCurrentPhotoStack:function(){var a=this.getPhotoId();return a?(a=this.photo_stream_cache.getById(a))&&0<a.stack_count:
!1},goToHash:function(c,e){e="undefined"===typeof e?!0:e;c=c.replace(/^\/*/,"").replace(/\/*\s*$/,"");location.hash.replace(/^[^#]*#\/*/,"").replace(/\/*\s*$/,"")==c&&e?(a.photos.ignore_scrolltop=!0,a.photos.dispatch()):location.hash=c?"/"+c+"/":"/"},goToAnchor:function(c){c=a("a[name="+c+"]");c.length&&a(document).scrollTop(c.position().top)},photo_stream_cache:new PhotoStream,onCreateAlbum:function(c,e){var h=tmpl("template-album-list-item",c),k=a("#album-list");if(e){var l=k.find("li[rel="+e+"]");
var n=l.find("ul:first");n.length||(l.append('<ul class="menu-v with-icons"></ul>'),n=l.find("ul:first"),l.find(".count:first").after('<i class="icon16 darr overhanging collapse-handler" id="album-'+e+'-handler"></i>'));n.prepend(h)}else n=k.find("ul:first"),n.length||(k.find(".p-empty-album-list").hide(),k.prepend('<ul class="menu-v with-icons"><li class="drag-newposition"></li></ul>').find("ul:first")),k.find("ul:first").prepend(h);k.find(".new-item").removeClass("new-item").mouseover();c.type||
(h=a("#p-upload-step2 select[name=album_id]"),e?(e=h.find("option[value="+e+"]"),h=e.text().replace(/[^-]/g,"")+"-",e.after('<option value="'+c.id+'">'+h+" "+c.name+"</option>")):h.find("optgroup").prepend('<option value="'+c.id+'">'+c.name+"</option>"))},onDeleteAlbum:function(c){var e=a("#album-list"),h=e.find("li[rel="+c+"]"),k=h.find("ul:first"),l=h.parents("ul:first");h.hide();if(k.length){h.prev(".drag-newposition:first").remove();h.next(".drag-newposition:first").remove();var n=k.children("li");
n.hide().insertAfter(h);k.remove();h.remove();n.show()}else h.next(".drag-newposition:first").remove().end().remove();l.length&&!l.find("li:not(.drag-newposition)").length&&(h=l.parent("li"),h.length&&h.find("i.collapse-handler").remove(),l.remove());e.find("ul:first").length||e.find(".p-empty-album-list").show();a("#p-upload-step2 select[name=album_id]").find("option[value="+c+"]").remove()},fixRightToolbar:function(){a.photos.fixRightToolbar._handler=function e(){var h=a("#p-toolbar");h.length&&
(h.hasClass("rendered")?h.removeClass("p-fixed"):(e.top||(e.top=h.children(":first").position().top),a(this).scrollTop()>e.top?h.addClass("p-fixed"):h.removeClass("p-fixed")))};a.photos.fixRightToolbar._handler.call(document);a(document).bind("scroll",a.photos.fixRightToolbar._handler)},photo_stack_cache:new PhotoStream,isSelectedAnyPhoto:function(){return!!a("#photo-list li.selected:first").length},getRatingHtml:function(a,e,h){e=e||10;a=Math.round(2*a)/2;if(!a&&!h)return"";h="";for(var c=1;5>=c;c+=
1)h+='<i class="icon'+e+" star",c>a&&(h=.5==c-a?h+"-half":h+"-empty"),h+='"></i>';return h},uploadDialog:function(){a("#p-uploader").waDialog({onLoad:a.photos.onUploadDialog,onClose:a.photos.dialogClearSteps,onSubmit:function(){a("#p-start-upload-button").click();return!1}})},dialogClearSteps:function(){a("#p-upload-step2").hide();a("#p-upload-step2-buttons").hide();a("#p-upload-step3").hide();a("#p-upload-step3-buttons").hide();a("#p-upload-step1").show();a("#p-upload-step1-buttons").show()},onUploadDialog:function(){a(this);
a(this).find(".files").empty();var c=a.storage.get("photos/hash"),e=a("#p-upload-step2 select[name=album_id]");c&&~c.indexOf("album")?(c=parseInt(c.replace(/\/?album\//,"")),c=e.find("optgroup option[value="+c+"]"),c.length?c.attr("selected",!0):e.find("option:first").attr("selected",!0)):e.find("option:first").attr("selected",!0)},massPost:function(c){function e(e){m?(p?(k=p.splice(0,h),c.data=l.concat(k)):c.data=l,m-=h,m=0<m?m:0,a.ajax(c)):"function"==typeof c.fullSuccess&&c.fullSuccess(e)}var h=
c.chunk_count||25,k,l=[];if(a.isArray(c.data))l=l.concat(c.data);else if("object"==typeof c.data)for(var n in c.data)l.push({name:n,value:c.data[n]});c.type="post";var m=parseInt(c.count)||0,p=c.photo_id;if(c.photo_id){p=c.photo_id;if(a.isArray(p))p=[].concat(p);else{l.push({name:"photo_id",value:p});c.data=l;c.success=c.fullSuccess;a.ajax(c);return}m=p.length}if("function"==typeof c.success){var r=c.success;c.success=function(a){r(a,l);e(a)}}else c.success=e;e()},confirmDialog:function(c){var e=
a("#confirm-dialog");e.length||(e=a('<div id="confirm-dialog"></div>'),a("body").append(e));c.url&&e.load(c.url,function(){var h=a.extend({},c);delete h.url;var k=a(this),l=h.onLoad;h.onLoad=function(){e.find("input[type=submit]").focus();"function"===typeof l&&l()};k.find("div:first").waDialog(h)})},showServerError:function(a){a?(console&&console.log("Server error occurred:\n"+a),alert(a)):console&&console.log("Server error occurred")},initAlbumThumbsDragAndDrop:function(c,e){c.sortable({handle:"img",
distance:5,tolerance:"pointer",stop:function(c,k){a.post("?module=album&action=move",{id:k.item.data("album-id"),before_id:k.item.next().data("album-id")||0,parent_id:e})}})},hooks_manager:{handlers:{},bind:function(a,e,h){if(1==arguments.length&&arguments[0]&&"object"===typeof arguments[0]){var c=arguments[0];for(a in c)c.hasOwnProperty(a)&&this.bind(a,c[a])}else return h=h||(""+Math.random()).slice(2),this.handlers[a]=this.handlers[a]||{},this.handlers[a][h]=e,e.handler_name=h},unbind:function(a,
e){var c=e;"undefined"===typeof e?this.handlers[a]={}:("function"===typeof e&&(c=e.handler_name),"function"===typeof this.handlers[a][c]&&delete this.handlers[a][c])},trigger:function(a){var c=this.handlers[a];if(c&&"object"===typeof c){var h=Array.prototype.slice.call(arguments,1),k;for(k in c)c.hasOwnProperty(k)&&"function"===typeof c[k]&&c[k].apply(null,h)}}}}})(jQuery);
$(function(){$(".p-one-photo .next").live("click",function(){$.photos.shift_next=!0});$(".dialog").die().live("change_loading_status",function(a,b){b=b||!1;a=$(this).find("input[type=submit]");b?a.attr("disabled",!0).after('<i style="vertical-align: middle" class="icon16 loading"></i>'):a.attr("disabled",!1).next("i").remove()});(function(){var a=!1;$(document).on("selectstart","#photo-list",function(){return!a});$(document).keydown(function(b){16==b.keyCode&&(a=!0)}).keyup(function(b){16==b.keyCode&&
(a=!1)})})();$("#photo-list li").live("select",function(a,b,d){d=void 0!==d?d:!0;(void 0!==b?b:1)?$(this).addClass("selected").find("input:first").attr("checked",!0):(a=$("#selector-menu").find('[data-action="select-photos"]'),a.data("checked")&&a.data("checked",!1).find(".unchecked").show().end().find(".checked").hide(),$(this).removeClass("selected").find("input:first").attr("checked",!1));d&&$("#share-menu-block, #organize-menu-block").trigger("recount")});(function(){function a(a,b,c){if(a&&b&&
a[0]&&b[0]&&!a.is(b[0])){var d=!1;b.parent().children().each(function(e,f){if(d){if(a.is(f)||b.is(f))return!1;e=$(f).find(".p-details input:checkbox");e.prop("checked")!=c&&e.prop("checked",c).change()}else if(a.is(f)||b.is(f))d=!0})}}var b=null,d=null;$("#content").on("click","#photo-list li .p-details input:checkbox, #photo-list li .p-details label",function(f){var g=$(this).closest("li"),c=g.find(".p-details input:checkbox");if(c.is(f.target))var e=c.prop("checked");else e=!c.prop("checked"),c.prop("checked",
e).change();e?(f.shiftKey&&b&&a(b,g,!0),b=g,d=null):(f.shiftKey&&d&&a(d,g,!1),b=null,d=g)})})();$("#content").off($.photos.namespace+"-photo-list-select-checkbox").on("change"+$.photos.namespace+"-photo-list-select-checkbox",':checkbox[name="photo_id[]"]',function(){this.checked?$(this).closest("li").addClass("selected"):$(this).closest("li").removeClass("selected");$("#share-menu-block, #organize-menu-block").trigger("recount")});$.photos.hooks_manager.bind("afterLoadPhoto",function(){$.photos.photo_stream_cache.getPrev()?
$("#p-block .p-one-photo > .p-image-nav.p-rewind").show():$("#p-block .p-one-photo > .p-image-nav.p-rewind").hide();$.photos.photo_stream_cache.getNext()?$("#p-block .p-one-photo > .p-image-nav.p-ff").show():$("#p-block .p-one-photo > .p-image-nav.p-ff").hide()});$.photos_dragndrop.init()});
function ToolbarMenu(a,b){var d=null;return{init:function(){d=$(a);d.length&&d.activeMenu(b);return this},enable:function(a){a?d.activeMenu("enable",a):(d.parents("div:first").show(),d.activeMenu("fire"));return this},disable:function(a){a?d.activeMenu("disable",a):d.parents("div:first").hide();return this},setAction:function(a,g){b[a]=g;d&&d.activeMenu("setOption",a,g);return this},getAction:function(a){return b[a]},is:function(b){return d?d.is(b):$(a).is(b)}}};(function(a){a.photos.menu.register("list","#organize-menu",{addToAlbumAction:function(){var b=a("#choose-albums");b.length&&b.parent().remove();a("<div></div>").appendTo("body").load("?module=dialog&action=albums",function(){a("#choose-albums").waDialog({onLoad:function(){a(this).find("h1:first span:first").text("("+a("#photo-list li.selected").length+")")},onSubmit:function(b){var d=a("input[name^=photo_id]").serializeArray(),g=a(this).serializeArray();if(!g.length)return alert($_("Please select at least one album")),
!1;if(!d.length)return b.trigger("close"),!1;b.trigger("change_loading_status",!0);a.photos.addToAlbums({photo_id:d,album_id:g,copy:1,fn:function(){a("#photo-list li.selected").trigger("select",!1);b.trigger("change_loading_status",!1).trigger("close")}});return!1}})})},assignTagsAction:function(){var b=$_("add a tag");a("#photo-list-tags-dialog").waDialog({onLoad:function(){var d=a("#photo-list-tags-dialog #photos-list-tags");a("#photo-list-tags-dialog .tagsinput").length||d.tagsInput({autocomplete_url:"?module=tag&action=list",
height:200,width:"100%",defaultText:b});d.importTags("");a("#photo-list-tags-dialog .js-selected-counter").text("("+a("input[name^=photo_id]:checked").length+")");var f=[];a("input[name^=photo_id]:checked").each(function(){f.push(a(this).val())});for(var g={},c=a.photos.photo_stream_cache.getAll(),e=0,h=a.photos.photo_stream_cache.length();e<h;e++){var k=c[e];if(-1!=a.inArray(k.id,f)&&(k=k.tags,!a.isEmptyObject(k)))if(a.isEmptyObject(g))g=k;else for(var l in k)k.hasOwnProperty(l)&&(g[l]=k[l])}a("#photos-tags-remove-list").empty();
if(jQuery.isEmptyObject(g))a("#photo-tags-remove").hide();else for(l in a("#photo-tags-remove").show(),g)a("#photos-tags-remove-list").append(a("<label></label>").text(g[l]).prepend('<input name="delete_tags[]" value="'+l+'" type="checkbox"> ')).append("<br>");a("#photo-list-tags-dialog .dialog-window").height(a("#photo-list-tags-dialog .dialog-content-indent").outerHeight());a("#photos-popular-tags").off("click.photos","a").on("click.photos","a",function(){var b=a(this).text();d.removeTag(b);d.addTag(b)})},
onSubmit:function(d){var f=a("#photos-list-tags_tag");if(f.length&&f.val()!=b){var g=jQuery.Event("keypress",{which:13});f.trigger(g)}f=a("input[name^=photo_id]:checked").serializeArray();g=a("#photo-list-tags-dialog #photos-list-tags").val();var c=a("#photos-tags-remove-list input[name^=delete_tags]:checked").serializeArray();if(!g.length&&!c.length)return alert($_("Please select at least one tag")),!1;if(!f.length)return d.trigger("close"),!1;d.trigger("change_loading_status",!0);a.photos.assignTags({photo_id:f,
tags:g,delete_tags:c,fn:function(b){if("ok"==b.status){b=b.data.tags;var c=a("#photo-list li.selected"),e;for(e in b)if(b.hasOwnProperty(e)){var f=tmpl("template-photo-list-photo-tags",{tags:b[e]});c.filter("[data-photo-id="+e+"]:first").find(".tags>span").html(f)}c.trigger("select",!1);d.trigger("change_loading_status",!1).trigger("close")}}});return!1}})},deleteFromAlbumAction:function(){var b=a("input[name^=photo_id]").serializeArray();if(b.length){var d=a.photos.getAlbum().id;a.post("?module=photo&action=deleteFromAlbum&id="+
d,b,function(){a.photos.dispatch()},"json")}},deletePhotosAction:function(){var b=a("input[name^=photo_id]").serializeArray();b.length&&a.photos.confirmDialog({url:"?module=dialog&action=confirmDeletePhotos&cnt="+b.length,onSubmit:function(d){d.trigger("change_loading_status",!0);a.photos.deletePhotos(b,function(){a.photos.unsetCover();d.trigger("change_loading_status",!1).trigger("close");a("#photo-list li.selected").trigger("select",!1)});return!1}})},setRateAction:function(){var b=a('<div id="set-rate"></div>').waDialog({url:"?module=dialog&action=rates",
className:"width300px height200px",onLoad:function(d){b.find(".p-rate-photo-counter").text("("+a("input[name^=photo_id]:checked").length+")");a("#photos-rate",d).rateWidget({withClearAction:!1,onUpdate:function(d){var f=b;d=a("#photos-rate",f).rateWidget("getOption","rate");var c=a("input[name^=photo_id]").map(function(){return this.checked?{name:"id[]",value:this.value}:null}).toArray();if(!c.length)return f.trigger("close"),!1;a.photos.saveField({id:c,name:"rate",value:d,fn:function(b){if("ok"==
b.status){var c=b.data.allowed_photo_id&&!a.isArray(b.data.allowed_photo_id)?b.data.allowed_photo_id:{};a("#photo-list li.selected").each(function(){var b=a(this);c[b.attr("data-photo-id")]&&a.photos.updateThumbRate(b,d)}).find("input:first").trigger("select",!1);b.data.count&&a("#rated-count").text(0<b.data.count?b.data.count:"");b.data.alert_msg&&alert(b.data.alert_msg);f.trigger("close")}}});return!1}})}})},makeStackAction:function(){var b=a("input[name^=photo_id]").serializeArray();if(2>b.length)return alert($_("Please select at least two photos")),
!1;a.photos.makeStack(b);return!1},manageAccessAction:function(){var b=a("input[name^=photo_id]").serializeArray();a.photos.showManageAccessDialog(b,function(d){var f=a(this),g=f.serializeArray(),c=f.find("input[name=status]:checked").val();if(!b.length)return d.trigger("close"),!1;d.trigger("change_loading_status",!0);a.photos.saveAccess({photo_id:b,data:g,fn:function(b,f){b=a("#photo-list li.selected");for(var e=0,h=f.length;e<h;++e){var g=b.filter("[data-photo-id="+f[e]+"]:first").find(".p-image-corner.top.left");
g.find(".lock-bw").remove();0>=c&&g.append('<i class="icon16 lock-bw p-private-photo" title="'+$_("Private photo")+'"></i>')}a.photos._updateStreamCache(f,{status:c});a("#photo-list li.selected").trigger("select",!1);d.trigger("change_loading_status",!1).trigger("close")}});return!1});return!1},beforeAnyAction:function(b){if("make-stack"!=b&&!a.photos.isSelectedAnyPhoto())return alert($_("Please select at least one photo")),!1},onFire:function(){a("#organize-menu").trigger("recount")}});a.photos.menu.register("list",
"#selector-menu",{selectPhotosAction:function(b){var d=a("#share-menu-block, #organize-menu-block").find(".count");b.data("checked")?(b.data("checked",!1),b.find(".unchecked").show().end().find(".checked").hide(),d.text("").hide()):(b.data("checked",!0),b.find(".checked").show().end().find(".unchecked").hide(),d.text(a.photos.total_count).show());a("#photo-list li").trigger("select",[!!b.data("checked"),!1])}});a.photos.menu.register("list","#share-menu",{embedAction:function(){var b=a("#embed-photo-list-dialog"),
d=a.storage.get("photos/embed_size"),f=a("#photo-list li.selected").map(function(){var b=a(this).attr("data-photo-id"),c=a.photos.photo_stream_cache.getById(b);0>=c.status&&(b+=":"+c.hash);return b}).toArray().join(","),g=a.photos.getAlbum(),c=a.photos.hash,e={photo_ids:f,hash:c,size:d};g&&0>=g.status&&(c=c.replace(/\/*$/,"")+":"+g.hash+"/",e.hash=c);g="?module=dialog&action=embedPhotoList&photo_ids="+f+"&hash="+c;d&&(g+="&size="+d);b.length||(b=a('<div id="embed-photo-list-dialog"></div>'),a("body").append(b));
b.load(g,function(){b.find("div:first").waDialog({onLoad:function(){function c(d){var e=c.data,f=!1,h;for(h in e)if(e.hasOwnProperty(h)&&e[h]!==d[h]){f=!0;break}c.data=a.extend({},d);f&&(b.find("h1").find(".loading").parent().show(),a.post("?module=photo&action=embedList",d,function(c){if("ok"==c.status){var d=c.data.context;b.find("input[name=link]").val(d.link);b.find("a.link").attr("href",d.link);b.find("textarea[name=urls]").val(d.urls);b.find("#embed-photo-list-html").val(d.html);b.find("#embed-photo-list-html-with-descriptions").val(d.html_with_descriptions);
b.find("textarea[name=smarty_code]").val(d.smarty_code);b.find("h1 span:first").text("("+d.count+")");d.all_public?b.find(".exclamation-message").hide():b.find(".exclamation-message").show();d.domains=d.domains||{};m.children().each(function(){var b=a(this),c=b.attr("value");b.data("frontend-url",(d.domains[c]||{}).frontend_url||"")});g();l()}b.find("h1").find(".loading").parent().hide()},"json"))}function g(){a.each(["textarea[name=urls]","#embed-photo-list-html","#embed-photo-list-html-with-descriptions"],
function(b,c){b=a(c);b.data("context_data",b.val())})}function l(){if(!m.length)return!1;a.each(["textarea[name=urls]","#embed-photo-list-html","#embed-photo-list-html-with-descriptions"],function(b,c){b=a(c);b.val(b.data("context_data").split(m.data("original-domain")).join(m.val()))});var c=m.children(":selected");c.data("frontend-url")?(b.find("input[name=link]").val(c.data("frontend-url")).closest(".field").slideDown(),b.find("a.link").attr("href",c.data("frontend-url"))):b.find("input[name=link]").closest(".field").slideUp()}
var n=b.find("select[name=size]");d&&n.val(d);n.change(function(){var b=a(this).val();e.size=b;c(e);a.storage.set("photos/embed_size",b)});b.find("input[name=description]").click(function(){this.checked?(a("#embed-photo-list-html-with-descriptions").show().attr("disabled",!1),a("#embed-photo-list-html").hide().attr("disabled",!0)):(a("#embed-photo-list-html").show().attr("disabled",!1),a("#embed-photo-list-html-with-descriptions").hide().attr("disabled",!0))});b.find("input[name=link], textarea[name=urls], textarea[name=html], textarea[name=smarty_code]").click(function(){a(this).getSelection().length||
a(this).select()});b.find("input[name=link]").focus().select();b.find(".switcher").activeMenu({selectedPhotosAction:function(a){e.size=b.find("select[name=size]").val();e.photo_ids=f;c(e)},allListPhotosAction:function(a){e.size=b.find("select[name=size]").val();e.photo_ids="";c(e)}}).find("li").click(function(){a(this).parent().find(".selected").removeClass("selected").end().end().addClass("selected")});c.data=c.data||a.extend({},e);var m=b.find("select[name=domain]");m.length&&(g(),l(),m.change(l))},
onSubmit:function(){return!1}})});return!1},beforeAnyAction:function(b){if(!a.photos.isSelectedAnyPhoto()&&"blog-post"!=b&&"embed"!=b)return alert($_("Please select at least one photo")),!1},blogPostAction:function(){for(var b=a("#blog-post-form"),d=a("#photo-list li.selected").map(function(){return a(this).attr("data-photo-id")}).toArray(),f=[0,0],g=0;g<d.length;g++){var c=a.photos.photo_stream_cache.getById(d[g]);c||(c=a.photos.photo_stack_cache.getById(d[g]));c&&(c.hash&&(d[g]+=":"+c.hash),++f[c.status])}g=
a.photos.getAlbum();c=a.photos.hash;var e={photo_ids:d.join(","),hash:c,size:obligatory_size};g&&0>=g.status&&(c=c.replace(/\/*$/,"")+":"+g.hash+"/",e.hash=c);e.hash=null;a("#photo-blog-dialog :submit").attr("disabled",!0);a.post("?module=photo&action=embedList",e,function(c){"ok"==c.status&&(c=c.data.context,b.find('[name="title"]:input').val(a("#photo-list-name").text()),b.find('[name="text"]:input').val(blog_smarty_enabled?c.smarty_code:c.html_with_descriptions),f[0]?a("#photo-blog-dialog :submit").attr("disabled",
!1):b.submit())},"json");f[0]&&a("#photo-blog-dialog").waDialog({onLoad:function(){a("#photo-blog-dialog :submit").attr("disabled",!0);var b=a("#photo-blog-dialog p"),c=[f[0],d.length];b.html(b.html().replace(/(%d)/g,function(){return c.shift()}))},onSubmit:function(){b.submit();return!1}});return!1},onFire:function(){a("#share-menu").trigger("recount")}});a("#p-sidebar a, #wa-header a, a.album-view, #photo-list div.p-image a").live("click",function(b){if(a("#save-menu-block").is(":visible")&&a("#save-menu-block input.button").hasClass("yellow")&&
!confirm($_("Unsaved changes will be lost if you leave this page now. Are you sure?")))return b.preventDefault(),!1});a.photos.menu.register("list","#save-menu",{saveDescriptionAction:function(){var b={},d,f,g;a("#photo-list.p-descriptions :text,#photo-list.p-descriptions textarea").each(function(){if(this.defaultValue!=this.value&&(d=a(this).attr("name").match(/^photo\[(\d+)\]\[(\w+)\]$/))){f=d[1];g=d[2];var c=a.photos.photo_stream_cache.getById(f);c&&this.value==c[g]||(b[f]||(b[f]={id:f}),b[f][g]=
this.value)}});a.photos.saveFields(b);a("#photo-list.p-descriptions :text.highlighted,#photo-list.p-descriptions textarea.highlighted").each(function(){a(this).removeClass("highlighted")});var c=a("#save-menu-block .count.indicator");c.length&&(c.text(0),a("#save-menu-block input.button").removeClass("yellow").addClass("green"),c.hide());return!1},hideNameAction:function(b,d){var f=b.find(":checkbox"),g=f.prop("checked");"INPUT"!=d.target.tagName&&(g=!g);g?(a('#photo-list li :text[name$="[name]"]').hide(),
a('#photo-list li textarea[name$="[description]"].js-small').css("height","+=27").removeClass("js-small").addClass("js-big")):(a('#photo-list li :text[name$="[name]"]').show(),a('#photo-list li textarea[name$="[description]"].js-big').css("height","-=27").removeClass("js-big").addClass("js-small"));setTimeout(function(){f.attr("checked",g)},50);a.storage.set("photos/list/hide_name",g)},onFire:function(){var b=a("#save-menu-block .count.indicator");b.length&&(b.text("0"),a("#save-menu-block input.button").removeClass("yellow").addClass("green"),
b.hide())},onInit:function(b){b.find('[data-action="hide-name"] :checkbox').prop("checked",a.storage.get("photos/list/hide_name",!1));b=function(){var b=[],f;a("#photo-list.p-descriptions :text,#photo-list.p-descriptions textarea").each(function(){if(this.defaultValue!=this.value&&(f=a(this).attr("name").match(/^photo\[(\d+)\]\[(\w+)\]$/))){var c=f[1];if(0>b.indexOf(c)){var d=a.photos.photo_stream_cache.getById(c);d&&this.value==d[f[2]]?a(this).hasClass("highlighted")&&a(this).removeClass("highlighted"):
(a(this).addClass("highlighted"),b.push(c))}}else a(this).hasClass("highlighted")&&a(this).removeClass("highlighted")});var g=a("#save-menu-block .count.indicator"),c=b.length;g.length&&g.text(c);c?(a("#save-menu-block input.button").removeClass("green").addClass("yellow"),g.show()):(a("#save-menu-block input.button").removeClass("yellow").addClass("green"),g.hide())};a("#p-content").on("change.photos-save-menu","#photo-list.p-descriptions :text, #photo-list.p-descriptions textarea",b);a("#p-content").on("keyup.photos-save-menu",
"#photo-list.p-descriptions :text, #photo-list.p-descriptions textarea",b)}})})(jQuery);(function(a){a.photos.menu.register("photo","#photo-organize-menu",{addToAlbumAction:function(){a('<div id="choose-albums-photo"></div>').waDialog({url:"?module=dialog&action=albums&id="+a.photos.getPhotoId(),className:"width600px height400px",onSubmit:function(b){var d=a.photos.photo_stream_cache.getCurrent().id;a.photos.addToAlbums({photo_id:d,album_id:a(this).serializeArray(),copy:0,fn:function(f){if("ok"==f.status){var g=f.data.old_albums||[],c=a.photos.getAlbum();f=f.data.albums;if(c)for(var e=
0,h=g.length;e<h;++e)if(c.id==g[e].id){f.length?a.photos.goToHash("/album/"+f[0].id+"/photo/"+d):a.photos.goToHash("/photo/"+d);b.trigger("close");return}a("#photo-albums").html(tmpl("template-photo-albums",{albums:f}));b.trigger("close")}}});return!1}})},deletePhotoAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=confirmDeletePhoto&id="+a.photos.getPhotoId(),onSubmit:function(b){b.trigger("close");a.photos.setCover();a.photos.deletePhotos(a.photos.getPhotoId(),function(){a.photos.unsetCover()});
return!1}})},unstackAction:function(){a.photos.confirmDialog({url:"?module=dialog&action=confirmUnstack&cnt="+a.photos.photo_stack_cache.length(),onSubmit:function(b){b.trigger("close");b=a.photos.photo_stream_cache.getCurrent().id;a.post("?module=stack&action=unmake&id="+b,{},function(b){a.photos.goToHash(a.photos.hash)},"json");return!1}})},manageAccessAction:function(){var b=a.photos.photo_stream_cache.getCurrent().id;a.photos.showManageAccessDialog("photo_id="+b,function(b){var d=a(this).serializeArray();
d.push({name:"one_photo",value:1});a.photos.saveAccess({photo_id:a.photos.photo_stream_cache.getCurrent().id,data:d,fn:function(d){var c=d.data.photo,e=d.data.stack;if(c)c=a.photos.photo_stream_cache.updateById(c.id,c),a.photos.initPhotoContentControlWidget({frontend_link_template:d.data.frontend_link_template,photo:c}),a.photos.updatePhotoImgs(c);else if(e&&a.isArray(e)&&e.length){c=a.photos.photo_stack_cache;for(var f=c.getCurrent(),g=0,l=e.length;g<l;++g)c.updateById(e[g].id,e[g]);a.photos.initPhotoContentControlWidget({frontend_link_template:d.data.frontend_link_template,
photo:f});a.photos.updatePhotoImgs(f)}b.trigger("close")},onDeniedExist:function(){alert($_("You don't have sufficient access rights"))}});return!1});return!1}});a.photos.menu.register("photo","#edit-menu",{beforeAnyAction:function(){a.photos.setCover()},rotateLeftAction:function(){a.photos.rotate(a.photos.getPhotoId(),"left",function(){a.photos.unsetCover()})},rotateRightAction:function(){a.photos.rotate(a.photos.getPhotoId(),"right",function(){a.photos.unsetCover()})},onInit:function(){a(window).resize(a.photos.centralizeLoadingIcon)}});
a.photos.menu.register("photo","#share-menu",{embedAction:function(){var b=a("#embed-photo-dialog"),d=a.photos.getPhotoId(),f=a.photos.hash,g=a.storage.get("photos/embed_size");d="?module=dialog&action=embedPhoto&photo_id="+d+"&hash="+f;g&&(d+="&size="+g);b.length||(b=a('<div id="embed-photo-dialog"></div>'),a("body").append(b));b.load(d,function(){b.find("div:first").waDialog({onLoad:function(){function c(){k.length&&a.each(["textarea[name=html]","input[name=url]"],function(b,c){b=a(c);b.data("context_data",
b.val())})}function d(){if(!k.length)return!1;a.each(["textarea[name=html]","input[name=url]"],function(b,c){b=a(c);b.val(b.data("context_data").split(k.data("original-domain")).join(k.val()))});var c=k.children(":selected");c.data("frontend-url")?(b.find("input[name=link]").val(c.data("frontend-url")).closest(".field").slideDown(),b.find("a.link").attr("href",c.data("frontend-url"))):b.find("input[name=link]").closest(".field").slideUp()}var f=b.find("select[name=size]");f.val(g);f.change(function(){var e=
a(this).val(),f=b.data("contexts")[e];b.find("textarea[name=html]").val(f.html);b.find("input[name=url]").val(f.url);a.storage.set("photos/embed_size",e);c();d()});var k=b.find("select[name=domain]");k.length&&(c(),d(),k.change(d));b.find("input[name=url], textarea[name=html], input[name=link]").click(function(){a(this).getSelection().length||a(this).select()});b.find("input[name=link]").focus().select()},onSubmit:function(){return!1}})});return!1},blogPostAction:function(){var b=a("#blog-post-form"),
d=a.photos.getPhotoId(),f=a.photos.photo_stream_cache.getById(d);f||(f=a.photos.photo_stack_cache.getById(d));f&&(d=f.id,f.hash&&(d+=":"+f.hash),d={photo_ids:d,hash:null,size:obligatory_size},a("#photo-blog-dialog :submit").attr("disabled",!0),a.post("?module=photo&action=embedList",d,function(d){"ok"==d.status&&(d=d.data.context,b.find('[name="title"]:input').val(f.name),d=d.html_with_descriptions,b.find('[name="text"]:input').val(d.replace(/^<p>(.*)<\/p>$/mi,"$1")),parseInt(f.status)?b.submit():
a("#photo-blog-dialog :submit").attr("disabled",!1))},"json"),parseInt(f.status)||a("#photo-blog-dialog").waDialog({onLoad:function(){a("#photo-blog-dialog :submit").attr("disabled",!0);var b=a("#photo-blog-dialog p"),c=[1,1];b.html(b.html().replace(/(%d)/g,function(){return c.shift()}))},onSubmit:function(){b.submit();return!1}}));return!1}});a("#restore-original").live("click",function(){confirm($_("This will reset all changes you applied to the image after upload, and will restore the image to its original. Are you sure?"))&&
(a.photos.setCover(),a.photos.restoreOriginal(a.photos.getPhotoId(),function(){a.photos.unsetCover()}))})})(jQuery);$.photos=$.photos||{};$.photos.widget=$.photos.widget||{};
$.photos.widget.loupe={options:{animate:!0,debug:!1},css:{init:{width:null,"max-width":null,"margin-left":0,"margin-top":0,height:null}},drag:!1,loaded:!1,photo_data:null,thumb_data:null,container:null,helper:null,link:null,offset:{},status:"thumb",init:function(a){this.options=$.extend(this.options,a||{});var b=this;b.trace("init");$.photos.hooks_manager.bind("afterRenderImg",function(a,f,g){b.trace("afterRenderImg");b.prepare(a,f,g)});$.photos.hooks_manager.bind("beforeLoadPhoto",function(){b.trace("beforeLoadPhoto");
b.stop()});$.photos.hooks_manager.bind("onAbortPrevLoading",function(){b.trace("onAbortPrevLoading");b.stop()})},trace:function(a){console&&this.options.debug&&console.log(a)},prepare:function(a,b,d){var f=this;$(".p-one-photo a.next").die("click.loupe").live("click.loupe",function(a){return f.clickNextHandler.apply(f,[this,a])});this.trace("prepare, status="+this.status);this.photo_data=b;this.container=a;this.thumb_data={height:d.size.height,width:d.size.width,src:d.url};"thumb"!=this.status&&this.stop();
this.loaded=!1;this.reset()},reset:function(){this.trace("reset, status="+this.status);this.link=$("#photo-loupe-link");$("div.photo-loupe-wrapper").length&&(this.container.css({width:this.thumb_data.width+"px","max-width":"",height:this.thumb_data.height+"px","margin-left":"","margin-top":""}),this.container.unwrap());this.status="thumb";this.link.find(".minimize").hide();this.thumb_data.width&&this.thumb_data.width<this.photo_data.width||this.thumb_data.height&&this.thumb_data.height<this.photo_data.height?
(this.link.find(".maximize").show(),this.options.animate=this.thumb_data.height&&this.thumb_data.width?!0:!1):this.link.find(".maximize").hide();var a=this;this.link.unbind(".loupe").bind("click.loupe",function(b){return a.clickHandler.apply(a,[this,b])}).show()},clickHandler:function(){this.trace("clickHandler, status="+this.status);switch(this.status){case "loading":this.container.stop();case "maximized":this.status="unloading";this.link.find(".minimize").hide();this.link.find(".maximize").show();
this.decrease();break;case "thumb":this.status="loading",this.link.find(".minimize").hide(),this.link.find(".maximize").hide(),this.enlarge()}return!1},clickNextHandler:function(a,b){(a="thumb"==this.status?!0:!1)||b.preventDefault();this.trace("clickNextHandler "+a);return a},interaction:function(a,b,d){d=d.parents("body");switch(b.type){case "mouseup":this.drag&&(b.preventDefault(),this.drag=!1,$("div.photo-loupe-wrapper").css("cursor","auto"),$("body").css("cursor",""),d.unbind(".loupe-move"));
break;case "mousedown":case "click":this.clickNextHandler(a,b);if(!this.drag){$("div.photo-loupe-wrapper").css("cursor","move");this.drag=!0;this.offset.mouseX=b.pageX;this.offset.mouseY=b.pageY;var f=this;d.bind("mouseover.loupe-move mousemove.loupe-move",function(a){return f.watch.apply(f,[this,a])})}break;case "mouseleave":this.drag&&(b.preventDefault(),$("div.photo-loupe-wrapper").css("cursor","auto"),this.drag=!1,d.unbind(".loupe-move"))}},enlarge:function(){this.drag=!1;var a=this;this.trace("enlarge, status="+
this.status);$("#photo").removeClass("ui-draggable").closest(".p-image").addClass("p-image-maximized");this.offset=this.container.offset();this.offset.x=Math.round((this.thumb_data.width-this.photo_data.width)/2);this.offset.y=Math.round((this.thumb_data.height-this.photo_data.height)/2);this.container.wrap('<div class="photo-loupe-wrapper" style="height:'+this.thumb_data.height+"px;width:"+this.thumb_data.width+'px;position: relative;"/>');this.container.removeAttr("width").removeAttr("height").css({width:this.thumb_data.width+
"px",height:this.thumb_data.height+"px","margin-left":0,"margin-top":0,"max-width":this.photo_data.width+"px",display:"inline-block"});this.options.animate?this.container.animate({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"},function(){return a.enlargeComplete.apply(a,[this])}):(this.container.css({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+
"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"}),this.enlargeComplete());this.link.find(".minimize").show();this.bind(this.container);if(!this.helper){var b=$("#photo-loupe");this.helper=b.length?b.first():$('<img id="photo-loupe"/>');this.helper.load(function(b){a.loaded=!0})}this.helper.attr("src","?module=photo&action=download&photo_id="+this.photo_data.id+"&attach="+(this.photo_data.edit_datetime||this.photo_data.upload_datetime))},enlargeComplete:function(){if(this.loaded)this.trace("enlargeComplete, status="+
this.status),this.helper.css({width:this.photo_data.width+"px",height:this.photo_data.height+"px","margin-left":this.offset.x+"px","margin-top":this.offset.y+"px","max-width":this.photo_data.width+"px"}).show(),this.container.before(this.helper).hide(),this.container.unbind(".loupe .loupe-move"),this.bind(this.helper),this.container.css({width:this.thumb_data.width+"px","max-width":"",height:this.thumb_data.height+"px","margin-left":"","margin-top":""}),this.link.find(".minimize").show(),this.status=
"maximized";else{var a=this;setTimeout(function(){return a.enlargeComplete.apply(a,[this])},50)}},bind:function(a){this.trace("bind, status="+this.status);var b=this;a.bind("mousedown.loupe",function(d){return b.interaction.apply(b,[this,d,a])});$(document).bind("mouseup.loupe",function(d){return b.interaction.apply(b,[this,d,a])})},stop:function(){this.trace("stop at status="+this.status);var a=this.status;this.status="stop";switch(a){case "loading":this.container.stop();this.decrease(!0);break;
case "maximized":this.decrease(!0);break;case "unloading":this.helper&&this.helper.stop(),this.decreaseComplete(!0)}this.container&&this.container.find("*").unbind(".loupe .loupe-move");$(document).unbind(".loupe .loupe-move");a=$("div.photo-loupe-wrapper");$("#photo-loupe-link img:visible").hide();$("body").css("cursor","");a.length&&this.container.unwrap();this.helper&&(this.helper.remove(),this.helper=null);this.status="thumb"},decrease:function(a){this.trace("decrease, status="+this.status);this.loaded=
!1;var b=this,d={width:this.thumb_data.width+"px",height:this.thumb_data.height+"px","margin-left":0,"margin-top":0};a||!this.options.animate?(this.helper.css(d),b.decreaseComplete()):this.helper.animate(d,function(){b.decreaseComplete()});return!1},decreaseComplete:function(a){this.trace("decreaseComplete, status="+this.status);$("#photo").addClass("ui-draggable").closest(".p-image").removeClass("p-image-maximized");this.container.css(this.css.init).show();this.helper.hide();a||this.reset()},watch:function(a,
b){this.drag&&(b.preventDefault(),this.offset.x=Math.min(0,Math.max(this.thumb_data.width-this.photo_data.width,Math.round(this.offset.x-this.offset.mouseX+b.pageX))),this.offset.y=Math.min(0,Math.max(this.thumb_data.height-this.photo_data.height,Math.round(this.offset.y-this.offset.mouseY+b.pageY))),this.offset.mouseX=b.pageX,this.offset.mouseY=b.pageY,("loading"==this.status?this.container:this.helper).css({"margin-left":this.offset.x+"px","margin-top":this.offset.y+"px"}))}};(function(){jQuery.each({getSelection:function(){var a=this.jquery?this[0]:this;return("selectionStart"in a&&function(){var b=a.selectionEnd-a.selectionStart;return{start:a.selectionStart,end:a.selectionEnd,length:b,text:a.value.substr(a.selectionStart,b)}}||document.selection&&function(){a.focus();var b=document.selection.createRange();if(null===b)return{start:0,end:a.value.length,length:0};var d=a.createTextRange(),f=d.duplicate();d.moveToBookmark(b.getBookmark());f.setEndPoint("EndToStart",d);
return{start:f.text.length,end:f.text.length+b.text.length,length:b.text.length,text:b.text}}||function(){return null})()},replaceSelection:function(a){var b="function"==typeof this.id?this.get(0):this,d=a||"";return("selectionStart"in b&&function(){b.value=b.value.substr(0,b.selectionStart)+d+b.value.substr(b.selectionEnd,b.value.length);return this}||document.selection&&function(){b.focus();document.selection.createRange().text=d;return this}||function(){b.value+=d;return jQuery(b)})()}},function(a){jQuery.fn[a]=
this})})();
//# sourceMappingURL=photos-jquery.min.js.map