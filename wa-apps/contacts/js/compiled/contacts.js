(function(b){b.wa.controller={free:!0,init:function(a){this.frontend_url=a&&a.url||"/";this.backend_url=a&&a.backend_url||"/webasyst/";b.storage=new b.store;b.ajaxSetup({cache:!1});this.lastView={title:null,hash:null};this.options=a;this.random=null;b.wa.dropdownsCloseEnable();"undefined"!=typeof b.History&&b.History.bind(function(a){b.wa.controller.dispatch(a)});b.wa.errorHandler=function(a){return 404==a.status?(b.wa.setHash("/contacts/all/"),!1):!0};b("#contacts-container .contacts-data input.selector").live("click",
function(){b(this).is(":radio")&&b(this).parents(".contact-row").siblings().removeClass("selected");b(this).is(":checked")?b(this).parents(".contact-row").addClass("selected"):b(this).parents(".contact-row").removeClass("selected");b.wa.controller.updateSelectedCount()});b(".collapse-handler",b("#wa-app")).die("click").live("click",function(){b.wa.controller.collapseSidebarSection(this,"toggle")});this.restoreCollapsibleStatusInSidebar();b("ul.collapsible i.darr").click(function(){b(this).hasClass("darr")?
(b(this).parent("li").children("ul").hide(),b(this).removeClass("darr").addClass("rarr")):(b(this).parent("li").children("ul").show(),b(this).removeClass("rarr").addClass("darr"))});var c=null,d=function(a){if(a.hasClass("animated"))return!1;a.addClass("animated");a.hoverIntent({over:function(){c=setTimeout(function(){c=null},500);a.removeClass("disabled")},timeout:0.3,out:function(){a.addClass("disabled");c&&(clearTimeout(c),c=null)}});return!0};b("#c-list-toolbar-menu",b("#c-core")[0]).live("mouseover",
function(){var a=b(this);d(a)&&a.mouseover()});b("#c-list-toolbar-menu",b("#c-core")[0]).live("click",function(a){var g=b(this);if((!c||g.hasClass("disabled"))&&!(0<b(a.target).parents("ul#c-list-toolbar-menu ul").size()))g.toggleClass("disabled"),!d(g)&&c&&(clearTimeout(c),c=null)});b(document).ajaxError(function(){b.storage.del("contacts/last-hash")});this.initFull&&this.initFull(a)},stopDispatch:function(a){this.stopDispatchIndex=a},previousHash:null,redispatch:function(){this.previousHash=null;
this.dispatch()},dispatch:function(a){if(0<this.stopDispatchIndex)return this.stopDispatchIndex--,!1;a=void 0===a?this.getHash():this.cleanHash(a);if(this.previousHash!=a){var c=this.previousHash;this.previousHash=a;var d=new b.Event("wa_before_dispatched");b(window).trigger(d);if(d.isDefaultPrevented())return this.previousHash=c,window.location.hash=c,!1;if(a=a.replace(/^[^#]*#\/*/,"")){c=!0;a=a.split("/");if(a[0]){for(var d="",e=a.length,g=0;g<a.length;g++){var h=a[g];if(2>g)if(0===g)d=h;else if(parseInt(h,
10)!=h)d+=h.substr(0,1).toUpperCase()+h.substr(1);else{e=g;break}else{e=g;break}}e=a.slice(e);this[d+"Action"]?(this.currentAction=d,this.currentActionAttr=e,this[d+"Action"](e)):(c=!1,console&&console.log("Invalid action name:",d+"Action"))}else this.defaultAction();a.join&&(a=a.join("/"));c&&b.storage.set("contacts/last-hash",a)}else this.defaultAction(),b.storage.del("contacts/last-hash");this.highlightSidebar();b(document).trigger("hashchange",[a]);b(window).trigger("wa-dispatched")}},lastPage:function(){var a=
b.storage.get("contacts/last-hash");a?b.wa.setHash("#/"+a):this.defaultAction()},defaultAction:function(){this.contactsAllAction()},groupsRightsAction:function(a){!a||!a[0]?console&&console.log("Group id not specified for groupsRightsAction."):this.loadHTML("?module=groups&action=rights&id="+a[0],null,function(){this.setBlock()})},groupsCreateAction:function(){this.groupsEditAction()},groupsEditAction:function(a){this.loadHTML("?module=groups&action=editor"+(a&&a[0]?"&id="+a[0]:""),null,function(){this.setBlock()})},
categoriesCreateAction:function(){this.categoriesEditAction()},categoriesEditAction:function(a){this.loadHTML("?module=categories&action=editor"+(a&&a[0]?"&id="+a[0]:""),null,function(){this.setBlock()})},categoriesDeleteAction:function(a){var c=!0;if(!a||!a[0])a=[this.current_category_id],c=!1;b.wa.dialogCreate("delete-dialog",{content:b("<h2>"+$_("Delete this category?")+"</h2><p>"+$_("No contacts will be deleted.")+"</p>"),buttons:b("<div></div>").append(b('<input type="submit" class="button red" value="'+
$_("Delete category")+'">').click(function(){0>=b(this).find(".loading").size()&&b('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);b.post("?module=categories&action=delete",{id:a[0]},function(){b.wa.controller.reloadSidebar();b.wa.dialogHide();b.wa.setHash("#/users/all/")})})).append(" "+$_("or")+" ").append(b('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(function(){b.wa.dialogHide();c&&(b.wa.controller.stopDispatch(1),b.wa.back())})),small:!0});return!1},
contactsGroupAction:function(a){if(a&&a[0]){this.showLoading();var c=this.parseParams(a.slice(1),"contacts/group/"+a[0]);c.fields=["name","email","company","_access"];c.query="group/"+a[0];this.loadGrid(c,"/contacts/group/"+a[0]+"/",!1,{afterLoad:function(c){b('#list-group li[rel="group'+a[0]+'"]').children("span.count").html(c.count)},beforeLoad:function(){this.current_group_id=a[0];this.setBlock("contacts-list",null,["group-actions"])}})}},groupsDeleteAction:function(a){var c=!0;if(!a||!a[0])a=
[this.current_group_id],c=!1;b.wa.dialogCreate("delete-dialog",{content:b("<h2>"+$_("Delete this group?")+"</h2><p>"+$_("No contacts will be deleted.")+"</p>"),buttons:b("<div></div>").append(b('<input type="submit" class="button red" value="'+$_("Delete group")+'">').click(function(){b('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);b.post("?module=groups&action=delete",{id:a[0]},function(){b('#wa-app .sidebar a[href="#/contacts/group/'+a[0]+'/"]').parent().remove();
0>=b("#list-group").children().size()&&b.wa.controller.reloadSidebar();b.wa.dialogHide();b.wa.setHash("#/users/all/")})})).append(" "+$_("or")+" ").append(b('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(function(){b.wa.dialogHide();c&&(b.wa.controller.stopDispatch(1),b.wa.back())})),small:!0});return!1},contactsAddAction:function(a){this.loadHTML("?module=contacts&action=add"+(a&&a[0]?"&company=1":""),null,function(){this.setBlock("contacts-info")})},contactAction:function(a){var b={};
a[1]&&(b={tab:a[1]});this.showLoading();this.load("#c-core","?module=contacts&action=info&id="+a[0],b,function(){this.setBlock("contacts-info")})},contactPhotoAction:function(a){this.showLoading();this.loadHTML("?module=photo&action=editor&id="+a[0]+(a[1]?"&uploaded=1":""),{},function(){this.setBlock("contacts-info")})},contactsAllAction:function(a){this.showLoading();this.loadGrid(this.parseParams(a,"contacts/all"),"/contacts/all/",!1,{beforeLoad:function(){this.setBlock("contacts-list")},afterLoad:function(a){b("#sb-all-contacts-li span.count").html(a.count)}})},
contactsSearchAction:function(a,c){if(!a||!a[0]||"form"==a[0]){if(!this.contactsSearchForm){console&&(console.log("No advanced search in free contacts."),setTimeout(function(){b.wa.setHash("#/")},1));return}return this.contactsSearchForm(a&&"form"===a[0]?a.slice(1):[])}this.showLoading();"results"==a[0]&&(c||(c={search:!0}),a=a.slice(1));var d=a[0];"?"==d.substr(0,1)&&(d=d.substr(1));var e=this.parseParams(a.slice(1),"contacts/search/"+d);e.query=d;c&&c.search&&(e.search=1);d=this.cleanHash("#/contacts/search/"+
d);this.loadGrid(e,d.substr(1),null,{beforeLoad:function(){this.setBlock("contacts-list",false,["search-actions"]);this.setTitle();if(c&&c.search){b("#list-main .item-search").show();b("#list-main .item-search a").attr("href","#/contacts/search/results/"+a[0]+"/");e.search=1}}})},contactsCategoryAction:function(a){if(a&&a[0]){this.showLoading();var c=this.parseParams(a.slice(1),"contacts/category/"+a[0]);c.query="/category/"+a[0];this.loadGrid(c,"/contacts/category/"+a[0]+"/",!1,{beforeLoad:function(b){this.current_category_id=
a[0];this.setBlock("contacts-list",null,b&&b.system_category?[]:["category-actions"])},afterLoad:function(c){b('#list-category li[rel="category'+a[0]+'"]').children("span.count").html(c.count)}})}},usersAllAction:function(a){this.showLoading();a=this.parseParams(a,"users/all");a.query="/users/all/";a.fields=["name","email","company","_access"];this.loadGrid(a,"/users/all/",!1,{beforeLoad:function(){this.setBlock("contacts-list")},afterLoad:function(a){b("#sb-all-users-li span.count").html(a.count)}})},
contactsMerge:function(){var a=b.wa.grid.getSelected();if(2>a.length)return!1;this.loadHTML("?module=contacts&action=mergeSelectMaster",{ids:a})},simpleSearch:function(){var a=b.trim(b("#search-text").val());if(a){var c="",a=a.replace(/\\/g,"\\\\").replace(/%/g,"\\%").replace(/_/g,"\\_").replace(/&/g,"\\&").replace(/\+/g,"%2B").replace(/\//g,"%2F"),c=-1!=a.indexOf("@")?"email*="+a:"name*="+a;b.wa.controller.stopDispatch(1);b.wa.setHash("#/contacts/search/"+c+"/");b.wa.controller.contactsSearchAction([c],
{search:!0})}},addToCategory:function(a,c){c=c||b.wa.grid.getSelected();b.wa.controller.showMessage("",!0);c.length&&a&&b.post("?module=categories&type=add",{contacts:c,categories:a},function(a){if(a.data&&a.data.count)for(var c in a.data.count)b('#list-category li[rel="category'+c+'"] span.count').html(a.data.count[c]);b.wa.controller.showMessage(a.data.message,!0)},"json")},dialogAddSelectedToCategory:function(){0>=b.wa.grid.getSelected().length||0>=b("#list-category li:not(.empty):not(.selected):not(.hint)").size()?
b.wa.controller.showMessage('<span class="errormsg">'+$_("No categories available")+"</span>",!0):b('<div id="add-to-category-dialog"></div>').waDialog({url:"?module=categories&action=addSelected"+(this.current_category_id?"&disabled="+this.current_category_id:"")})},dialogRemoveSelectedFromCategory:function(a){a=a||b.wa.grid.getSelected();!(0>=a.length)&&b.wa.controller.current_category_id&&b('<div id="confirm-remove-from-category-dialog" class="small"></div>').waDialog({content:b("<h2></h2>").text($_('Exclude contacts from category "%s"?').replace("%s",
b("h1.wa-page-heading").text())),buttons:b("<div></div>").append(b('<input type="submit" class="button red" value="'+$_("Exclude")+'">').click(function(){b('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);b.post("?module=categories&type=del",{categories:[b.wa.controller.current_category_id],contacts:a},function(a){b.wa.dialogHide();b.wa.controller.afterInitHTML=function(){b.wa.controller.showMessage(a.data.message)};b.wa.controller.redispatch()},"json")})).append(" "+
$_("or")+" ").append(b('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(b.wa.dialogHide))})},excludeFromGroup:function(){b.post("?module=contacts&action=groups&type=del",{group_id:b.wa.grid.settings.group,"id[]":b.wa.grid.getSelected()},function(a){"ok"==a.status&&(b.wa.controller.afterInitHTML=function(){b.wa.controller.showMessage(a.data.message)},b.wa.controller.redispatch())},"json")},contactsDelete:function(a){a=a||b.wa.grid.getSelected();0>=a.length||b.wa.dialogCreate("delete-dialog",
{content:"<h2>"+$_("Checking links to other applications...")+' <i class="icon16 loading"></i></h2>',url:"?module=contacts&action=links",small:!0,post:{"id[]":a}})},listTabs:[],addListTab:function(a){this.listTabs.push(a)},setBlock:function(a,c,d){a||(a="default");void 0===c&&(c=$_("Loading..."));var e=this.block;this.block=a;b("#c-core .c-core-header").remove();var g=b("#c-core .c-core-content");0>=g.size()&&(g=b("#c-core").empty().append(b('<div class="contacts-background"><div class="block not-padded c-core-content"></div></div>')).find(".c-core-content"));
g.html('<div class="block"><h1 class="wa-page-heading">'+c+' <i class="icon16 loading"></i></h1></div>');b.scrollTo(0);d&&0<=d.indexOf("group-actions")&&this.current_group_id?g.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#/groups/edit/'+this.current_group_id+'/"><i class="icon16 edit"></i>'+$_("Edit group")+'</a></li><li><a href="#/groups/rights/'+this.current_group_id+'/"><i class="icon16 lock-unlocked"></i>'+$_("Customize access")+'</a></li><li><a href="#/groups/delete/'+
this.current_group_id+'/" onclick="return $.wa.controller.groupsDeleteAction();"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li></ul>"):d&&0<=d.indexOf("category-actions")&&this.current_category_id&&this.global_admin?g.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#/categories/edit/'+this.current_category_id+'/"><i class="icon16 edit"></i>'+$_("Edit category")+'</a></li><li><a href="#/categories/delete/'+this.current_category_id+'/" onclick="return $.wa.controller.categoriesDeleteAction();"><i class="icon16 delete"></i>'+
$_("Delete")+"</a></li></ul>"):d&&0<=d.indexOf("search-actions")&&!this.free?g.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#" onclick="return $.wa.controller.saveSearchAsFilter()"><i class="icon16 save-as-filter"></i>'+$_("Save as a filter")+"</a></li></ul>"):d&&0<=d.indexOf("list-actions")&&this.current_view_id?g.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#/lists/edit/'+this.current_view_id+'/"><i class="icon16 edit"></i>'+$_("Edit list")+'</a></li><li><a href="#" onclick="return $.wa.controller.deleteList('+
this.current_view_id+')"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li></ul>"):d&&(0<=d.indexOf("view-actions")&&this.current_view_id)&&g.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#/filters/edit/'+this.current_view_id+'/"><i class="icon16 edit"></i>'+$_("Edit filter")+'</a></li><li><a href="#" onclick="return $.wa.controller.deleteList('+this.current_view_id+', true)"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li></ul>");switch(a){case "contacts-duplicates":case "contacts-list":if(0<
this.listTabs.length){var e=b('<ul class="tabs" id="c-list-tabs"></ul>'),h=(b("#wa-app .sidebar .selected a").attr("href")||"").replace(/^[^#]*#/g,"");"/"!==h[0]&&(h="/"+h);for(var i=0;i<this.listTabs.length;i++)"function"==typeof this.listTabs[i]&&this.listTabs[i].call(b.wa.controller,e,h);0<e.children().size()&&(e.prepend(b('<li class="selected"></li>').append(b('<a href="#'+h+'">'+$_("Contacts")+"</a>").click(function(){b("#c-list-tabs .selected").removeClass("selected");b(this).parent().addClass("selected");
b.wa.controller.showLoading();return!0}))),g.append(e))}g.append('<div id="contacts-container" class="tab-content"></div>');g.next().hasClass("clear-left")||b('<div class="clear-left"></div>').insertAfter(g);this.showMenus(d?d:[]);g.find("#contacts-container").append('<div class="block not-padded contacts-data"></div>');break;case "contacts-info":case "default":break;default:throw this.block=e,Error("Unknown block: "+a);}this.afterInitHTML&&(this.afterInitHTML(),this.afterInitHTML="");b(window).trigger("wa_after_init_html",
[a,c,d])},showMenus:function(a){var a='<li><a href="javascript:void(0)" class="inline-link"><b><i><strong>'+$_("Actions with selected")+'</strong></i></b><i class="icon10 darr"></i></a><ul class="menu-v" id="actions-with-selected"><li class="line-after"><span id="selected-count">0</span> <span id="selected-count-word-form">'+$_(0,"contacts selected")+'</span></li><li id="add-to-category-link"><a href="#" onclick="$.wa.controller.dialogAddSelectedToCategory(); return false"><i class="icon16 contact"></i>'+
$_("Add to category")+"</a></li>"+(0<=a.indexOf("category-actions")&&this.current_category_id?'<li><a href="#" onclick="$.wa.controller.dialogRemoveSelectedFromCategory(); return false"><i class="icon16 contact"></i>'+$_("Exclude from this category")+"</a></li>":"")+(0<=a.indexOf("list-actions")&&this.current_view_id?'<li><a href="#" onclick="$.wa.controller.dialogRemoveSelectedFromList(); return false"><i class="icon16 from-list"></i>'+$_("Exclude from this list")+"</a></li>":"")+(b.wa.controller.addToListDialog?
'<li><a href="#" onclick="$.wa.controller.addToListDialog(); return false"><i class="icon16 add-to-list"></i>'+$_("Add to list")+"</a></li>":"")+(b.wa.controller.contactsMerge&&b.wa.controller.admin?'<li class="two-or-more"><a href="#" onClick="$.wa.controller.contactsMerge(); return false"><i class="icon16 merge"></i>'+$_("Merge contacts")+"</a></li>":"")+(b.wa.controller.exportDialog?'<li><a href="#" onclick="$.wa.controller.exportDialog(); return false"><i class="icon16 export"></i>'+$_("Export")+
"</a></li>":"")+'<li><a href="#" onclick="$.wa.controller.contactsDelete(); return false" class="red" id="show-dialog-delete"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li></ul></li>",a='<ul id="list-views" class="menu-h float-right"><li rel="table"><a href="#" onclick="return $.wa.grid.setView(\'table\');"><i class="icon16 only view-table"></i></a></li><li rel="list"><a href="#" onclick="return $.wa.grid.setView(\'list\');"><i class="icon16 only view-thumb-list"></i></a></li><li rel="thumbs"><a href="#" onclick="return $.wa.grid.setView(\'thumbs\');"><i class="icon16 only view-thumbs"></i></a></li></ul><ul id="c-list-toolbar-menu" class="menu-h dropdown disabled">'+
a+"</ul>",c=b("#contacts-container").find(".c-list-toolbar");0>=c.size()&&(c=b('<div class="block c-list-toolbar"></div>').prependTo(b("#contacts-container")));c.html(a);b.wa.controller.updateSelectedCount()},showLoading:function(){var a=b("h1");0>=a.size()||(a=b(a[0]),0<a.find(".loading").size()||a.append('<i class="icon16 loading"></i>'))},hideLoading:function(){b("h1 .loading").remove()},updateSelectedCount:function(){var a=b("input.selector:checked").size();b("#selected-count").text(a);b("#selected-count-word-form").text($_(a,
"contacts selected"));0>=a?b("#actions-with-selected li").addClass("disabled"):(b("#actions-with-selected li").removeClass("disabled"),0>=b("#list-category li:not(.empty):not(.selected)").size()&&b("#add-to-category-link").addClass("disabled"),2>a&&b("#actions-with-selected li.two-or-more").addClass("disabled"))},getUrl:function(){return this.options.url},loadHTML:function(a,b,d,e){this.showLoading();this.load(e||"#c-core .c-core-content",a,b,d)},load:function(a,c,d,e){var g=Math.random();this.random=
g;b.get(c,d,function(h){b.wa.controller.random==g&&(e&&e.call(b.wa.controller),b(window).trigger("wa_before_load",[a,c,d,h]),b(a).html(h),b(window).trigger("wa_after_load",[a,c,d,h]))})},parseParams:function(a,c){var d={};a&&a[0]&&(d.offset=a[0]);a&&a[1]&&(d.sort=a[1]);a&&a[2]&&(d.order=a[2]);a&&a[3]?(d.view=a[3],c&&b.storage.set("contacts/view/"+c,d.view)):d.view=b.storage.get("contacts/view/"+c)||"table";a&&a[4]?(d.limit=a[4],c&&b.storage.set("contacts/limit/"+c,d.limit)):d.limit=b.storage.get("contacts/limit/"+
c);return d},setBrowserTitle:function(a){document.title=a+" \u2014 "+this.accountName},setTitle:function(a,c){var d=b("#c-core h1.wa-page-heading");"undefined"!=typeof a&&(this.lastView={title:a,hash:window.location.hash.toString()},d.text(a),this.setBrowserTitle(a),c&&c.click&&d.click(c.click));return d},loadGrid:function(a,c,d,e){this.current_category_id=this.current_group_id=this.current_view_id=null;d||(d="?module=contacts&action=list");e||(e={});b.wa.grid.load(d,a,"#contacts-container .contacts-data",
c,e)},showMessage:function(a,c){var d=b("#c-core .wa-message");c&&(d.remove(),d=b());if(a){var e=b('<div class="wa-message wa-success"><a onclick="$(this).parent().empty().hide();"><i class="icon16 close"></i></a></div>').prepend(b('<span class="wa-message-text"></span>').append(a));d.size()?b(d[0]).empty().append(e):b("#c-core h1:first").size()?e.insertAfter(b("#c-core h1:first")):b("#c-core").prepend(e)}},setHash:function(a){return b.wa.setHash(this.cleanHash(a))},getHash:function(){return this.cleanHash()},
cleanHash:function(a){"undefined"==typeof a&&(a=window.location.hash.toString());for(a.length||(a=""+a);0<a.length&&"/"===a[a.length-1];)a=a.substr(0,a.length-1);a+="/";"#"!=a[0]?("/"!=a[0]&&(a="/"+a),a="#"+a):a[1]&&"/"!=a[1]&&(a="#/"+a.substr(1));return"#/"==a?"":a},switchToTab:function(a,c,d,e){"string"==typeof a&&("t-"==a.substr(0,2)?a="#"+a:"#"!=a[0]&&(a="#t-"+a));a=b(a);if(!(0>=a.size()||a.hasClass("selected"))){if(!e){var g=a.attr("id");if(!g||"t-"!=g.substr(0,2))return;e=b("#tc-"+g.substr(2))}d&&
(g=a.parent().children(".selected"),0<g.size()&&g.each(function(a,b){d.call(b)}));var h=function(){a.parent().find("li.selected").removeClass("selected");a.removeClass("hidden").css("display","").addClass("selected");e.siblings(".tab-content").addClass("hidden");e.removeClass("hidden");c&&c.call(a[0])};b.effects&&b.effects.slideDIB&&!a.is(":visible")?(b.wa.controller.loadTabSlidingAnimation(),a.hide().removeClass("hidden").show("slideDIB",{direction:"down"},300,function(){h()})):h()}},initCheckboxList:function(a){var a=
b(a),c=function(a,c){var g=b(c||this);g.is(":checked")?g.parent().addClass("highlighted"):g.parent().removeClass("highlighted")};a.find('input[type="checkbox"]').click(c).each(c);return a},collapseSidebarSection:function(a,c){c||(c="coollapse");a=b(a);if(!(0>=a.size())){var d=a.find(".darr, .rarr");0>=d.size()&&(d=b('<i class="icon16 darr">'),a.prepend(d));var e,g=a.attr("id"),h=d.hasClass("darr")?"shown":"hidden",i=function(){a.parent().find("ul.collapsible").hide();d.removeClass("darr").addClass("rarr");
e="hidden"},j=function(){a.parent().find("ul.collapsible").show();d.removeClass("rarr").addClass("darr");e="shown"};switch(c){case "toggle":"shown"==h?i():j();break;case "restore":g&&("hidden"==b.storage.get("contacts/collapsible/"+g)?i():j());break;case "uncollapse":j();break;default:i()}g&&e&&b.storage.set("contacts/collapsible/"+g,e)}},restoreCollapsibleStatusInSidebar:function(){b("#wa-app .collapse-handler").each(function(a,c){b.wa.controller.collapseSidebarSection(c,"restore")})},reloadSidebar:function(){b.post("?module=backend&action=sidebar",
null,function(a){var c=b("#wa-app .sidebar");c.css("height",c.height()+"px").html(a).css("height","");b.wa.controller.highlightSidebar();b.wa.controller.restoreCollapsibleStatusInSidebar();b.wa.controller.initSidebarDragAndDrop&&b.wa.controller.initSidebarDragAndDrop()})},highlightSidebar:function(){var a=this.cleanHash(location.hash),c=!1,d=!1;b("#wa-app .sidebar li a").each(function(e,h){var h=b(h),i=b.wa.controller.cleanHash(h.attr("href"));if(i==a)return d=h,!1;!c&&(2<i.length&&a.substr(0,i.length)===
i)&&(c=h)});!d&&c&&(d=c);if(d&&(b("#wa-app .sidebar .selected").removeClass("selected"),0>=d.parents("ul.dropdown").size())){for(var e=d.parent();0<e.size()&&"li"!=e[0].tagName.toLowerCase();)e=e.parent();0<e.size()&&e.addClass("selected")}},loadTabSlidingAnimation:function(){b.effects&&!b.effects.slideDIB&&(b.effects.slideDIB=function(a){return this.queue(function(){var c=b(this),d="position top left width height margin".split(" "),e=b.effects.setMode(c,a.options.mode||"show"),g=a.options.direction||
"left";b.effects.save(c,d);c.show();b.effects.createWrapper(c).css({overflow:"hidden",display:"inline-block",width:"auto"});var h="up"==g||"down"==g?"top":"left",g="up"==g||"left"==g?"pos":"neg",i=a.options.distance||("top"==h?c.outerHeight({margin:!0}):c.outerWidth({margin:!0}));"show"==e&&c.css(h,"pos"==g?-i:i);var j={};j[h]=("show"==e?"pos"==g?"+=":"-=":"pos"==g?"-=":"+=")+i;c.animate(j,{queue:!1,duration:a.duration,easing:a.options.easing,complete:function(){"hide"==e&&c.hide();b.effects.restore(c,
d);b.effects.removeWrapper(c);a.callback&&a.callback.apply(this,arguments);c.dequeue()}})})})}}})(jQuery);(function(b){b.wa.grid={init:function(a){a&&(this.config=a);this.defaultSettings={limit:30,offset:0,sort:"name",order:1,view:"table"};this.settings=b.extend({},this.defaultSettings);this.fields=[{id:"photo",title:$_("Photo"),filter:function(a){var c;c=!a.photo||a.photo=="0"?b.wa.controller.options.url+"wa-content/img/userpic96.jpg":""+parseInt(a.photo)==a.photo?b.wa.controller.options.url+"wa-data/public/contacts/photo/"+a.id+"/"+a.photo+".96x96.jpg":a.photo;return'<div class="image"><a href="#/contact/'+
a.id+'"><img src="'+c+'" /></a></div>'}},{id:"f",title:"Field",filter:function(a,b){var c=b.hash.replace(/duplicates/,"search");return'<a href="#'+c.substr(0,c.length-1)+"="+encodeURIComponent(a.f)+'/0/~data/0/list/">'+a.f+"</a>"},sorted:!0},{id:"n",title:"Number",sorted:!0}];for(var c in this.config.fields)f={id:c,title:this.config.fields[c].name},"email"==c?(f.filter=function(a,c){return c&&c.value?'<a href="mailto:'+encodeURIComponent(c.value.value||c.value)+'">'+b.wa.encodeHTML(c.value.value||
c.value)+"</a>":""},f.attrs='class="alist"'):"company"==c?(f.filter=function(a){return a.company&&!b.wa.controller.free?'<a href="#/contacts/search/company='+encodeURIComponent(a.company)+'/">'+b.wa.encodeHTML(a.company)+"</a>":b.wa.encodeHTML(a.company)},f.sorted=!0):"name"==c&&(f.attrs='class="wa-c-name"',f.filter=function(a){return'<a href="#/contact/'+a.id+'">'+b.wa.encodeHTML(a.name||"")+"</a>"},f.sorted=!0),this.fields.push(f);this.fields.push({id:"_access",title:$_("Access"),filter:function(a){return a._access==
"admin"?"<strong>"+$_("Administrator")+"</strong>":a._access?a._access=="custom"?'<span style="white-space: nowrap">'+$_("Limited access")+"</span>":a._access:'<span style="color: red; white-space: nowrap">'+$_("No access")+"</span>"}});this.fields.push({id:"_online_status",title:"",filter:function(a){switch(a._online_status){case "online":return'<i class="icon10 online"></i>';default:return""}}});var d=this;b("#records-per-page").die(b.browser.msie?"click":"change");b("#records-per-page").live(b.browser.msie?
"click":"change",function(){var a=b(this).val(),c=0;d.settings&&d.settings.offset&&(c=Math.floor(d.settings.offset/a)*a);b.wa.setHash(b.wa.grid.hash+b.wa.grid.getHash({limit:a,offset:c}))})},load:function(a,c,d,e,g){this.url=a;this.options=g;this.hash=e;this.settings=b.extend({},this.defaultSettings);var h=["id","name","email","company"],i;for(i in c)"fields"!=i?null!==c[i]&&(this.settings[i]=c[i]):h=c[i];this.settings.fields="string"!=typeof h&&h.join?h.join(","):h;var j=this,k=Math.random();b.wa.controller.random=
k;b.post(a,this.settings,function(a){if(b.wa.controller.random!=k||"ok"!=a.status)return!1;if(a.data.count&&a.data.contacts&&!a.data.contacts.length)return a=Math.floor((a.data.count-1)/j.settings.limit)*j.settings.limit,a!=j.settings.offset&&b.wa.setHash(b.wa.grid.hash+b.wa.grid.getHash({offset:a})),!1;j.options&&j.options.beforeLoad&&j.options.beforeLoad.call(b.wa.controller,a.data);b("#contacts-container .tools-view li.selected").removeClass("selected");b("#contacts-container .tools-view li[rel="+
j.settings.view+"]").addClass("selected");a.data.title&&b.wa.controller.setTitle(a.data.title);a.data.desc&&b.wa.controller.setDesc(a.data.desc);a.data.fields&&(h=a.data.fields);a.data.history&&b.wa.history.updateHistory(a.data.history);d=b(d);d.html(j.view(j.settings.view,a.data,h));if(!g.hide_head){var c=j.topLineHtml(j.settings.view);c&&d.before(b(c))}j.options&&j.options.afterLoad&&j.options.afterLoad(a.data)},"json")},getSelected:function(){var a=[];b("input.selector:checked").each(function(){a.push(this.value)});
return a},setView:function(a){b.wa.setHash(this.hash+this.getHash({view:a}));return!1},selectItems:function(a){b(a).is(":checked")?b("#contacts-container").find("input.selector").attr("checked","checked").parents(".contact-row").addClass("selected"):b("#contacts-container").find("input.selector").removeAttr("checked").parents(".contact-row").removeClass("selected");b.wa.controller.updateSelectedCount()},viewtable:function(a,c){for(var d='<table class="zebra full-width bottom-bordered"><thead><tr><th class="wa-check-td min-width"><input onclick="$.wa.grid.selectItems(this)" type="checkbox" /></th><th class="min-width"></th>',
e=0;e<this.fields.length;e++)if(-1!=c.indexOf(this.fields[e].id))if(this.fields[e].sorted){var g={sort:this.fields[e].id,order:1};this.settings.sort==g.sort&&(g.order=1-this.settings.order);d+='<th><a style="white-space:nowrap" href="#'+this.hash+this.getHash(g)+'">'+this.fields[e].title+(this.settings.sort==g.sort?g.order?' <i class="icon10 darr"></i>':' <i class="icon10 uarr"></i>':"")+"</a></th>"}else d+="<th>"+this.fields[e].title+"</th>";d+="</tr></thead>";for(e=0;e<a.contacts.length;e++){for(var g=
a.contacts[e],d=d+('<tr class="contact-row"><td><input class="selector" type="checkbox" value="'+g.id+'" /></td><td></td>'),h=0;h<this.fields.length;h++)if(-1!=c.indexOf(this.fields[h].id)){var i=g[this.fields[h].id];if(void 0==i)i="";else if("object"==typeof i){for(var j=[],k=0;k<i.length;k++)"object"==typeof i[k]?j.push('<span title="'+i[k].ext+'">'+(this.fields[h].filter?this.fields[h].filter(g,{hash:this.hash,value:i[k].value}):i[k].value)+"</span>"):j.push(b.trim(this.fields[h].filter?this.fields[h].filter(g,
{hash:this.hash,value:i[k]}):i[k]));i=j.join(", ")}else i=this.fields[h].filter?this.fields[h].filter(g,{hash:this.hash,value:i}):b.wa.encodeHTML(i);d+="<td "+(this.fields[h].attrs?this.fields[h].attrs:"")+">"+i+"</td>"}d+="</tr>"}return d=d+"</table>"+this.getPaging(a.count)},getFieldById:function(a){for(var b=0;b<this.fields.length;b++)if(this.fields[b].id==a)return this.fields[b];return{}},topLineHtml:function(a){if("list"!=a&&"thumbs"!=a)return"";var a='<div class="c-list-top-line"><input onclick="$.wa.grid.selectItems(this)" type="checkbox"><span>'+
$_("Sort by")+":</span>",b={name:$_("Name"),company:$_("Company")},d;for(d in b){var e={sort:d,order:1};this.settings.sort==e.sort&&(e.order=1-this.settings.order);a+='<a href="#'+this.hash+this.getHash(e)+'">'+b[d]+(this.settings.sort==e.sort?e.order?'<i class="icon10 darr"></i>':'<i class="icon10 uarr"></i>':"")+"</a>"}return a},viewthumbs:function(a){b("#contacts-container .contacts-data").removeClass("not-padded").addClass("padded");for(var c='<ul class="thumbs li100px">',d=0;d<a.contacts.length;d++){var e=
a.contacts[d],g=this.getFieldById("photo"),h=e.photo;g.filter&&(h=g.filter(e,{hash:this.hash,value:h}));var i="#/contact/"+e.id;name=e.name;g=this.getFieldById("name");g.filter&&(name=g.filter(e,{hash:this.hash,value:name}));c+='<li class="contact-row">'+h+'<div class="c-name-check"><input class="selector" value="'+e.id+'" type="checkbox"><a href="'+i+'">'+name+'</a></div><div class="status"></div></li>'}return c=c+"</ul>"+this.getPaging(a.count)},viewlist:function(a){b("#contacts-container .contacts-data").removeClass("padded").addClass("not-padded");
for(var c='<ul class="zebra">',d=0;d<a.contacts.length;d++){var e=this.getFieldById("photo");contact=a.contacts[d];var g=contact.photo;e.filter&&(g=e.filter(contact,{hash:this.hash,value:g}));name=contact.name;e=this.getFieldById("name");e.filter&&(name=e.filter(contact,{hash:this.hash,value:name}));var c=c+('<li class="contact-row"><div class="profile image96px">'+g+'<div class="details"><input class="selector" name="c_list_selector" value="'+contact.id+'" type="'+("radio"==this.options.selector?
"radio":"checkbox")+'"><p class="contact-name"><a href="'+("#/contact/"+contact.id)+'">'+name+"</a></p>"),g={title:!0,name:!0,photo:!0,firstname:!0,middlename:!0,lastname:!0,locale:!0,timezone:!0},h;for(h in this.config.fields)if(!g[h]&&contact[h]&&!("0000-00-00"==contact[h]||"undefined"!=typeof contact[h].length&&!contact[h].length))if(e=this.config.fields[h],e.fields)if("object"==typeof contact[h])for(var i=0;i<contact[h].length;i++)c+='<p><span class="c-details-label">'+e.name,b.trim(contact[h][i].ext)&&
(c=e.ext&&e.ext[contact[h][i].ext]?c+(" <span>("+e.ext[contact[h][i].ext]+")</span>"):c+(" <span>("+b.wa.encodeHTML(contact[h][i].ext)+")</span>")),c+=":</span> "+this.viewlistvalue(contact[h][i],e)+"</p>";else c+='<p><span class="c-details-label">'+e.name+":</span> "+this.viewlistvalue(contact[h],!0)+"</p>";else{c+='<p><span class="c-details-label">'+e.name+":</span> ";if("object"==typeof contact[h]){v=[];for(i=0;i<contact[h].length;i++)v.push(this.viewlistvalue(contact[h][i],e));c+=v.join(", ")}else c+=
this.viewlistvalue(contact[h],e);c+="</p>"}c+="</div></div></li>"}c+="</ul>";this.options.hide_foot||(c+=this.getPaging(a.count));return c},viewlistvalue:function(a,c){if("object"!=typeof a)return b.wa.encodeHTML(a);var d="",e=!0,g;for(g in a)if("ext"!=g&&"value"!=g){e=!1;break}a.value&&(d+=e?b.wa.encodeHTML(a.value):a.value);b.trim(a.ext)&&!c.fields&&(d=c.ext&&c.ext[a.ext]?d+(' <em class="hint">'+c.ext[a.ext]+"</em>"):d+(' <em class="hint">'+b.wa.encodeHTML(a.ext)+"</em>"));return d},view:function(a,
c,d){this["view"+a]||(a="table");b("#list-views li.selected").removeClass("selected");b("#list-views li[rel="+a+"]").addClass("selected");return this["view"+a](c,d)},getHash:function(a){var b={},d;for(d in this.settings)b[d]=this.settings[d];for(d in a)b[d]=a[d];return b.offset+"/"+b.sort+"/"+b.order+"/"+b.view+"/"+b.limit+"/"},getPaging:function(a){var b;b="";for(var d=[30,50,100,200,500],e=0;e<d.length;e++)b+='<option value="'+d[e]+'"'+(this.settings.limit==d[e]?' selected="selected"':"")+">"+d[e]+
"</option>";b='<div class="block paging">'+('<span class="c-page-num">'+$_("Show %s records on a page").replace("%s",'<select id="records-per-page">'+b+"</select>")+"</span>");b+='<span class="total">'+$_("Contacts")+": "+a+"</span>";a=Math.ceil(a/parseInt(this.settings.limit));d=Math.ceil(parseInt(this.settings.offset)/parseInt(this.settings.limit))+1;if(1<a){"/"!=this.hash[this.hash.length-1]&&(this.hash+="/");b+="<span>"+$_("Pages")+":</span>";if(1==a)return"";for(var g=0,e=1;e<=a;e++)3>Math.abs(d-
e)||5>e||3>a-e?(b+="<a "+(e==d?'class="selected"':"")+' href="#'+this.hash+this.getHash({offset:(e-1)*this.settings.limit})+'">'+e+"</a>",g=0):3>g++&&(b+=".")}1<d&&(b+='<a href="#'+this.hash+this.getHash({offset:(d-2)*this.settings.limit})+'" class="prevnext"><i class="icon10 larr"></i> '+$_("prev")+"</a>");d<a&&(b+='<a href="#'+this.hash+this.getHash({offset:d*this.settings.limit})+'" class="prevnext">'+$_("next")+' <i class="icon10 rarr"></i></a>');return b+"</div>"}}})(jQuery);$.wa.history={data:null,updateHistory:function(b){this.data=b;var a=$("#wa-search-history").empty(),c=$("#wa-creation-history").empty();$.wa.controller.cleanHash(location.hash);for(var d=0;d<b.length;d++){var e=b[d];e.hash=$.wa.controller.cleanHash(e.hash);var g=$('<li rel="'+e.id+'">'+(0<=e.cnt?'<span class="count">'+e.cnt+"</span>":"")+'<a href="'+e.hash+'"><i class="icon16 '+e.type+'"></i></a></li>');("search"==e.type||"import"==e.type)&&g.addClass("wa-h-type-search");g.children("a").append($("<b>").text(e.name));
if("import"==e.type)c.append(g);else if("add"==e.type){var h=parseInt(g.find("a").attr("href").substr(10)),h=$.wa.controller.backend_url+"?action=photo&size=20x20&id="+h,h=h+("&__t="+e.cnt);g.find(".icon16").removeClass(e.type).addClass("userpic20").css("background-image","url("+h+")");c.append(g)}else"search"==e.type&&a.append(g)}b=[a,c];for(a=0;a<b.length;a++)c=b[a],0<c.children().size()?c.parents(".block.wrapper").show():c.parents(".block.wrapper").hide();$.wa.controller.highlightSidebar()},clear:function(b){!b||
"search"==b?($("#wa-search-history").parents(".block.wrapper").hide(),$("#wa-search-history").empty(),b="&ctype="+b):b&&"creation"==b?($("#wa-creation-history").parents(".block.wrapper").hide(),$("#wa-creation-history").empty(),b="&ctype[]=import&ctype[]=add"):b="";$.get("?module=contacts&action=history&clear=1"+b);return!1}};$.wa.contactEditor={contact_id:null,contactType:"person",baseFieldType:null,saveUrl:"?module=contacts&action=save",factoryTypes:{},editorFactories:{},fieldEditors:{},initFactories:function(b){this.editorFactories={};this.fieldEditors={};for(var a in b){if("object"!=typeof b[a]||!b[a].type)throw Error("Field data error for "+a);if("undefined"==typeof this.factoryTypes[b[a].type])throw Error("Unknown factory type: "+b[a].type);this.editorFactories[a]=b[a].multi?$.extend({},this.factoryTypes.Multifield):
$.extend({},this.factoryTypes[b[a].type]);this.editorFactories[a].initializeFactory(b[a])}},initAllEditors:function(){for(var b in $.wa.contactEditor.editorFactories)"undefined"==typeof this.fieldEditors[b]?this.fieldEditors[b]=this.editorFactories[b].createEditor():this.fieldEditors[b].reinit()},initFieldEditors:function(b){if(!(b instanceof Array))for(var a in b){if("undefined"==typeof this.editorFactories[a]){$.wa.controller.contactAction([this.contact_id]);break}"undefined"==typeof this.fieldEditors[a]&&
(this.fieldEditors[a]=this.editorFactories[a].createEditor());this.fieldEditors[a].setValue(b[a])}},initContactInfoBlock:function(b){this.switchMode(b,!0)},switchMode:function(b,a){var c=$("#contact-info-block");a&&(c.html(""),c.removeClass("edit-mode"),c.removeClass("view-mode"));if(!("edit"==b&&c.hasClass("edit-mode"))&&!("view"==b&&c.hasClass("view-mode"))){c.find("div.field.buttons").remove();var d=[],e;for(e in this.fieldEditors){d.push(e);var g=this.fieldEditors[e].setMode(b);a&&c.append(g)}"edit"==
b?($("#c-editor-edit-link").hide(),d=this.inplaceEditorButtons(d,function(a){if(typeof a!="undefined"&&!a)return false;if(typeof $.wa.contactEditor.justCreated!="undefined"&&$.wa.contactEditor.justCreated){a=$("#sb-all-contacts-li .count");a.text(1+parseInt(a.text()));$.wa.setHash("/contact/"+$.wa.contactEditor.contact_id);return false}$.wa.contactEditor.switchMode("view");$.scrollTo(0);return false},function(){if($.wa.contactEditor.contact_id==null)$.wa.back();else{$.wa.contactEditor.switchMode("view");
$.scrollTo(0)}}),c.append(d),c.removeClass("view-mode"),c.addClass("edit-mode")):($("#c-editor-edit-link").show(),c.removeClass("edit-mode"),c.addClass("view-mode"))}},saveFields:function(b,a){for(var c={},d=!1,e=0;e<b.length;e++){var g=b[e],h=this.fieldEditors[g].validate();if(h){if(!d)for(d=this.fieldEditors[g].domElement;!d.is(":visible");)d=d.parent();this.fieldEditors[g].showValidationErrors(h)}else this.fieldEditors[g].showValidationErrors(null);c[g]=this.fieldEditors[g].getValue()}if(d)$.scrollTo(d),
$.scrollTo("-=100px"),a(!1);else{var i=this;$.post(this.saveUrl,{data:$.JSON.encode(c),type:this.contactType,id:null!=this.contact_id?this.contact_id:0},function(b){if("ok"!=b.status)throw new Exception("AJAX error: "+$.JSON.encode(b));b=b.data;b.history&&$.wa.history.updateHistory(b.history);if(b.data&&b.data.top){for(var c="",d=0;d<b.data.top.length;d++)var e=b.data.top[d],c=c+("<li>"+("im"==e.id?"":'<i class="icon16 '+e.id+'"></i>')+e.value+"</li>");$("#contact-info-top").html(c);delete b.data.top}"company"==
$.wa.contactEditor.contactType&&b.data.name&&delete b.data.name;null!=$.wa.contactEditor.contact_id&&$.wa.contactEditor.initFieldEditors(b.data);c=!1;for(e in i.fieldEditors)if("undefined"!=typeof b.errors[e]){if(i.fieldEditors[e].showValidationErrors(b.errors[e]),!c)for(c=i.fieldEditors[e].domElement;!c.is(":visible");)c=c.parent()}else"edit"==i.fieldEditors[e].currentMode&&i.fieldEditors[e].showValidationErrors(null);if(c)$.scrollTo(c),$.scrollTo("-=100px");else if($.wa.contactEditor.contact_id&&
b.data.reload){window.location.reload();return}null==$.wa.contactEditor.contact_id&&!c&&($.wa.contactEditor.contact_id=b.data.id,$.wa.contactEditor.justCreated=!0);a(!c)},"json")}},createExtSelect:function(b,a){var c="",d=!0,e;for(e in b){var g="";if(b[e]===a||e===a)g=' selected="selected"',d=!1;var h=this.htmlentities(b[e]),c=c+('<option value="'+("undefined"===typeof b.length?e:h)+'"'+g+">"+h+"</option>")}var i;d?(c+='<option value="%custom" selected="selected">'+$_("other")+"...</option>",i='<input type="text" class="small ext">'):
(c+='<option value="%custom">'+$_("other")+"...</option>",i='<input type="text" class="small empty ext">');var c=$('<span><select class="ext">'+c+"</select><span>"+i+"</span></span>"),j=c.children("select");i=c.find("input");i.val(a);"%custom"!==j.val()&&i.hide();var a=$_("which?"),k=function(){if(!i.val()&&!i.hasClass("empty")){i.val(a);i.addClass("empty")}};i.blur(k);i.focus(function(){if(i.hasClass("empty")){i.val("");i.removeClass("empty")}});j.change(function(){var b=j.val();if(b==="%custom"){i.hasClass("empty")&&
i.val(a);i.show()}else{i.hide();i.addClass("empty");i.val(b||"")}k()});i[0].getExtValue=function(){return j.val()==="%custom"&&i.hasClass("empty")?"":i.val()};i[0].setExtValue=function(a){b[a]?j.val(a):j.val("%custom");i.val(a)};return c},inplaceEditorButtons:function(b,a,c){var d=$('<div class="field buttons"><div class="value submit"><em class="errormsg" id="validation-notice"></em></div></div>'),e=function(){d.find(".loading").show();$.wa.contactEditor.saveFields(b,function(b){d.find(".loading").hide();
a(b)});return!1},g=$('#contact-info-block.edit-mode input[type="text"]',$("#c-core")[0]);g.die("keyup");g.live("keyup",function(a){13==a.keyCode&&e()});var g=$('<input type="submit" class="button green" value="'+$_("Save")+'" />').click(e),h=this,i=$('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(function(){d.find(".loading").hide();"function"!=typeof c?a():c();h.fieldEditors.name.showValidationErrors(null);$.scrollTo(0);return!1});d.children("div.value.submit").append(g).append(" "+$_("or")+
" ").append(i).append($('<i class="icon16 loading" style="margin-left: 16px; display: none;"></i>'));return d},wrapper:function(b,a,c){c=$('<div class="field'+("undefined"!=typeof c&&c?" "+c:"")+'"></div>');"undefined"!=typeof a&&a&&c.append('<div class="name">'+a+"</div>");if("object"!=typeof b||!(b instanceof jQuery)||0>=b.find("div.value").size())b=$('<div class="value"></div>').append(b);c.append(b);return c},htmlentities:function(b){var a=document.createElement("div"),b=document.createTextNode(b);
a.appendChild(b);return a.innerHTML}};$.wa.contactEditor.baseFieldType={createEditor:function(){var b=$.extend({},this);delete b.createEditor;delete b.initializeFactory;b.parentEditorData={};b.initialize();return b},fieldValue:"",initializeFactory:function(b){this.fieldData=b},initialize:function(){this.setValue("")},reinit:function(){this.currentMode="null";this.initialize()},setValue:function(b){this.fieldValue=b;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):
this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var b=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var a=this.domElement.find(".val");if(0<a.length&&(b="",!a.hasClass("empty")&&("checkbox"!=a.attr("type")||a.attr("checked"))))b=a.val()}return b},isModified:function(){return this.fieldValue!=this.getValue()},validate:function(b){var a=this.getValue();return!b&&this.fieldData.required&&!a?$_("This field is required."):null},newFieldElement:function(b){this.fieldData.read_only&&
(b="view");var a=this.newInlineFieldElement(b);if(null===a&&(!this.fieldData.show_empty||"edit"==b))return $('<div style="display: none"></div>');var c="";"edit"==b&&(c=(this.fieldData.required?'<span class="req-star">*</span>':"")+":");return $.wa.contactEditor.wrapper(a,this.fieldData.name+c)},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;var a=null;"edit"==b?(a=$('<span><input class="val" type="text"></span>'),a.find(".val").val(this.fieldValue)):(a=$('<span class="val"></span>'),
a.text(this.fieldValue));return a},showValidationErrors:function(b){if(null!==this.domElement){var a=this.domElement.find(".val");a.parents(".value").children("em.errormsg").remove();null!==b?(a.parents(".value").append($('<em class="errormsg">'+b+"</em>")),a.addClass("error")):a.removeClass("error")}},fieldData:null,domElement:null,currentMode:"null",parentEditor:null,parentEditorData:null,setMode:function(b,a){"undefined"==typeof a&&(a=!0);if("view"!=b&&"edit"!=b)throw Error("Unknown mode: "+b);
if(this.currentMode!=b&&(this.currentMode=b,a)){var c=this.domElement;this.domElement=this.newFieldElement(b);null!==c&&c.replaceWith(this.domElement)}return this.domElement}};
$.wa.contactEditor.factoryTypes.String=$.extend({},$.wa.contactEditor.baseFieldType,{setValue:function(b){this.fieldValue=b;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var b=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var a=this.domElement.find(".val"),b="";a.hasClass("empty")||(b=a.val())}return b},newInlineFieldElement:function(b){if("view"==
b&&!this.fieldValue)return null;var a=null,c=this.fieldValue;"edit"==b?(a=1>=this.fieldData.input_height?$('<span><input class="val" type="text"></span>'):$('<span><textarea class="val" rows="'+this.fieldData.input_height+'"></textarea></span>'),a.find(".val").val(c)):a=$('<span class="val"></span>').text(c);return a}});$.wa.contactEditor.factoryTypes.Text=$.extend({},$.wa.contactEditor.factoryTypes.String);$.wa.contactEditor.factoryTypes.Phone=$.extend({},$.wa.contactEditor.baseFieldType);
$.wa.contactEditor.factoryTypes.Select=$.extend({},$.wa.contactEditor.baseFieldType,{notSet:function(){return"&lt;"+(this.fieldData.defaultOption||$_("not set"))+"&gt;"},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;if("view"==b)return $('<span class="val"></span>').text(this.fieldData.options[this.fieldValue]||this.fieldValue);for(var b="",a=!1,c,d=0;d<this.fieldData.oOrder.length;d++){var e=this.fieldData.oOrder[d];!a&&e==this.fieldValue&&this.fieldValue?(a=!0,c=" selected"):
c="";""===e&&(c+=" disabled");b+='<option value="'+e+'"'+c+">"+this.fieldData.options[e]+"</option>"}return $('<div><select class="val"><option value=""'+(a?"":" selected")+">"+this.notSet()+"</option>"+b+"</select></div>")}});
$.wa.contactEditor.factoryTypes.Conditional=$.extend({},$.wa.contactEditor.factoryTypes.Select,{unbindEventHandlers:function(){},getValue:function(){var b=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var a=this.domElement.find(".val:visible");0<a.length&&(b=a.hasClass("empty")?"":a.val())}return b},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;this.unbindEventHandlers();if("view"==b)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&
this.fieldData.options[this.fieldValue]||this.fieldValue));for(var a=this,b=(a.fieldData.parent_field||"").split(":"),c=$.wa.contactEditor.fieldEditors[b.shift()];c&&b.length;)if(subfields=c.subfieldEditors,subfields instanceof Array)for(var c=null,d=0;d<subfields.length;d++){if(subfields[d]===a.parentEditor){c=subfields[d];break}}else c=subfields[b.shift()];if(c){var e=this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue,g=$('<input type="text" class="hidden val">').val(e),
h=$('<select class="hidden val"></select>').hide(),i;setTimeout(function(){c.domElement?(c.domElement.on("change",".val",i=function(){var b=$(this),c=g.is(":visible")?g.val():h.is(":visible")?h.val():e,b=(b.val()||"").toLowerCase();if(b=a.fieldData.parent_options[b]){g.hide();h.show().children().remove();for(d=0;d<b.length;d++)h.append($("<option></option>").attr("value",b[d]).text(b[d]).attr("selected",a.fieldValue==b[d]));h.val(c)}else g.val(c||"").show().blur(),h.hide()}),i.call(c.domElement.find(".val:visible")[0])):
g.show()},0);a.unbindEventHandlers=function(){i&&c.domElement&&c.domElement.find(".val").unbind("change",i);a.unbindEventHandlers=function(){}};return $("<div></div>").append(g).append(h)}return $("<div></div>").append($('<input type="text" class="val">').val(a.fieldValue))}});
$.wa.contactEditor.factoryTypes.Region=$.extend({},$.wa.contactEditor.factoryTypes.Select,{notSet:function(){return this.fieldData.options&&this.fieldValue&&!this.fieldData.options[this.fieldValue]?this.fieldValue:"&lt;"+$_("select region")+"&gt;"},unbindEventHandlers:function(){},setCurrentCountry:function(){var b=this.current_country;this.current_country=this.parentEditorData.parent.subfieldEditors.country.getValue();return b!==this.current_country?(delete this.fieldData.options,!0):!1},getRegionsControllerUrl:function(b){return($.wa.contactEditor.regionsUrl||
"?module=backend&action=regions&country=")+b},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;this.unbindEventHandlers();if("view"==b)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue));var a=this;if(this.parentEditorData.parent&&this.parentEditorData.parent.subfieldEditors.country){this.setCurrentCountry();var c;$("#contact-info-block").on("change","select",c=function(){a.setCurrentCountry()&&
a.domElement.empty().append(a.newInlineFieldElement(b).children())});a.unbindEventHandlers=function(){$("#contact-info-block").off("change","select",c);a.unbindEventHandlers=function(){}}}if(void 0===this.fieldData.options&&this.current_country&&this.fieldData.region_countries[this.current_country]){var d=this.current_country;$.get(this.getRegionsControllerUrl(d),function(c){b!==a.currentMode||d!==a.current_country||(a.fieldData.options=c.data.options||!1,a.fieldData.oOrder=c.data.oOrder||[],a.domElement.empty().append(a.newInlineFieldElement(b).children()))},
"json");return $("<div></div>").append($('<i class="icon16 loading"></i>'))}if(this.fieldData.options)return $("<div></div>").append($.wa.contactEditor.factoryTypes.Select.newInlineFieldElement.call(this,b));var e=$("<div></div>").append($.wa.contactEditor.baseFieldType.newInlineFieldElement.call(this,b));$.wa.defaultInputValue(e.find(".val"),this.fieldData.name+(this.fieldData.required?" ("+$_("required")+")":""),"empty");return e}});$.wa.contactEditor.factoryTypes.Country=$.extend({},$.wa.contactEditor.factoryTypes.Select);
$.wa.contactEditor.factoryTypes.Checklist=$.extend({},$.wa.contactEditor.baseFieldType,{validate:function(b){return!b&&this.fieldData.required&&0>=this.getValue().length?$_("This field is required."):null},setValue:function(b){this.fieldValue=b;if("edit"==this.currentMode&&this.domElement){this.domElement.find('input[type="checkbox"]').attr("checked",!1);for(var a in this.fieldValue)this.domElement.find('input[type="checkbox"][value="'+a+'"]').attr("checked",!0)}else"view"==this.currentMode&&this.domElement&&
this.domElement.find(".val").html(this.getValueView())},getValue:function(){if("edit"!=this.currentMode||!this.domElement)return this.fieldValue;var b=[];this.domElement.find('input[type="checkbox"]:checked').each(function(a,c){b.push($(c).val())});return b},getValueView:function(){for(var b="",a=0;a<this.fieldData.oOrder.length;a++){var c=this.fieldData.oOrder[a];0>this.fieldValue.indexOf(c)||(b+=(b?", ":"")+'<a href="'+(this.fieldData.hrefPrefix||"#")+c+'">'+(this.fieldData.options[c]&&$.wa.contactEditor.htmlentities(this.fieldData.options[c])||
$_("&lt;no name&gt;"))+"</a>")}return b||$_("&lt;none&gt;")},newInlineFieldElement:function(b){if("view"==b&&(!this.fieldValue||!this.fieldValue.length))return null;if("view"==b)return $('<span class="val"></span>').html(this.getValueView());var b=0,a;for(a in this.fieldData.options)if(b++,1<b)break;if(!b)return null;for(var c="",d=0;d<this.fieldData.oOrder.length;d++){a=this.fieldData.oOrder[d];c+='<li><label><input type="checkbox" value="'+a+'"';if(0<=this.fieldValue.indexOf(a-0)||!$.wa.contactEditor.contact_id&&
$.wa.contactEditor.limitedCategories&&2>b)c+=' checked="checked"';this.fieldData.disabled&&this.fieldData.disabled[a]&&(c+=' disabled="disabled"');c+=" />"+(this.fieldData.options[a]&&$.wa.contactEditor.htmlentities(this.fieldData.options[a])||$_("&lt;no name&gt;"))+"</label></li>"}return $.wa.controller.initCheckboxList('<div class="c-checkbox-menu-container val"><div><ul class="menu-v compact with-icons c-checkbox-menu">'+c+"</ul></div></div>")}});
$.wa.contactEditor.factoryTypes.Name=$.extend({},$.wa.contactEditor.baseFieldType,{newInlineFieldElement:null,newFieldElement:function(){var b="";$.wa.contactEditor.fieldEditors.title&&(b=$.wa.contactEditor.fieldEditors.title.getValue()+" ");$("#contact-fullname").text(""+b+(this.fieldValue?this.fieldValue:"<"+$_("no name")+">"));$.wa.controller.setBrowserTitle($("#contact-fullname").text());$.wa.contactEditor.contact_id&&$.wa.contactEditor.contact_id==$.wa.contactEditor.current_user_id&&$("#wa-my-username").text(""+
(this.fieldValue?this.fieldValue:"<"+$_("no name")+">"));return $('<div style="display: none"></div>')},setValue:function(b){this.fieldValue=b},getValue:function(b){if(this.fieldValue&&!b)return this.fieldValue;b=$.wa.contactEditor.fieldEditors.firstname.getValue();b+=(b?" ":"")+$.wa.contactEditor.fieldEditors.middlename.getValue();return b+=(b?" ":"")+$.wa.contactEditor.fieldEditors.lastname.getValue()},validate:function(b){var a=this.getValue(!0);if(!b&&this.fieldData.required&&!a){b=$("#contact-info-block input:visible:text[value]:not(.empty)").val();
if(!b)return $_("At least one of these fields must be filled");$.wa.contactEditor.fieldEditors.firstname.setValue(b)}return null},showValidationErrors:function(b){var a=$("#contact-info-block");a.children("div.wa-errors-block").remove();if(null!==b){var c=$('<div class="field wa-errors-block"><div class="value"><em class="errormsg">'+b+"</em></div></div>");$.wa.contactEditor.fieldEditors.lastname?$.wa.contactEditor.fieldEditors.lastname.domElement.after(c):a.prepend(c)}a=["firstname","middlename",
"lastname"];for(c=0;c<a.length;c++)df=a[c],$.wa.contactEditor.fieldEditors[df]&&(null!==b?$.wa.contactEditor.fieldEditors[df].domElement.find(".val").addClass("external-error"):$.wa.contactEditor.fieldEditors[df].domElement.find(".val").removeClass("external-error"))}});$.wa.contactEditor.factoryTypes.NameSubfield=$.extend({},$.wa.contactEditor.baseFieldType,{});
$.wa.contactEditor.factoryTypes.Multifield=$.extend({},$.wa.contactEditor.baseFieldType,{subfieldEditors:null,subfieldFactory:null,emptySubValue:null,initializeFactory:function(b){this.fieldData=b;if("undefined"!=typeof this.fieldData.ext){this.fieldData.extKeys=[];this.fieldData.extValues=[];for(var a in this.fieldData.ext)this.fieldData.extKeys[this.fieldData.extKeys.length]=a,this.fieldData.extValues[this.fieldData.extValues.length]=this.fieldData.ext[a]}},initialize:function(){this.subfieldFactory=
$.extend({},$.wa.contactEditor.factoryTypes[this.fieldData.type]);this.subfieldFactory.parentEditor=this;this.subfieldFactory.initializeFactory($.extend({},this.fieldData));this.fieldData=$.extend({},this.fieldData,{required:this.subfieldFactory.fieldData.required});this.subfieldEditors=[this.subfieldFactory.createEditor()];this.emptySubValue="object"==typeof this.subfieldEditors[0].fieldValue?$.extend({},this.subfieldEditors[0].fieldValue):{value:this.subfieldEditors[0].fieldValue};this.fieldData.ext&&
(this.emptySubValue.ext=this.fieldData.extKeys[0]);this.fieldValue=[this.emptySubValue]},setValue:function(b){if(!b||"undefined"==typeof b[0])b=[this.emptySubValue];this.fieldValue=b;var a=0;do{this.subfieldEditors.length<=a&&(this.subfieldEditors[a]=this.subfieldFactory.createEditor(),"null"!=this.currentMode&&this.subfieldEditors[a].setMode(this.currentMode).insertAfter(this.subfieldEditors[a-1].parentEditorData.domElement));if("undefined"!=typeof b[a]){var c=!1,d;for(d in b[a])if("value"!=d&&"ext"!=
d){c=!0;break}this.subfieldEditors[a].setValue(c?b[a]:b[a].value?b[a].value:"");if("undefined"!=typeof this.fieldData.ext&&(c=b[a].ext,"null"!=this.currentMode&&this.subfieldEditors[a].parentEditorData.domElement)){var e=this.subfieldEditors[a].parentEditorData.domElement.find("input.ext");0<e.size()&&e[0].setExtValue(c)}}else throw Error("At least one record must exist in data at this time.");a++}while(a<b.length);if(b.length<this.subfieldEditors.length){for(a=b.length;a<this.subfieldEditors.length;a++)0!==
a&&"null"!=this.currentMode&&this.subfieldEditors[a].parentEditorData.domElement.remove();b=0<b.length?b.length:1;this.subfieldEditors.splice(b,this.subfieldEditors.length-b)}this.origFieldValue=null},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue);for(var b=[],a=0;a<this.subfieldEditors.length;a++){var c=this.subfieldEditors[a];b[a]={value:c.getValue()};if("undefined"!=typeof this.fieldData.ext){var d=this.fieldValue[a].ext,e=c.parentEditorData.domElement.find("input.ext")[0];
"edit"==c.currentMode&&e&&(d=e.getExtValue());b[a].ext=d}}return b},isModified:function(){for(var b=0;b<this.subfieldEditors.length;b++)if(this.subfieldEditors[b].isModified())return!0;return!1},validate:function(b){for(var a=[],c=!0,d=0;d<this.subfieldEditors.length;d++){var e=this.subfieldEditors[d],g=e.validate(!0);g&&(a[d]=g);if((e=e.getValue())||"string"!=typeof e)c=!1}!b&&(this.fieldData.required&&c)&&(a[0]="This field is required.");return 0>=a.length?null:a},showValidationErrors:function(b){for(var a=
0;a<this.subfieldEditors.length;a++){var c=this.subfieldEditors[a];null!==b&&"undefined"!=typeof b[a]?c.showValidationErrors(b[a]):c.showValidationErrors(null)}},deleteSubfieldButton:function(b){var a=this,c=$('<a class="delete-subfield hint" href="javascript:void(0)">'+$_("delete")+"</a>").click(function(){if(1>=a.subfieldEditors.length)return!1;var c=a.subfieldEditors.indexOf(b);"null"!=a.currentMode&&a.subfieldEditors[c].parentEditorData.domElement.remove();a.subfieldEditors.splice(c,1);1>=a.subfieldEditors.length&&
a.domElement.find(".delete-subfield").hide();return!1});1>=this.subfieldEditors.length&&c.hide();return c},newSubFieldElement:function(b,a){var a=a-0,c=this.subfieldEditors[a];c.parentEditorData||(c.parentEditorData={});c.parentEditorData.parent=this;c.parentEditorData.empty=!1;var d;if("function"!=typeof c.newInlineFieldElement){d="";"edit"==b&&(d=(this.fieldData.required?'<span class="req-star">*</span>':"")+":");var e=$.wa.contactEditor.wrapper('<span class="replace-me-with-value"></span>',0===
a?this.fieldData.name+d:"","no-bot-margins"),g=e.find("span.replace-me-with-value");d=this.fieldValue[a].ext;"edit"==b?d=$.wa.contactEditor.createExtSelect(this.fieldData.ext,d):(d=this.fieldData.ext[this.fieldValue[a].ext]||d,d=$("<strong>"+$.wa.contactEditor.htmlentities(d)+"</strong>"));g.before(d);"edit"==b&&g.before(this.deleteSubfieldButton(c));g.remove();c.domElement=this.subfieldEditors[a].newFieldElement(b);self=this;c.domElement.find("div.name").each(function(a,b){if(b.innerHTML.substr(0,
self.fieldData.name.length)===self.fieldData.name)b.innerHTML=""});c.parentEditorData.domElement=$("<div></div>").append(e).append(c.domElement);return c.parentEditorData.domElement}d=c.newInlineFieldElement(b);if(null===d)return c.parentEditorData.domElement=c.domElement=$("<div></div>"),c.parentEditorData.empty=!0,c.parentEditorData.domElement;c.domElement=d;e=$('<div class="value"></div>').append(d);g=e.find(".replace-with-ext");0>=g.size()&&(e.append('<span><span class="replace-with-ext"></span></span>'),
g=e.find(".replace-with-ext"));"undefined"!=typeof this.fieldData.ext&&(d=this.fieldValue[a].ext,"edit"==b?g.before($.wa.contactEditor.createExtSelect(this.fieldData.ext,d)):(d=this.fieldData.ext[this.fieldValue[a].ext]||d,0<g.parents(".ext").size()?g.before($.wa.contactEditor.htmlentities(d)):g.before($('<em class="hint"></em>').text(" "+d))));"edit"==b&&g.before(this.deleteSubfieldButton(c));g.remove();return c.parentEditorData.domElement=e},newInlineFieldElement:null,newFieldElement:function(b){this.fieldData.read_only&&
(b="view");for(var a=$('<div class="multifield-subfields"></div>'),c="function"==typeof this.subfieldFactory.newInlineFieldElement,d=!0,e=0;e<this.subfieldEditors.length;e++){var g=this.newSubFieldElement(b,e);a.append(g);d=d&&this.subfieldEditors[e].parentEditorData.empty}if(d&&!this.fieldData.show_empty)return $('<div style="display: none"></div>');d=$("<div></div>").append(a);if("edit"==b){var e=c?$('<div class="value"><span class="replace-me-with-value"></span></div>'):$.wa.contactEditor.wrapper('<span class="replace-me-with-value"></span>'),
h=this;e.find(".replace-me-with-value").replaceWith($('<a href="javascript:void(0)" class="small inline-link"><b><i>'+$_("Add another")+"</i></b></a>").click(function(){var c=h.subfieldFactory.createEditor(),d=h.subfieldEditors.length;val={value:c.getValue(),temp:!0};"undefined"!=typeof h.fieldData.ext&&(val.ext="");h.fieldValue[d]=val;h.subfieldEditors[d]=c;"null"!=h.currentMode&&c.setMode(h.currentMode);a.append(h.newSubFieldElement(b,d));h.domElement.find(".delete-subfield").css("display","inline")}));
d.append(e)}c&&(c="","edit"==b&&(c=(this.fieldData.required?'<span class="req-star">*</span>':"")+":"),d=$.wa.contactEditor.wrapper(d,this.fieldData.name+c));return d},setMode:function(b,a){"undefined"==typeof a&&(a=!0);if("view"!=b&&"edit"!=b)throw Error("Unknown mode: "+b);if(this.currentMode!=b){if("view"==b&&"edit"==this.currentMode&&this.origFieldValue)this.setValue(this.origFieldValue);else if("view"==this.currentMode&&!this.origFieldValue){this.origFieldValue=[];for(var c=0;c<this.fieldValue.length;c++)this.origFieldValue.push($.extend({},
this.fieldValue[c]))}this.currentMode=b;a&&(c=this.domElement,this.domElement=this.newFieldElement(b),null!==c&&c.replaceWith(this.domElement))}for(c=0;c<this.subfieldEditors.length;c++)this.subfieldEditors[c].setMode(b,!1);return this.domElement}});
$.wa.contactEditor.factoryTypes.Composite=$.extend({},$.wa.contactEditor.baseFieldType,{subfieldEditors:null,initializeFactory:function(b){this.fieldData=b;if(this.fieldData.required){for(var a in this.fieldData.required)if(this.fieldData.required[a]){this.fieldData.required=!0;break}!0!==this.fieldData.required&&(this.fieldData.required=!1)}},initialize:function(){var b={data:{},value:""};this.subfieldEditors={};this.fieldData.subfields=this.fieldData.fields;for(var a in this.fieldData.subfields){var c=
$.extend({},$.wa.contactEditor.factoryTypes[this.fieldData.subfields[a].type]),d=this.fieldData.fields[a];this.fieldData.required&&this.fieldData.required[a]&&(d.required=!0);d=$.extend({},d,{id:null,multi:!1});c.initializeFactory(d);c.parentEditor=this;c.parentEditorData={};c.initialize();c.parentEditorData.sfid=a;c.parentEditorData.parent=this;this.subfieldEditors[a]=c;b.data[a]=c.getValue()}this.fieldValue=b},setValue:function(b){if(b){this.fieldValue=b;for(var a in this.subfieldEditors){var c=
this.subfieldEditors[a];"undefined"==typeof b.data?(c.initialize(),c.setValue(c.getValue())):"undefined"!=typeof b.data[a]?c.setValue(b.data[a]):c.setValue(c.getValue())}}},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue.data);var b={},a;for(a in this.subfieldEditors)b[a]=this.subfieldEditors[a].getValue();return b},isModified:function(){for(var b in this.subfieldEditors)if(this.subfieldEditors[b].isModified())return!0;return!1},validate:function(b){var a={},c=!1,
d;for(d in this.subfieldEditors){var e=this.subfieldEditors[d].validate(b);e&&(a[d]=e,c=!0)}return!c?null:a},showValidationErrors:function(b){if(null!==this.domElement)for(var a in this.subfieldEditors){var c=this.subfieldEditors[a];null!==b&&"undefined"!=typeof b[a]?c.showValidationErrors(b[a]):c.showValidationErrors(null)}},newInlineFieldElement:null,newFieldElement:function(b){this.fieldData.read_only&&(b="view");if("view"==b&&!this.fieldValue.value&&!this.fieldData.show_empty)return $('<div style="display: none"></div>');
var a=$('<div class="composite '+b+'"></div>').append($.wa.contactEditor.wrapper('<span style="display:none" class="replace-with-ext"></span>',this.fieldData.name,"hdr")),c;for(c in this.subfieldEditors){var d=this.subfieldEditors[c],e=d.newFieldElement(b);d.domElement=e;a.append(e)}return a},setMode:function(b,a){"undefined"==typeof a&&(a=!0);if("view"!=b&&"edit"!=b)throw Error("Unknown mode: "+b);if(this.currentMode!=b&&(this.currentMode=b,a)){var c=this.domElement;this.domElement=this.newFieldElement(b);
null!==c&&c.replaceWith(this.domElement)}for(var d in this.subfieldEditors)this.subfieldEditors[d].setMode(b,!1);return this.domElement}});
$.wa.contactEditor.factoryTypes.Address=$.extend({},$.wa.contactEditor.factoryTypes.Composite,{showValidationErrors:function(b){if(null!==this.domElement&&(this.domElement.find("em.errormsg").remove(),this.domElement.find(".val").removeClass("error"),b))for(var a in this.subfieldEditors){var c=this.subfieldEditors[a];"undefined"!=typeof b[a]&&c.domElement.find(".val").addClass("error").parents(".address-subfield").append($('<em class="errormsg">'+b[a]+"</em>"))}},newInlineFieldElement:function(b){if("view"==
b)return!this.fieldValue.value?null:$('<div class="address-field"></div>').append(this.fieldValue.value).append('<span style="display:none" class="replace-with-ext"></span>');b=$('<div class="address-field"></div>');b.append('<span style="display:none" class="replace-with-ext"></span>');for(var a in this.subfieldEditors){var c=this.subfieldEditors[a],d=c.newInlineFieldElement("edit");c.domElement=d;b.append($('<div class="address-subfield"></div>').append(d));$.wa.defaultInputValue(d.find("input.val"),
c.fieldData.name+(c.fieldData.required?" ("+$_("required")+")":""),"empty")}return b}});
$.wa.contactEditor.factoryTypes.Date=$.extend({},$.wa.contactEditor.baseFieldType,{datepickerOptions:function(b){return{altField:b.find("input.val"),dateFormat:this.fieldData.format,altFormat:"yy-mm-dd",yearRange:"-99:+1",changeYear:!0,changeMonth:!0}},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;var a=null,c=this.fieldValue;if("edit"==b){var a=$('<span><input class="datepicker" type="text"><input class="val" type="hidden"></span>'),d=a.find("input.datepicker").val(c);
d.datepicker(this.datepickerOptions(a)).blur(function(){$(this).val()||a.find("input.val").val("")});d.datepicker("setDate",d.datepicker("getDate"));d.datepicker("widget").hide();$(document).one("hashchange",function(){for(var a=d[0];a=a.parentNode;)if(a===document){d.datepicker("hide").datepicker("destroy");break}})}else a=$('<span class="val"></span>').text(c);return a}});
$.wa.contactEditor.factoryTypes.IM=$.extend({},$.wa.contactEditor.baseFieldType,{setValue:function(b){"undefined"==typeof b&&(b="");"object"==typeof b?(this.fieldValue=b.data,this.viewValue=b.value):this.fieldValue=this.viewValue=b;"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(b){if("view"==b&&!this.fieldValue)return null;var a=null;"edit"==
b?(a=$('<span><input class="val" type="text"></span>'),a.find(".val").val(this.fieldValue)):a=$('<span class="val"></span>').html(this.viewValue);return a}});
$.wa.contactEditor.factoryTypes.Url=$.extend({},$.wa.contactEditor.factoryTypes.IM,{validate:function(b){var a=$.trim(this.getValue());if(!b&&this.fieldData.required&&!a)return $_("This field is required.");if(!a)return null;/^(https?|ftp|gopher|telnet|file|notes|ms-help)/.test(a)||(a="http://"+a,this.setValue(a));b=RegExp("^(https?|ftp|gopher|telnet|file|notes|ms-help):((//)|(\\\\\\\\))+[^`!\\[\\]{}'\"<>\u00ab\u00bb\u201c\u201d\u2018\u2019\\s]*$","i");return!b.test(a)||/^(http|ftp)/.test(a.toLowerCase())&&
(b=RegExp("^(https?|ftp):((//)|(\\\\\\\\))+((?:[^`!()\\[\\]{};:'\".,<>?\u00ab\u00bb\u201c\u201d\u2018\u2019\\s+]+\\.)+[^`!()\\[\\]{};:'\".,<>?\u00ab\u00bb\u201c\u201d\u2018\u2019\\s+]{2,6})((/|\\\\|#)[^`!\\[\\]{}'\"<>\u00ab\u00bb\u201c\u201d\u2018\u2019\\s]*)?$","i"),!b.test(a))?$_("Incorrect URL format."):null}});
$.wa.contactEditor.factoryTypes.Email=$.extend({},$.wa.contactEditor.factoryTypes.Url,{validate:function(b){var a=$.trim(this.getValue());return!b&&this.fieldData.required&&!a?$_("This field is required."):!a?null:!/^([^@\s]+)@[^\s@]+\.[^\s@\.]{2,}$/i.test(a)?$_("Incorrect Email address format."):null}});
$.wa.contactEditor.factoryTypes.Checkbox=$.extend({},$.wa.contactEditor.baseFieldType,{setValue:function(b){this.fieldValue=parseInt(b);"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").attr("checked",!!this.fieldValue):this.domElement.find(".val").text(this.fieldValue?"Yes":"No"))},newInlineFieldElement:function(b){var a=null;"edit"==b?(a=$('<span><input class="val" type="checkbox" value="1" checked="checked"></span>'),this.fieldValue||a.find(".val").removeAttr("checked")):
a=$('<span class="val"></span>').text(this.fieldValue?"Yes":"No");return a}});$.wa.contactEditor.factoryTypes.Number=$.extend({},$.wa.contactEditor.baseFieldType,{validate:function(b){var a=$.trim(this.getValue());return!b&&this.fieldData.required&&!a&&0!==a?$_("This field is required."):a&&!/^-?[0-9]+([\.,][0-9]+$)?/.test(a)?$_("Must be a number."):null}});
