(function(a){a.wa.controller={free:!0,hashes:[],init:function(b){this.frontend_url=b&&b.url||"/";this.backend_url=b&&b.backend_url||"/webasyst/";this.wa_app_url=b.wa_app_url||"";a.storage=new a.store;a.ajaxSetup({cache:!1});this.lastView={title:null,hash:null,sort:null,order:null,offset:null};this.options=b;this.random=null;a.wa.dropdownsCloseEnable();"undefined"!=typeof a.History&&a.History.bind(function(c){a.wa.controller.dispatch(c)});a.wa.errorHandler=function(c){return 404==c.status?(a.wa.setHash("/contacts/all/"),
!1):!0};a("#contacts-container .contacts-data input.selector").live("click",function(){a(this).is(":radio")&&a(this).parents(".contact-row").siblings().removeClass("selected");a(this).is(":checked")?a(this).parents(".contact-row").addClass("selected"):a(this).parents(".contact-row").removeClass("selected");a.wa.controller.updateSelectedCount()});a(".collapse-handler",a("#wa-app")).die("click").live("click",function(){a.wa.controller.collapseSidebarSection(this,"toggle")});this.restoreCollapsibleStatusInSidebar();
a("ul.collapsible i.darr").click(function(){a(this).hasClass("darr")?(a(this).parent("li").children("ul").hide(),a(this).removeClass("darr").addClass("rarr")):(a(this).parent("li").children("ul").show(),a(this).removeClass("rarr").addClass("darr"))});var c=null,e=function(e){if(e.hasClass("animated"))return!1;e.addClass("animated");e.hoverIntent({over:function(){c=setTimeout(function(){c=null},500);e.removeClass("disabled")},timeout:0.3,out:function(){e.addClass("disabled");c&&(clearTimeout(c),c=
null)}});return!0};a("#c-list-toolbar-menu",a("#c-core")[0]).live("mouseover",function(){var c=a(this);e(c)&&c.mouseover()});a("#c-list-toolbar-menu",a("#c-core")[0]).live("click",function(d){var b=a(this);if((!c||b.hasClass("disabled"))&&!(0<a(d.target).parents("ul#c-list-toolbar-menu ul").size()))b.toggleClass("disabled"),!e(b)&&c&&(clearTimeout(c),c=null)});a(document).ajaxError(function(){a.storage.del("contacts/last-hash")});a("#c-core").off("click.contact-choose",".contact-row a.contact").on("click.contact-choose",
".contact-row a.contact",function(){a.wa.controller.setLastView({offset:a(this).data("offset")||0,sort:a.wa.grid.settings.sort,order:a.wa.grid.settings.order,title:a.wa.controller.getTitle(),hash:location.hash||""})});a("#c-core").off("click.contact-choose","a.contact.next, a.contact.prev").on("click.contact-choose","a.contact.next, a.contact.prev",function(){a.wa.controller.setLastView({offset:a(this).data("offset")||0})})},stopDispatch:function(a){this.stopDispatchIndex=a},previousHash:null,redispatch:function(){this.previousHash=
null;this.dispatch()},dispatch:function(b,c){var b=void 0===b?this.getHash():this.cleanHash(b),e=b.replace(/^[^#]*#\/*/,""),d=(this.previousHash||"").replace(/^[^#]*#\/*/,"");e!==d&&this.hashes.unshift(b.replace(/^[^#]*#\/*/,""));10<this.hashes.length&&this.hashes.pop();if(0<this.stopDispatchIndex)return this.previousHash=b,this.stopDispatchIndex--,!1;if(this.previousHash!=b){e=this.previousHash;this.previousHash=b;d=new a.Event("wa_before_dispatched");a(window).trigger(d,[b]);if(d.isDefaultPrevented())return this.previousHash=
e,window.location.hash=e,!1;if(b=b.replace(/^[^#]*#\/*/,"")){for(var d=!0,b=b.replace(/\\\//g,"ESCAPED_SLASH"),b=b.split("/"),g=0;g<b.length;g+=1)b[g]=b[g].replace(/ESCAPED_SLASH/g,"/");if(b[0]){for(var f="",h=b.length,g=0;g<b.length;g++)if(e=b[g],2>g)if(0===g)f=e;else if(parseInt(e,10)!=e&&-1==e.indexOf("."))f+=e.substr(0,1).toUpperCase()+e.substr(1);else{h=g;break}else{h=g;break}e=b.slice(h);this[f+"Action"]?(this.currentAction=f,this.currentActionAttr=e,this[f+"Action"].apply(this,[].concat([e],
c||[]))):(d=!1,console&&console.log("Invalid action name:",f+"Action"),a.wa.setHash("#/contacts/all/"))}else this.defaultAction();b.join&&(b=b.join("/"));d&&a.storage.set("contacts/last-hash",b)}else this.defaultAction(),a.storage.del("contacts/last-hash");this.highlightSidebar();a(document).trigger("hashchange",[b]);a(window).trigger("wa-dispatched")}},lastPage:function(){var b=a.storage.get("contacts/last-hash");b?a.wa.setHash("#/"+b):this.defaultAction()},defaultAction:function(){this.contactsAllAction()},
groupsCreateAction:function(a){this.current_group_id=0;this.groupsEditAction(a,$_("New user group"))},groupsEditAction:function(b,c){c=$_("New user group");b[0]&&(this.current_group_id=b[0],c=this.groups[this.current_group_id].name);a("#c-users-sidebar-menu").length?this.showLoading():this.setBlock("contacts-users",c);this.setTitle(c);this.load("#c-core .c-core-content","?module=groups&action=editor"+(b&&b[0]?"&id="+b[0]:""),null,null,function(){this.setTitle(c);a("#c-group-edit-name").focus();a(".wa-page-heading .loading").hide();
a("#c-users-sidebar-menu li.selected").removeClass("selected");!b||!b[0]?a("#c-create-group-toggle").addClass("selected"):a("#list-group li[rel=group"+b[0]+"]").addClass("selected")})},categoriesCreateAction:function(){this.categoriesEditAction()},categoriesEditAction:function(a){this.loadHTML("?module=categories&action=editor"+(a&&a[0]?"&id="+a[0]:""),null,function(){this.setBlock()})},categoriesDeleteAction:function(b){var c=!0;if(!b||!b[0])b=[this.current_category_id],c=!1;a.wa.dialogCreate("delete-dialog",
{content:a("<h2>"+$_("Delete this category?")+"</h2><p>"+$_("No contacts will be deleted.")+"</p>"),buttons:a("<div></div>").append(a('<input type="submit" class="button red" value="'+$_("Delete category")+'">').click(function(){0>=a(this).find(".loading").size()&&a('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);a.post("?module=categories&action=delete",{id:b[0]},function(){a.wa.controller.reloadSidebar();a.wa.dialogHide();a.wa.setHash("#/users/all/")})})).append(" "+
$_("or")+" ").append(a('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(function(){a.wa.dialogHide();c&&(a.wa.controller.stopDispatch(1),a.wa.back())})),small:!0});return!1},deleteCustomField:function(b){a('.custom-field-th[data-field-id="'+b+'"]').remove();a('.custom-field-td[data-field-id="'+b+'"]').remove();if(a(".custom-field-th").length)for(var b=["first","last"],c=0;c<b.length;c+=1){var e=b[c],d=a(".custom-field-th."+e);d.length||(d.removeClass(e),a(".custom-field-td."+e).removeClass(e),
a(".custom-field-th:"+e).addClass(e),a(".contact-row").each(function(){a(this).find(".custom-field-td:"+e).addClass(e)}))}else a(".with-custom-fields").removeClass("with-custom-fields"),a(".list-with-custom-fields").removeClass("list-with-custom-fields")},contactsGroupAction:function(b){if(b&&b[0]){var c=this.parseParams(b.slice(1),"contacts/group/"+b[0]);c.fields=["name","email","company","_access"];c.query="group/"+b[0];a(".wa-page-heading").css({width:""});this.loadGrid(c,"/contacts/group/"+b[0]+
"/",!1,{beforeLoad:function(c){this.current_group_id=b[0];if(c.count>0)this.setBlock("contacts-users",null,["group-settings","group-actions"]);else{this.setBlock("contacts-users",null,"group-settings");a("#contacts-container").html('<div class="block double-padded" style="margin-top: 35px;"><p>'+$_("No users in this group.")+"</p> <p>"+$_('To add users to group, go to <a href="#/users/all/">All users</a>, select them, and click <strong>Actions with selected / Add to group</strong>.')+"</p></div>");
return false}},afterLoad:function(c){a('#list-group li[rel="group'+b[0]+'"]').children("span.count").html(c.count)}})}},groupsDeleteAction:function(b){var c=!0;if(!b||!b[0])b=[this.current_group_id],c=!1;a.wa.dialogCreate("delete-dialog",{content:a("<h2>"+$_("Delete this group?")+"</h2><p>"+$_("No contacts will be deleted.")+"</p>"),buttons:a("<div></div>").append(a('<input type="submit" class="button red" value="'+$_("Delete group")+'">').click(function(){a('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);
a.post("?module=groups&action=delete",{id:b[0]},function(){a('#wa-app .sidebar a[href="#/contacts/group/'+b[0]+'/"]').parent().remove();0>=a("#list-group").find(".c-group").length&&a("#list-group").find(".c-shown-on-no-groups").show();delete a.wa.controller.groups[b[0]];a.wa.dialogHide();a.wa.setHash("#/users/all/")})})).append(" "+$_("or")+" ").append(a('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(function(){a.wa.dialogHide();c&&(a.wa.controller.stopDispatch(1),a.wa.back())})),small:!0});
return!1},clearLastView:function(){this.lastView={title:null,hash:null,sort:null,order:null,offset:null}},contactsAddAction:function(b){this.setBlock("contacts-info");this.load(a("#c-core .c-core-content"),"?module=contacts&action=add"+(b&&b[0]?"&company=1":""),{},null,function(){a.wa.controller.setTitle($_("New contact"),!0);a.wa.controller.clearLastView()})},contactAction:function(a){var c={};a[1]&&(c={tab:a[1]});this.lastView&&null!==this.lastView.hash&&(c.last_hash=this.lastView.hash,c.sort=this.lastView.sort,
c.offset=this.lastView.offset);this.showLoading();this.load("#c-core","?module=contacts&action=info&id="+a[0],c,function(){this.setBlock("contacts-info")})},contactPhotoAction:function(a){this.showLoading();this.loadHTML("?module=photo&action=editor&id="+a[0]+(a[1]?"&uploaded=1":""),{},function(){this.setBlock("contacts-info")})},contactsAllAction:function(b){this.showLoading();this.loadGrid(this.parseParams(b,"contacts/all"),"/contacts/all/",!1,{beforeLoad:function(){this.setBlock("contacts-list")},
afterLoad:function(c){a("#sb-all-contacts-li span.count").html(c.count)}})},contactsSearchAction:function(b,c){this.showLoading();"results"==b[0]&&(c||(c={search:!0}),b=b.slice(1));var e=b[0];"?"==e.substr(0,1)&&(e=e.substr(1));var d=this.parseParams(b.slice(1),"contacts/search/"+e);d.query=e;c&&c.search&&(d.search=1);b[5]||(d.view="list");e=this.cleanHash("#/contacts/search/"+e);a.wa.controller.setBlock("contacts-list",null,["search-actions"]);this.loadGrid(d,e.substr(1),null,{afterLoad:function(){a.wa.controller.hideLoading();
if(c&&c.search){a("#list-main .item-search").show();a("#list-main .item-search a").attr("href","#/contacts/search/results/"+b[0]+"/");d.search=1}}})},contactsCategoryAction:function(b){if(b&&b[0]){this.showLoading();var c=this.parseParams(b.slice(1),"contacts/category/"+b[0]);c.query="/category/"+b[0];this.loadGrid(c,"/contacts/category/"+b[0]+"/",!1,{beforeLoad:function(c){this.current_category_id=b[0];this.setBlock("contacts-list",null,c&&c.system_category?[]:["category-actions"])},afterLoad:function(c){a('#list-category li[rel="category'+
b[0]+'"]').children("span.count").html(c.count)}})}},usersAllAction:function(b){this.showLoading();b=this.parseParams(b,"users/all");b.query="/users/all/";b.fields=["name","email","company","_access"];this.loadGrid(b,"/users/all/",!1,{beforeLoad:function(){this.setBlock("contacts-users",$_("All users"),["group-actions"])},afterLoad:function(c){a("#sb-all-users-li span.count").html(c.count);a("#c-core .sidebar ul.stack li:first").addClass("selected")}})},usersAddAction:function(){this.checkAdminRights(function(){this.setBlock("contacts-users",
$_("New user"),!1);this.setTitle($_("New user"));a(".wa-page-heading").find(".loading").hide();a(".contacts-data").html('<div class="block double-padded"><p>'+$_("You can grant access to your account backend to any existing contact.")+"<br><br>"+$_('Find a contact, or <a href="#/contacts/add/">create a new contact</a>, and then customize their access rights on Access tab.')+"</p></div>")})},addToGroupDialog:function(){if(0>=a.wa.grid.getSelected().length)return!1;a.wa.controller.last_selected=a.wa.grid.getSelected();
a.wa.dialogCreate("c-d-add-to-group",{url:"?module=groups&action=add"})},addToGroup:function(b){a.post("?module=groups&action=contactSave",{"id[]":a.wa.grid.getSelected(),"groups[]":b||[]},function(c){a.wa.controller.last_selected=[];"ok"===c.status?(a.wa.controller.updateGroupCounters(c.data.counters||{}),a.wa.controller.afterInitHTML=function(){a.wa.controller.showMessage(c.data.message,!0,"float-left max-width")},a.wa.controller.redispatch(),a.wa.dialogHide(),a.wa.grid.selectItems(a("#c-select-all-items").attr("checked",
!1))):a.wa.controller.showMessage(c.data.message)},"json")},updateGroupCounters:function(b){if(!a.isEmptyObject(b))for(var c in b)if(b.hasOwnProperty(c)){var e=b[c]||0;a("#list-group").find("li[rel=group"+c+"] .count").text(e);this.groups[c]&&(this.groups[c].cnt=e)}},merge:function(){var b=a.wa.grid.getSelected();if(2>b.length)return!1;b=b.join(",");a.wa.setHash("/contacts/merge/"+b)},contactsMergeAction:function(b){if(b[0]){for(var c=[],b=b[0].split(","),e=0;e<b.length;e+=1)parseInt(b[e],10)&&c.push(b[e]);
a("#c-abc-index").remove();this.showLoading();this.load("#c-core .c-core-content","?module=contacts&action=mergeSelectMaster",{ids:c},null,function(){a(window).unbind("wa_after_merge_contacts").one("wa_after_merge_contacts",function(c,e){e&&"ok"===e.status&&(a(window).one("wa_after_load",function(){a.wa.controller.showMessage(e.data.message)}),a.wa.setHash("#/contact/"+e.data.master.id))});a(window).unbind("wa_cancel_merge_contacts").one("wa_cancel_merge_contacts",function(){var c=a.wa.controller.hashes;
c[1]?a.wa.setHash(c[1]):a.wa.setHash("")})})}else a.wa.setHash("/contacts/all/")},simpleSearch:function(){var b=a.trim(a("#search-text").val());if(b){var c="",b=b.replace(/\//g,"\\/").replace(/&/,"\\&"),c=-1!=b.indexOf("@")?"email*="+b:"name*="+b;a.wa.controller.stopDispatch(1);a.wa.setHash("#/contacts/search/"+c+"/");a.wa.controller.contactsSearchAction([c],{search:!0})}},addToCategory:function(b,c){c=c||a.wa.grid.getSelected();a.wa.controller.showMessage("",!0);c.length&&b&&a.post("?module=categories&type=add",
{contacts:c,categories:b},function(c){if(c.data&&c.data.count)for(var d in c.data.count)a('#list-category li[rel="category'+d+'"] span.count').html(c.data.count[d]);a.wa.controller.showMessage(c.data.message,!0)},"json")},dialogAddSelectedToCategory:function(){0>=a.wa.grid.getSelected().length||0>=a("#list-category li:not(.empty):not(.selected):not(.hint)").size()||a('<div id="add-to-category-dialog"></div>').waDialog({url:"?module=categories&action=addSelected"+(this.current_category_id?"&disabled="+
this.current_category_id:"")})},dialogRemoveSelectedFromCategory:function(b){b=b||a.wa.grid.getSelected();!(0>=b.length)&&a.wa.controller.current_category_id&&a('<div id="confirm-remove-from-category-dialog" class="small"></div>').waDialog({content:a("<h2></h2>").text($_('Exclude contacts from category "%s"?').replace("%s",a("h1.wa-page-heading").text())),buttons:a("<div></div>").append(a('<input type="submit" class="button red" value="'+$_("Exclude")+'">').click(function(){a('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);
a.post("?module=categories&action=deleteFrom",{categories:[a.wa.controller.current_category_id],contacts:b},function(c){a.wa.dialogHide();"ok"===c.status&&(a.wa.controller.afterInitHTML=function(){a.wa.controller.showMessage(c.data.message)},a.wa.controller.redispatch())},"json")})).append(" "+$_("or")+" ").append(a('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(a.wa.dialogHide))})},dialogRemoveSelectedFromGroup:function(b){b=b||a.wa.grid.getSelected();!(0>=b.length)&&a.wa.controller.current_group_id&&
a('<div id="confirm-remove-from-category-dialog" class="small"></div>').waDialog({content:a("<h2></h2>").text($_('Exclude users from group "%s"?').replace("%s",a("h1.wa-page-heading").text())),buttons:a("<div></div>").append(a('<input type="submit" class="button red" value="'+$_("Exclude")+'">').click(function(){a('<i style="margin: 8px 0 0 10px" class="icon16 loading"></i>').insertAfter(this);a.post("?module=groups&action=deleteFrom",{groups:[a.wa.controller.current_group_id],contacts:b},function(c){a.wa.dialogHide();
"ok"===c.status&&(a.wa.controller.updateGroupCounters(c.data.counters||{}),a.wa.controller.afterInitHTML=function(){a.wa.controller.showMessage(c.data.message,null)},a.wa.controller.redispatch())},"json")})).append(" "+$_("or")+" ").append(a('<a href="javascript:void(0)">'+$_("cancel")+"</a>").click(a.wa.dialogHide))})},contactsDelete:function(b){b=b||a.wa.grid.getSelected();0>=b.length||a.wa.dialogCreate("delete-dialog",{content:"<h2>"+$_("Checking links to other applications...")+' <i class="icon16 loading"></i></h2>',
url:(this.wa_app_url||"")+"?module=contacts&action=links",small:!0,post:{"id[]":b}})},listTabs:[],addListTab:function(a){this.listTabs.push(a)},addGroup:function(b){a.isEmptyObject(b)||(a.wa.controller.groups[b.id]=b,a("#list-group").replaceWith(this.renderGroups(a.wa.controller.groups)))},renderGroups:function(b){var c;c='<ul class="menu-v with-icons collapsible" id="list-group">'+('<li class="hint c-shown-on-no-groups" style="padding:0 20px; '+(!a.isEmptyObject(b)?"display: none;":"")+'">'+$_("User groups are for organizing Webasyst users and setting common access rights for groups.")+
"</li>");if(!a.isEmptyObject(b)){var e=[],d;for(d in b)b.hasOwnProperty(d)&&e.push(b[d]);e=e.sort(function(c,e){return c.name.toString().localeCompare(e.name.toString())});d=0;for(b=e.length;d<b;d+=1){var g=e[d];c+='<li rel="group'+g.id+'" class="c-group">';c+='<span class="count">'+g.cnt+"</span>";c+='<a href="#/contacts/group/'+g.id+'/"><img src="../../wa-content/img/users/'+g.icon+'.png"> <b class="name">'+g.name+"</b></a>";c+="</li>"}}return c+"</ul>"},updateGroup:function(b,c){this.groups[b]=
c;a("#list-group").find("li[rel=group"+b+"]").html('<span class="count">'+c.cnt+'</span><a href="#/contacts/group/'+c.id+'"><img src="../../wa-content/img/users/'+c.icon+'.png"> <b>'+c.name+"</b></a>")},checkAdminRights:function(b,c){a.get("?module=contacts&action=user&a=is_admin",function(){b.call(void 0===c?a.wa.controller:c)})},setBlock:function(b,c,e,d){b||(b="default");if(void 0===c||null===c)c=$_("Loading...");var g=this.block;this.block=b;a("#c-core .c-core-header").remove();var d=d||{},e=
"undefined"===typeof e?[]:e,f="";"contacts-users"===b?(f=a("#c-core .c-core-content"),f="",!1!==d.groups&&(f+=a.wa.controller.renderGroups(d.groups||a.wa.controller.groups)),a("#c-core").html('<div class="shadowed" id="c-users-page"><div class="sidebar left200px" style="min-height: 300px;"><ul class="menu-v with-icons stack" id="c-users-sidebar-menu"><li class="selected" style="margin-left: 17px;"><a class="" href="#/users/all/"><i class="icon16 user"></i>'+$_("All users")+'</a></li><li style="margin-left: 15px;"><a class="small" href="#/users/add/"><i class="icon10 add"></i>'+
$_("New user")+'</a></li><li class="" style="text-transform: uppercase;"><h5 class="heading">'+$_("Groups")+"</h5></li>"+f+'<li class="small" id="c-create-group-toggle" style="margin-left: 14px;"><a href="#/groups/create/"><i class="icon10 add"></i>'+$_("New group")+'</a></li></ul></div><div class="content left200px bordered-left blank"><div class="block not-padded c-core-content"><div class="block" style="overflow:hidden;"><div class="c-actions-wrapper float-right" style="margin: 8px;"></div><h1 class="wa-page-heading">'+
(c||$_("All users"))+' <i class="icon16 loading"></i></h1></div><div class="block not-padded tab-content float-left" style="width: 100%;" id="contacts-container"><div class="block not-padded contacts-data"></div></div></div><div class="clear"></div></div><div class="clear"></div></div>'),f=a("#c-core .c-core-content"),a("#c-create-group-toggle").click(function(){a.wa.controller.last_selected=[]}),a.isArray(e)?a.wa.controller.showMenus(e):f.find(".c-list-toolbar").remove()):(f=a("#c-core").empty().append(a('<div class="contacts-background"><div class="block not-padded c-core-content"></div></div>')).find(".c-core-content"),
f.html('<div class="block"><div class="c-actions-wrapper"></div><h1 class="wa-page-heading">'+c+' <i class="icon16 loading"></i></h1></div>'));a.scrollTo(0);e&&0<=e.indexOf("group-settings")&&this.current_group_id?f.find(".c-actions-wrapper").html('<a href="#/groups/edit/'+this.current_group_id+'/"><i class="icon16 settings"></i></a>'):e&&0<=e.indexOf("category-actions")&&this.current_category_id&&this.global_admin?f.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#/categories/edit/'+
this.current_category_id+'/"><i class="icon16 edit"></i>'+$_("Edit category")+'</a></li><li><a href="#/categories/delete/'+this.current_category_id+'/" onclick="return $.wa.controller.categoriesDeleteAction();"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li></ul>"):e&&0<=e.indexOf("search-actions")&&!this.free?f.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#" onclick="return $.wa.controller.saveSearchAsFilter()"><i class="icon16 save-as-filter"></i>'+$_("Save as a filter")+
"</a></li></ul>"):e&&(0<=e.indexOf("view-actions")&&this.current_view_id)&&f.find("div.block").prepend('<ul class="menu-h c-actions"><li><a href="#/filters/edit/'+this.current_view_id+'/"><i class="icon16 edit"></i>'+$_("Edit filter")+'</a></li><li><a href="#" onclick="return $.wa.controller.deleteList('+this.current_view_id+', true)"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li></ul>");switch(b){case "contacts-duplicates":case "contacts-list":if(0<this.listTabs.length){d=a('<ul class="tabs" id="c-list-tabs"></ul>');
g=(a("#wa-app .sidebar .selected a").attr("href")||"").replace(/^[^#]*#/g,"");"/"!==g[0]&&(g="/"+g);for(var h=0;h<this.listTabs.length;h++)"function"==typeof this.listTabs[h]&&this.listTabs[h].call(a.wa.controller,d,g);0<d.children().size()&&(d.prepend(a('<li class="selected"></li>').append(a('<a href="#'+g+'">'+$_("Contacts")+"</a>").click(function(){a("#c-list-tabs .selected").removeClass("selected");a(this).parent().addClass("selected");a.wa.controller.showLoading();return true}))),f.append(d))}f.append('<div id="contacts-container" class="tab-content"></div>');
f.next().hasClass("clear-left")||a('<div class="clear-left"></div>').insertAfter(f);this.showMenus((e||[]).concat(["merge","delete"]));f.find("#contacts-container").append('<div class="block not-padded contacts-data"></div>');break;case "contacts-users":case "contacts-info":case "default":break;default:throw this.block=g,Error("Unknown block: "+b);}this.afterInitHTML&&(this.afterInitHTML(),this.afterInitHTML="");a(window).trigger("wa_after_init_html",[b,c,e])},showMenus:function(b){var b='<li><a href="javascript:void(0)" class="inline-link"><b><i>'+
$_("Actions with selected")+' (<span id="selected-count" class="selected-count">0</span>)</i></b><i class="icon10 darr"></i></a><ul class="menu-v" id="actions-with-selected">'+(0<=b.indexOf("group-actions")?'<li><a href="#" onclick="$.wa.controller.addToGroupDialog(); return false"><i class="icon16 contact"></i>'+$_("Add to group")+"</a></li>":"")+'<li id="add-to-category-link"><a href="#" onclick="$.wa.controller.dialogAddSelectedToCategory(); return false"><i class="icon16 contact"></i>'+$_("Add to category")+
"</a></li>"+(0<=b.indexOf("group-actions")&&this.current_group_id?'<li><a href="#" onclick="$.wa.controller.dialogRemoveSelectedFromGroup(); return false"><i class="icon16 contact"></i>'+$_("Exclude from this group")+"</a></li>":"")+(0<=b.indexOf("category-actions")&&this.current_category_id?'<li><a href="#" onclick="$.wa.controller.dialogRemoveSelectedFromCategory(); return false"><i class="icon16 contact"></i>'+$_("Exclude from this category")+"</a></li>":"")+(0<=b.indexOf("merge")&&a.wa.controller.merge&&
a.wa.controller.admin?'<li class="two-or-more disabled"><a href="#" onClick="$.wa.controller.merge(); return false"><i class="icon16 merge"></i>'+$_("Merge contacts")+"</a></li>":"")+(0<=b.indexOf("delete")?'<li><a href="#" onclick="$.wa.controller.contactsDelete(); return false" class="red" id="show-dialog-delete"><i class="icon16 delete"></i>'+$_("Delete")+"</a></li>":"")+"</ul></li>",b='<ul id="list-views" class="menu-h float-right"><li rel="table"><a href="#"><i class="icon16 only view-table" title="'+
$_("List")+'"></i></a></li><li rel="list"><a href="#" title="'+$_("Details")+'"><i class="icon16 only view-thumb-list"></i></a></li><li rel="thumbs"><a href="#" title="'+$_("Userpics")+'"><i class="icon16 only view-thumbs"></i></a></li></ul><div id="c-list-toolbar-menu-wrapper"><input id="c-select-all-items" onclick="$.wa.grid.selectItems(this)" type="checkbox"><ul id="c-list-toolbar-menu" class="menu-h dropdown disabled" style="display:inline-block;">'+b+"</ul></div>",c=a("#contacts-container").find(".c-list-toolbar");
0>=c.size()&&(c=a('<div class="block c-list-toolbar"></div>').prependTo(a("#contacts-container")));c.html(b);a("#contacts-container").off("click.contacts_view","#list-views > li").on("click.contacts_view","#list-views > li",function(){a.wa.grid.setView(a(this).closest("li").attr("rel"));return!1});a.wa.controller.updateSelectedCount()},showLoading:function(){var b=a("h1");0>=b.size()||(b=a(b[0]),0<b.find(".loading").show().size()||b.append('<i class="icon16 loading"></i>'))},hideLoading:function(){a("h1 .loading").remove()},
updateSelectedCount:function(){var b=a("input.selector:checked").size();a("#selected-count").text(b);a("#selected-count-word-form").text($_(b,"contacts selected"));0>=b?a("#actions-with-selected li").addClass("disabled"):(a("#actions-with-selected li").removeClass("disabled"),0>=a("#list-category li:not(.empty):not(.selected)").size()&&a("#add-to-category-link").addClass("disabled"),2>b&&a("#actions-with-selected li.two-or-more").addClass("disabled"))},getUrl:function(){return this.options.url},loadHTML:function(a,
c,e,d){this.showLoading();this.load(d||"#c-core .c-core-content",a,c,e)},load:function(b,c,e,d,g){a.wa.contactEditor.load.apply(this,Array.prototype.slice.apply(arguments))},parseParams:function(b,c){var e={};b&&b[0]&&(e.offset=b[0]);b&&b[1]&&(e.sort=b[1]);b&&b[2]&&(e.order=b[2]);b&&b[3]?(e.view=b[3],c&&a.storage.set("contacts/view/"+c,e.view)):e.view=a.storage.get("contacts/view/"+c)||"table";b&&b[4]?(e.limit=b[4],c&&a.storage.set("contacts/limit/"+c,e.limit)):e.limit=a.storage.get("contacts/limit/"+
c)||30;return e},setTitle:function(b,c){this.title=b;document.title=this.accountName?b+" \u2014 "+this.accountName:b;c&&a("#c-core h1.wa-page-heading").text("string"===typeof c?c:b)},getTitle:function(){return this.title||""},setLastView:function(b){this.lastView=a.extend(this.lastView,b)},clearLastView:function(){this.lastView={title:null,hash:null,sort:null,order:null,offset:null}},loadGrid:function(b,c,e,d){this.current_category_id=this.current_group_id=this.current_view_id=null;e||(e="?module=contacts&action=list");
d||(d={});a.wa.grid.load(e,b,"#contacts-container .contacts-data",c,d)},showMessage:function(b,c,e){var d=a("#c-core .wa-message");c&&(d.remove(),d=a());b&&(b=a('<div class="wa-message wa-success '+(e||"")+'"><a onclick="$(this).parent().empty().hide();"><i class="icon16 close"></i></a></div>').prepend(a('<span class="wa-message-text"></span>').append(b)),d.size()?a(d[0]).empty().append(b):a("#c-core h1:first").size()?b.insertAfter(a("#c-core h1:first")):a("#c-core").prepend(b))},setHash:function(b){return a.wa.setHash(this.cleanHash(b))},
getHash:function(){return this.cleanHash()},cleanHash:function(a){"undefined"==typeof a&&(a=window.location.hash.toString());for(a.length||(a=""+a);0<a.length&&"/"===a[a.length-1];)a=a.substr(0,a.length-1);a+="/";"#"!=a[0]?("/"!=a[0]&&(a="/"+a),a="#"+a):a[1]&&"/"!=a[1]&&(a="#/"+a.substr(1));return"#/"==a?"":a},collapseSidebarSection:function(b,c){c||(c="coollapse");b=a(b);if(!(0>=b.size())){var e=b.find(".darr, .rarr");0>=e.size()&&(e=a('<i class="icon16 darr">'),b.prepend(e));var d,g=b.attr("id"),
f=e.hasClass("darr")?"shown":"hidden",h=function(){b.parent().find("ul.collapsible").hide();e.removeClass("darr").addClass("rarr");d="hidden";b.trigger("collapsible",["hide"])},j=function(){b.parent().find("ul.collapsible").show();e.removeClass("rarr").addClass("darr");d="shown";b.trigger("collapsible",["show"])};switch(c){case "toggle":"shown"==f?h():j();break;case "restore":g&&("hidden"==a.storage.get("contacts/collapsible/"+g)?h():j());break;case "uncollapse":j();break;default:h()}g&&d&&a.storage.set("contacts/collapsible/"+
g,d)}},restoreCollapsibleStatusInSidebar:function(){a("#wa-app .collapse-handler").each(function(b,c){a.wa.controller.collapseSidebarSection(c,"restore")})},reloadSidebar:function(){a.post("?module=backend&action=sidebar",null,function(b){var c=a("#wa-app .sidebar");c.css("height",c.height()+"px").html(b).css("height","");a.wa.controller.highlightSidebar();a.wa.controller.restoreCollapsibleStatusInSidebar();a.wa.controller.initSidebarDragAndDrop&&a.wa.controller.initSidebarDragAndDrop()})},highlightSidebar:function(){var b=
this.cleanHash(location.hash),c=!1,e=!1;a("#wa-app .sidebar li a").each(function(d,f){var f=a(f),h=a.wa.controller.cleanHash(f.attr("href"));if(h==b)return e=f,!1;!c&&(2<h.length&&b.substr(0,h.length)===h)&&(c=f)});!e&&c&&(e=c);if(e&&(a("#wa-app .sidebar .selected").removeClass("selected"),0>=e.parents("ul.dropdown").size())){for(var d=e.parent();0<d.size()&&"li"!=d[0].tagName.toLowerCase();)d=d.parent();0<d.size()&&d.addClass("selected")}},loadTabSlidingAnimation:function(){a.effects&&!a.effects.slideDIB&&
(a.effects.slideDIB=function(b){return this.queue(function(){var c=a(this),e="position top left width height margin".split(" "),d=a.effects.setMode(c,b.options.mode||"show"),g=b.options.direction||"left";a.effects.save(c,e);c.show();a.effects.createWrapper(c).css({overflow:"hidden",display:"inline-block",width:"auto"});var f="up"==g||"down"==g?"top":"left",g="up"==g||"left"==g?"pos":"neg",h=b.options.distance||("top"==f?c.outerHeight({margin:!0}):c.outerWidth({margin:!0}));"show"==d&&c.css(f,"pos"==
g?-h:h);var j={};j[f]=("show"==d?"pos"==g?"+=":"-=":"pos"==g?"-=":"+=")+h;c.animate(j,{queue:!1,duration:b.duration,easing:b.options.easing,complete:function(){"hide"==d&&c.hide();a.effects.restore(c,e);a.effects.removeWrapper(c);b.callback&&b.callback.apply(this,arguments);c.dequeue()}})})})}}})(jQuery);(function(a){a.wa.grid={count:0,data:{},highlight_terms:[],init:function(){this.defaultSettings={limit:30,offset:0,sort:"name",order:1,view:"table"};this.settings=a.extend({},this.defaultSettings);var b=this;a("#records-per-page").die(a.browser.msie?"click":"change");a("#records-per-page").live(a.browser.msie?"click":"change",function(){var c=a(this).val(),e=0;b.settings&&b.settings.offset&&(e=b.settings.offset);a.wa.setHash(a.wa.grid.hash+a.wa.grid.getHash({limit:c,offset:e}))})},formatFieldValue:function(b,
c){return"_access"===c.id?"admin"==b?"<strong>"+$_("Administrator")+"</strong>":b?"custom"==b?'<span style="white-space: nowrap">'+$_("Limited access")+"</span>":b:'<span style="color: red; white-space: nowrap">'+$_("No access")+"</span>":b?a.wa.encodeHTML(b):""},setHightlightTerms:function(b){var c=[];if(a.isArray(b)&&b.length)for(var e=0,d=b.length;e<d;e+=1)c.push(b[e]||"");else"string"===typeof b&&c.push(b||"");return this.highlight_terms=b},highlight:function(b){var c=this.highlight_terms;if(b&&
!a.isEmptyObject(c)){var e=a.parseXML?a.parseXML:a.parseHTML,d=function(a){for(var e=0,d=c.length;e<d;e+=1)c[e]&&(a=(""+a).replace(RegExp("("+c[e].replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"),'<span class="highlighted">$1</span>'));return a};try{var g="wrapper"+(""+Math.random()).slice(2),f=e.call(a,'<div id="'+g+'">'+b+"</div>"),h=function(c){return c.contents().map(function(c,e){if(3==e.nodeType)return d(a.wa.encodeHTML(a(e).text()));if(a(e).contents().length){var b=a("<div>");
h(a(e)).each(function(c,a){b.append(a)});return b.find(":first").get(0)}return e})},j=a("<div>");h(a(f).find("#"+g)).each(function(c,a){j.append(a)});return j.html()}catch(i){return console&&console.log([b,i]),d(b)}}return b},formNamesHtml:function(b){var c=this.highlight(a.wa.encodeHTML(b.name)),e=this.highlight(a.wa.encodeHTML(b.lastname)),d=this.highlight(a.wa.encodeHTML(b.middlename)),g=this.highlight(a.wa.encodeHTML(b.firstname)),f=!1,h=[g,d,e].join(" ").trim();b.lastname?(e="<strong>"+e+"</strong>",
f=!0):b.firstname?(g="<strong>"+g+"</strong>",f=!0):b.middlename&&(d="<strong>"+d+"</strong>",f=!0);d=[g,d,e].join(" ").trim();e=[];if(parseInt(b.is_company,10))return h="",h=f?h+(b.company?this.highlight(a.wa.encodeHTML(b.company)):c):h+((b.company?"<strong>"+this.highlight(a.wa.encodeHTML(b.company)):c)+"</strong>"),[h];b.title&&e.push("<span class='title'>"+this.highlight(a.wa.encodeHTML(b.title))+"</span>");h?e.push(d):c?e.push(c):e.push(a("<span></span>").text($_("<no-name>")).html());e=e.join(" ").trim();
h="";if(b.jobtitle||b.company)b.jobtitle&&(h+='<span class="title">'+this.highlight(a.wa.encodeHTML(b.jobtitle))+"</span>"),b.jobtitle&&b.company&&(h+=' <span class="at">'+$_("@")+"</span> "),b.company&&(h=f?h+('<span class="company">'+this.highlight(a.wa.encodeHTML(b.company))+"</span>"):h+('<span class="company"><strong>'+this.highlight(a.wa.encodeHTML(b.company))+"</strong></span>"));return[e,h]},viewtable:function(a,c){var e=tmpl("template-contacts-list-table",a);this.count=a.count;c||(e+=this.getPaging(a.count));
return e},viewlist:function(a){var c=tmpl("template-contacts-list-list",a);this.count=a.count;return c+=this.getPaging(a.count)},viewthumbs:function(a){var c=tmpl("template-contacts-list-thumbs",a);this.count=a.count;return c+=this.getPaging(a.count)},load:function(b,c,e,d,g){this.url=b;this.options=g;this.hash=d;this.settings=a.extend({},this.defaultSettings);for(var f in c)null!==c[f]&&(this.settings[f]=c[f]);var h=this,j=Math.random();a.wa.controller.random=j;a.post(b,this.settings,function(c){if(a.wa.controller.random!=
j||"ok"!=c.status)return!1;c.data.contacts&&(a.wa.grid.data=c.data);if(c.data.count&&c.data.contacts&&!c.data.contacts.length)return c=Math.floor((c.data.count-1)/h.settings.limit)*h.settings.limit,c!=h.settings.offset&&a.wa.setHash(a.wa.grid.hash+a.wa.grid.getHash({offset:c})),!1;var d=null;h.options&&h.options.beforeLoad&&(d=h.options.beforeLoad.call(a.wa.controller,c.data));c.data.title&&a.wa.controller.setTitle(c.data.title,!0);c.data.desc&&a.wa.controller.setDesc(c.data.desc);c.data.history&&
a.wa.history.updateHistory(c.data.history);e=a(e);!1!==d&&e.html(h.view(h.settings.view,c.data));h.options&&h.options.afterLoad&&h.options.afterLoad(c.data);a.wa.controller.clearLastView()},"json")},getSelected:function(b){var c=[];a("input.selector:checked").each(function(){if(b){var a=parseInt(this.value,10);isNaN(a)||c.push(a)}else c.push(this.value)});return c},setView:function(b){a.wa.setHash(this.hash+this.getHash({view:b}));return!1},selectItems:function(b,c){c=a("#"+(c||"contacts-container"));
a(b).is(":checked")?c.find("input.selector").attr("checked","checked").parents(".contact-row,.item-row").addClass("selected"):c.find("input.selector").removeAttr("checked").parents(".contact-row,.item-row").removeClass("selected");a.wa.controller.updateSelectedCount()},viewlistvalue:function(b,c){if("object"!==typeof b){if("Select"===c.type){var e=c.options||{};void 0!==e[b]&&(b=e[b])}return a.wa.encodeHTML(b)}e="";c.icon&&(e+='<i class="icon16 '+c.icon+'"></i>');var d=!0,g;for(g in b)if("ext"!=g&&
"value"!=g){d=!1;break}b.value&&(e+=d?a.wa.encodeHTML(b.value):b.value);a.trim(b.ext)&&!c.fields&&(e=c.ext&&c.ext[b.ext]?e+(' <em class="hint">'+c.ext[b.ext]+"</em>"):e+(' <em class="hint">'+a.wa.encodeHTML(b.ext)+"</em>"));return e},view:function(b,c,e){this["view"+b]||(b="table");a("#list-views li.selected").removeClass("selected");a("#list-views li[rel="+b+"]").addClass("selected");a("#contacts-container .contacts-data").removeClass("padded").addClass("not-padded");var d=c.highlight_terms||(c.info&&
c.info.highlight_terms?c.info.highlight_terms:[])||[];"string"===typeof d&&(d=[d]);a.wa.grid.setHightlightTerms(d);return this["view"+b](c,e)},getHash:function(a){var c={},e;for(e in this.settings)c[e]=this.settings[e];for(e in a)c[e]=a[e];return c.offset+"/"+c.sort+"/"+c.order+"/"+c.view+"/"+c.limit+"/"},getPaging:function(b,c,e){var c="undefined"===typeof c?!0:c,d='<div class="block paging">',g=a.wa.controller.options.paginator_type;if("undefined"===typeof e||e){for(var f="",h=[30,50,100,200,500],
e=0;e<h.length;e++)f+='<option value="'+h[e]+'"'+(this.settings.limit==h[e]?' selected="selected"':"")+">"+h[e]+"</option>";b>h[0]&&(d+='<span class="c-page-num">'+$_("Show %s records on a page").replace("%s",'<select id="records-per-page">'+f+"</select>")+"</span>")}c&&"page"===g&&(d+='<span class="total">'+$_("Contacts")+": "+b+"</span>");c=Math.ceil(b/parseInt(this.settings.limit));f=Math.ceil(parseInt(this.settings.offset)/parseInt(this.settings.limit))+1;if(1<c){"/"!=this.hash[this.hash.length-
1]&&(this.hash+="/");"page"===g&&(d+="<span>"+$_("Pages")+":</span>");if(1==c)return"";if("page"===g){b=0;for(e=1;e<=c;e++)2>Math.abs(f-e)||2>e||1>c-e?(d+="<a "+(e==f?'class="selected"':"")+' href="#'+this.hash+this.getHash({offset:(e-1)*this.settings.limit})+'">'+e+"</a>",b=0):3>b++&&(d+=".")}else d+=parseInt(this.settings.offset,10)+1+"&mdash;"+Math.min(b,parseInt(this.settings.offset,10)+parseInt(this.settings.limit,10)),d+=" "+$_("of")+" "+b}else"page"!==g&&(0>=c?d+=$_("No contacts."):(d+=Math.min(parseInt(this.settings.offset,
10)+1,b)+"&mdash;"+Math.min(b,parseInt(this.settings.offset,10)+parseInt(this.settings.limit,10)),d+=" "+$_("of")+" "+b));1<f&&(d+='<a href="#'+this.hash+this.getHash({offset:(f-2)*this.settings.limit})+'" class="prevnext"><i class="icon10 larr"></i> '+$_("prev")+"</a>");f<c&&(d+='<a href="#'+this.hash+this.getHash({offset:f*this.settings.limit})+'" class="prevnext">'+$_("next")+' <i class="icon10 rarr"></i></a>');return d+"</div>"}}})(jQuery);$.wa.history={data:null,updateHistory:function(a){this.data=a;var b=$("#wa-search-history").empty(),c=$("#wa-creation-history").empty();$.wa.controller.cleanHash(location.hash);for(var e=0;e<a.length;e++){var d=a[e];d.hash=$.wa.controller.cleanHash(d.hash);var g=$('<li rel="'+d.id+'">'+(0<=d.cnt?'<span class="count">'+d.cnt+"</span>":"")+'<a href="'+d.hash+'"><i class="icon16 '+d.type+'"></i></a></li>');("search"==d.type||"import"==d.type)&&g.addClass("wa-h-type-search");g.children("a").append($("<b>").text(d.name));
"import"==d.type?c.append(g):"add"==d.type?(g.find(".icon16").removeClass(d.type).addClass("userpic20").css("background-image","url("+d.icon+")"),c.append(g)):"search"==d.type&&b.append(g)}a=[b,c];for(b=0;b<a.length;b++)c=a[b],0<c.children().size()?c.parents(".block.wrapper").show():c.parents(".block.wrapper").hide();$.wa.controller.highlightSidebar()},clear:function(a){!a||"search"==a?($("#wa-search-history").parents(".block.wrapper").hide(),$("#wa-search-history").empty(),a="&ctype="+a):a&&"creation"==
a?($("#wa-creation-history").parents(".block.wrapper").hide(),$("#wa-creation-history").empty(),a="&ctype[]=import&ctype[]=add"):a="";$.get("?module=contacts&action=history&clear=1"+a);return!1}};$.wa.fieldTypesFactory=function(a,b){a=a||$.wa.contactEditorFactory();a.baseFieldType={contactType:"person",options:{},createEditor:function(c){this.contactType=c||"person";c=$.extend({},this);delete c.createEditor;delete c.initializeFactory;c.parentEditorData={};c.initialize();return c},fieldValue:"",initializeFactory:function(c,a){this.fieldData=c;this.options=a||{}},initialize:function(){this.setValue("")},reinit:function(){this.currentMode="null";this.initialize()},setValue:function(c){this.fieldValue=
c;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var c=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var a=this.domElement.find(".val");if(0<a.length&&(c="",!a.hasClass("empty")&&("checkbox"!=a.attr("type")||a.attr("checked"))))c=a.val()}return c},isModified:function(){return this.fieldValue!=this.getValue()},validate:function(c){var a=
this.getValue();return!c&&this.fieldData.required&&!a?$_("This field is required."):null},newFieldElement:function(c){this.fieldData.read_only&&(c="view");var e=this.newInlineFieldElement(c);if(null===e&&(!this.fieldData.show_empty||"edit"==c))return $('<div style="display: none" class="field" data-field-id="'+this.fieldData.id+'"></div>');var d;"person"===this.contactType?0<=["firstname","middlename","lastname"].indexOf(this.fieldData.id)?(d="subname",e.find(".val").attr("placeholder",this.fieldData.name)):
"title"===this.fieldData.id?(d="subname title",e.find(".val").attr("placeholder",this.fieldData.name)):"jobtitle"===this.fieldData.id?d="jobtitle-company jobtitle":"company"===this.fieldData.id&&(d="jobtitle-company company"):"company"===this.fieldData.id&&(d="company");return a.wrapper(e,this.fieldData.name+"",d).attr("data-field-id",this.fieldData.id)},newInlineFieldElement:function(c){if("view"==c&&!this.fieldValue)return null;var a=null;"edit"==c?(a=$('<span><input class="val" type="text"></span>'),
a.find(".val").val(this.fieldValue)):(a=$('<span class="val"></span>'),a.text(this.fieldValue));return a},showValidationErrors:function(c){if(null!==this.domElement){var a=this.domElement.find(".val");a.parents(".value").children("em.errormsg").remove();null!==c?(a.parents(".value").append($('<em class="errormsg">'+c+"</em>")),a.addClass("error")):a.removeClass("error")}},fieldData:null,domElement:null,currentMode:"null",parentEditor:null,parentEditorData:null,setMode:function(c,a){"undefined"==typeof a&&
(a=!0);if("view"!=c&&"edit"!=c)throw Error("Unknown mode: "+c);if(this.currentMode!=c&&(this.currentMode=c,a)){var d=this.domElement;this.domElement=this.newFieldElement(c);null!==d&&d.replaceWith(this.domElement)}return this.domElement}};a.factoryTypes.Hidden=$.extend({},a.baseFieldType,{newFieldElement:function(c){c=this.newInlineFieldElement(c);return a.wrapper(c,this.fieldData.name).attr("data-field-id",this.fieldData.id).hide()},newInlineFieldElement:function(c){if("view"==c&&!this.fieldValue)return null;
var a=null;"edit"==c&&(a=$('<span><input type="hidden" class="val" type="text"></span>'),a.find(".val").val(this.fieldValue));return a}});a.factoryTypes.String=$.extend({},a.baseFieldType,{setValue:function(c){this.fieldValue=c;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var c=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var a=
this.domElement.find(".val"),c="";a.hasClass("empty")||(c=a.val())}return c},newInlineFieldElement:function(c){if("view"==c&&!this.fieldValue)return null;var a=null,d=this.fieldValue;"edit"==c?(a=1>=this.fieldData.input_height?$('<span><input class="val" type="text"><i class="icon16 loading" style="display:none;"></i></span>'):$('<span><textarea class="val" rows="'+this.fieldData.input_height+'"></textarea></span>'),a.find(".val").val(d)):a=$('<span class="val"></span><i class="icon16 loading" style="display:none;">').text(d);
return a},setMode:function(c,a){"undefined"==typeof a&&(a=!0);if("view"!=c&&"edit"!=c)throw Error("Unknown mode: "+c);if(this.currentMode!=c&&(this.currentMode=c,a)){var d=this.domElement;this.domElement=this.newFieldElement(c);null!==d&&d.replaceWith(this.domElement)}return this.domElement}});a.factoryTypes.Text=$.extend({},a.factoryTypes.String);a.factoryTypes.Phone=$.extend({},a.baseFieldType);a.factoryTypes.Select=$.extend({},a.baseFieldType,{notSet:function(){return""},newInlineFieldElement:function(c){if("view"==
c&&!this.fieldValue)return null;if("view"==c)return $('<span class="val"></span>').text(this.fieldData.options[this.fieldValue]||this.fieldValue);for(var c="",a=!1,d,b=0;b<this.fieldData.oOrder.length;b++){var f=this.fieldData.oOrder[b];!a&&f==this.fieldValue&&this.fieldValue?(a=!0,d=" selected"):d="";""===f&&(d+=" disabled");c+='<option value="'+f+'"'+d+">"+$.wa.encodeHTML(this.fieldData.options[f])+"</option>"}return $('<div><select class="val '+(this.fieldData.type+"").toLowerCase()+'"><option value=""'+
(a?"":" selected")+">"+this.notSet()+"</option>"+c+"</select></div>")}});a.factoryTypes.Conditional=$.extend({},a.factoryTypes.Select,{unbindEventHandlers:function(){},getValue:function(){var c=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var a=this.domElement.find(".val:visible");0<a.length&&(c=a.hasClass("empty")?"":a.val())}return c},newInlineFieldElement:function(c){if("view"==c&&!this.fieldValue)return null;this.unbindEventHandlers();if("view"==c)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&
this.fieldData.options[this.fieldValue]||this.fieldValue));for(var e=this,c=(e.fieldData.parent_field||"").split(":"),d=a.fieldEditors[c.shift()];d&&c.length;){var b=d.subfieldEditors;if(b instanceof Array)for(var d=null,f=0;f<b.length;f++){if(b[f]===e.parentEditor){d=b[f];break}}else d=b[c.shift()]}if(d){var h=this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue,j=$('<input type="text" class="hidden val">').val(h),i=$('<select class="hidden val"></select>').hide(),k=function(){var c=
$(this),a=j.is(":visible")?j.val():i.is(":visible")?i.val():h,c=(c.val()||"").toLowerCase();if(c=e.fieldData.parent_options[c]){j.hide();i.show().children().remove();for(f=0;f<c.length;f++)i.append($("<option></option>").attr("value",c[f]).text(c[f]).attr("selected",e.fieldValue==c[f]));i.val(a)}else j.val(a||"").show().blur(),i.hide()};setTimeout(function(){if(d.domElement){d.domElement.on("change",".val",k);var c=d.domElement.find(".val:visible");c.length&&k.call(c.get(0))}else j.show()},0);e.unbindEventHandlers=
function(){k&&d.domElement&&d.domElement.find(".val").unbind("change",k);e.unbindEventHandlers=function(){}};return $("<div></div>").append(j).append(i)}return $("<div></div>").append($('<input type="text" class="val">').val(e.fieldValue))}});a.factoryTypes.Region=$.extend({},a.factoryTypes.Select,{notSet:function(){return""},unbindEventHandlers:function(){},setCurrentCountry:function(){var c=this.current_country;this.current_country=this.parentEditorData.parent.subfieldEditors.country.getValue();
return c!==this.current_country?(delete this.fieldData.options,!0):!1},getRegionsControllerUrl:function(c){return a.getRegionsUrl()+c},newInlineFieldElement:function(c){if("view"==c&&!this.fieldValue)return null;this.unbindEventHandlers();var e=this.options||{};void 0!==e.country&&(this.current_country=e.country);if("view"==c)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue));var d=this;if(this.parentEditorData.parent&&
this.parentEditorData.parent.subfieldEditors.country){this.setCurrentCountry();var b;$(document).on("change","select.country",b=function(){if(d.setCurrentCountry()){var a="",e=d.domElement.find(".val"),a=e.is("input")?e.val().trim():e.find(":selected").text().trim(),b=function(c,a){var e=a.toLocaleLowerCase();c.find("option").each(function(){if($(this).text().trim().toLocaleLowerCase()===e){$(this).attr("selected",true);return false}})};d.domElement.empty().append(d.newInlineFieldElement(c).children());
e=d.domElement.find(".val");e.is("input")&&!e.val()?e.val(a):e.is("select")&&a?b(e,a):d.domElement.unbind("load.fieldTypes").bind("load.fieldTypes",function(){var c=d.domElement.find(".val");c.is("select")&&a&&b(c,a)})}});d.unbindEventHandlers=function(){$(document).off("change","select.country",b);d.unbindEventHandlers=function(){}}}if(!e.no_ajax_select&&void 0===this.fieldData.options&&this.current_country&&this.fieldData.region_countries[this.current_country]){var f=this.current_country;$.get(this.getRegionsControllerUrl(f),
function(a){if(!(c!==d.currentMode||f!==d.current_country)){d.fieldData.options=a.data.options||false;d.fieldData.oOrder=a.data.oOrder||[];$.isPlainObject(d.options)&&d.options.country!==void 0&&delete d.options.country;$("<div></div>").append(d.newInlineFieldElement(c).children());d.domElement.empty().append(d.newInlineFieldElement(c).children());d.domElement.trigger("load")}},"json");return $("<div></div>").append($('<i class="icon16 loading"></i>'))}if(this.fieldData.options)return $("<div></div>").append(a.factoryTypes.Select.newInlineFieldElement.call(this,
c));e=$("<div></div>").append(a.baseFieldType.newInlineFieldElement.call(this,c));e.find(".val").val("");e.find(".val").attr("placeholder",this.fieldData.name+(this.fieldData.required?" ("+$_("required")+")":""));return e}});a.factoryTypes.Country=$.extend({},a.factoryTypes.Select);a.factoryTypes.Checklist=$.extend({},a.baseFieldType,{validate:function(){return null},setValue:function(c){this.fieldValue=c;if("edit"==this.currentMode&&this.domElement){this.domElement.find('input[type="checkbox"]').attr("checked",
!1);for(var a in this.fieldValue)this.domElement.find('input[type="checkbox"][value="'+a+'"]').attr("checked",!0)}else"view"==this.currentMode&&this.domElement&&this.domElement.find(".val").html(this.getValueView())},getValue:function(){if("edit"!=this.currentMode||!this.domElement)return this.fieldValue;var c=[];this.domElement.find('input[type="checkbox"]:checked').each(function(a,d){c.push($(d).val())});return c},getValueView:function(){for(var c="",e=0;e<this.fieldData.oOrder.length;e++){var d=
this.fieldData.oOrder[e];0>this.fieldValue.indexOf(d)||(c+=(c?", ":"")+'<a href="'+(this.fieldData.hrefPrefix||"#")+d+'">'+(this.fieldData.options[d]&&a.htmlentities(this.fieldData.options[d])||$_("&lt;no name&gt;"))+"</a>")}return c||$_("&lt;none&gt;")},newInlineFieldElement:function(c){if("view"==c&&(!this.fieldValue||!this.fieldValue.length))return null;if("view"==c)return $('<span class="val"></span>').html(this.getValueView());var c=0,e;for(e in this.fieldData.options)if(c++,1<c)break;if(!c)return null;
for(var c="",d=0;d<this.fieldData.oOrder.length;d++){e=this.fieldData.oOrder[d];c+='<li><label><input type="checkbox" value="'+e+'"';this.fieldData.disabled&&this.fieldData.disabled[e]&&(c+=' disabled="disabled"');if(-1!==(this.fieldValue||[]).indexOf(e))c+=' checked="checked"';c+=" />"+(this.fieldData.options[e]&&a.htmlentities(this.fieldData.options[e])||$_("&lt;no name&gt;"))+"</label></li>"}return a.initCheckboxList('<div class="c-checkbox-menu-container val"><div><ul class="menu-v compact with-icons c-checkbox-menu">'+
c+"</ul></div></div>")}});a.factoryTypes.Name=$.extend({},a.baseFieldType,{newInlineFieldElement:null,newFieldElement:function(){return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>')},setValue:function(c){this.fieldValue=c},getValue:function(c){if(this.fieldValue&&!c)return this.fieldValue;c=[];"person"==this.contactType?(a.fieldEditors.firstname&&c.push(a.fieldEditors.firstname.getValue()),a.fieldEditors.middlename&&c.push(a.fieldEditors.middlename.getValue()),
a.fieldEditors.lastname&&c.push(a.fieldEditors.lastname.getValue())):a.fieldEditors.company&&c.push(a.fieldEditors.company.getValue());return c.join(" ").trim()},validate:function(c){var e=this.getValue(!0);if(!c&&this.fieldData.required&&!e){c=$("#contact-info-block input:visible:text[value]:not(.empty)").val();if(!c)return $_("At least one of these fields must be filled");a.fieldEditors.firstname.setValue(c)}return null},showValidationErrors:function(c){var e=$("#contact-info-block");e.find("div.wa-errors-block").remove();
if(null!==c){var d=$('<div class="field wa-errors-block"><div class="value"><em class="errormsg">'+c+"</em></div></div>");a.fieldEditors.lastname?a.fieldEditors.lastname.domElement.after(d):e.prepend(d)}e=["firstname","middlename","lastname"];for(d=0;d<e.length;d++){var b=e[d];a.fieldEditors[b]&&(null!==c?a.fieldEditors[b].domElement.find(".val").addClass("external-error"):a.fieldEditors[b].domElement.find(".val").removeClass("external-error"))}},setMode:function(c,e){"undefined"==typeof e&&(e=!0);
if("view"!=c&&"edit"!=c)throw Error("Unknown mode: "+c);if(this.currentMode!=c&&(this.currentMode=c,e)){var d=this.domElement;this.domElement=this.newFieldElement(c);null!==d&&d.replaceWith(this.domElement)}var b="";a.fieldEditors.title&&(b=a.fieldEditors.title.getValue()+" ");if("view"===c&&!a.not_update_name){var d=$("#contact-fullname"),f="",h="",j="";if(a.fieldEditors.firstname){var i=a.fieldEditors.firstname.currentMode;a.fieldEditors.firstname.currentMode=c;f=a.fieldEditors.firstname.getValue();
a.fieldEditors.firstname.currentMode=i}a.fieldEditors.middlename&&(i=a.fieldEditors.middlename.currentMode,a.fieldEditors.middlename.currentMode=c,h=a.fieldEditors.middlename.getValue(),a.fieldEditors.middlename.currentMode=i);a.fieldEditors.lastname&&(i=a.fieldEditors.lastname.currentMode,a.fieldEditors.lastname.currentMode=c,j=a.fieldEditors.lastname.getValue(),a.fieldEditors.lastname.currentMode=i);(i=[f,h,j].join(" ").trim())||(i=this.fieldValue||"<"+$_("no name")+">");b=d.find("h1.name").html('<span class="title">'+
$.wa.encodeHTML(b)+"</span>"+$.wa.encodeHTML(i));"person"===this.contactType&&(j=h=f="",a.fieldEditors.jobtitle&&(i=a.fieldEditors.jobtitle.currentMode,a.fieldEditors.jobtitle.currentMode=c,h=a.fieldEditors.jobtitle.getValue(),a.fieldEditors.jobtitle.currentMode=i),a.fieldEditors.company&&(i=a.fieldEditors.company.currentMode,a.fieldEditors.company.currentMode=c,j=a.fieldEditors.company.getValue(),a.fieldEditors.company.currentMode=i),h&&(f+='<span class="title">'+$.wa.encodeHTML(h)+"</span> "),h&&
j&&(f+='<span class="at">'+$_("@")+"</span> "),j&&(f+='<span class="company">'+$.wa.encodeHTML(j)+"</span> "),d.find("h1.jobtitle-company").html(f));a.update_title&&$.wa.controller.setTitle(b.text())}a.contact_id&&a.contact_id==a.current_user_id&&$("#wa-my-username").text(""+(this.fieldValue?this.fieldValue:"<"+$_("no name")+">"));return this.domElement}});a.factoryTypes.NameSubfield=$.extend({},a.baseFieldType,{});a.factoryTypes.Multifield=$.extend({},a.baseFieldType,{subfieldEditors:null,subfieldFactory:null,
emptySubValue:null,initializeFactory:function(c){this.fieldData=c;if("undefined"!=typeof this.fieldData.ext){this.fieldData.extKeys=[];this.fieldData.extValues=[];for(var a in this.fieldData.ext)this.fieldData.extKeys[this.fieldData.extKeys.length]=a,this.fieldData.extValues[this.fieldData.extValues.length]=this.fieldData.ext[a]}},initialize:function(){this.subfieldFactory=$.extend({},a.factoryTypes[this.fieldData.type]);this.subfieldFactory.parentEditor=this;this.subfieldFactory.initializeFactory($.extend({},
this.fieldData));this.fieldData=$.extend({},this.fieldData,{required:this.subfieldFactory.fieldData.required});this.subfieldEditors=[this.subfieldFactory.createEditor(this.contactType)];this.emptySubValue="object"==typeof this.subfieldEditors[0].fieldValue?$.extend({},this.subfieldEditors[0].fieldValue):{value:this.subfieldEditors[0].fieldValue};this.fieldData.ext&&(this.emptySubValue.ext=this.fieldData.extKeys[0]);this.fieldValue=[this.emptySubValue]},setValue:function(c){if(!c||"undefined"==typeof c[0])c=
[this.emptySubValue];this.fieldValue=c;var a=0;do{this.subfieldEditors.length<=a&&(this.subfieldEditors[a]=this.subfieldFactory.createEditor(this.contactType),"null"!=this.currentMode&&this.subfieldEditors[a].setMode(this.currentMode).insertAfter(this.subfieldEditors[a-1].parentEditorData.domElement));if("undefined"!=typeof c[a]){var d=!1,b;for(b in c[a])if("value"!=b&&"ext"!=b){d=!0;break}this.subfieldEditors[a].setValue(d?c[a]:c[a].value?c[a].value:"");if("undefined"!=typeof this.fieldData.ext&&
(d=c[a].ext,"null"!=this.currentMode&&this.subfieldEditors[a].parentEditorData.domElement)){var f=this.subfieldEditors[a].parentEditorData.domElement.find("input.ext");0<f.size()&&f[0].setExtValue(d)}}else throw Error("At least one record must exist in data at this time.");a++}while(a<c.length);if(c.length<this.subfieldEditors.length){for(a=c.length;a<this.subfieldEditors.length;a++)0!==a&&"null"!=this.currentMode&&this.subfieldEditors[a].parentEditorData.domElement.remove();c=0<c.length?c.length:
1;this.subfieldEditors.splice(c,this.subfieldEditors.length-c)}this.origFieldValue=null},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue);for(var c=[],a=0;a<this.subfieldEditors.length;a++){var d=this.subfieldEditors[a];c[a]={value:d.getValue()};if("undefined"!=typeof this.fieldData.ext){var b=this.fieldValue[a].ext,f=d.parentEditorData.domElement.find("input.ext")[0];"edit"==d.currentMode&&f&&(b=f.getExtValue());c[a].ext=b}}return c},isModified:function(){for(var c=
0;c<this.subfieldEditors.length;c++)if(this.subfieldEditors[c].isModified())return!0;return!1},validate:function(c){for(var a=[],d=!0,b=0;b<this.subfieldEditors.length;b++){var f=this.subfieldEditors[b],h=f.validate(!0);h&&(a[b]=h);if((f=f.getValue())||"string"!=typeof f)d=!1}!c&&(this.fieldData.required&&d)&&(a[0]="This field is required.");return 0>=a.length?null:a},showValidationErrors:function(c){for(var a=0;a<this.subfieldEditors.length;a++){var d=this.subfieldEditors[a];null!==c&&"undefined"!=
typeof c[a]?d.showValidationErrors(c[a]):d.showValidationErrors(null)}},deleteSubfieldButton:function(c){var a=this,d=$('<a class="delete-subfield hint" href="javascript:void(0)">'+$_("delete")+"</a>").click(function(){if(1>=a.subfieldEditors.length)return!1;var d=a.subfieldEditors.indexOf(c);"null"!=a.currentMode&&a.subfieldEditors[d].parentEditorData.domElement.remove();a.subfieldEditors.splice(d,1);1>=a.subfieldEditors.length&&a.domElement.find(".delete-subfield").hide();return!1});1>=this.subfieldEditors.length&&
d.hide();return d},newSubFieldElement:function(c,e){var e=e-0,d=this.subfieldEditors[e];d.parentEditorData||(d.parentEditorData={});d.parentEditorData.parent=this;d.parentEditorData.empty=!1;var b;if("function"!=typeof d.newInlineFieldElement){var f=a.wrapper('<span class="replace-me-with-value"></span>',0===e?this.fieldData.name+"":"","no-bot-margins"),h=f.find("span.replace-me-with-value");b=this.fieldValue[e].ext;"edit"==c?b=a.createExtSelect(this.fieldData.ext,b):(b=this.fieldData.ext[this.fieldValue[e].ext]||
b,b=$("<strong>"+a.htmlentities(b)+"</strong>"));h.before(b);"edit"==c&&h.before(this.deleteSubfieldButton(d));h.remove();d.domElement=this.subfieldEditors[e].newFieldElement(c);var j=this;d.domElement.find("div.name").each(function(c,a){if(a.innerHTML.substr(0,j.fieldData.name.length)===j.fieldData.name)a.innerHTML=""});d.parentEditorData.domElement=$("<div></div>").append(f).append(d.domElement);d.parentEditorData.empty="edit"==c?!1:!d.fieldValue.value&&!d.fieldData.show_empty;return d.parentEditorData.domElement}b=
d.newInlineFieldElement(c);if(null===b)return d.parentEditorData.domElement=d.domElement=$("<div></div>"),d.parentEditorData.empty=!0,d.parentEditorData.domElement;d.domElement=b;d.domElement.data("subfield-index",e).attr("data-subfield-index",e);f=$('<div class="value"></div>').append(b);h=f.find(".replace-with-ext");0>=h.size()&&(f.append('<span><span class="replace-with-ext"></span></span>'),h=f.find(".replace-with-ext"));"undefined"!=typeof this.fieldData.ext&&(b=this.fieldValue[e].ext,"edit"==
c?h.before(a.createExtSelect(this.fieldData.ext,b)):(b=this.fieldData.ext[this.fieldValue[e].ext]||b,0<h.parents(".ext").size()?h.before(a.htmlentities(b)):h.before($('<em class="hint"></em>').text(" "+b))));"edit"==c&&h.before(this.deleteSubfieldButton(d));h.remove();return d.parentEditorData.domElement=f},newInlineFieldElement:null,newFieldElement:function(c){this.fieldData.read_only&&(c="view");for(var e=$('<div class="multifield-subfields"></div>'),d="function"==typeof this.subfieldFactory.newInlineFieldElement,
b=!0,f=0;f<this.subfieldEditors.length;f++){var h=this.newSubFieldElement(c,f);e.append(h);b=b&&this.subfieldEditors[f].parentEditorData.empty}if(b&&!this.fieldData.show_empty)return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>');b=d?$("<div></div>").append(e):$('<div class="field" data-field-id="'+this.fieldData.id+'"></div>').append(e);if("edit"==c){var f=d?$('<div class="value multifield-subfields-add-another"><span class="replace-me-with-value"></span></div>'):
a.wrapper('<span class="replace-me-with-value"></span>'),j=this;f.find(".replace-me-with-value").replaceWith($('<a href="javascript:void(0)" class="small inline-link"><b><i>'+$_("Add another")+"</i></b></a>").click(function(){var a=j.subfieldFactory.createEditor(this.contactType),b=j.subfieldEditors.length;val={value:a.getValue(),temp:!0};"undefined"!=typeof j.fieldData.ext&&(val.ext="");j.fieldValue[b]=val;j.subfieldEditors[b]=a;"null"!=j.currentMode&&a.setMode(j.currentMode);e.append(j.newSubFieldElement(c,
b));j.domElement.find(".delete-subfield").css("display","inline")}));b.append(f)}d&&(b=a.wrapper(b,this.fieldData.name+"").attr("data-field-id",this.fieldData.id));return b},setMode:function(c,a){"undefined"==typeof a&&(a=!0);if("view"!=c&&"edit"!=c)throw Error("Unknown mode: "+c);if(this.currentMode!=c){if("view"==c&&"edit"==this.currentMode&&this.origFieldValue)this.setValue(this.origFieldValue);else if("view"==this.currentMode&&!this.origFieldValue){this.origFieldValue=[];for(var b=0;b<this.fieldValue.length;b++)this.origFieldValue.push($.extend({},
this.fieldValue[b]))}this.currentMode=c;a&&(b=this.domElement,this.domElement=this.newFieldElement(c),null!==b&&b.replaceWith(this.domElement))}for(b=0;b<this.subfieldEditors.length;b++)this.subfieldEditors[b].setMode(c,!1);return this.domElement}});a.factoryTypes.Composite=$.extend({},a.baseFieldType,{subfieldEditors:null,initializeFactory:function(c,a){this.fieldData=c;if(this.fieldData.required){for(var b in this.fieldData.required)if(this.fieldData.required[b]){this.fieldData.required=!0;break}!0!==
this.fieldData.required&&(this.fieldData.required=!1)}this.options=a||{}},initialize:function(){var c={data:{},value:""};this.subfieldEditors={};this.fieldData.subfields=this.fieldData.fields;for(var b in this.fieldData.subfields){var d=$.extend({},a.factoryTypes[this.fieldData.subfields[b].type]),g=this.fieldData.fields[b];this.fieldData.required&&this.fieldData.required[b]&&(g.required=!0);g=$.extend({},g,{id:null,multi:!1});d.initializeFactory(g,this.options);d.parentEditor=this;d.parentEditorData=
{};d.initialize();d.parentEditorData.sfid=b;d.parentEditorData.parent=this;this.subfieldEditors[b]=d;c.data[b]=d.getValue()}this.fieldValue=c},setValue:function(c){if(c){this.fieldValue=c;for(var a in this.subfieldEditors){var b=this.subfieldEditors[a];"undefined"==typeof c.data?(b.initialize(),b.setValue(b.getValue())):"undefined"!=typeof c.data[a]?b.setValue(c.data[a]):b.setValue(b.getValue())}}},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue.data);var c={},a;
for(a in this.subfieldEditors)c[a]=this.subfieldEditors[a].getValue();return c},isModified:function(){for(var c in this.subfieldEditors)if(this.subfieldEditors[c].isModified())return!0;return!1},validate:function(c){var a={},b=!1,g;for(g in this.subfieldEditors){var f=this.subfieldEditors[g].validate(c);f&&(a[g]=f,b=!0)}return!b?null:a},showValidationErrors:function(c){if(null!==this.domElement)for(var a in this.subfieldEditors){var b=this.subfieldEditors[a];null!==c&&"undefined"!=typeof c[a]?b.showValidationErrors(c[a]):
b.showValidationErrors(null)}},newInlineFieldElement:null,newFieldElement:function(c){this.fieldData.read_only&&(c="view");if("view"==c&&!this.fieldValue.value&&!this.fieldData.show_empty)return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>');var b=$('<div class="composite '+c+' field" data-field-id="'+this.fieldData.id+'"></div>').append(a.wrapper('<span style="display:none" class="replace-with-ext"></span>',this.fieldData.name,"hdr")),d;for(d in this.subfieldEditors){var g=
this.subfieldEditors[d],f=g.newFieldElement(c);f.attr("data-field-id",d);f.data("fieldId",d);g.domElement=f;b.append(f)}return b},setMode:function(c,a){"undefined"==typeof a&&(a=!0);if("view"!=c&&"edit"!=c)throw Error("Unknown mode: "+c);if(this.currentMode!=c&&(this.currentMode=c,a)){var b=this.domElement;this.domElement=this.newFieldElement(c);null!==b&&b.replaceWith(this.domElement)}for(var g in this.subfieldEditors)this.subfieldEditors[g].setMode(c,!1);return this.domElement}});a.factoryTypes.Address=
$.extend({},a.factoryTypes.Composite,{showValidationErrors:function(c){if(null!==this.domElement&&(this.domElement.find("em.errormsg").remove(),this.domElement.find(".val").removeClass("error"),c))for(var a in this.subfieldEditors){var b=this.subfieldEditors[a];"undefined"!=typeof c[a]&&b.domElement.find(".val").addClass("error").parents(".address-subfield").append($('<em class="errormsg">'+c[a]+"</em>"))}},newInlineFieldElement:function(c){var a="";if("view"==c){if(!this.fieldValue.value)return null;
var b="",b="string"===typeof this.fieldValue.for_map?this.fieldValue.for_map:this.fieldValue.for_map.coords?this.fieldValue.for_map.coords:this.fieldValue.for_map.with_street;return a=$('<div class="address-field"></div>').append(this.fieldValue.value).append('<span style="display:none" class="replace-with-ext"></span> ').append('<a target="_blank" href="//maps.google.com/maps?q='+encodeURIComponent(b)+'&z=15" class="small map-link">'+$_("map")+"</a>")}c=$('<div class="address-field"></div>');c.append('<span style="display:none" class="replace-with-ext"></span>');
for(b in this.subfieldEditors){var a=this.subfieldEditors[b],g=a.newInlineFieldElement("edit");a.domElement=g;c.append($('<div class="address-subfield"></div>').append(g));"Hidden"!==a.fieldData.type&&g.find("input.val").attr("placeholder",a.fieldData.name+(a.fieldData.required?" ("+$_("required")+")":""))}return c}});a.factoryTypes.Birthday=a.factoryTypes.Date=$.extend({},a.baseFieldType,{newInlineFieldElement:function(c){if("view"==c&&!this.fieldValue.value)return null;var a=null,a=this.fieldValue.data||
{};if("edit"==c){for(var c=$('<select class="val" data-part="day"><option data=""></option></select>'),b=1;31>=b;b+=1){var g=$('<option data="'+b+'" value="'+b+'">'+b+"</option>");b==a.day&&g.attr("selected",!0);c.append(g)}for(var b=$('<select class="val" data-part="month"><option data=""></option></select>'),f="January February March April May June July August September October November December".split(" "),h=0;12>h;h+=1)g=$_(f[h]),g=$('<option data="'+(h+1)+'"  value="'+(h+1)+'">'+g+"</option>"),
h+1==a.month&&g.attr("selected",!0),b.append(g);g=$('<input type="text" data-part="year" class="val" style="min-width: 32px; width: 32px;" placeholder="'+$_("year")+'">');a.year&&g.val(a.year);a=$("<span></span>").append(c).append(" ").append(b).append(" ").append(g)}else a=$('<span class="val"></span>').text(this.fieldValue.value);return a},getValue:function(){var a=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var b=this.domElement.find(".val");0<b.length&&(a={value:{day:null,
month:null,year:null}},b.each(function(){var b=$(this),e=b.data("part");a.value[e]=parseInt(b.val(),10)||null}))}return a},setValue:function(a){this.fieldValue=a;"null"==this.currentMode||null===this.domElement||("edit"==this.currentMode?this.domElement.find(".val").each(function(){var b=$(this),d=b.data("part");b.val(a.data[d]||"")}):this.domElement.find(".val").html(this.fieldValue))}});a.factoryTypes.IM=$.extend({},a.baseFieldType,{setValue:function(a){"undefined"==typeof a&&(a="");"object"==typeof a?
(this.fieldValue=a.data,this.viewValue=a.value):this.fieldValue=this.viewValue=a;"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;var b=null;"edit"==a?(b=$('<span><input class="val" type="text"></span>'),b.find(".val").val(this.fieldValue)):b=$('<span class="val"></span>').html(this.viewValue);return b}});
a.factoryTypes.SocialNetwork=$.extend({},a.baseFieldType,{setValue:function(a){"undefined"==typeof a&&(a="");"object"==typeof a?(this.fieldValue=a.data,this.viewValue=a.value):this.fieldValue=this.viewValue=a;"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(a){if("view"==a&&!this.fieldValue)return null;var b=null;"edit"==a?(b=$('<span><input class="val" type="text"></span>'),
b.find(".val").val(this.fieldValue)):b=$('<span class="val"></span>').html(this.viewValue);return b}});a.factoryTypes.Url=$.extend({},a.factoryTypes.IM,{validate:function(a){var b=$.trim(this.getValue());if(!a&&this.fieldData.required&&!b)return $_("This field is required.");if(!b)return null;/^(https?|ftp|gopher|telnet|file|notes|ms-help)/.test(b)||(b="http://"+b,this.setValue(b));a=RegExp("^(https?|ftp|gopher|telnet|file|notes|ms-help):((//)|(\\\\\\\\))+[^`!\\[\\]{}'\"<>\u00ab\u00bb\u201c\u201d\u2018\u2019\\s]*$",
"i");return!a.test(b)||/^(http|ftp)/.test(b.toLowerCase())&&(a=RegExp("^(https?|ftp):((//)|(\\\\\\\\))+((?:[^`!()\\[\\]{};:'\".,<>?\u00ab\u00bb\u201c\u201d\u2018\u2019\\s+]+\\.)+[^`!()\\[\\]{};:'\".,<>?\u00ab\u00bb\u201c\u201d\u2018\u2019\\s+]{2,6})((/|\\\\|#)[^`!\\[\\]{}'\"<>\u00ab\u00bb\u201c\u201d\u2018\u2019\\s]*)?$","i"),!a.test(b))?$_("Incorrect URL format."):null}});a.factoryTypes.Email=$.extend({},a.factoryTypes.Url,{validate:function(a){var b=$.trim(this.getValue());return!a&&this.fieldData.required&&
!b?$_("This field is required."):!b?null:!/^([^@\s]+)@[^\s@]+\.[^\s@\.]{2,}$/i.test(b)?$_("Incorrect Email address format."):null}});a.factoryTypes.Checkbox=$.extend({},a.baseFieldType,{setValue:function(a){this.fieldValue=parseInt(a);"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").attr("checked",!!this.fieldValue):this.domElement.find(".val").text(this.fieldValue?"Yes":"No"))},newInlineFieldElement:function(a){var b=null;"edit"==a?(b=$('<span><input class="val" type="checkbox" value="1" checked="checked"></span>'),
this.fieldValue||b.find(".val").removeAttr("checked")):b=$('<span class="val"></span>').text(this.fieldValue?"Yes":"No");return b}});a.factoryTypes.Number=$.extend({},a.baseFieldType,{validate:function(a){var b=$.trim(this.getValue());return!a&&this.fieldData.required&&!b&&0!==b?$_("This field is required."):b&&!/^-?[0-9]+([\.,][0-9]+$)?/.test(b)?$_("Must be a number."):null}});return b?a.factoryTypes[b]:a.factoryTypes};
$.wa.fieldTypeFactory=function(a){return $.extend({},$.wa.fieldTypesFactory(null,a))};$.wa.contactEditorFactory=function(a){var a=$.extend({contact_id:null,current_user_id:null,contactType:"person",baseFieldType:null,saveUrl:"?module=contacts&action=save",saveGeocoordsUrl:"?module=contacts&action=saveGeocoords",regionsUrl:"?module=backend&action=regions&country=",el:"#contact-info-block",with_inplace_buttons:!0,update_title:!0},a),b=$.extend({wa_app_url:"",fields:{},fieldsOrder:[],fieldsValues:{},factoryTypes:{},editorFactories:{},fieldEditors:{},initFactories:function(a,b){this.fields=
a;this.fieldsOrder=b;this.editorFactories={};this.fieldEditors={};for(var d=0;d<b.length;d+=1){var g=b[d];if("object"!=typeof a[g]||!a[g].type)throw Error("Field data error for "+g);if("undefined"==typeof this.factoryTypes[a[g].type])throw Error("Unknown factory type: "+a[g].type);this.editorFactories[g]=a[g].multi?$.extend({},this.factoryTypes.Multifield):$.extend({},this.factoryTypes[a[g].type]);this.editorFactories[g].initializeFactory(a[g])}},initAllEditors:function(){for(var a=0;a<this.fieldsOrder.length;a+=
1){var b=this.fieldsOrder[a];"undefined"==typeof this.fieldEditors[b]?this.fieldEditors[b]=this.editorFactories[b].createEditor(this.contactType,b):this.fieldEditors[b].reinit()}},initFieldEditors:function(a){if(!(a instanceof Array)){this.fieldsValues=a;for(var b=0;b<this.fieldsOrder.length;b+=1){var d=this.fieldsOrder[b];if("undefined"==typeof this.editorFactories[d]){$.wa.controller.contactAction([this.contact_id]);break}"undefined"==typeof this.fieldEditors[d]&&(this.fieldEditors[d]=this.editorFactories[d].createEditor(this.contactType));
this.fieldEditors[d].setValue(a[d])}}},initContactInfoBlock:function(a){this.switchMode(a,!0)},_getUrl:function(a){return"string"===typeof this[a]?this[a].slice(0,this.wa_app_url.length)!==this.wa_app_url?this.wa_app_url+this[a]:this[a]:""},getSaveUrl:function(){return this._getUrl("saveUrl")},getSaveGeocoordsUrl:function(){return this._getUrl("saveGeocoordsUrl")},getPasswdSaveUrl:function(){return this._getUrl("passwdSaveUrl")},getRegionsUrl:function(){return this._getUrl("regionsUrl")},switchMode:function(a,
b){var d=$(this.el),g=this;b&&(d.html(""),d.removeClass("edit-mode"),d.removeClass("view-mode"),$(d).add("#contact-info-top").off("click.map",".map-link").on("click.map",".map-link",function(){var a=$(this).parent().data("subfield-index");void 0!==a&&g.geocodeAddress(g.fieldEditors.address.fieldValue,a)}));if(!("edit"==a&&d.hasClass("edit-mode"))&&!("view"==a&&d.hasClass("view-mode"))){$("#tc-contact").trigger("before_switch_mode");d.find("div.field.buttons").remove();for(var f=[],h=0;h<this.fieldsOrder.length;h+=
1){var j=this.fieldsOrder[h];f.push(j);var i=this.fieldEditors[j].setMode(a);$(this).trigger("set_mode",[{mode:a,el:d,field_id:j,field:this.fieldEditors[j]}]);b&&d.append(i)}var k=this;"edit"==a?(d.find(".subname").wrapAll('<div class="subname-wrapper"></div>'),d.find(".jobtitle-company").wrapAll('<div class="jobtitle-company-wrapper"></div>'),this.with_inplace_buttons&&(f=this.inplaceEditorButtons(f,function(a){if(typeof a!="undefined"&&!a)return false;if(typeof k.justCreated!="undefined"&&k.justCreated){a=
$("#sb-all-contacts-li .count");a.text(1+parseInt(a.text()));$.wa.setHash("/contact/"+k.contact_id);return false}k.switchMode("view");$.scrollTo(0);return false},function(){if(k.contact_id==null)$.wa.back();else{k.switchMode("view");$.scrollTo(0)}}),null===k.contact_id&&f.find(".cancel, .or").remove(),d.append(f),d.removeClass("view-mode"),d.addClass("edit-mode"),$("#edit-contact-double").hide(),d.find(".buttons").sticky({fixed_css:{bottom:0,background:"#fff",width:"100%",margin:"0"},fixed_class:"sticky-bottom",
isStaticVisible:function(a){var c=$(window),a=a.element.offset().top;return c.scrollTop()+c.height()>a}}),d.find(".sticky-bottom .cancel").click(function(){d.find(".buttons:not(.sticky-bottom) .cancel").click();return false}),d.find(".sticky-bottom :submit").click(function(){d.find(".buttons:not(.sticky-bottom) :submit").click();return false}))):(d.removeClass("edit-mode"),d.addClass("view-mode"),$("#edit-contact-double").show(),d.find(".subname-wrapper").length&&d.find(".subname").unwrap(),d.find(".jobtitle-company-wrapper").length&&
d.find(".jobtitle-company").unwrap());$("#tc-contact").trigger("after_switch_mode",[a,this])}},saveFields:function(a,b){if(!a){var a=[],d;for(d in this.fields)this.fields.hasOwnProperty(d)&&a.push(d)}var g={};d=!1;for(var f=0;f<a.length;f++){var h=a[f],j=this.fieldEditors[h].validate();if(j){if(!d)for(d=this.fieldEditors[h].domElement;!d.is(":visible");)d=d.parent();this.fieldEditors[h].showValidationErrors(j)}else this.fieldEditors[h].showValidationErrors(null);g[h]=this.fieldEditors[h].getValue()}if(d)$.scrollTo(d),
$.scrollTo("-=100px"),b(!1);else{var i=this,k=function(a){a=void 0===a?!0:a;$.post(i.getSaveUrl(),{data:$.JSON.encode(g),type:i.contactType,id:null!=i.contact_id?i.contact_id:0},function(c){if("ok"!=c.status)throw new Exception("AJAX error: "+$.JSON.encode(c));c=c.data;c.history&&$.wa.history.updateHistory(c.history);if(c.data&&c.data.top){for(var d="",f=0;f<c.data.top.length;f++)var h=c.data.top[f],d=d+("<li>"+("im"!=h.id?h.icon?'<i class="icon16 '+h.id+'"></i>':"":"")+h.value+"</li>");$("#contact-info-top").html(d);
delete c.data.top}d=i.fieldsValues||{};null!=i.contact_id&&i.initFieldEditors(c.data);f=!1;for(h in i.fieldEditors)if("undefined"!=typeof c.errors[h]){if(i.fieldEditors[h].showValidationErrors(c.errors[h]),!f)for(f=i.fieldEditors[h].domElement;!f.is(":visible");)f=f.parent()}else"edit"==i.fieldEditors[h].currentMode&&i.fieldEditors[h].showValidationErrors(null);if(f)$.scrollTo(f),$.scrollTo("-=100px");else if(i.contact_id&&c.data.reload){window.location.reload();return}if(f)b(!f);else if(null===i.contact_id&&
(i.justCreated=!0),i.contact_id=c.data.id,a)if(h=$.storage.get("contacts/last_geocoding")||0,3600<(new Date).getTime()-h)if($.storage.del("contacts/last_geocoding"),c=c.data.address,$.isEmptyObject(c))b(!f);else{for(var j=[],p=[],h=0;h<c.length;h+=1){var l=!0;if(g.address[h]){a:{for(var l=c[h].data,q=(d.address[h]||{}).data||{},o=["city","country","region","street","zip"],m=0;m<o.length;m+=1)if(l[o[m]]&&q[o[m]]&&l[o[m]]!=q[o[m]]){l=!1;break a}l=!0}l=!l}l&&(j.push(i.sendGeocodeRequest(c[h].for_map)),
p.push(h))}if(j.length){var r=function(a,c){if(a.status==="OK"){var b=a.results[0].geometry.location.lng||"";g.address[c].value.lat=a.results[0].geometry.location.lat||"";g.address[c].value.lng=b}else a.status==="OVER_QUERY_LIMIT"&&$.storage.set("contacts/last_geocoding",(new Date).getTime()/1E3)};$.when.apply($,j).then(function(){if(j.length<=1&&arguments[1]==="success")r(arguments[0],p[0]);else for(var a=0;a<arguments.length;a=a+1)arguments[a][1]==="success"&&r(arguments[a][0],p[a]);k.call(i,false)})}else b(!f)}else b(!f);
else b(!f)},"json")};k()}},createExtSelect:function(a,b){var d="",g=!0,f;for(f in a){var h="";if(a[f]===b||f===b)h=' selected="selected"',g=!1;var j=this.htmlentities(a[f]),d=d+('<option value="'+("undefined"===typeof a.length?f:j)+'"'+h+">"+j+"</option>")}var i;g?(d+='<option value="%custom" selected="selected">'+$_("other")+"...</option>",i='<input type="text" class="small ext">'):(d+='<option value="%custom">'+$_("other")+"...</option>",i='<input type="text" class="small empty ext">');var d=$('<span><select class="ext">'+
d+"</select><span>"+i+"</span></span>"),k=d.children("select");i=d.find("input");i.val(b);"%custom"!==k.val()&&i.hide();var b=$_("which?"),n=function(){if(!i.val()&&!i.hasClass("empty")){i.val(b);i.addClass("empty")}};i.blur(n);i.focus(function(){if(i.hasClass("empty")){i.val("");i.removeClass("empty")}});k.change(function(){var a=k.val();if(a==="%custom"){i.hasClass("empty")&&i.val(b);i.show()}else{i.hide();i.addClass("empty");i.val(a||"")}n()});i[0].getExtValue=function(){return k.val()==="%custom"&&
i.hasClass("empty")?"":i.val()};i[0].setExtValue=function(b){a[b]?k.val(b):k.val("%custom");i.val(b)};return d},inplaceEditorButtons:function(a,b,d){var g=$('<div class="field buttons"><div class="value submit"><em class="errormsg" id="validation-notice"></em></div></div>'),f=this,h=function(){$(".buttons .loading").show();f.saveFields(a,function(a){$(".buttons .loading").hide();b(a)});return!1},j=$('#contact-info-block.edit-mode input[type="text"]',$("#c-core")[0]);j.die("keyup");j.live("keyup",
function(a){13==a.keyCode&&(!$(a.currentTarget).data("autocomplete")||!$(a.currentTarget).data("contact_id"))&&h()});var j=$('<input type="submit" class="button green" value="'+$_("Save")+'" />').click(h),f=this,i=$('<a href="javascript:void(0)" class="cancel">'+$_("cancel")+"</a>").click(function(){$(".buttons .loading").hide();"function"!=typeof d?b():d();f.fieldEditors.name.showValidationErrors(null);$.scrollTo(0);return!1});g.children("div.value.submit").append(j).append('<span class="or"> '+
$_("or")+" </span>").append(i).append($('<i class="icon16 loading" style="margin-left: 16px; display: none;"></i>'));return g},destroy:function(){$(this.el).html("")},wrapper:function(a,b,d){d=$('<div class="field'+("undefined"!=typeof d&&d?" "+d:"")+'"></div>');"undefined"!=typeof b&&b&&d.append('<div class="name">'+$.wa.encodeHTML(b)+"</div>");if("object"!=typeof a||!(a instanceof jQuery)||0>=a.find("div.value").size())a=$('<div class="value"></div>').append(a);d.append(a);return d},setOptions:function(c){this.options=
$.extend(a,this.options||{},c)},htmlentities:function(a){var b=document.createElement("div"),a=document.createTextNode(a);b.appendChild(a);return b.innerHTML},addressToString:function(a){for(var b=[],d=["street","city","country","region","zip"],a=$.extend({},a||{}),g=0;g<d.length;g+=1)b.push(a[d[g]]||""),delete a[d[g]];for(var f in a)a.hasOwnProperty(f)&&("lat"!==f&&"lng"!=f)&&b.push(a[f]);return b.join(",")},geocodeAddress:function(a,b){var d=this;if(!a[b].data.lat||!a[b].data.lng)this.sendGeocodeRequest(a[b].for_map||
a[b].value,function(g){a[b].data.lat=g.lat;a[b].data.lng=g.lng;$.post(d.getSaveGeocoordsUrl(),{id:d.contact_id,lat:g.lat,lng:g.lng,sort:b})})},sendGeocodeRequest:function(a,b,d){var g=[];"string"===typeof a?g.push(a):a.with_street&&a.without_street&&a.with_street===a.without_street?g.push(a.with_street):(a.with_street&&g.push(a.with_street),a.without_street&&g.push(a.without_street));var d=!0,f=$.Deferred(),h=this;$.ajax({url:"//maps.googleapis.com/maps/api/geocode/json",data:{sensor:!1,address:g[0]},
dataType:"json",success:function(a){var c,k;if(a)if(a.status==="OK"){c=a.results.length;var n=false;for(k=0;k<c;k=k+1)if(!a.results[k].partial_match){c=a.results[k].geometry.location.lat||"";k=a.results[k].geometry.location.lng||"";b instanceof Function&&b({lat:c,lng:k});n=true;break}if(n)f.resolve([a,"success"]);else if(d){c=a.results[0].geometry.location.lat||"";k=a.results[0].geometry.location.lng||"";b instanceof Function&&b({lat:c,lng:k});f.resolve([a,"success"])}else g[1]?h.sendGeocodeRequest(g[1],
b,true).always(function(a){f.resolve(a)}):f.resolve([a,"success"])}else f.resolve([a,"success"]);else f.resolve([{},"error"])},error:function(a){f.resolve([a,"error"])}});return f},switchToTab:function(a,b,d,g){"string"==typeof a&&("t-"==a.substr(0,2)?a="#"+a:"#"!=a[0]&&(a="#t-"+a));a=$(a);if(!(0>=a.size()||a.hasClass("selected"))){if(!g){var f=a.attr("id");if(!f||"t-"!=f.substr(0,2))return;g=$("#tc-"+f.substr(2))}d&&(f=a.parent().children(".selected"),0<f.size()&&f.each(function(a,c){d.call(c)}));
var h=function(){a.parent().find("li.selected").removeClass("selected");a.removeClass("hidden").css("display","").addClass("selected");g.siblings(".tab-content").addClass("hidden");g.removeClass("hidden");b&&b.call(a[0]);$("#c-info-tabs").trigger("after_switch_tab",[a])};$("#c-info-tabs").trigger("before_switch_tab",[a]);$.effects&&$.effects.slideDIB&&!a.is(":visible")?($.wa.controller.loadTabSlidingAnimation(),a.hide().removeClass("hidden").show("slideDIB",{direction:"down"},300,function(){h()})):
h()}},initCheckboxList:function(a){var a=$(a),b=function(a,c){var b=$(c||this);b.is(":checked")?b.parent().addClass("highlighted"):b.parent().removeClass("highlighted")};a.find('input[type="checkbox"]').click(b).each(b);return a},load:function(a,b,d,g,f){var h=Math.random(),j=this;j.random=h;$.get(b,d,function(i){j.random==h&&(g&&g.call(j),$(window).trigger("wa_before_load",[a,b,d,i]),$(a).html(i),$(window).trigger("wa_after_load",[a,b,d,i]),f&&f.call(j))})}},a);$.wa.fieldTypesFactory(b);return b};
$.wa.contactEditor=$.wa.contactEditorFactory();
