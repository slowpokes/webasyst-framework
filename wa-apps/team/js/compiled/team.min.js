!function(e){"object"==typeof exports&&exports&&"object"==typeof module&&module&&module.exports===exports?e(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){function t(e){var t=e[0];return t.offsetWidth>0&&t.offsetHeight>0}function i(t){if(t.minTime&&(t.minTime=y(t.minTime)),t.maxTime&&(t.maxTime=y(t.maxTime)),t.durationTime&&"function"!=typeof t.durationTime&&(t.durationTime=y(t.durationTime)),"now"==t.scrollDefault)t.scrollDefault=function(){return t.roundingFunction(y(new Date),t)};else if(t.scrollDefault&&"function"!=typeof t.scrollDefault){var i=t.scrollDefault;t.scrollDefault=function(){return t.roundingFunction(y(i),t)}}else t.minTime&&(t.scrollDefault=function(){return t.roundingFunction(t.minTime,t)});if("string"===e.type(t.timeFormat)&&t.timeFormat.match(/[gh]/)&&(t._twelveHourTime=!0),!1===t.showOnFocus&&-1!=t.showOn.indexOf("focus")&&t.showOn.splice(t.showOn.indexOf("focus"),1),t.disableTimeRanges.length>0){for(var a in t.disableTimeRanges)t.disableTimeRanges[a]=[y(t.disableTimeRanges[a][0]),y(t.disableTimeRanges[a][1])];t.disableTimeRanges=t.disableTimeRanges.sort(function(e,t){return e[0]-t[0]});for(var a=t.disableTimeRanges.length-1;a>0;a--)t.disableTimeRanges[a][0]<=t.disableTimeRanges[a-1][1]&&(t.disableTimeRanges[a-1]=[Math.min(t.disableTimeRanges[a][0],t.disableTimeRanges[a-1][0]),Math.max(t.disableTimeRanges[a][1],t.disableTimeRanges[a-1][1])],t.disableTimeRanges.splice(a,1))}return t}function a(t){var i=t.data("timepicker-settings"),a=t.data("timepicker-list");if(a&&a.length&&(a.remove(),t.data("timepicker-list",!1)),i.useSelect){a=e("<select />",{class:"ui-timepicker-select"});var o=a}else{a=e("<ul />",{class:"ui-timepicker-list"});var o=e("<div />",{class:"ui-timepicker-wrapper",tabindex:-1});o.css({display:"none",position:"absolute"}).append(a)}if(i.noneOption)if(!0===i.noneOption&&(i.noneOption=i.useSelect?"Time...":"None"),e.isArray(i.noneOption)){for(var l in i.noneOption)if(parseInt(l,10)==l){var c=n(i.noneOption[l],i.useSelect);a.append(c)}}else{var c=n(i.noneOption,i.useSelect);a.append(c)}i.className&&o.addClass(i.className),null===i.minTime&&null===i.durationTime||!i.showDuration||("function"==typeof i.step||i.step,o.addClass("ui-timepicker-with-duration"),o.addClass("ui-timepicker-step-"+i.step));var u=i.minTime;"function"==typeof i.durationTime?u=y(i.durationTime()):null!==i.durationTime&&(u=i.durationTime);var f=null!==i.minTime?i.minTime:0,h=null!==i.maxTime?i.maxTime:f+_-1;f>h&&(h+=_),h===_-1&&"string"===e.type(i.timeFormat)&&i.show2400&&(h=_);var m=i.disableTimeRanges,b=0,k=m.length,E=i.step;"function"!=typeof E&&(E=function(){return i.step});for(var l=f,D=0;h>=l;D++,l+=60*E(D)){var C=l,x=w(C,i);if(i.useSelect){var T=e("<option />",{value:x});T.text(x)}else{var T=e("<li />");T.addClass(43200>C%86400?"ui-timepicker-am":"ui-timepicker-pm"),T.data("time",86400>=C?C:C%86400),T.text(x)}if((null!==i.minTime||null!==i.durationTime)&&i.showDuration){var S=g(l-u,i.step);if(i.useSelect)T.text(T.text()+" ("+S+")");else{var V=e("<span />",{class:"ui-timepicker-duration"});V.text(" ("+S+")"),T.append(V)}}k>b&&(C>=m[b][1]&&(b+=1),m[b]&&C>=m[b][0]&&C<m[b][1]&&(i.useSelect?T.prop("disabled",!0):T.addClass("ui-timepicker-disabled"))),a.append(T)}if(o.data("timepicker-input",t),t.data("timepicker-list",o),i.useSelect)t.val()&&a.val(r(y(t.val()),i)),a.on("focus",function(){e(this).data("timepicker-input").trigger("showTimepicker")}),a.on("blur",function(){e(this).data("timepicker-input").trigger("hideTimepicker")}),a.on("change",function(){p(t,e(this).val(),"select")}),p(t,a.val(),"initial"),t.hide().after(a);else{var j=i.appendTo;"string"==typeof j?j=e(j):"function"==typeof j&&(j=j(t)),j.append(o),d(t,a),a.on("mousedown click","li",function(i){t.off("focus.timepicker"),t.on("focus.timepicker-ie-hack",function(){t.off("focus.timepicker-ie-hack"),t.on("focus.timepicker",$.show)}),s(t)||t[0].focus(),a.find("li").removeClass("ui-timepicker-selected"),e(this).addClass("ui-timepicker-selected"),v(t)&&(t.trigger("hideTimepicker"),a.on("mouseup.timepicker click.timepicker","li",function(e){a.off("mouseup.timepicker click.timepicker"),o.hide()}))})}}function n(t,i){var a,n,r;return"object"==typeof t?(a=t.label,n=t.className,r=t.value):"string"==typeof t?a=t:e.error("Invalid noneOption value"),i?e("<option />",{value:r,class:n,text:a}):e("<li />",{class:n,text:a}).data("time",String(r))}function r(e,t){return e=t.roundingFunction(e,t),null!==e?w(e,t):void 0}function o(t){if(t.target!=window){var i=e(t.target);i.closest(".ui-timepicker-input").length||i.closest(".ui-timepicker-wrapper").length||($.hide(),e(document).unbind(".ui-timepicker"),e(window).unbind(".ui-timepicker"))}}function s(e){var t=e.data("timepicker-settings");return(window.navigator.msMaxTouchPoints||"ontouchstart"in document)&&t.disableTouchKeyboard}function l(t,i,a){if(!a&&0!==a)return!1;var n=t.data("timepicker-settings"),r=!1,a=n.roundingFunction(a,n);return i.find("li").each(function(t,i){var n=e(i);if("number"==typeof n.data("time"))return n.data("time")==a?(r=n,!1):void 0}),r}function d(e,t){t.find("li").removeClass("ui-timepicker-selected");var i=y(u(e),e.data("timepicker-settings"));if(null!==i){var a=l(e,t,i);if(a){var n=a.offset().top-t.offset().top;(n+a.outerHeight()>t.outerHeight()||0>n)&&t.scrollTop(t.scrollTop()+a.position().top-a.outerHeight()),a.addClass("ui-timepicker-selected")}}}function c(t,i){if(""!==this.value&&"timepicker"!=i){var a=e(this);if(!a.is(":focus")||t&&"change"==t.type){var n=a.data("timepicker-settings"),r=y(this.value,n);if(null===r)return void a.trigger("timeFormatError");var o=!1;if(null!==n.minTime&&null!==n.maxTime&&(r<n.minTime||r>n.maxTime)&&(o=!0),e.each(n.disableTimeRanges,function(){return r>=this[0]&&r<this[1]?(o=!0,!1):void 0}),n.forceRoundTime){var s=n.roundingFunction(r,n);s!=r&&(r=s,i=null)}var l=w(r,n);o?p(a,l,"error")&&a.trigger("timeRangeError"):p(a,l,i)}}}function u(e){return e.is("input")?e.val():e.data("ui-timepicker-value")}function p(e,t,i){if(e.is("input")){e.val(t);var a=e.data("timepicker-settings");a.useSelect&&"select"!=i&&"initial"!=i&&e.data("timepicker-list").val(r(y(t),a))}return e.data("ui-timepicker-value")!=t?(e.data("ui-timepicker-value",t),"select"==i?e.trigger("selectTime").trigger("changeTime").trigger("change","timepicker"):-1==["error","initial"].indexOf(i)&&e.trigger("changeTime"),!0):(e.trigger("selectTime"),!1)}function f(e){switch(e.keyCode){case 13:case 9:return;default:e.preventDefault()}}function h(i){var a=e(this),n=a.data("timepicker-list");if(!n||!t(n)){if(40!=i.keyCode)return!0;$.show.call(a.get(0)),n=a.data("timepicker-list"),s(a)||a.focus()}switch(i.keyCode){case 13:return v(a)&&(c.call(a.get(0),{type:"change"}),$.hide.apply(this)),i.preventDefault(),!1;case 38:var r=n.find(".ui-timepicker-selected");return r.length?r.is(":first-child")||(r.removeClass("ui-timepicker-selected"),r.prev().addClass("ui-timepicker-selected"),r.prev().position().top<r.outerHeight()&&n.scrollTop(n.scrollTop()-r.outerHeight())):(n.find("li").each(function(t,i){return e(i).position().top>0?(r=e(i),!1):void 0}),r.addClass("ui-timepicker-selected")),!1;case 40:return r=n.find(".ui-timepicker-selected"),0===r.length?(n.find("li").each(function(t,i){return e(i).position().top>0?(r=e(i),!1):void 0}),r.addClass("ui-timepicker-selected")):r.is(":last-child")||(r.removeClass("ui-timepicker-selected"),r.next().addClass("ui-timepicker-selected"),r.next().position().top+2*r.outerHeight()>n.outerHeight()&&n.scrollTop(n.scrollTop()+r.outerHeight())),!1;case 27:n.find("li").removeClass("ui-timepicker-selected"),$.hide();break;case 9:$.hide();break;default:return!0}}function m(i){var a=e(this),n=a.data("timepicker-list"),r=a.data("timepicker-settings");if(!n||!t(n)||r.disableTextInput)return!0;switch(i.keyCode){case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 65:case 77:case 80:case 186:case 8:case 46:r.typeaheadHighlight?d(a,n):n.hide()}}function v(e){var t=e.data("timepicker-settings"),i=e.data("timepicker-list"),a=null,n=i.find(".ui-timepicker-selected");return!n.hasClass("ui-timepicker-disabled")&&(n.length&&(a=n.data("time")),null!==a&&("string"!=typeof a&&(a=w(a,t)),p(e,a,"select")),!0)}function g(e,t){e=Math.abs(e);var i,a,n=Math.round(e/60),r=[];return 60>n?r=[n,b.mins]:(i=Math.floor(n/60),a=n%60,30==t&&30==a&&(i+=b.decimal+5),r.push(i),r.push(1==i?b.hr:b.hrs),30!=t&&a&&(r.push(a),r.push(b.mins))),r.join(" ")}function w(t,i){if("number"!=typeof t)return null;var a=parseInt(t%60),n=parseInt(t/60%60),r=parseInt(t/3600%24),o=new Date(1970,0,2,r,n,a,0);if(isNaN(o.getTime()))return null;if("function"===e.type(i.timeFormat))return i.timeFormat(o);for(var s,l,d="",c=0;c<i.timeFormat.length;c++)switch(l=i.timeFormat.charAt(c)){case"a":d+=o.getHours()>11?b.pm:b.am;break;case"A":d+=o.getHours()>11?b.PM:b.AM;break;case"g":s=o.getHours()%12,d+=0===s?"12":s;break;case"G":s=o.getHours(),t===_&&(s=i.show2400?24:0),d+=s;break;case"h":s=o.getHours()%12,0!==s&&10>s&&(s="0"+s),d+=0===s?"12":s;break;case"H":s=o.getHours(),t===_&&(s=i.show2400?24:0),d+=s>9?s:"0"+s;break;case"i":var n=o.getMinutes();d+=n>9?n:"0"+n;break;case"s":a=o.getSeconds(),d+=a>9?a:"0"+a;break;case"\\":c++,d+=i.timeFormat.charAt(c);break;default:d+=l}return d}function y(e,t){if(""===e||null===e)return null;if("object"==typeof e)return 3600*e.getHours()+60*e.getMinutes()+e.getSeconds();if("string"!=typeof e)return e;e=e.toLowerCase().replace(/[\s\.]/g,""),("a"==e.slice(-1)||"p"==e.slice(-1))&&(e+="m");var i="("+b.am.replace(".","")+"|"+b.pm.replace(".","")+"|"+b.AM.replace(".","")+"|"+b.PM.replace(".","")+")?",a=new RegExp("^"+i+"([0-9]?[0-9])\\W?([0-5][0-9])?\\W?([0-5][0-9])?"+i+"$"),n=e.match(a);if(!n)return null;var r=parseInt(1*n[2],10);if(r>24){if(t&&!1===t.wrapHours)return null;r%=24}var o=n[1]||n[5],s=r;if(12>=r&&o){var l=o==b.pm||o==b.PM;s=12==r?l?12:0:r+(l?12:0)}var d=1*n[3]||0,c=1*n[4]||0,u=3600*s+60*d+c;if(12>r&&!o&&t&&t._twelveHourTime&&t.scrollDefault){var p=u-t.scrollDefault();0>p&&p>=_/-2&&(u=(u+_/2)%_)}return u}var _=86400,b={am:"am",pm:"pm",AM:"AM",PM:"PM",decimal:".",mins:"mins",hr:"hr",hrs:"hrs"},$={init:function(t){return this.each(function(){var n=e(this),r=[];for(var o in e.fn.timepicker.defaults)n.data(o)&&(r[o]=n.data(o));var s=e.extend({},e.fn.timepicker.defaults,r,t);if(s.lang&&(b=e.extend(b,s.lang)),s=i(s),n.data("timepicker-settings",s),n.addClass("ui-timepicker-input"),s.useSelect)a(n);else{if(n.prop("autocomplete","off"),s.showOn)for(var l in s.showOn)n.on(s.showOn[l]+".timepicker",$.show);n.on("change.timepicker",c),n.on("keydown.timepicker",h),n.on("keyup.timepicker",m),s.disableTextInput&&n.on("keydown.timepicker",f),c.call(n.get(0),null,"initial")}})},show:function(i){var n=e(this),r=n.data("timepicker-settings");if(i&&i.preventDefault(),r.useSelect)return void n.data("timepicker-list").focus();s(n)&&n.blur();var c=n.data("timepicker-list");if(!n.prop("readonly")&&(c&&0!==c.length&&"function"!=typeof r.durationTime||(a(n),c=n.data("timepicker-list")),!t(c))){n.data("ui-timepicker-value",n.val()),d(n,c),$.hide(),c.show();var p={};r.orientation.match(/r/)?p.left=n.offset().left+n.outerWidth()-c.outerWidth()+parseInt(c.css("marginLeft").replace("px",""),10):p.left=n.offset().left+parseInt(c.css("marginLeft").replace("px",""),10);var f;f=r.orientation.match(/t/)?"t":r.orientation.match(/b/)?"b":n.offset().top+n.outerHeight(!0)+c.outerHeight()>e(window).height()+e(window).scrollTop()?"t":"b","t"==f?(c.addClass("ui-timepicker-positioned-top"),p.top=n.offset().top-c.outerHeight()+parseInt(c.css("marginTop").replace("px",""),10)):(c.removeClass("ui-timepicker-positioned-top"),p.top=n.offset().top+n.outerHeight()+parseInt(c.css("marginTop").replace("px",""),10)),c.offset(p);var h=c.find(".ui-timepicker-selected");if(!h.length){var m=y(u(n));null!==m?h=l(n,c,m):r.scrollDefault&&(h=l(n,c,r.scrollDefault()))}if(h&&h.length){var v=c.scrollTop()+h.position().top-h.outerHeight();c.scrollTop(v)}else c.scrollTop(0);return r.stopScrollPropagation&&e(document).on("wheel.ui-timepicker",".ui-timepicker-wrapper",function(t){t.preventDefault();var i=e(this).scrollTop();e(this).scrollTop(i+t.originalEvent.deltaY)}),e(document).on("touchstart.ui-timepicker mousedown.ui-timepicker",o),e(window).on("resize.ui-timepicker",o),r.closeOnWindowScroll&&e(document).on("scroll.ui-timepicker",o),n.trigger("showTimepicker"),this}},hide:function(i){var a=e(this),n=a.data("timepicker-settings");return n&&n.useSelect&&a.blur(),e(".ui-timepicker-wrapper").each(function(){var i=e(this);if(t(i)){var a=i.data("timepicker-input"),n=a.data("timepicker-settings");n&&n.selectOnBlur&&v(a),i.hide(),a.trigger("hideTimepicker")}}),this},option:function(t,n){return"string"==typeof t&&void 0===n?e(this).data("timepicker-settings")[t]:this.each(function(){var r=e(this),o=r.data("timepicker-settings"),s=r.data("timepicker-list");"object"==typeof t?o=e.extend(o,t):"string"==typeof t&&(o[t]=n),o=i(o),r.data("timepicker-settings",o),s&&(s.remove(),r.data("timepicker-list",!1)),o.useSelect&&a(r)})},getSecondsFromMidnight:function(){return y(u(this))},getTime:function(e){var t=this,i=u(t);if(!i)return null;var a=y(i);if(null===a)return null;e||(e=new Date);var n=new Date(e);return n.setHours(a/3600),n.setMinutes(a%3600/60),n.setSeconds(a%60),n.setMilliseconds(0),n},isVisible:function(){var e=this,i=e.data("timepicker-list");return!(!i||!t(i))},setTime:function(e){var t=this,i=t.data("timepicker-settings");if(i.forceRoundTime)var a=r(y(e),i);else var a=w(y(e),i);return e&&null===a&&i.noneOption&&(a=e),p(t,a),t.data("timepicker-list")&&d(t,t.data("timepicker-list")),this},remove:function(){var e=this;if(e.hasClass("ui-timepicker-input")){var t=e.data("timepicker-settings");return e.removeAttr("autocomplete","off"),e.removeClass("ui-timepicker-input"),e.removeData("timepicker-settings"),e.off(".timepicker"),e.data("timepicker-list")&&e.data("timepicker-list").remove(),t.useSelect&&e.show(),e.removeData("timepicker-list"),this}}};e.fn.timepicker=function(t){return this.length?$[t]?this.hasClass("ui-timepicker-input")?$[t].apply(this,Array.prototype.slice.call(arguments,1)):this:"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.timepicker"):$.init.apply(this,arguments):this},e.fn.timepicker.defaults={appendTo:"body",className:null,closeOnWindowScroll:!1,disableTextInput:!1,disableTimeRanges:[],disableTouchKeyboard:!1,durationTime:null,forceRoundTime:!1,maxTime:null,minTime:null,noneOption:!1,orientation:"l",roundingFunction:function(e,t){if(null===e)return null;if("number"!=typeof t.step)return e;var i=e%(60*t.step);return i>=30*t.step?e+=60*t.step-i:e-=i,e==_&&t.show2400?e:e%_},scrollDefault:null,selectOnBlur:!1,show2400:!1,showDuration:!1,showOn:["click","focus"],showOnFocus:!0,step:30,stopScrollPropagation:!1,timeFormat:"g:ia",typeaheadHighlight:!0,useSelect:!1,wrapHours:!0}});var AccessPage=function(e){var t=function(e){return t=function(e){var t=this;t.$wrapper=e.$wrapper,t.$accessWrapper=t.$wrapper.find(".t-access-wrapper"),t.$accessSlider=t.$wrapper.find(".t-access-slider"),t.$headerApps=t.$wrapper.find(".t-header-apps"),t.$headerList=t.$headerApps.find(".t-apps-list"),t.$apps=t.$headerList.find(".t-app-item"),t.item_count=t.$apps.length,t.type_class=!1,t.left=0,t.items_left=0,t.access_wrapper_w=!1,t.access_slider_w=!1,t.item_w=!1,t.initClass()},t.prototype.initClass=function(){function t(){e.contains(document,i.$wrapper[0])?i.reset():e(window).off("resize",t)}var i=this;i.detectSliderWidth(),i.showArrows(),e(window).on("resize",t),i.$wrapper.on("click",".t-action",function(){var t=e(this);t.hasClass("left")&&i.moveSlider(!1),t.hasClass("right")&&i.moveSlider(!0)})},t.prototype.detectSliderWidth=function(){var e=this;e.access_wrapper_w=e.$accessWrapper.outerWidth(),e.access_slider_w=e.$accessSlider.outerWidth(),e.item_w=e.$apps.first().outerWidth()},t.prototype.showArrows=function(){function e(e){t.type_class&&(t.$accessWrapper.removeClass(t.type_class),t.$headerApps.removeClass(t.type_class)),e&&(t.$accessWrapper.addClass(e),t.$headerApps.addClass(e),t.type_class=e)}var t=this;t.left>=0?t.access_wrapper_w<t.access_slider_w?e("type-1"):e():e(t.access_wrapper_w<t.access_slider_w-Math.abs(t.left)?"type-2":"type-3")},t.prototype.setLeft=function(e){var t=this;t.$headerList.css({left:e}),t.$accessSlider.css({left:e}),t.left=e},t.prototype.moveSlider=function(e){var t,i,a=this,n=a.items_left;e?t=n+1:(t=n-1)<0&&(t=0),i=t*a.item_w,i>-(a.access_wrapper_w-a.access_slider_w)&&(i=-(a.access_wrapper_w-a.access_slider_w)),a.items_left=t,a.setLeft(-i),a.showArrows()},t.prototype.reset=function(){var e=this;e.items_left=0,e.setLeft(0),e.detectSliderWidth(),e.showArrows()},t}(e),i=function(e){return i=function(e){var t=this;t.$wrapper=e.$wrapper,t.$header=t.$wrapper.find(".t-elastic-header"),t.wrapper_offset=t.$wrapper.offset(),t.header_w=t.$header.outerWidth(),t.header_h=t.$header.outerHeight(),t.fixed_class="is-fixed",t.is_fixed=!1,t.initClass()},i.prototype.initClass=function(){function t(){e.contains(document,a.$header[0])?a.onScroll(n.scrollTop()):n.off("scroll",t)}function i(){e.contains(document,a.$header[0])?a.onResize():n.off("resize",i)}var a=this,n=e(window);n.on("scroll",t).on("resize",i)},i.prototype.onScroll=function(e){var t=this;e>t.wrapper_offset.top?(t.$header.addClass(t.fixed_class).css({top:0,left:t.wrapper_offset.left,width:t.header_w}),t.is_fixed=!0):(t.$header.removeClass(t.fixed_class).removeAttr("style"),t.is_fixed=!1)},i.prototype.onResize=function(){var e=this;e.header_w=e.$wrapper.outerWidth(),e.is_fixed&&e.$header.width(e.header_w)},i}(jQuery);return AccessPage=function(e){var t=this;t.$wrapper=e.$wrapper,t.slider=!1,t.dialogs=[],t.initClass()},AccessPage.prototype.initClass=function(){var e=this;e.initAccessSlider(),e.initElasticHeader(),e.initHover(),e.bindEvents()},AccessPage.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".t-access-status",function(i){i.preventDefault();var a=e(this);a.hasClass("is-admin")&&!t.dialogs.length?e.team.content.load(a.data("uri")):showAccessDialog(a,a.data("app-id"),a.data("user-id"))});var i;e(document).on("team_access_level_changed",i=function(a,n){if(!e.contains(document.body,t.$wrapper[0]))return void e(document).off("team_access_level_changed",i);t.$wrapper.find('table.t-access-table tr[data-user-id="'+n.contact_id+'"] .t-access-status[data-app-id="'+n.app_id+'"]').removeClass("type-no type-limited type-full type-"+n.prev_level).addClass("type-"+n.new_level)})},AccessPage.prototype.initAccessSlider=function(){var e=this;e.slider||(e.slider=new t({$wrapper:e.$wrapper}))},AccessPage.prototype.initElasticHeader=function(){new i({$wrapper:this.$wrapper})},AccessPage.prototype.closeDialogs=function(){var t=this,i=!1;return t.dialogs.length&&(e.each(t.dialogs,function(t,a){e.contains(document,a.$wrapper[0])&&(a.close(),i=!0)}),t.dialogs=[]),i},AccessPage.prototype.initHover=function(){function t(t){var a=t.data("user-id"),s=t.data("app-id");if(i(),a&&s){var l=e("#t-user-"+a),d=e("#t-app-"+s);l.length&&(l.addClass(o),n=l),d.length&&(d.addClass(o),r=d)}}function i(){n&&(n.removeClass(o),n=!1),r&&(r.removeClass(o),r=!1)}var a=this,n=!1,r=!1,o="highlighted";a.$wrapper.on("mouseenter",".t-access-status",function(){t(e(this))}),a.$wrapper.on("mouseleave",".t-access-status",i)},AccessPage}(jQuery);!function(e){window.AccessDialog=function(e){function t(e){var t=this;t.$dialogWrapper=e.$wrapper,t.$wrapper=t.$dialogWrapper.find(".t-dialog-block"),t.$limitedContent=t.$wrapper.find(".t-limited-access-form"),t.active_class="is-active",t.disabled_class="is-disabled",t.wa_app_url=e.wa_app_url,t.app_id=e.app_id,t.contact_id=e.contact_id,t.teamDialog=t.$dialogWrapper.data("teamDialog")||!1,t.noticeToggle=i(t.$wrapper),t.$activeTab=t.$wrapper.find(".t-access-item."+t.active_class),t.active_access_id=t.$activeTab.data("access-id"),t.is_locked=!1,t.initClass()}function i(t){var i,a,n=t.find(".t-loading"),r=t.find(".t-success");return i={loading:function(){r.removeClass("is-visible"),n.addClass("is-visible")},success:function(){r.addClass("is-visible"),n.removeClass("is-visible"),a&&clearTimeout(a),a=setTimeout(function(){e.contains(document,r[0])&&i.hide()},2e3)},hide:function(){a&&clearTimeout(a),n.removeClass("is-visible"),r.removeClass("is-visible")}}}return t.prototype.initClass=function(){this.bindEvents()},t.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".t-access-item",function(){var i=e(this),a=i.hasClass(t.active_class),n=i.hasClass(t.disabled_class);t.is_locked||a||n?n&&alert(i.data("reason-disabled")):(t.changeTab(i),t.teamDialog&&t.teamDialog.resize())}),t.$wrapper.on("click",'input[type="submit"]',function(e){e.stopPropagation(),t.save()})},t.prototype.changeTab=function(e){var t=this,i=e.data("access-id"),a=t.$limitedContent;t.$activeTab.length&&t.$activeTab.removeClass(t.active_class),e.addClass(t.active_class),t.$activeTab=e,t.$wrapper.find(".t-hint").hide(),"no"==i?t.$wrapper.find(".t-hint.js-access-no").show():"full"==i&&t.$wrapper.find(".t-hint.js-access-full").show(),t.$limitedContent.length&&("limited"==i?a.show():a.hide())},t.prototype.save=function(){function t(t,a){e(document).trigger("team_access_level_changed",{app_id:i.app_id,contact_id:i.contact_id,prev_level:t,new_level:a})}var i=this,a=i.$activeTab.data("access-id"),n=function(e){var t=!1,i={no:0,limited:1,full:2};return i.hasOwnProperty(e)&&(t=i[e]),t}(a);i.is_locked=!0,i.noticeToggle.loading();var r=function(t){var a=i.wa_app_url+"?module=accessSave&action=rights&id="+i.contact_id;return e.post(a,{app_id:i.app_id,name:"backend",value:t},"json")}(n);"limited"===a&&(r=r.then(function(){var t=i.$limitedContent.find("form");return e.post(t.attr("action"),t.serialize(),"json")})),r.then(function(){t(i.active_access_id,a),i.active_access_id=a,i.noticeToggle.success(),i.is_locked=!1,i.teamDialog.close()})},t}(e),window.ProfileAccessTab=function(t){"use strict";function i(t,a){if(!e.fn.iButton)return void e.ajax({cache:!0,dataType:"script",url:t+"wa-content/js/jquery-plugins/ibutton/jquery.ibutton.min.js?"+a,success:function(){i(t,a)}});var n=e(".basic-user-fields"),s=e(".js-block-user-reason-form");s.on("click",".js-block-user-cancel",function(){s.hide()}),s.on("submit",function(t){if(t.preventDefault(),confirm(l.data("alert"))){var i=s.find(".js-block-user-reason"),a=e.trim(i.val());e(".c-shown-on-enabled").hide();var c=d.parent().find(".loading").show();e.post(o+"?module=accessSave&action=ban&id="+r,{magic_word:"please",text:a},function(t){c.hide(),s.hide(),"ok"===t.status&&(n.addClass("gray"),e(".c-shown-on-disabled").show(),e("#tc-user-access-disabled").show().html(t.data.access_disable_msg))},"json")}});var l=e("#c-access-link-block").click(function(){s.show()}),d=e("#c-access-link-unblock").click(function(){if(!confirm(d.data("alert")))return!1;e(".c-shown-on-disabled").hide();var t=d.parent().find(".loading").show();e.post(o+"?module=accessSave&action=unban&id="+r,{magic_word:"please"},function(){t.hide(),n.removeClass("gray"),e(".c-shown-on-enabled").show(),e("#tc-user-access-disabled").hide().html("")})})}var a=t.login,n=t.password,r=t.contact_id,o=t.wa_app_url,s=t.url_change_api_token,l=t.loc;!function(){var t=e("#form-customize-groups");t.length&&(function(t){function i(t,i){var a=e(i||this);a.prop("checked")?a.parent().addClass("highlighted"):a.parent().removeClass("highlighted")}t.find('input[type="checkbox"]').click(i).each(i)}(e("#form-customize-groups .c-checkbox-menu")),e("#open-customize-groups").click(function(){e("#form-customize-groups").toggle()}),e("#cancel-customize-groups").click(function(){var t=e("#form-customize-groups").hide();return t.find(".loading").hide(),t.find(".errormsg").remove(),!1}),t.submit(function(){var t=e(this);return t.find(".errormsg").remove(),t.find(".loading").show(),e.post(t.attr("action"),t.serialize(),function(i){if("ok"==i.status){try{window.parent.$.team.sidebar.reload()}catch(e){}window.hasOwnProperty("profileTab")&&window.profileTab.reload()}else"fail"==i.status&&t.find(".c-checkbox-menu-container").after(e('<em class="errormsg">'+i.errors.join("<br />")+"</em>"))},"json"),!1}))}(),function(){e("#c-credentials-form").submit(function(){var t=e(this);t.find("input.error").removeClass("error"),t.find(".errormsg").remove();var i=t.find(".c-login-input"),n=e.trim(i.val());if(!n)return i.addClass("error").after('<em class="errormsg">'+l["Login is required"]+"</em>"),!1;var r=t.serializeArray();return"1"===e("#c-access-rights-toggle").val()&&(r=r.concat([{name:"set_rights",value:"1"},{name:"app_id",value:"webasyst"},{name:"name",value:"backend"},{name:"value",value:1}])),e.post(t.attr("action"),r,function(i){if("ok"===i.status){t.hide(),a=n,e("#c-login-block").show().find(".c-login-input").val(a).end().find(".c-login").text(a);try{window.parent.$.team.sidebar.reload()}catch(e){}try{window.profileTab.reload()}catch(e){}}else"fail"===i.status&&t.find('input[type="submit"]').parent().prepend(e('<em class="errormsg" style="margin-bottom:10px">'+i.errors.join("<br>")+"</em>"))},"json"),!1}).find(".cancel").click(function(){return e("#c-credentials-block").hide(),!1})}(),function(){var t=e("#c-login-form"),i=t.find(".c-login-input");t.submit(function(){t.find("input.error").removeClass("error"),t.find(".errormsg").remove();var n=e.trim(i.val());return a!==n&&(n?(t.find(".loading").show(),e.post(t.attr("action"),t.serialize(),function(r){if(t.find(".loading").hide(),"ok"===r.status){if(e("#c-login-block").show(),i.val(n),t.find(".c-login").text(n),t.find(".c-one-tab").show(),t.find(".c-two-tab").hide(),!a)try{window.profileTab.reload()}catch(e){}a=n}else"fail"===r.status&&t.find('input[type="submit"]').parent().prepend(e('<em class="errormsg" style="margin-bottom:10px">'+r.errors.join("\n<br>\n")+"</em>"))},"json"),!1):(i.addClass("error").after('<em class="errormsg">'+l["Login is required."]+"</em>"),!1))}),t.find(".c-tab-toggle").click(function(){return t.find(".c-one-tab,.c-two-tab").toggle(),i.is(":visible")&&i.focus(),!1})}(),function(){var t=e("#c-password-form"),i=t.find(".c-password-input"),a=t.find(".c-confirm-password-input");t.submit(function(){return t.find("input.error").removeClass("error"),t.find(".errormsg").remove(),i.val()!==a.val()?(i.addClass("error"),a.after().after('<em class="errormsg">'+l["Passwords do not match."]+"</em>"),!1):(t.find(".loading").show(),e.post(t.attr("action"),t.serialize(),function(r){t.find(".loading").hide(),"ok"===r.status?(n=!0,i.val(""),a.val(""),t.find(".c-one-tab").show(),t.find(".c-two-tab").hide(),e("#c-password-block").show()):"fail"===r.status&&a.after('<em class="errormsg">'+r.errors.join("<br />")+"</em>")},"json"),!1)}),t.find(".c-tab-toggle").click(function(){t.find(".c-one-tab,.c-two-tab").toggle();var e=t.find(".c-password-input");return e.is(":visible")&&e.focus(),!1})}(),function(){var t=e("#tc-api-tokens-filed"),i=t.find(".js-api-tokens-list"),a=!1;t.on("click",".js-remove-api-token",function(n){n.preventDefault();var r=e(this).parents(".js-token-item"),o=r.find(".icon16"),d=r.data("token"),c={action:"remove",token_id:d};!a&&d&&confirm(l.remove_ask)&&(a=!0,o.removeClass("no").addClass("loading"),e.post(s,c,function(e){e.status&&"ok"===e.status?(r.remove(),0===i.find(".js-token-item").length&&t.remove()):(a=!1,o.removeClass("loading").addClass("no"))}).always(function(){a=!1,o.removeClass("loading").addClass("no")}))})}(),t.is_own_profile||i(t.wa_url,t.wa_framework_version),t.is_own_profile&&function(){e(".js-webasyst-id-auth").on("click",function(e){e.preventDefault(),window.top.$("body").trigger("wa_webasyst_id_auth")})}(),function(){e(".js-webasyst-id-unbind-auth").on("click",function(e){e.preventDefault(),window.top.$(".js-webasyst-id-unbind-auth").trigger("wa_waid_unbind_auth",{id:r})})}(),function(){e(".js-webasyst-id-help-link").on("click",function(e){e.preventDefault(),window.top.$("body").trigger("wa_waid_help_link")})}(),function(t,i,s){function l(){d(!0)&&c()}function d(i){e("#c-access-rights-hint-warning").hide(),e("#c-access-rights-hint-customize").hide();var r=u.val();switch(void 0===r&&(r="1"),r){case"remove":if(e("#c-credentials-block").hide(),e("#c-login-block").hide(),e("#c-password-block").hide(),s){e("#c-access-rights-by-app").hide(),e(".c-shown-on-access").hide();break}return u.val(f||"0"),e("#c-access-rights-hint-warning").show(),!1;case"0":if(a||n){if(a){var o=e("#c-access-rights-by-app");o.show(),i&&o.find(".t-access-status").removeClass("type-no type-limited type-full").addClass("type-no"),e(".c-shown-on-access").show(),e("#c-login-block").show(),e("#c-password-block").show();break}return e("#c-login-block").show().find(".cancel").one("click.access",function(){u.val(f),l()}).end().find(".c-tab-toggle:first").click(),e("#c-password-block").show(),!1}return e("#c-credentials-block").show().find(".c-login-input").focus().end().find(".cancel").one("click.access",function(){u.val(f),l()}),!1;case"1":if(a||n){if(a){e("#c-access-rights-by-app").hide(),e(".c-shown-on-access").show(),e("#c-login-block").show(),e("#c-password-block").show();break}return e("#c-login-block").show().find(".cancel").one("click.access",function(){u.val(f),l()}).end().find(".c-tab-toggle:first").click(),e("#c-password-block").show(),!1}return e("#c-credentials-block").show().find(".c-login-input").focus().end().find(".cancel").one("click.access",function(){u.val(f),l()}),!1;default:return!1}return t&&(e("#c-login-block").show(),e("#c-password-block").show()),f=r,!0}function c(){function t(){return e.post(o+"?module=accessSave&action=makeuser",{id:r},"json")}function i(t,i,a){return e.post(o+"?module=accessSave&action=rights&id="+r,{app_id:t,name:i,value:a},"json")}var a=u.val();void 0===a&&(a="1"),function(){switch(a){case"0":return t().then(function(){return i("webasyst","backend",0)});case"1":return i("webasyst","backend",1);case"remove":return e.post(o+"?module=accessSave&action=revoke",{id:r},"json")}}().then(function(){s&&"0"==a?e("#c-access-rights-hint-customize").show():e("#c-access-rights-hint-warning").hide()})}var u=e("#c-access-rights-toggle"),p=e("#access-rights-toggle-confirm"),f=u.val();i?e(".c-shown-on-access").hide():e(".c-shown-on-access").show(),d(),p.on("click",".cancel",function(){u.val(f),p.hide()}),p.on("click",".button",function(){p.hide(),l()}),u.change(function(){if(!a)return void d(!0);e("#c-access-rights-hint-warning").hide(),e("#c-access-rights-hint-customize").hide();var t=u.val();void 0===t&&(t="1"),t===f?p.hide():p.show()})}(t.is_own_profile,t.contact_no_access,t.contact_groups_no_access),new UserAccessTable({$wrapper:e("#c-access-rights-wrapper"),contact_id:r,is_frame:!0})},window.UserAccessTable=function(t){"use strict";var i=t.$wrapper,a=t.contact_id,n=t.is_frame||!1;i.on("click",".t-access-status",function(t){t.preventDefault();var i=e(this);showAccessDialog(i,i.data("app-id"),a,!0,n)});var r;e(document).on("team_access_level_changed",r=function(t,a){if(!e.contains(document.body,i[0]))return void e(document).off("team_access_level_changed",r);i.find('.t-access-status[data-app-id="'+a.app_id+'"]').removeClass("type-no type-limited type-full type-"+a.prev_level).addClass("type-"+a.new_level)})},window.showAccessDialog=function(t,i,a,n,r){t.trigger("close"),e.post(e.team.app_url+"?module=access&action=dialog",{user_id:a,app_id:i},function(i){var a={html:i};r&&n&&(a.setPosition=function(i){var a=e(window),n=a.width();return{top:t.offset().top,left:parseInt((n-i.width)/2)}}),new TeamDialog(a)})}}(jQuery);var SiteApiTokenPage=function(e){return SiteApiTokenPage=function(e){var t=this;t.$wrapper=e.$wrapper,t.locale=e.locale,t.initClass()},SiteApiTokenPage.prototype.initClass=function(){this.initRemoveApiToken()},SiteApiTokenPage.prototype.initRemoveApiToken=function(){var t,i=this,a=i.$wrapper.find(".js-api-tokens-list")
;i.$wrapper.on("click",".js-remove-api-token",function(n){n.preventDefault();var r=e(this).parents(".js-token-item"),o=r.find(".icon16"),s=r.data("token"),l=r.data("contact-id"),d={action:"remove",token_id:s,contact_id:l};!t&&s&&confirm(i.locale.remove_ask)&&(t=!0,o.removeClass("no").addClass("loading"),e.post("?module=apiTokensRemove",d,function(e){e.status&&"ok"===e.status?(r.remove(),a.find(".js-token-item").length):(t=!1,o.removeClass("loading").addClass("no"))}).always(function(){t=!1,o.removeClass("loading").addClass("no")}))})},SiteApiTokenPage}(jQuery),CalendarPage=function(e){var t=function(e){return t=function(e){var t=this;t.$wrapper=e.$wrapper,t.$monthSelect=t.$wrapper.find(".month"),t.$yearSelect=t.$wrapper.find(".year"),t.filters_href=e.filters_href,t.month=parseInt(t.$monthSelect.val()),t.year=parseInt(t.$yearSelect.val()),t.initClass()},t.prototype.initClass=function(){var t=this;t.$monthSelect.on("change",function(){var i=e(this).val();return i&&(t.month=parseInt(i)),t.useFilter(),!1}),t.$yearSelect.on("change",function(){var i=e(this).val();return i&&(t.year=parseInt(i)),t.useFilter(),!1}),t.$wrapper.on("click",".t-arrow",function(){var i=e(this);return i.hasClass("left")&&t.changeMonth(!1),i.hasClass("right")&&t.changeMonth(!0),t.useFilter(),!1})},t.prototype.changeMonth=function(e){var t=this;e?t.month>=12?(t.month=1,t.year++):t.month++:t.month<=1?(t.month=12,t.year--):t.month--},t.prototype.useFilter=function(){var t,i=this,a=i.year+"-"+(i.month>9?i.month:"0"+i.month)+"-01",n="start="+a,r=i.filters_href.split("?"),o=r[0],s=r[1]||"",l=s.indexOf("&")>=0?s.split("&"):[s],d=!1;l.length&&e.each(l,function(e,t){"start"==t.split("=")[0]&&(d=e)}),d||0===d?l[d]=n:l.push(n),t=o+"?"+l.join("&"),e.team.content.load(t)},t}(jQuery);return CalendarPage=function(t){var i=this;i.$wrapper=t.$wrapper,i.$dateFilter=t.$dateFilter,i.filters_href=t.filters_href,i.user_id=t.user_id,i.local_storage=new e.store,i.initClass()},CalendarPage.prototype.initClass=function(){var e=this;new t({$wrapper:e.$dateFilter,filters_href:e.filters_href}),e.initInfoBlock()},CalendarPage.prototype.initInfoBlock=function(){var e=this,t=e.$wrapper.find(".t-info-notice-wrapper"),i=e.local_storage,a="team/calendar_info_warn_block_hide";i.get(a)?t.hide():t.show(),t.find(".t-info-notice-toggle").on("click",function(){i.set(a,1),t.hide()})},CalendarPage}(jQuery),TeamCalendar=function(e){function t(t){var i=[];return t.each(function(){var t=e(this),a=[];t.find(".t-day-ornament").each(function(){a.push(e(this))}),i.push(a)}),i}return TeamCalendar=function(e){var i=this;i.$wrapper=e.$wrapper,i.$rows=i.$wrapper.find(".t-week-row"),i.days_count=7,i.weeks_count=i.$rows.length,i.selected_class="is-selected",i.active_class="is-active",i.locales=e.locales,i.is_profile=e.is_profile,i.event_view_uri="?module=schedule&action=eventView",i.event_edit_uri="?module=schedule&action=eventEdit",i.day_uri="?module=schedule&action=day",i.user_id=e.user_id,i.has_right_to_change=e.has_right_to_change,i.selected_user_id=e.selected_user_id,i.selected_calendar_id=e.selected_calendar_id,i.period_start=e.period_start,i.period_end=e.period_end,i.daysArray=t(i.$rows),i.wrapper_o=i.$wrapper.offset(),i.wrapper_w=i.$wrapper.width(),i.wrapper_h=i.$wrapper.height(),i.day_w=0,i.day_h=0,i.dialogs=[],i.xhr=!1,i.start=!1,i.end=!1,i.$selectedDays=[],i.is_locked=!1,i.bindEvents(),i.initHoverOnDay(),i.initMove()},TeamCalendar.prototype.bindEvents=function(){function t(i){e.contains(document,n.$wrapper[0])?27===i.keyCode&&n.deselectDays():e(document).off("keydown",t)}function i(e){return n.is_locked||(n.is_locked=!0,n.onMouseMove(e),setTimeout(function(){n.is_locked=!1},10)),!1}function a(){return n.onMouseUp(),n.$wrapper.off("mousemove",i),r.off("mouseup",a),!1}var n=this,r=e(document);n.has_right_to_change&&(n.$wrapper.find(".show-full-days-events, .t-event-wrapper").on("mousedown",function(e){e.stopPropagation(),n.clearSelection()}),r.on("mousedown",function(){n.clearSelection()}),n.$wrapper.on("mousedown",function(e){return e.stopPropagation(),n.closeDialogs()||(n.onMouseDown(e),n.$wrapper.on("mousemove",i),r.on("mouseup",a)),!1})),n.$wrapper.on("click",".show-full-days-events",function(t){t.preventDefault(),n.closeDialogs()||n.showFullDayEvents(e(this))}),n.$wrapper.on("click",".t-event-block.js-view-event",function(t){t.preventDefault(),n.closeDialogs()||n.showEventDetails(e(this).closest(".t-event-wrapper"))}),e(document).on("keydown",t)},TeamCalendar.prototype.showFullDayEvents=function(t){var i=this,a=t.data("events-id").split(","),n=t.data("date"),r={date:n,id:a};i.xhr&&(i.xhr.abort(),i.xhr=!1),i.xhr=e.post(i.day_uri,r,function(a){function n(t){var i=t.width,a=t.height,n=(i-s.width)/2,r=(a-s.height)/2,o=s.top-(r>0?r:0),l=s.left-(n>0?n:0),d=e(window).width()-(l+i);if(d<0){l-=Math.abs(d)+10}return{top:o,left:l}}var r=t.closest(".t-action-wrapper"),o=r.closest(".t-week-row"),s={top:o.offset().top,left:r.offset().left,width:r.outerWidth(),height:o.outerHeight()},l=new TeamDialog({html:a,setPosition:n});i.addDialog(l)})},TeamCalendar.prototype.showEventDetails=function(t){var i=this,a=t.data("id"),n={"data[id]":a};i.xhr&&(i.xhr.abort(),i.xhr=!1),i.xhr=e.post(i.event_view_uri,n,function(e){var t=new TeamDialog({html:e});i.addDialog(t)})},TeamCalendar.prototype.createEvent=function(){var t=this,i=t.daysArray[t.start.week-1][t.start.day-1],a=t.daysArray[t.end.week-1][t.end.day-1],n=i.data("date"),r=a.data("date"),o={"data[start]":!1,"data[end]":!1,"data[contact_id]":t.selected_user_id||t.user_id},s=new Date,l=s.getHours();o["data[start]"]=n.replace("00:00:00",l>=23?"23:59:59":l+1+":00:00"),o["data[end]"]=r.replace("00:00:00",l>=22?"23:59:59":l+2+":00:00"),t.selected_calendar_id&&(o["data[calendar_id]"]=t.selected_calendar_id),t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.post(t.event_edit_uri,o,function(e){var i=new TeamDialog({html:e});t.addDialog(i)})},TeamCalendar.prototype.onMouseDown=function(e){var t=this;t.start=t.getDayPosition(e),t.end=t.start,t.markDays()},TeamCalendar.prototype.onMouseMove=function(e){var t=this,i=t.getDayPosition(e);t.end&&t.end.week==i.week&&t.end.day==i.day||(t.end=i,t.markDays())},TeamCalendar.prototype.initHoverOnDay=function(t){function i(t){var i=s.getDayPosition(t),a=o(i,s.daysArray),l=e(t.target);return l.hasClass("t-event-block")||l.closest(".t-event-block").length?(r(),!1):s.start?(r(),!1):a?!a.hasClass(c)&&(d&&r(),void n(a)):(r(),!1)}function a(){r()}function n(e){e.addClass(c),d=e}function r(){d&&d.removeClass(c),d=!1}function o(e,t){var i=!1;return t[e.week-1]&&t[e.week-1][e.day-1]&&(i=t[e.week-1][e.day-1]),i}var s=this,l=s.$wrapper,d=!1,c="is-highlighted";l.on("mousemove",i).on("mouseleave",a)},TeamCalendar.prototype.onMouseUp=function(){var e=this;if(e.start.week>e.end.week||e.start.week==e.end.week&&e.start.day>e.end.day){var t={week:e.start.week,day:e.start.day};e.start={week:e.end.week,day:e.end.day},e.end=t}e.createEvent(),e.start=!1,e.end=!1},TeamCalendar.prototype.initMove=function(){function t(t){var i=n.getDayPosition(t),r=n.daysArray[i.week-1][i.day-1];if(!r)return console&&console.log&&console.log("error: date is not exist"),!1;var o=e.team.app_url+"?module=schedule&action=eventMove",l={id:parseInt(s.data("id")),start:r.data("date").replace(" 00:00:00","")};a&&a.abort(),a=e.post(o,l,function(e){"ok"==e.status&&n.reload()},"json")}function i(e){var t=r.offset(),i=[t.left,t.left+r.outerWidth()],a=[t.top,t.top+r.outerHeight()];if(n.clearSelection(),e.pageX<=i[0]||e.pageX>=i[1])return!1;if(e.pageY<=a[0]||e.pageY>=a[1])return!1;var o=parseInt(s.data("day-count")||s.closest(".t-column").attr("colspan"));n.start=n.getDayPosition(e),n.end=function(e,t,i){var a={week:t.week,day:t.day},n=7-t.day;return i-=1,i<=n?a.day=a.day+i:(a.week=a.week+1,a.day=i-n,a.week>e.length&&(a={week:e.length,day:7})),a}(n.daysArray,n.start,o),n.markDays()}var a,n=this,r=n.$wrapper,o=r.find(".js-move-event"),s=!1,l=!1;o.draggable({helper:"clone",appendTo:"body",cursor:"move",delay:200,cursorAt:{top:11,left:16},start:function(t,i){var a=e(i.helper.context),n=i.helper;s=a;var r=parseInt(s.closest(".t-column").attr("colspan")),o=a.data("move-hint")||!1;o&&n.find(".t-event-block").append("<span class='t-day-count'>("+o+")</span>"),n.addClass("is-clone").css({minWidth:parseInt(a.width()/r)+"px",height:a.height()+"px"})},drag:function(e,t){l||(l=!0,setTimeout(function(){l=!1},100),i(e))},stop:function(e,t){n.clearSelection(),s=!1}}),r.droppable({drop:function(e){t(e)}})},TeamCalendar.prototype.markDays=function(){var t=this;t.deselectDays();var i=e.extend({},t.start),a=e.extend({},t.end);i.week>a.week&&(i=e.extend({},t.end),a=e.extend({},t.start));for(var n=i.week,r=a.week,o=n;o<=r;o++){var s,l;n==r?(s=i.day,l=a.day,s>l&&(s=a.day,l=i.day)):o==n?(s=i.day,l=t.days_count):o==r?(s=1,l=a.day):(s=1,l=t.days_count);for(var d=s;d<=l;d++)!function(e,i){if(!(e>0&&i>0))return!1;var a=t.daysArray[e-1][i-1];if(!a.length)return console.log("Error: Day isn't exist"),!1;a.addClass(t.selected_class),t.$selectedDays.push(a)}(o,d)}},TeamCalendar.prototype.getDayPosition=function(e){var t=this;t.wrapper_o=t.$wrapper.offset(),t.wrapper_w=t.$wrapper.width(),t.wrapper_h=t.$wrapper.height(),t.day_w=t.wrapper_w/t.days_count,t.day_h=t.wrapper_h/t.weeks_count;var i={top:e.pageY-t.wrapper_o.top,left:e.pageX-t.wrapper_o.left};return{week:parseInt(i.top/t.day_h)+(i.top%t.day_h>0?1:0),day:parseInt(i.left/t.day_w)+(i.left%t.day_w>0?1:0)}},TeamCalendar.prototype.deselectDays=function(){var t=this;t.$selectedDays.length&&(e.each(t.$selectedDays,function(){e(this).removeClass(t.selected_class)}),t.$selectedDays=[])},TeamCalendar.prototype.clearSelection=function(){var e=this;e.deselectDays(),e.start=!1,e.end=!1},TeamCalendar.prototype.reload=function(){var t=this,i={};t.closeDialogs(),t.selected_user_id&&(i.user=t.selected_user_id),t.selected_calendar_id&&(i.calendar=t.selected_calendar_id),t.period_start&&(i.start=t.period_start),t.period_end&&(i.end=t.period_end),t.is_profile&&(i.period=1),e.get("?module=schedule&action=inc",i,function(i){e.team.calendar=!1,t.$wrapper.closest(".t-calendar-wrapper").replaceWith(i)})},TeamCalendar.prototype.addDialog=function(e){this.dialogs.push(e)},TeamCalendar.prototype.closeDialogs=function(){var t=this,i=!1;return t.dialogs.length&&(e.each(t.dialogs,function(t,a){e.contains(document,a.$wrapper[0])&&(a.close(),i=!0)}),t.dialogs=[]),e("#ui-datepicker-div").length&&e(document).trigger("mousedown"),i},TeamCalendar}(jQuery),DayEventsDialog=function(e){return DayEventsDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.event_view_uri="?module=schedule&action=eventView",t.dialog=!1,t.xhr=!1,t.initClass()},DayEventsDialog.prototype.initClass=function(){var t=this;t.$wrapper.on("click",".t-event-block.js-view-event",function(i){i.preventDefault(),t.showEventDetails(e(this).closest(".t-event-wrapper"))})},DayEventsDialog.prototype.showEventDetails=function(t){var i=this,a=t.data("id"),n={"data[id]":a};i.xhr&&(i.xhr.abort(),i.xhr=!1),i.xhr=e.post(i.event_view_uri,n,function(e){i.dialog=new TeamDialog({html:e})})},DayEventsDialog}(jQuery),EventEditDialog=function(e){function t(t){var i={};return t.find(".menu-v li").each(function(){var t=e(this),a=t.find(".userpic20"),n=t.data("calendar-id");i[n]={id:n,default_status:t.data("default-status"),name:e.trim(e("<div />").html(t.text()).text()).toLowerCase(),font_color:a.css("color"),bg_color:a.css("background-color")}}),i}function i(t){var i={};return t.find(".menu-v li").each(function(){var t=e(this),a=t.find(".userpic20"),n=t.data("user-id");i[n]={id:n,$icon:a,name:e.trim(e("<div />").html(t.text()).text())}}),i}return EventEditDialog=function(e){var a=this;a.$wrapper=e.$wrapper,a.$form=a.$wrapper.find("form"),a.$statusToggle=a.$wrapper.find(".t-status-toggle"),a.$calendarToggle=a.$wrapper.find(".t-calendar-toggle"),a.$typeToggle=a.$wrapper.find(".t-type-toggle"),a.$userToggle=a.$wrapper.find(".t-user-toggle"),a.$startAltField=a.$wrapper.find("input[name='data[start_alt]']"),a.$endAltField=a.$wrapper.find("input[name='data[end_alt]']"),a.$summaryField=a.$form.find("input[name='data[summary]']"),a.teamDialog=a.$wrapper.data("teamDialog"),a.active_class="is-active",a.extended_class="is-extended",a.selected_class="selected",a.has_error_class="error",a.locales=e.locales,a.event_id=e.event_id,a.calendars=t(a.$calendarToggle),a.users=i(a.$userToggle),a.$activeStatusToggle=a.$statusToggle.find("."+a.active_class)||!1,a.is_status=e.is_status,a.is_locked=!1,a.is_changed=!1,a.user_id=e.user_id,a.calendar_id=e.calendar_id,a.summary=e.summary,a.summary_type=e.summary_type,a.start_date_locale=!1,a.end_date_locale=!1,a.initClass()},EventEditDialog.prototype.initClass=function(){var e=this;e.initDatePicker(),e.initTimePicker(),e.bindEvents(),e.setStatusLocale(),e.is_status&&(e.generateStatusTypes(),e.generatePreview())},EventEditDialog.prototype.bindEvents=function(){var t=this;t.$form.on("submit",function(e){return e.preventDefault(),t.is_locked||t.save(t.$form),!1}),t.$form.on("click",".js-delete-event",function(e){e.preventDefault(),t.is_locked||t.showDeleteConfirm()}),t.$statusToggle.on("click",".t-toggle-button",function(){return t.changeStatus(e(this)),!1}),t.$calendarToggle.on("click",".menu-v a",function(i){i.preventDefault(),t.changeCalendar(e(this))}),t.$startAltField.on("change",function(){t.setStatusLocale(),t.generateStatusTypes(),t.generatePreview()}),t.$endAltField.on("change",function(){t.setStatusLocale(),t.generateStatusTypes(),t.generatePreview()}),t.$summaryField.on("change",function(){t.summary=e(this).val(),t.summary_type="custom"}),t.$form.on("change","input[name='data[status_summary]']",function(){t.summary=e(this).val(),t.$summaryField.val(t.summary)}),t.$form.on("change",'textarea[name="data[description]"]',function(){var i=e(this).val();t.$form.find('textarea[name="data[status_description]"]').val(i)}),t.$form.on("change",'textarea[name="data[status_description]"]',function(){var i=e(this).val();t.$form.find('textarea[name="data[description]"]').val(i)}),t.$form.on("summaryChange",function(){t.$summaryField.val(t.summary)}),t.$userToggle.length&&t.$userToggle.on("click",".menu-v a",function(i){i.preventDefault(),t.changeUser(e(this))}),t.$form.on("change",".js-extended-date",function(){return t.dateToggle(e(this)),!1}),t.$form.find("input").on("mousedown",function(){var i=e(this);i.hasClass(t.has_error_class)&&i.removeClass(t.has_error_class).closest(".value").find(".t-error").remove()})},EventEditDialog.prototype.initDatePicker=function(){function t(){var t=!1,i=e("#ui-datepicker-div");return i.length&&"none"!=i.css("display")&&(t=i),t}function i(){e(document).trigger("mousedown")}this.$wrapper.find(".js-datepicker").each(function(){var a=e(this),n=a.closest(".t-date-wrapper").find("input[type='hidden']");a.datepicker({altField:n,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,shortYearCutoff:2,showOtherMonths:!0,selectOtherMonths:!0,stepMonths:2,numberOfMonths:2,beforeShow:function(a,n){n.dpDiv.on("click",function(e){e.stopPropagation()}),e(a).on("click",function(a){t()&&(a.stopPropagation(),i(),e(this).blur())})}})})},EventEditDialog.prototype.initTimePicker=function(){this.$wrapper.find(".js-timepicker").each(function(){var t=e(this),i=!1;t.timepicker(),t.on("showTimepicker",function(){var a=t.data("timepicker-list");i||(a.on("click",function(e){e.stopPropagation()}),i=!0);var n=parseInt(t.offset().top)+parseInt(t.outerHeight())-parseInt(e(window).scrollTop());a.css({position:"fixed",top:n})})})},EventEditDialog.prototype.showDeleteConfirm=function(){var t=this,i={id:t.event_id};t.is_locked=!0,t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get("?module=schedule&action=eventDeleteConfirm",i,function(e){new TeamDialog({html:e}),t.is_locked=!1,t.close()})},EventEditDialog.prototype.changeStatus=function(e){var t=this;if(!e.hasClass(t.active_class)){var i=e.data("status-id");t.$activeStatusToggle&&t.$activeStatusToggle.removeClass(t.active_class),e.addClass(t.active_class),t.$activeStatusToggle=e,t.$form.find('input[name="data[is_status]"]').val(i).trigger("change");var a=1==i;if(t.is_status=a,a){t.$wrapper.removeClass("is-event").addClass("is-status");var n=t.$form.find(".js-extended-date");"checked"==n.attr("checked")||n.click()}else t.$wrapper.removeClass("is-status").addClass("is-event");t.generateStatusTypes(),t.generatePreview(),t.teamDialog.resize()}},EventEditDialog.prototype.changeCalendar=function(e){var t=this,i=e.closest("li"),a=i.data("calendar-id");if(!i.hasClass(t.selected_class)&&!t.is_locked){t.is_locked=!0,t.calendar_id=a,t.$calendarToggle.find("."+t.selected_class).removeClass(t.selected_class),t.$calendarToggle.find(".t-selected-item").html(e.html()),t.$form.find('input[name="data[calendar_id]"]').val(a).trigger("change");var n=t.$calendarToggle.find(".menu-v");n.hide(),setTimeout(function(){n.removeAttr("style"),t.is_locked=!1},500),t.generateStatusTypes(),t.generatePreview()}},EventEditDialog.prototype.changeUser=function(e){var t=this,i=e.closest("li"),a=i.data("user-id");if(!i.hasClass(t.selected_class)&&!t.is_locked){t.is_locked=!0,t.user_id=a,t.$userToggle.find("."+t.selected_class).removeClass(t.selected_class),t.$userToggle.find(".t-selected-item").html(e.html()),t.$form.find('input[name="data[contact_id]"]').val(a).trigger("change");var n=t.$userToggle.find(".menu-v");n.hide(),setTimeout(function(){n.removeAttr("style"),t.is_locked=!1},200),t.generatePreview()}},EventEditDialog.prototype.save=function(t){var i=this,a=function(t){function a(e){var t=e.split("-"),i=parseInt(t[0]),a=parseInt(t[1]),n=parseInt(t[2]);return i>0&&a>0&&n>0&&new Date(i,a-1,n)}var n={},r=[];e.each(t,function(e,t){n[t.name]=t.value}),n["data[summary_type]"]||(n["data[summary_type]"]="custom");var o=i.is_status;return o&&(n["data[description]"]=n["data[status_description]"]?n["data[status_description]"]:"",delete n["data[status_description]"],n["data[summary]"]=i.summary,delete n["data[status_summary]"]),e.trim(n["data[summary]"]).length||(o?r.push({field:"data[status_summary]",locale:"empty"}):r.push({field:"data[summary]",locale:"empty"})),n["data[start]"].match(/^(\d){4}-(\d){2}-(\d){2}$/)||r.push({field:"data[end]",locale:"date"}),n["data[end]"].match(/^(\d){4}-(\d){2}-(\d){2}$/)||r.push({field:"data[end]",locale:"date"}),a(n["data[start]"])>a(n["data[end]"])&&(r.push({field:"data[start_alt]",locale:"period"}),r.push({field:"data[end_alt]",locale:"period"})),r.length?(function(t){i.$form.find(".t-error").remove(),e.each(t,function(e,t){var a=i.$form.find("[name='"+t.field+"']");a.length&&a.addClass(i.has_error_class).after('<span class="t-error">'+i.locales[t.locale]+"</span>")})}(r),!1):(n["data[start_time]"].length||(n["data[start_time]"]="00:00"),n["data[end_time]"].length||(n["data[end_time]"]="00:00"),n["data[start]"]=n["data[start]"]+" "+n["data[start_time]"],n["data[end]"]=n["data[end]"]+" "+n["data[end_time]"],n["data[is_allday]"]=n["data[is_allday]"]?1:0,delete n["data[start_time]"],delete n["data[end_time]"],delete n["data[start_alt]"],delete n["data[end_alt]"],n)}(t.serializeArray());i.is_locked=!0,a?e.post("?module=schedule&action=eventSave",a,function(t){if("ok"==t.status)t.data&&t.data.message&&alert(t.data.message),i.reloadCalendar();else if(t.errors){var a=null;e.each(t.errors,function(e,t){"redirect"===t[0]&&(a=t[1])}),a&&(location.href=a)}i.close(),i.is_locked=!1},"json"):i.is_locked=!1},EventEditDialog.prototype.reloadCalendar=function(){e.team.calendar.reload()},EventEditDialog.prototype.dateToggle=function(e){var t=this,i="checked"==e.attr("checked"),a=t.$form.find(".t-date-wrapper");i?a.removeClass(t.extended_class):a.addClass(t.extended_class)},EventEditDialog.prototype.generatePreview=function(){var t=this,i=t.$wrapper.find(".t-preview-block"),a=t.calendars[t.calendar_id],n=a.bg_color,r=a.font_color,o=t.users[t.user_id],s=o.$icon.clone(),l=o.name,d=e("<span class='t-type'>"+(t.summary?t.summary:t.locales.empty_type)+"</span>").css({background:n,color:r});i.html("").append(s).append("<span class='t-user-name'>"+l+"</span>").append(d)},EventEditDialog.prototype.generateStatusTypes=function(){var t=this,i=t.$typeToggle,a=function(){var a=i.find(".is-template li"),n=a.eq(0),r=a.eq(1),o=e("<ul class='menu-v'></ul>"),s=t.calendars[t.calendar_id];if(s.default_status){var l=n.clone();l.find(".t-type").text(s.default_status),l.find("input:radio").val("default"),o.append(l)}var d=n.clone();d.find(".t-type").text(s.name),d.find("input:radio").val("calendar"),o.append(d);var c=n.clone();c.find(".t-type").text((s.default_status?s.default_status:s.name)+" "+t.locales.till+" "+t.end_date_locale),c.find("input:radio").val("till"),o.append(c);var u=n.clone();u.find(".t-type").text((s.default_status?s.default_status:s.name)+" "+t.locales.from+" "+t.start_date_locale+" "+t.locales.till+" "+t.end_date_locale),u.find("input:radio").val("interval"),o.append(u);var p=r.clone();return p.find("input:radio").val("custom"),t.summary&&p.find("input:text").val(t.summary),o.append(p),i.find(".value").html("").append(o),o}();!function(i){i.on("change","input:radio",function(){var i=e(this),a="checked"==i.attr("checked"),n=i.closest("li").find(".t-type"),r=i.closest("li").find("input:text");if(a){if(n.length)t.summary=n.text();else{if(!r.length)return!1;t.summary=r.val()}t.summary_type=i.val(),t.$form.trigger("summaryChange"),t.generatePreview()}}),i.on("focus set","input:text",function(){var i=e(this),a=i.closest("li").find("input:radio");"checked"!=a.attr("checked")&&a.attr("checked","checked").trigger("change"),i.hasClass(t.has_error_class)&&i.removeClass(t.has_error_class).closest(".value").find(".t-error").remove()}),i.on("focus change keyup","input:text",function(){var i=e(this),a=i.val();t.summary=e("<div />").html(i.val()).text(),a.length&&(t.summary_type="custom",t.summary=a),t.generatePreview()})}(a),function(e){if(!t.summary_type&&t.summary&&(t.summary_type="custom"),t.summary_type){var i=e.find("input:radio[value='"+t.summary_type+"']");i.length?(i.click(),"custom"!==t.summary_type&&e.find("input:text").val("")):"default"==t.summary_type?e.find("input[value='calendar']").click():e.find("input:text").val(t.summary?t.summary:"").trigger("change")}else e.find("input:radio:first").click()}(a)},EventEditDialog.prototype.setStatusLocale=function(){function t(t){var a=t.val().split(" ")[0],n=a.split("-"),r=parseInt(n[2]),o=parseInt(n[1]),s=parseInt(n[0]),l=(new Date).getFullYear(),d=i.locales.status_type.format,c=i.locales.status_type.months[o],u=e.datepicker.formatDate(d,new Date(s,o-1,r));return u=u.replace("f",c),l==s&&(u=u.replace(", "+s,"").replace(" "+s,"").replace(s+" ","")),u}var i=this,a=i.$wrapper.find("input[name='data[start]']"),n=i.$wrapper.find("input[name='data[end]']");i.start_date_locale=t(a),i.end_date_locale=t(n)},EventEditDialog.prototype.close=function(){this.$wrapper.trigger("close")},EventEditDialog}(jQuery),EventViewDialog=function(e){return EventViewDialog=function(e){var t=this;t.$dialogWrapper=e.$wrapper,t.$wrapper=t.$dialogWrapper.find(".t-dialog-block"),t.event_id=e.event_id,t.event_edit_uri="?module=schedule&action=eventEdit",t.xhr=!1,t.initClass()},EventViewDialog.prototype.initClass=function(){var e=this;e.$wrapper.on("click",".js-edit-event",function(t){t.preventDefault(),e.showEditForm()})},EventViewDialog.prototype.showEditForm=function(){var t=this,i={"data[id]":t.event_id};t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.post(t.event_edit_uri,i,function(i){var a=(t.$wrapper.offset(),e.team.calendar);t.close();var n=new TeamDialog({html:i});a.addDialog(n)})},EventViewDialog.prototype.close=function(){this.$wrapper.trigger("close")},EventViewDialog}(jQuery),EventDeleteDialog=function(e){return EventDeleteDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.event_id=e.event_id,t.is_locked=!1,t.initClass()},EventDeleteDialog.prototype.initClass=function(){var e=this;e.$block.on("click",".js-delete-event",function(t){t.preventDefault(),e.is_locked||e.delete()})},EventDeleteDialog.prototype.delete=function(){var t=this,i={id:t.event_id};t.is_locked=!0,e.post("?module=schedule&action=eventDelete",i,function(i){"ok"==i.status&&(i.data&&i.data.message&&alert(i.data.message),t.$wrapper.trigger("close"),e.team.calendar.reload())})},EventDeleteDialog}(jQuery),GroupPage=function(e){return GroupPage=function(e){var t=this;t.$wrapper=e.$wrapper,t.group_id=e.group_id,t.map_adapter=e.map_adapter,t.latitude=e.latitude,t.longitude=e.longitude,t.can_manage=e.can_manage,t.map_is_render=!1,t.map_is_shown=!1,t.initClass()},GroupPage.prototype.initClass=function(){var e=this;e.bindEvents(),e.can_manage&&(e.initEditableName(),e.initEditableDescription()),e.initInfoBlock()},GroupPage.prototype.bindEvents=function(){var e=this;e.map_adapter&&e.latitude&&e.longitude&&e.$wrapper.on("click",".js-open-map-link",function(){e.showMap()})},GroupPage.prototype.showMap=function(){var e=this,t=e.$wrapper.find(".t-map-wrapper");e.map_is_shown?t.slideUp(200):e.map_is_render?t.slideDown(200):(t.show(),e.initMap(),e.map_is_render=!0),e.map_is_shown=!e.map_is_shown},GroupPage.prototype.initMap=function(){var e=this,t=e.$wrapper.find("#t-location-map");new TeamMap(t,e.map_adapter).render(e.latitude,e.longitude)},GroupPage.prototype.initEditableName=function(){var t=this,i=t.$wrapper.find(".js-name-editable").first();i.length&&new TeamEditable({$wrapper:i,onSave:function(i){var a=i.$field.val();if(a.length&&i.text!==a){var n=e.team.app_url+"?module=group&action=save",r={"data[id]":t.group_id,"data[name]":a};i.$field.attr("disabled",!0);var o=e('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(i.$field);e.post(n,r,function(){i.$field.attr("disabled",!1),o.remove(),i.text=a,i.$wrapper.text(a),i.toggle("hide"),e.team.sidebar.reload()})}else a.length||i.$field.val(i.text),i.toggle("hide")}})},GroupPage.prototype.initEditableDescription=function(){var t=this,i=t.$wrapper.find(".js-desc-editable").first();i.length&&new TeamEditable({$wrapper:i,onSave:function(i){var a=i.$field.val(),n=!a.length;if(i.text!==a){var r=e.team.app_url+"?module=group&action=save",o={"data[id]":t.group_id,"data[description]":a};i.$field.attr("disabled",!0);var s=e('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(i.$field);e.post(r,o,function(){i.$field.attr("disabled",!1),s.remove(),i.is_empty=n,i.text=a,i.$wrapper.text(a),i.toggle("hide"),n&&e.team.content.reload()})}else i.toggle("hide")}})},GroupPage.prototype.initInfoBlock=function(){var t=this,i=t.$wrapper.find(".t-info-notice-wrapper"),a=new e.store,n="team/empty_group_notice_hide";a.get(n)?i.hide():i.show(),i.find(".t-info-notice-toggle").on("click",function(){a.set(n,1),i.hide()})},GroupPage}(jQuery),GroupManage=function(e){return GroupManage=function(e){var t=this;t.$wrapper=e.$wrapper,t.$groupUsersW=t.$wrapper.find(".t-users-list.is-used-list"),t.$groupUsersHint=t.$wrapper.find(".t-empty-users-in-group"),t.$otherUsersW=t.$wrapper.find(".t-users-list.is-unused-list"),t.$otherUsersHint=t.$wrapper.find(".t-empty-users-outside-group"),t.group_id=e.group_id,t.hidden_class="is-hidden",t.locales=e.locales,t.$sidebarLink=!1,t.is_locked=!1,t.xhr=!1,t.group_count=t.$groupUsersW.find(".t-user-wrapper").length,t.other_count=t.$otherUsersW.find(".t-user-wrapper").length,t.initClass()},GroupManage.prototype.initClass=function(){var e=this;e.bindEvents(),e.initAutoComplete(),e.initEditableName()},GroupManage.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".js-edit-group",function(e){e.preventDefault(),t.group_id&&!t.is_locked&&t.showEditGroupDialog()}),t.$wrapper.on("click",".js-delete-group",function(e){e.preventDefault(),t.group_id&&!t.is_locked&&t.showDeleteDialog()}),t.$groupUsersW.on("click",".js-move-user",function(i){i.preventDefault(),t.is_locked||t.moveUser(e(this).closest(".t-user-wrapper"),!1)}),t.$otherUsersW.on("click",".js-move-user",function(i){i.preventDefault(),t.is_locked||t.moveUser(e(this).closest(".t-user-wrapper"),!0)})},GroupManage.prototype.showEditGroupDialog=function(){var t=this,i={id:t.group_id};t.is_locked||(t.is_locked=!0,t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get("?module=group&action=edit",i,function(e){new TeamDialog({html:e}),t.is_locked=!1}))},GroupManage.prototype.showDeleteDialog=function(){var t=this,i=e.team.app_url+"?module=group&action=deleteConfirm",a={id:t.group_id};t.is_locked||(t.is_locked=!0,t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get(i,a,function(e){new TeamDialog({html:e}),t.is_locked=!1,t.$wrapper.trigger("close")}))},GroupManage.prototype.moveUser=function(t,i){var a,n=this,r={user_id:t.data("user-id"),group_id:n.group_id};n.is_locked||(n.xhr&&(n.xhr.abort(),n.xhr=!1),a=i?e.team.app_url+"?module=group&action=userAdd":e.team.app_url+"?module=group&action=userRemove",n.xhr=e.post(a,r,function(e){"ok"==e.status&&(i?(n.$groupUsersW.append(t),n.group_count++,n.other_count--):(n.$otherUsersW.prepend(t),n.group_count--,n.other_count++),n.group_count<=0?(n.$groupUsersW.addClass(n.hidden_class),n.$groupUsersHint.removeClass(n.hidden_class)):(n.$groupUsersW.removeClass(n.hidden_class),n.$groupUsersHint.addClass(n.hidden_class)),n.other_count<=0?(n.$otherUsersW.addClass(n.hidden_class),n.$otherUsersHint.removeClass(n.hidden_class)):(n.$otherUsersW.removeClass(n.hidden_class),n.$otherUsersHint.addClass(n.hidden_class)),n.setCount(n.group_count)),n.is_locked=!1}))},GroupManage.prototype.setCount=function(t){var i=this,a=e.team.app_url+"group/"+i.group_id+"/";if(i.$sidebarLink||(i.$sidebarLink=e.team.sidebar.$wrapper.find('a[href="'+a+'"] ')),i.$sidebarLink.length){var n,r=i.$sidebarLink.closest("li");r.find(".indicator").remove(),n=r.find(".count"),n.text(t),e.team.sidebar.saveCount(a,t)}},GroupManage.prototype.initAutoComplete=function(){function t(){clearTimeout(l),s.length&&(s.remove(),s=!1)}function i(i){s=e('<span class="t-hint"><i class="icon16 yes"></i>'+i+"</span>"),o.after(s),l=setTimeout(t,1e3)}function a(t,i){var a=e.team.app_url+"?module=autocomplete&type=user",n={term:t.term};r.group_id&&(n.group_id=r.group_id),e.post(a,n,function(e){i(e)},"json")}function n(e){var t=r.$otherUsersW.find('.t-user-wrapper[data-user-id="'+e+'"]');t.length?(t.find(".js-move-user").click(),i(r.locales.added)):i(r.locales.in_group)}var r=this,o=r.$wrapper.find(".t-autocomplete-wrapper .t-input"),s=!1,l=0;o.autocomplete({source:a,minLength:2,open:function(){t()},focus:function(){return!1},select:function(e,t){return t.item.id&&n(t.item.id),o.val(""),!1}})},GroupManage.prototype.initEditableName=function(){var t=this,i=t.$wrapper.find(".js-name-editable").first();i.length&&new TeamEditable({$wrapper:i,onSave:function(i){var a=i.$field.val();if(a.length&&i.text!==a){var n=e.team.app_url+"?module=group&action=save",r={"data[id]":t.group_id,"data[name]":a};i.$field.attr("disabled",!0);var o=e('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(i.$field);e.post(n,r,function(){i.$field.attr("disabled",!1),o.remove(),i.text=a,i.$wrapper.text(a),i.toggle("hide"),e.team.sidebar.reload()})}else a.length||i.$field.val(i.text),i.toggle("hide")}})},GroupManage}(jQuery),GroupEditDialog=function(e){return GroupEditDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.$form=t.$block.find("form"),t.$iconToggle=t.$block.find(".t-icon-toggle"),t.$addressToggle=t.$block.find(".t-address-toggle"),t.$mapToggle=t.$block.find(".t-map-toggle"),t.$submitButton=t.$form.find('input[type="submit"]'),t.selected_class="is-selected",t.hidden_class="is-hidden",t.has_error_class="error",t.locales=e.locales,t.dialog=t.$wrapper.data("teamDialog"),t.$activeType=t.$block.find(".t-type-toggle ."+t.selected_class),t.$activeIcon=t.$iconToggle.find("."+t.selected_class),t.is_locked=!1,t.save_timeout=0,t.is_map_loading=!1,t.bindEvents(),t.teamMap=t.initMap(e.map_type||"google")},GroupEditDialog.prototype.bindEvents=function(){var t=this;t.$block.on("click",".t-type-toggle .t-toggle-item",function(i){i.stopPropagation(),
t.setType(e(this))}),t.$iconToggle.on("click",".t-icon-item",function(i){i.preventDefault(),t.setIcon(e(this))}),t.$form.on("submit",function(e){e.preventDefault(),t.is_locked||(t.$form.find(".js-submit-loading").remove(),t.$submitButton.parent().append("<i class='icon16 loading js-submit-loading'></i>"),t.save())}),t.$form.find("input, textarea").on("mousedown",function(){var i=e(this),a=i.hasClass(t.has_error_class);t.$form.find(".js-submit-loading").remove(),a&&i.removeClass(t.has_error_class).closest(".value").find(".t-error").remove()})},GroupEditDialog.prototype.setType=function(e){var t=this,i=e.data("type");if(e.hasClass(t.selected_class))return!1;t.$activeType.length&&t.$activeType.removeClass(t.selected_class),"group"==i?(t.$iconToggle.removeClass(t.hidden_class),t.$addressToggle.addClass(t.hidden_class),t.$mapToggle.addClass(t.hidden_class)):(t.$iconToggle.addClass(t.hidden_class),t.$addressToggle.removeClass(t.hidden_class),t.$mapToggle.removeClass(t.hidden_class)),e.addClass(t.selected_class),t.$activeType=e,t.dialog.resize()},GroupEditDialog.prototype.setIcon=function(e){var t=this,i=e.data("icon-class");if(e.hasClass(t.selected_class))return!1;t.$activeIcon.length&&t.$activeIcon.removeClass(t.selected_class),t.$form.find('input[name="data[icon]"]').val(i).trigger("change"),e.addClass(t.selected_class),t.$activeIcon=e},GroupEditDialog.prototype.save=function(t){var i,a=this;if(t=t||0,!a.is_locked)if(a.is_locked=!0,i=function(t){var i={},n=[];return e.each(t,function(e,t){i[t.name]=t.value}),e.trim(i["data[name]"]).length||n.push({field:"data[name]",locale:"empty"}),n.length?(function(t){a.$form.find(".t-error").remove(),e.each(t,function(e,t){var i=a.$form.find("[name='"+t.field+"']");i.length&&i.addClass(a.has_error_class).after('<span class="t-error">'+a.locales[t.locale]+"</span>")})}(n),!1):i}(a.$form.serializeArray())){if(a.is_map_loading&&t<5)return a.is_locked=!1,a.save_timeout=setTimeout(function(){e.contains(document,a.$wrapper[0])&&a.save(t+1)},1e3),!1;var n=function(){e.post("?module=group&action=save",i,function(t){if("ok"==t.status){var i=e.team.app_url+"group/"+t.data.id+"/manage/";e.team.content.load(i),e.team.sidebar.reload(),a.is_locked=!1}})},r=i["data[location][address]"],o=i["data[location][latitude]"],s=i["data[location][longitude]"];if(r&&(!o||!s)&&a.teamMap)return void a.teamMap.geocode(r,function(e,t){i["data[location][latitude]"]=e,i["data[location][longitude]"]=t,n()},function(){n()});n()}else a.is_locked=!1},GroupEditDialog.prototype.initMap=function(t){function i(t){function i(e,t){d.is(":hidden")&&(d.show(),r.data("top",r.offset().top),r.css("top",r.data("top")-d.height()/2)),a.render(e,t),l.val(e),s.val(t)}clearTimeout(u),"string"===e.type(t)?(n.is_map_loading=!0,a.geocode(t,function(e,t){l.val(e),s.val(t),c.hide(),i(e,t),n.is_map_loading=!1},function(){d.hide(),s.val(""),l.val(""),c.show(),n.is_map_loading=!1})):i(t.lat,t.lng)}var a,n=this,r=n.$block,o=n.$addressToggle.find(".f-location-edit-address-input"),s=n.$addressToggle.find(".t-location-longitude-input"),l=n.$addressToggle.find(".t-location-latitude-input"),d=n.$mapToggle.find(".t-location-edit-map"),c=n.$addressToggle.find(".t-map-hint"),u=0;if(o.length>0){var p=n.$form.find(".value").first().width();d.width(p),d.height(p/1.618)}a=new TeamMap(d,t);var f=s.val(),h=l.val();return f&&h&&i({lat:h,lng:f}),o.on("change",function(){var t=e(this).val();t.length?i(t):(s.val(""),l.val(""),d.hide())}),o.on("keyup",function(){clearTimeout(u);var t=e(this).val();t.length?(n.is_map_loading=!0,u=setTimeout(function(){i(t)},1e3)):(s.val(""),l.val(""),d.hide())}),a},GroupEditDialog}(jQuery),GroupDeleteDialog=function(e){return GroupDeleteDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.api_enabled=window.history&&window.history.replaceState,t.group_id=e.group_id,t.is_locked=!1,t.initClass()},GroupDeleteDialog.prototype.initClass=function(){var e=this;e.$block.on("click",".js-delete-event",function(t){t.preventDefault(),e.is_locked||e.delete()})},GroupDeleteDialog.prototype.delete=function(){var t=this,i={id:t.group_id};t.is_locked=!0,e.post("?module=group&action=delete",i,function(i){"ok"==i.status&&(t.$wrapper.trigger("close"),t.api_enabled?(history.state.content_uri=e.team.app_url,history.replaceState({reload:!0,content_uri:e.team.app_url},"",e.team.app_url),e.team.sidebar.reload(),e.team.content.reload()):location.href=e.team.app_url)},"json")},GroupDeleteDialog}(jQuery),InvitePage=function(e){return InvitePage=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-invite-block"),t.$form=t.$wrapper.find("form"),t.errors=e.errors,t.error_class="error",t.backend_url=e.backend_url||"",t.is_locked=!1,t.initClass()},InvitePage.prototype.initClass=function(){var e=this;e.showErrors(),e.bindEvents(),e.autoCenter(),e.initProfileWebasystIDHelpLink()},InvitePage.prototype.bindEvents=function(){var t=this;t.$form.on("keydown change","."+t.error_class,function(){e(this).removeClass(t.error_class).parent().find(".errormsg").remove()}),e(window).on("resize",function(){t.autoCenter()})},InvitePage.prototype.showErrors=function(){var t=this,i=t.$form,a=t.errors,n=i.find(":submit:first");e.each(a,function(a,r){var o=i.find('[name="data['+a+']"]');o.length?o.addClass(t.error_class):o=n,o.parent().append(e('<em class="errormsg"></em>').text(r))})},InvitePage.prototype.autoCenter=function(){var t,i=this,a=i.$block,n=a.outerHeight(),r=e(window).height();t=parseInt((r-n)/2),t<10&&(t=10),a.css({top:t})},InvitePage.prototype.initProfileWebasystIDHelpLink=function(){var t=this,i=function(){var i=t.backend_url+"?module=backend&action=webasystIDHelp";e.get(i,function(t){e("body").append(t)})};e(".js-waid-hint").on("click",function(e){e.preventDefault(),i()})},InvitePage}(jQuery),LongActionProcess=function(e){var t,i,a,n,r,o,s,l,d="",c="",u=500,p=750,f=[],h={},m=null,v=!1,g=function(){for(;f.length>0;){var e=f.shift();e&&clearTimeout(e)}},w=function(){var i=e.extend(!0,{},h);i.processId=c,i.cleanup=1,e.post(d,i,function(e){t&&t(e)}).always(function(){g()})},y=function(t){if(!v){t=t||u;var o=setTimeout(function(){var t=e.extend(!0,{},h);t.processId=c,e.post(d,t,function(e){e?e.ready?(i&&i.call(m,e),w()):e.error?n&&n.call(m,e):e.progress?(a&&a.call(m,e),y()):e.warning?(r&&r.call(m,e),y()):y(p):y(p),l&&l.call(m,e)},"json").error(function(){y(p)})},t);f.push(o)}},_=function(){o&&o();var t=e.extend(!0,{},h);e.post(d,t,function(e){e&&e.processId?(c=e.processId,y(100),y(200)):e&&e.error?n&&n.call(m,e):n&&n.call(m,"Server error")},"json").error(function(){n&&n.call(m,"Server error")})},b=function(){v=!0,s&&s.call(m),g()},$=function(e){if(!e.url)throw new Error("Url is required");d=e.url,u=e.step_delay||u,p=e.rest_delay||p,h=e.post_data||h,t=e.onCleanup,i=e.onReady,a=e.onProgress,n=e.onError,r=e.onWarning,o=e.onStart,s=e.onStop,l=e.onAlways,m=this};return e.extend($.prototype,{start:_,stop:b}),$}(jQuery),TeamMap=function(e){var t=function(t,i,a){var n=this;if(a=a||{},!t)throw Error("DOM element is required");n.$map=e(t),n.provider=i,n.provider&&["google","yandex","disabled"].indexOf(n.provider)<0&&console.error("Not supported map provider: %s".replace("%s",n.provider)),n.map_info=null,n.initClass()};return t.prototype.initClass=function(){},t.prototype.render=function(e,t){var i=this;switch(i.provider){case"google":return i.googleRender(e,t);case"yandex":return i.yandexRender(e,t);default:return}},t.prototype.googleRender=function(i,a){var n=this;n.map_info=n.map_info||{};var r=new google.maps.LatLng(i,a);if(!n.map_info.map){var o={zoom:12,center:r,mapTypeId:google.maps.MapTypeId.ROADMAP};n.map_info.map=new google.maps.Map(n.$map.get(0),o)}n.map_info.marker&&n.map_info.marker.setMap(null),n.map_info.marker=new google.maps.Marker({position:r,map:n.map_info.map}),n.map_info.map.setCenter(r),t.google_error_html=t.google_error_html||"",setTimeout(function(){if(n.$map.find(".gm-err-container").length){n.$map.find(".gm-err-container").find(".gm-err-message").last().after('<div class="gm-err-message">'+e.team.locales.map_check_your_key+"</div>"),t.google_error_html=n.$map.find(".gm-err-container").parent().html()}else if(!n.$map.find(".gm-style").length)if(t.google_error_html)n.$map.children().html(t.google_error_html);else{var i='<div class="gm-err-container"><div class="gm-err-content"><div class="gm-err-icon"><img src="https://maps.gstatic.com/mapfiles/api-3/images/icon_error.png" draggable="false" style="user-select: none;"></div><div class="gm-err-title">:title:</div><div class="gm-err-message">:message1:</div><div class="gm-err-message">:message2:</div></div></div>';i=i.replace(":title:",e.team.locales.map_error_title),i=i.replace(":message1:",e.team.locales.map_error_message),i=i.replace(":message2:",e.team.locales.map_check_your_key),n.$map.children().html(i)}},5e3)},t.prototype.yandexRender=function(e,t){var i=this;i.map_info=i.map_info||{};var a=[e,t];if(!i.map_info.map){var n={zoom:12,center:a,controls:["zoomControl","fullscreenControl"]};i.map_info.map=new ymaps.Map(i.$map.get(0),n)}i.map_info.marker&&i.map_info.map.geoObjects.remove(i.map_info.marker),i.map_info.marker=new ymaps.Placemark(a),i.map_info.map.geoObjects.add(i.map_info.marker),i.map_info.map.setCenter(a)},t.prototype.geocode=function(e,t,i){var a=this;switch(a.provider){case"google":return a.googleGeocode(e,t,i);case"yandex":return a.yandexGeocode(e,t,i);default:i?i():t&&t()}},t.prototype.googleGeocode=function(e,t,i){var a=new google.maps.Geocoder,n=!1,r=!1;a.geocode({address:e},function(e,a){if(n=!0,!r)if(a==google.maps.GeocoderStatus.OK){var o=e[0].geometry.location;t(o.lat(),o.lng())}else i&&i()}),setTimeout(function(){n||(r=!0,i&&i(!0))},5e3)},t.prototype.yandexGeocode=function(e,t,i){ymaps.geocode(e,{results:1}).then(function(e){var a=1;if(e.metaData&&e.metaData.geocoder&&"found"in e.metaData.geocoder&&(a=e.metaData.geocoder.found),a<=0)return void i();var n=e.geoObjects.get(0),r=n.geometry.getCoordinates();t(r[0],r[1])},function(e){i(e)})},t}(jQuery);!function(e){function t(t,i){"number"==typeof t&&(i=t),i=i||0;var a=0;if(t&&t.length){var n=t.offset();n&&n.top&&(a=n.top)}var r=window,o=window.parent,s=0;o&&e(o.document).find("iframe").each(function(){if(this.contentWindow==r){var t=e(this).offset();s=t&&t.top?t.top:0}});var l=Math.max(Math.floor(a+i+s),0);e((o||r).document).find("html,body").stop().animate({scrollTop:l},500)}e.wa.fieldTypesFactory=function(t,i){"use strict";return t=t||e.wa.contactEditorFactory(),t.baseFieldType||(t.baseFieldType={contactType:"person",options:{},createEditor:function(t){this.contactType=t||"person";var i=e.extend({},this);return delete i.createEditor,delete i.initializeFactory,i.parentEditorData={},i.initialize(),i},fieldValue:"",initializeFactory:function(e,t){this.fieldData=e,this.options=t||{}},initialize:function(){this.setValue("")},reinit:function(){this.currentMode="null",this.initialize()},setValue:function(t){this.fieldValue=t,"null"!=this.currentMode&&null!==this.domElement&&("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(e.wa.encodeHTML(this.fieldValue)))},getValue:function(){var e=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var t=this.domElement.find(".val");t.length>0&&(e="",t.hasClass("empty")||("checkbox"!=t.attr("type")||t.attr("checked"))&&(e=t.val()))}return e},isModified:function(){return this.fieldValue!=this.getValue()},validate:function(e){var t=this.getValue();return e||!this.fieldData.required||t?null:$_("This field is required.")},newFieldElement:function(i){this.fieldData.read_only&&(i="view");var a=this.newInlineFieldElement(i);if(null===a&&(!this.fieldData.show_empty||"edit"==i))return e('<div style="display: none" class="field" data-field-id="'+this.fieldData.id+'"></div>');var n;return"person"===this.contactType?["firstname","middlename","lastname"].indexOf(this.fieldData.id)>=0?(n="subname",a.find(".val").attr("placeholder",this.fieldData.name).attr("title",this.fieldData.name)):"title"===this.fieldData.id?(n="subname title",a.find(".val").attr("placeholder",this.fieldData.name).attr("title",this.fieldData.name)):"jobtitle"===this.fieldData.id?n="jobtitle-company jobtitle":"company"===this.fieldData.id&&(n="jobtitle-company company"):"company"===this.fieldData.id&&(n="company"),t.wrapper(a,this.fieldData.name+"",n).attr("data-field-id",this.fieldData.id)},newInlineFieldElement:function(t){if("view"==t&&!this.fieldValue)return null;var i=e.isPlainObject(this.fieldValue)?this.fieldValue.value:this.fieldValue,a=null;return"edit"==t?(a=e('<span><input class="val" type="text"></span>'),a.find(".val").val(i)):(a=e('<span class="val"></span>'),a.text(i)),a},showValidationErrors:function(t){if(null!==this.domElement){var i=this.domElement.find(".val");i.parents(".value").children("em.errormsg").remove(),null!==t?(i.parents(".value").append(e('<em class="errormsg">'+t+"</em>")),i.addClass("error")):i.removeClass("error")}},fieldData:null,domElement:null,currentMode:"null",parentEditor:null,parentEditorData:null,setMode:function(e,t){if(void 0===t&&(t=!0),"view"!=e&&"edit"!=e)throw new Error("Unknown mode: "+e);if(this.currentMode!=e&&(this.currentMode=e,t)){var i=this.domElement;this.domElement=this.newFieldElement(e),null!==i&&i.replaceWith(this.domElement)}return this.domElement}}),t.factoryTypes.Hidden=e.extend({},t.baseFieldType,{newFieldElement:function(e){var i=this.newInlineFieldElement(e);return t.wrapper(i,this.fieldData.name).attr("data-field-id",this.fieldData.id).hide()},newInlineFieldElement:function(t){if("view"==t&&!this.fieldValue)return null;var i=null;return"edit"==t&&(i=e('<span><input type="hidden" class="val" type="text"></span>'),i.find(".val").val(this.fieldValue)),i}}),t.factoryTypes.String=e.extend({},t.baseFieldType,{setValue:function(t){this.fieldValue=t,"null"!=this.currentMode&&null!==this.domElement&&("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(e.wa.encodeHTML(this.fieldValue)))},getValue:function(){var e=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var t=this.domElement.find(".val");e="",t.hasClass("empty")||(e=t.val())}return e},newInlineFieldElement:function(t){if("view"==t&&!this.fieldValue)return null;var i=null,a=this.fieldValue;if("edit"==t)i=e(this.fieldData.input_height<=1?'<span><input class="val" type="text"><i class="icon16 loading" style="display:none;"></i></span>':'<span><textarea class="val" rows="'+this.fieldData.input_height+'"></textarea></span>'),i.find(".val").val(a);else if(this.fieldData.input_height<=1)i=e('<span class="val"></span><i class="icon16 loading" style="display:none;">').text(a);else{var n=e.wa.encodeHTML(a||"").replace(/\n/g,"<br>");i=e('<span class="val"></span><i class="icon16 loading" style="display:none;">').html(n)}return i},setMode:function(e,t){if(void 0===t&&(t=!0),"view"!=e&&"edit"!=e)throw new Error("Unknown mode: "+e);if(this.currentMode!=e&&(this.currentMode=e,t)){var i=this.domElement;this.domElement=this.newFieldElement(e),null!==i&&i.replaceWith(this.domElement)}return this.domElement}}),t.factoryTypes.Text=e.extend({},t.factoryTypes.String),t.factoryTypes.Phone=e.extend({},t.baseFieldType),t.factoryTypes.Select=e.extend({},t.baseFieldType,{notSet:function(){return""},newInlineFieldElement:function(t){if("view"==t&&!this.fieldValue)return null;if("view"==t)return e('<span class="val"></span>').text(this.fieldData.options[this.fieldValue]||this.fieldValue);for(var i,a="",n=!1,r=0;r<this.fieldData.oOrder.length;r++){var o=this.fieldData.oOrder[r];!n&&o==this.fieldValue&&this.fieldValue?(n=!0,i=" selected"):i="",""===o&&(i+=" disabled"),o=o||"",o="string"==typeof o?o:""+o;a+='<option value="{$id}" {$attrs}>{$text}</option>'.replace("{$id}",e.wa.encodeHTML(o).replace('"',"&quot;")).replace("{$attrs}",i).replace("{$text}",e.wa.encodeHTML(this.fieldData.options[o]))}return e('<div><select class="val '+(this.fieldData.type+"").toLowerCase()+'"><option value=""'+(n?"":" selected")+">"+this.notSet()+"</option>"+a+"</select></div>")}}),t.factoryTypes.Conditional=e.extend({},t.factoryTypes.Select,{unbindEventHandlers:function(){},getValue:function(){var e=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var t=this.domElement.find(".val:visible");t.length>0&&(e=t.hasClass("empty")?"":t.val())}return e},newInlineFieldElement:function(i){if("view"==i&&!this.fieldValue)return null;if(this.unbindEventHandlers(),"view"==i)return e("<div></div>").append(e('<span class="val"></span>').text(this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue));for(var a=this,n=(a.fieldData.parent_field||"").split(":"),r=t.fieldEditors[n.shift()];r&&n.length;){var o=r.subfieldEditors;if(o instanceof Array){r=null;for(var s=0;s<o.length;s++)if(o[s]===a.parentEditor){r=o[s];break}}else r=o[n.shift()]}if(r){var l=this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue,d=e('<input type="text" class="hidden val">').val(l),c=e('<select class="hidden val"></select>').hide(),u=function(){return d.is(":visible")?d.val():c.is(":visible")?c.val():l},p=function(){var t=e(this),i=u(),n=(t.val()||"").toLowerCase(),r=a.fieldData.parent_options[n];if(r){for(d.hide(),c.show().children().remove(),s=0;s<r.length;s++)c.append(e("<option></option>").attr("value",r[s]).text(r[s]).attr("selected",a.fieldValue==r[s]));c.val(i)}else d.val(i||"").show().blur(),c.hide()};return setTimeout(function(){if(!r.domElement)return void d.show();r.domElement.on("change",".val",p);var e=r.domElement.find(".val:visible");e.length&&p.call(e.get(0))},0),a.unbindEventHandlers=function(){p&&r.domElement&&r.domElement.find(".val").unbind("change",p),a.unbindEventHandlers=function(){}},e("<div></div>").append(d).append(c)}return e("<div></div>").append(e('<input type="text" class="val">').val(a.fieldValue))}}),t.factoryTypes.Timezone=e.extend({},t.factoryTypes.Select,{notSet:function(){return $_("Auto")}}),t.factoryTypes.Region=e.extend({},t.factoryTypes.Select,{notSet:function(){return""},unbindEventHandlers:function(){},setCurrentCountry:function(){var e=this.current_country;return this.current_country=this.parentEditorData.parent.subfieldEditors.country.getValue(),e!==this.current_country&&(delete this.fieldData.options,!0)},getRegionsControllerUrl:function(e){return t.getRegionsUrl()+e},newInlineFieldElement:function(i){if("view"==i&&!this.fieldValue)return null;this.unbindEventHandlers();var a=this.options||{};if(void 0!==a.country&&(this.current_country=a.country),"view"==i)return e("<div></div>").append(e('<span class="val"></span>').text(this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue));var n=this;if(this.parentEditorData.parent&&this.parentEditorData.parent.subfieldEditors.country){this.setCurrentCountry();var r;e(document).on("change","select.country",r=function(){if(n.setCurrentCountry()){var t="",a=n.domElement.find(".val");t=a.is("input")?a.val().trim():a.find(":selected").text().trim();var r=function(t,i){var a=i.toLocaleLowerCase();t.find("option").each(function(){if(e(this).text().trim().toLocaleLowerCase()===a)return e(this).attr("selected",!0),!1})};n.domElement.empty().append(n.newInlineFieldElement(i).children());var o=n.domElement.find(".val");o.is("input")&&!o.val()?o.val(t):o.is("select")&&t?r(o,t):n.domElement.unbind("load.fieldTypes").bind("load.fieldTypes",function(){var e=n.domElement.find(".val");e.is("select")&&t&&r(e,t)})}}),n.unbindEventHandlers=function(){e(document).off("change","select.country",r),n.unbindEventHandlers=function(){}}}if(!a.no_ajax_select&&void 0===this.fieldData.options&&this.current_country&&this.fieldData.region_countries[this.current_country]){var o=this.current_country;return e.get(this.getRegionsControllerUrl(o),function(t){if(i===n.currentMode&&o===n.current_country){n.fieldData.options=t.data.options||!1,n.fieldData.oOrder=t.data.oOrder||[],e.isPlainObject(n.options)&&void 0!==n.options.country&&delete n.options.country;e("<div></div>").append(n.newInlineFieldElement(i).children()),n.domElement.empty().append(n.newInlineFieldElement(i).children()),n.domElement.trigger("load")}},"json"),e("<div></div>").append(e('<i class="icon16 loading"></i>'))}if(this.fieldData.options)return e("<div></div>").append(t.factoryTypes.Select.newInlineFieldElement.call(this,i));var s=e("<div></div>").append(t.baseFieldType.newInlineFieldElement.call(this,i));return s.find(".val").attr("placeholder",this.fieldData.name+(this.fieldData.required?" ("+$_("required")+")":"")),s}}),t.factoryTypes.Country=e.extend({},t.factoryTypes.Select),t.factoryTypes.Checklist=e.extend({},t.baseFieldType,{validate:function(e){return null},setValue:function(e){if(this.fieldValue=e,"edit"==this.currentMode&&this.domElement){this.domElement.find('input[type="checkbox"]').attr("checked",!1);for(var t in this.fieldValue)this.domElement.find('input[type="checkbox"][value="'+t+'"]').attr("checked",!0)}else"view"==this.currentMode&&this.domElement&&this.domElement.find(".val").html(this.getValueView())},getValue:function(){if("edit"!=this.currentMode||!this.domElement)return this.fieldValue;var t=[];return this.domElement.find('input[type="checkbox"]:checked').each(function(i,a){t.push(e(a).val())}),t},getValueView:function(){for(var e="",i=0;i<this.fieldData.oOrder.length;i++){var a=this.fieldData.oOrder[i];this.fieldValue.indexOf(a)<0||(e+=(e?", ":"")+'<a href="'+(this.fieldData.hrefPrefix||"#")+a+'">'+(this.fieldData.options[a]&&t.htmlentities(this.fieldData.options[a])||$_("&lt;no name&gt;"))+"</a>")}return e||$_("&lt;none&gt;")},newInlineFieldElement:function(i){if(!("view"!=i||this.fieldValue&&this.fieldValue.length))return null;if("view"==i)return e('<span class="val"></span>').html(this.getValueView());var a,n=0;for(a in this.fieldData.options)if(++n>1)break;if(!n)return null;for(var r="",o=0;o<this.fieldData.oOrder.length;o++)a=this.fieldData.oOrder[o],r+='<li><label><input type="checkbox" value="'+a+'"',this.fieldData.disabled&&this.fieldData.disabled[a]&&(r+=' disabled="disabled"'),-1!==(this.fieldValue||[]).indexOf(a)&&(r+=' checked="checked"'),r+=" />"+(this.fieldData.options[a]&&t.htmlentities(this.fieldData.options[a])||$_("&lt;no name&gt;"))+"</label></li>";return t.initCheckboxList('<div class="c-checkbox-menu-container val"><div><ul class="menu-v compact with-icons c-checkbox-menu">'+r+"</ul></div></div>")}}),t.factoryTypes.Name=e.extend({},t.baseFieldType,{newInlineFieldElement:null,newFieldElement:function(t){return e('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>')},setValue:function(e){this.fieldValue=e},getValue:function(e){if(this.fieldValue&&!e)return this.fieldValue;var i=[];return"person"==this.contactType?(t.fieldEditors.firstname&&i.push(t.fieldEditors.firstname.getValue()),t.fieldEditors.middlename&&i.push(t.fieldEditors.middlename.getValue()),t.fieldEditors.lastname&&i.push(t.fieldEditors.lastname.getValue())):t.fieldEditors.company&&i.push(t.fieldEditors.company.getValue()),i.join(" ").trim()},validate:function(i){var a=this.getValue(!0);if(!i&&this.fieldData.required&&!a){var n=e("#contact-info-block input:visible:text[value]:not(.empty)").val();if(!n)return $_("At least one of these fields must be filled");t.fieldEditors.firstname.setValue(n)}return null},showValidationErrors:function(i){var a=e("#contact-info-block");if(a.find("div.wa-errors-block").remove(),null!==i){var n=e('<div class="field wa-errors-block"><div class="value"><em class="errormsg">'+i+"</em></div></div>");t.fieldEditors.lastname?t.fieldEditors.lastname.domElement.after(n):a.prepend(n)}for(var r=["firstname","middlename","lastname"],o=0;o<r.length;o++){var s=r[o];t.fieldEditors[s]&&(null!==i?t.fieldEditors[s].domElement.find(".val").addClass("external-error"):t.fieldEditors[s].domElement.find(".val").removeClass("external-error"))}},setMode:function(e,i){if(void 0===i&&(i=!0),"view"!=e&&"edit"!=e)throw new Error("Unknown mode: "+e);if(this.currentMode!=e&&(this.currentMode=e,i)){var a=this.domElement;this.domElement=this.newFieldElement(e),null!==a&&a.replaceWith(this.domElement)}return t.fieldEditors.title&&t.fieldEditors.title.getValue()+" ",this.domElement}}),t.factoryTypes.NameSubfield=e.extend({},t.baseFieldType,{}),t.factoryTypes.Multifield=e.extend({},t.baseFieldType,{subfieldEditors:null,subfieldFactory:null,emptySubValue:null,initializeFactory:function(e){if(this.fieldData=e,void 0!==this.fieldData.ext){this.fieldData.extKeys=[],this.fieldData.extValues=[];for(var t in this.fieldData.ext)this.fieldData.extKeys[this.fieldData.extKeys.length]=t,this.fieldData.extValues[this.fieldData.extValues.length]=this.fieldData.ext[t]}},initialize:function(){this.subfieldFactory=e.extend({},t.factoryTypes[this.fieldData.type]),this.subfieldFactory.parentEditor=this,this.subfieldFactory.initializeFactory(e.extend({},this.fieldData)),this.fieldData=e.extend({},this.fieldData,{required:this.subfieldFactory.fieldData.required}),this.subfieldEditors=[this.subfieldFactory.createEditor(this.contactType)],e.isPlainObject(this.subfieldEditors[0].fieldValue)?(this.emptySubValue=e.extend({},this.subfieldEditors[0].fieldValue),this.fieldData.ext&&(this.emptySubValue.ext=this.fieldData.extKeys[0])):(this.emptySubValue={value:this.subfieldEditors[0].fieldValue},this.fieldData.ext&&(this.emptySubValue.ext=this.fieldData.extKeys[0])),this.fieldValue=[this.emptySubValue]},setValue:function(e){e&&void 0!==e[0]||(e=[this.emptySubValue]),this.fieldValue=e;var t=0;do{if(this.subfieldEditors.length<=t&&(this.subfieldEditors[t]=this.subfieldFactory.createEditor(this.contactType),"null"!=this.currentMode&&this.subfieldEditors[t].setMode(this.currentMode).insertAfter(this.subfieldEditors[t-1].parentEditorData.domElement)),void 0===e[t])throw new Error("At least one record must exist in data at this time.");var i=!1;for(var a in e[t])if("value"!=a&&"ext"!=a&&"status"!=a){i=!0;break}if(this.subfieldEditors[t].setValue(i?e[t]:e[t].value?e[t].value:""),void 0!==this.fieldData.ext){var n=e[t].ext;if("null"!=this.currentMode&&this.subfieldEditors[t].parentEditorData.domElement){var r=this.subfieldEditors[t].parentEditorData.domElement.find("input.ext");r.size()>0&&r[0].setExtValue(n)}}t++}while(t<e.length);if(e.length<this.subfieldEditors.length){for(t=e.length;t<this.subfieldEditors.length;t++)0!==t&&"null"!=this.currentMode&&this.subfieldEditors[t].parentEditorData.domElement.remove();var o=e.length>0?e.length:1;this.subfieldEditors.splice(o,this.subfieldEditors.length-o)}this.origFieldValue=null},getValue:function(){if("null"==this.currentMode)return e.extend({},this.fieldValue);for(var t=[],i=0;i<this.subfieldEditors.length;i++){var a=this.subfieldEditors[i];if(t[i]={value:a.getValue()},void 0!==this.fieldData.ext){var n=this.fieldValue[i].ext,r=a.parentEditorData.domElement.find("input.ext")[0];"edit"==a.currentMode&&r&&(n=r.getExtValue()),t[i].ext=n}}return t},isModified:function(){for(var e=0;e<this.subfieldEditors.length;e++){if(this.subfieldEditors[e].isModified())return!0}return!1},validate:function(e){for(var t=[],i=!0,a=0;a<this.subfieldEditors.length;a++){var n=this.subfieldEditors[a],r=n.validate(!0);r&&(t[a]=r);var o=n.getValue();(o||"string"!=typeof o)&&(i=!1)}return!e&&this.fieldData.required&&i&&(t[0]="This field is required."),t.length<=0?null:t},showValidationErrors:function(e){for(var t=0;t<this.subfieldEditors.length;t++){var i=this.subfieldEditors[t];null!==e&&void 0!==e[t]?i.showValidationErrors(e[t]):i.showValidationErrors(null)}},deleteSubfieldButton:function(t){var i=this,a=e('<a class="delete-subfield hint" href="javascript:void(0)">'+$_("delete")+"</a>").click(function(){if(i.subfieldEditors.length<=1)return!1;var e=i.subfieldEditors.indexOf(t);return"null"!=i.currentMode&&i.subfieldEditors[e].parentEditorData.domElement.remove(),i.subfieldEditors.splice(e,1),i.subfieldEditors.length<=1&&i.domElement.find(".delete-subfield").hide(),!1});return this.subfieldEditors.length<=1&&a.hide(),a},newSubFieldElement:function(i,a){a-=0;var n=this.subfieldEditors[a];n.parentEditorData||(n.parentEditorData={}),n.parentEditorData.parent=this,n.parentEditorData.empty=!1;var r;if("function"!=typeof n.newInlineFieldElement){var o="";0!=a&&"Composite"!==this.fieldData.type||(o=this.fieldData.name+"");var s=t.wrapper('<span class="replace-me-with-value"></span>',o,"no-bot-margins"),l=s.find("span.replace-me-with-value");r=this.fieldValue[a].ext,"edit"==i?r=t.createExtSelect(this.fieldData.ext,r):(r=this.fieldData.ext[this.fieldValue[a].ext]||r,r=e("<strong>"+t.htmlentities(r)+"</strong>")),l.before(r),"edit"==i&&l.before(this.deleteSubfieldButton(n)),l.remove(),n.domElement=this.subfieldEditors[a].newFieldElement(i);var d=this;n.domElement.find("div.name").each(function(e,t){t.innerHTML.substr(0,d.fieldData.name.length)===d.fieldData.name&&(t.innerHTML="")});var c="";return"Composite"===this.fieldData.type&&(c="field-composite-subfields-block"),n.domElement.data("multifield-index",a).attr("data-multifield-index",a),n.parentEditorData.domElement=e('<div class="'+c+'"></div>').append(s).append(n.domElement),n.parentEditorData.empty="edit"!=i&&(!n.fieldValue.value&&!n.fieldData.show_empty),n.parentEditorData.domElement}var u=n.newInlineFieldElement(i);if(null===u)return n.parentEditorData.domElement=n.domElement=e("<div></div>"),n.parentEditorData.empty=!0,n.parentEditorData.domElement;n.domElement=u,n.domElement.data("multifield-index",a).attr("data-multifield-index",a);var p=e('<div class="value"></div>').append(u),f=p.find(".replace-with-ext");return f.size()<=0&&(p.append('<span><span class="replace-with-ext"></span></span>'),f=p.find(".replace-with-ext")),void 0!==this.fieldData.ext&&(r=this.fieldValue[a].ext,"edit"==i?f.before(t.createExtSelect(this.fieldData.ext,r)):(r=this.fieldData.ext[this.fieldValue[a].ext]||r,f.parents(".ext").size()>0?f.before(t.htmlentities(r)):f.before(e('<em class="hint"></em>').text(" "+r)))),"edit"==i&&f.before(this.deleteSubfieldButton(n)),f.remove(),n.parentEditorData.domElement=p,p},newInlineFieldElement:null,newFieldElement:function(i){var a=this;this.fieldData.read_only&&(i="view");for(var n=e('<div class="multifield-subfields"></div>'),r="function"==typeof this.subfieldFactory.newInlineFieldElement,o=!0,s=0;s<this.subfieldEditors.length;s++){var l=this.newSubFieldElement(i,s);l.data("subfieldEditor",this.subfieldEditors[s]),"edit"===i&&l.prepend('<i class="icon16 sort sort-handler"></i>'),n.append(l),o=o&&this.subfieldEditors[s].parentEditorData.empty}if(o&&!this.fieldData.show_empty)return e('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>');var d;if(d=r?e("<div></div>").append(n):e('<div class="field" data-field-id="'+this.fieldData.id+'"></div>').append(n),"edit"==i){var c;c=r?e('<div class="value multifield-subfields-add-another"><span class="replace-me-with-value"></span></div>'):t.wrapper('<span class="replace-me-with-value"></span>');var a=this;c.find(".replace-me-with-value").replaceWith(e('<a href="javascript:void(0)" class="small inline-link"><b><i>'+$_("Add another")+"</i></b></a>").click(function(e){var t=a.subfieldFactory.createEditor(this.contactType),r=a.subfieldEditors.length,o={value:t.getValue(),temp:!0};void 0!==a.fieldData.ext&&(o.ext=""),a.fieldValue[r]=o,a.subfieldEditors[r]=t,"null"!=a.currentMode&&t.setMode(a.currentMode);var s=a.newSubFieldElement(i,r);s.data("subfieldEditor",a.subfieldEditors[r]),s.prepend('<i class="icon16 sort sort-handler"></i>'),n.append(s),a.domElement.find(".delete-subfield").css("display","inline")})),d.append(c),this.fieldData.multi&&e.fn.sortable?d.find(".multifield-subfields").sortable({distance:5,opacity:.75,axis:"y",tolerance:"pointer",items:"> .value, > .field-composite-subfields-block",handle:".sort-handler",cursor:"move",update:function(t,i){var n=i.item,r=n.closest(".multifield-subfields"),o=0
;r.find("[data-multifield-index]").each(function(){var t=e(this),i=t.parent().data("subfieldEditor");a.subfieldEditors[o]=i,t.data("subfieldIndex",o).attr("data-multifield-index",o),o++})}}):console.log(["$.fn.sortable available?",!!e.fn.sortable])}if(r){d=t.wrapper(d,this.fieldData.name+"").attr("data-field-id",this.fieldData.id)}return d},setMode:function(t,i){if(void 0===i&&(i=!0),"view"!=t&&"edit"!=t)throw new Error("Unknown mode: "+t);if(this.currentMode!=t){if("view"==t&&"edit"==this.currentMode&&this.origFieldValue)this.setValue(this.origFieldValue);else if("view"==this.currentMode&&!this.origFieldValue){this.origFieldValue=[];for(var a=0;a<this.fieldValue.length;a++)this.origFieldValue.push(e.extend({},this.fieldValue[a]))}if(this.currentMode=t,i){var n=this.domElement;this.domElement=this.newFieldElement(t),null!==n&&n.replaceWith(this.domElement)}}for(var a=0;a<this.subfieldEditors.length;a++)this.subfieldEditors[a].setMode(t,!1);return this.domElement}}),t.factoryTypes.Composite=e.extend({},t.baseFieldType,{subfieldEditors:null,initializeFactory:function(e,t){if(this.fieldData=e,this.fieldData.required){for(var i in this.fieldData.required)if(this.fieldData.required[i]){this.fieldData.required=!0;break}!0!==this.fieldData.required&&(this.fieldData.required=!1)}this.options=t||{}},initialize:function(){var i={data:{},value:""};this.subfieldEditors={},this.fieldData.subfields=this.fieldData.fields;for(var a in this.fieldData.subfields){var n=this.fieldData.subfields[a],r=e.extend({},t.factoryTypes[n.type]),o=this.fieldData.fields[a];this.fieldData.required&&this.fieldData.required[a]&&(o.required=!0);var s=e.extend({},o,{id:null,multi:!1});r.initializeFactory(s,this.options),r.parentEditor=this,r.parentEditorData={},r.initialize(),r.parentEditorData.sfid=a,r.parentEditorData.parent=this,this.subfieldEditors[a]=r,i.data[a]=r.getValue()}this.fieldValue=i},setValue:function(e){if(e){this.fieldValue=e;for(var t in this.subfieldEditors){var i=this.subfieldEditors[t];void 0===e.data?(i.initialize(),i.setValue(i.getValue())):void 0!==e.data[t]?i.setValue(e.data[t]):i.setValue(i.getValue())}}},getValue:function(){if("null"==this.currentMode)return e.extend({},this.fieldValue.data);var t={};for(var i in this.subfieldEditors){var a=this.subfieldEditors[i];t[i]=a.getValue()}return t},isModified:function(){for(var e in this.subfieldEditors)if(this.subfieldEditors[e].isModified())return!0;return!1},validate:function(e){var t={},i=!1;for(var a in this.subfieldEditors){var n=this.subfieldEditors[a].validate(e);n&&(t[a]=n,i=!0)}return i?t:null},showValidationErrors:function(e){if(null!==this.domElement)for(var t in this.subfieldEditors){var i=this.subfieldEditors[t];null!==e&&void 0!==e[t]?i.showValidationErrors(e[t]):i.showValidationErrors(null)}},newInlineFieldElement:null,newFieldElement:function(i){if(this.fieldData.read_only&&(i="view"),"view"==i&&!this.fieldValue.value&&!this.fieldData.show_empty)return e('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>');var a=e('<div class="composite '+i+' field" data-field-id="'+this.fieldData.id+'"></div>').append(t.wrapper('<span style="display:none" class="replace-with-ext"></span>',this.fieldData.name,"hdr"));for(var n in this.subfieldEditors){var r=this.subfieldEditors[n],o=r.newFieldElement(i);o.attr("data-field-id",n),o.data("fieldId",n),r.domElement=o,a.append(o)}return a},setMode:function(e,t){if(void 0===t&&(t=!0),"view"!=e&&"edit"!=e)throw new Error("Unknown mode: "+e);if(this.currentMode!=e&&(this.currentMode=e,t)){var i=this.domElement;this.domElement=this.newFieldElement(e),null!==i&&i.replaceWith(this.domElement)}for(var a in this.subfieldEditors)this.subfieldEditors[a].setMode(e,!1);return this.domElement}}),t.factoryTypes.Address=e.extend({},t.factoryTypes.Composite,{showValidationErrors:function(t){if(null!==this.domElement&&(this.domElement.find("em.errormsg").remove(),this.domElement.find(".val").removeClass("error"),t))for(var i in this.subfieldEditors){var a=this.subfieldEditors[i];if(void 0!==t[i]){var n=a.domElement.find(".val").addClass("error");n.parents(".address-subfield").append(e('<em class="errormsg">'+t[i]+"</em>"))}}},newInlineFieldElement:function(t){if("view"==t){if(!this.fieldValue.value)return null;var i="";return i="string"==typeof this.fieldValue.for_map?this.fieldValue.for_map:this.fieldValue.for_map.coords?this.fieldValue.for_map.coords:this.fieldValue.for_map.with_street,e('<div class="address-field"></div>').append(this.fieldValue.value).append('<span style="display:none" class="replace-with-ext"></span> ').append('<a target="_blank" href="//maps.google.com/maps?q='+encodeURIComponent(i)+'&z=15" class="small map-link">'+$_("map")+"</a>")}var a=e('<div class="address-field"></div>');a.append('<span style="display:none" class="replace-with-ext"></span>');for(var n in this.subfieldEditors){var r=this.subfieldEditors[n],o=r.newInlineFieldElement("edit");if(r.domElement=o,a.append(e('<div class="address-subfield"></div>').append(o)),"Hidden"!==r.fieldData.type){var s=r.fieldData.name+(r.fieldData.required?" ("+$_("required")+")":"");o.find("input.val,textarea.val").attr("placeholder",s).attr("title",s)}}return a}}),t.factoryTypes.Birthday=e.extend({},t.baseFieldType,{newInlineFieldElement:function(t){if(this.fieldValue=this.fieldValue||{},"view"==t&&!this.fieldValue.value)return null;var i=null,a=this.fieldValue.data||{};if("edit"==t){for(var n=e('<select class="val" data-part="day"><option data=""></option></select>'),r=1;r<=31;r+=1){var o=e('<option data="'+r+'" value="'+r+'">'+r+"</option>");r==a.day&&o.attr("selected",!0),n.append(o)}for(var s=e('<select class="val" data-part="month"><option data=""></option></select>'),l=["January","February","March","April","May","June","July","August","September","October","November","December"],d=0;d<12;d+=1){var c=$_(l[d]),o=e('<option data="'+(d+1)+'"  value="'+(d+1)+'">'+c+"</option>");d+1==a.month&&o.attr("selected",!0),s.append(o)}var u=e('<input type="text" data-part="year" class="val" style="min-width: 32px; width: 32px;" placeholder="'+$_("year")+'">');a.year&&u.val(a.year),i=e("<span></span>").append(n).append(" ").append(s).append(" ").append(u)}else i=e('<span class="val"></span>').text(this.fieldValue.value);return i},getValue:function(){var t=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var i=this.domElement.find(".val");i.length>0&&(t={value:{day:null,month:null,year:null}},i.each(function(){var i=e(this),a=i.data("part");t.value[a]=parseInt(i.val(),10)||null}))}return t},setValue:function(t){if(this.fieldValue=t,"null"!=this.currentMode&&null!==this.domElement)if("edit"==this.currentMode)t&&t.data&&this.domElement.find(".val").each(function(){var i=e(this),a=i.data("part");i.val(t.data[a]||"")});else{var i=this.fieldValue;"object"==typeof this.fieldValue&&this.fieldValue.value&&(i=this.fieldValue.value),this.domElement.find(".val").html(e.wa.encodeHTML(i))}}}),t.factoryTypes.Date=e.extend({},t.factoryTypes.String,{initializeFactory:function(e,t){this.fieldData=e||{},this.options=t||{},this.fieldData.input_height=1},setValue:function(t){this.fieldValue=t,"null"!=this.currentMode&&null!==this.domElement&&("edit"==this.currentMode?this.domElement.find("input:text").datepicker("setDate",this.fieldValue):this.domElement.find(".val").html(e.wa.encodeHTML(this.fieldValue)))},newInlineFieldElement:function(i){var a=t.factoryTypes.String.newInlineFieldElement.call(this,i);if("edit"==i){var n=this,r=a.find("input:text").removeClass("val"),o=e('<input type="hidden" class="val">').insertAfter(r);!function(t){r.datepicker?t():e.wa.loadFiles([e.wa.contactEditor.wa_backend_url+"../wa-content/js/jquery-ui/jquery.ui.core.min.js",e.wa.contactEditor.wa_backend_url+"../wa-content/js/jquery-ui/jquery.ui.datepicker.min.js"]).then(t)}(function(){r.datepicker({altField:o,altFormat:"yy-mm-dd",dateFormat:n.fieldData.format,changeMonth:!0,changeYear:!0,shortYearCutoff:2,showOtherMonths:!0,selectOtherMonths:!0,stepMonths:2,numberOfMonths:2}),n.fieldValue&&r.datepicker("setDate",n.fieldValue),function(e){var t=null;r.keydown(function(){t&&clearTimeout(t),t=setTimeout(function(){e()},250)}),r.change(e)}(function(){e.trim(r.val()).length<=0&&(r.datepicker("setDate",null),n.fieldValue=null)})})}return a}}),t.factoryTypes.IM=e.extend({},t.baseFieldType,{setValue:function(t){void 0===t&&(t=""),e.isPlainObject(t)?(this.fieldValue=t.data,this.viewValue=t.value):this.fieldValue=this.viewValue=t,"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(t){if("view"==t&&!this.fieldValue)return null;var i=null;return"edit"==t?(i=e('<span><input class="val" type="text"></span>'),i.find(".val").val(this.fieldValue)):i=e('<span class="val"></span>').html(this.viewValue),i}}),t.factoryTypes.SocialNetwork=e.extend({},t.baseFieldType,{setValue:function(t){void 0===t&&(t=""),e.isPlainObject(t)?(this.fieldValue=t.data,this.viewValue=t.value):this.fieldValue=this.viewValue=t,"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(t){if("view"==t&&!this.fieldValue)return null;var i=null;return"edit"==t?(i=e('<span><input class="val" type="text"></span>'),i.find(".val").val(this.fieldValue)):i=e('<span class="val"></span>').html(this.viewValue),i}}),t.factoryTypes.Url=e.extend({},t.factoryTypes.IM,{validate:function(t){var i=e.trim(this.getValue());if(!t&&this.fieldData.required&&!i)return $_("This field is required.");if(!i)return null;/^(https?|ftp|gopher|telnet|file|notes|ms-help)/.test(i)||(i="http://"+i,this.setValue(i));var a="[^`!()\\[\\]{};:'\".,<>?«»“”‘’\\s+]",n="[^`!\\[\\]{}'\"<>«»“”‘’\\s]",r=new RegExp("^(https?|ftp|gopher|telnet|file|notes|ms-help):((//)|(\\\\\\\\))+"+n+"*$","i");return r.test(i)?/^(http|ftp)/.test(i.toLowerCase())&&(r=new RegExp("^(https?|ftp):((//)|(\\\\\\\\))+((?:"+a+"+\\.)+"+a+"{2,6})((/|\\\\|#)"+n+"*)?$","i"),!r.test(i))?$_("Incorrect URL format."):null:$_("Incorrect URL format.")}}),t.factoryTypes.Email=e.extend({},t.factoryTypes.Url,{validate:function(t){var i=e.trim(this.getValue());return t||!this.fieldData.required||i?i?new RegExp("^([^@\\s]+)@[^\\s@]+\\.[^\\s@\\.]{2,}$","i").test(i)?null:$_("Incorrect email address format."):null:$_("This field is required.")}}),t.factoryTypes.Checkbox=e.extend({},t.baseFieldType,{setValue:function(e){this.fieldValue=parseInt(e),"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").attr("checked",!!this.fieldValue):this.domElement.find(".val").text(this.fieldValue?"Yes":"No"))},newInlineFieldElement:function(t){var i=null;return"edit"==t?(i=e('<span><input class="val" type="checkbox" value="1" checked="checked"></span>'),this.fieldValue||i.find(".val").removeAttr("checked")):i=e('<span class="val"></span>').text(this.fieldValue?"Yes":"No"),i}}),t.factoryTypes.Number=e.extend({},t.baseFieldType,{validate:function(t){var i=e.trim(this.getValue());return t||!this.fieldData.required||i||0===i?i&&!/^-?[0-9]+([\.,][0-9]+$)?/.test(i)?$_("Must be a number."):null:$_("This field is required.")}}),t.factoryTypes},e.wa.contactEditorFactory=function(i){"use strict";i=e.extend({contact_id:null,current_user_id:null,contactType:"person",baseFieldType:null,saveUrl:"?module=profile&action=save",saveGeocoordsUrl:"?module=contacts&action=saveGeocoords",regionsUrl:"?module=backend&action=regions&country=",el:"#contact-info-block",update_title:!0},i);var a=e.extend({wa_app_url:"",fields:{},fieldsOrder:[],fieldsValues:{},factoryTypes:{},editorFactories:{},fieldEditors:{},initFactories:function(t,i){var a=this;this.fields=t,this.fieldsOrder=i,this.editorFactories={},this.fieldEditors={},this.fieldsOrder=e.each(i,function(i,n){try{if("object"!=typeof t[n]||!t[n].type)throw new Error("Field data error for "+n);if(void 0===a.factoryTypes[t[n].type])throw new Error("Unknown factory type: "+t[n].type);return t[n].multi?a.editorFactories[n]=e.extend({},a.factoryTypes.Multifield):a.editorFactories[n]=e.extend({},a.factoryTypes[t[n].type]),a.editorFactories[n].initializeFactory(t[n]),n}catch(e){console.log("Unable to init field "+n),console.log(e),t[n]=void 0,delete t[n]}}).filter(function(e){return!!e})},resetFieldEditors:function(){for(var e=0;e<this.fieldsOrder.length;e+=1){var t=this.fieldsOrder[e];void 0===this.fieldEditors[t]?this.fieldEditors[t]=this.editorFactories[t].createEditor(this.contactType,t):this.fieldEditors[t].reinit()}},initFieldEditors:function(t){if(!(t instanceof Array)){this.fieldsValues=t;for(var i=0;i<this.fieldsOrder.length;i+=1){var a=this.fieldsOrder[i];if(void 0===this.editorFactories[a])return void e.wa.controller.contactAction([this.contact_id]);try{void 0===this.fieldEditors[a]&&(this.fieldEditors[a]=this.editorFactories[a].createEditor(this.contactType)),this.fieldEditors[a].setValue(t[a])}catch(e){console.log("Unable to initialize editor "+a),console.log(e)}}}},initContactInfoBlock:function(e){this.switchMode(e,!0)},getSaveUrl:function(){return this.saveUrl},getSaveGeocoordsUrl:function(){return e.wa.contactEditor.wa_backend_url+"?module=profile&action=saveGeocoords"},getRegionsUrl:function(){return e.wa.contactEditor.wa_backend_url+"?module=profile&action=regions&country="},switchMode:function(i,a){var n=e(this.el),r=this;if(a&&(n.html(""),n.removeClass("edit-mode view-mode"),n.off("click.map",".map-link").on("click.map",".map-link",function(){var t=e(this).parent().data("multifield-index");if(void 0!==t){var i=r.fieldEditors.address.fieldValue;r.geocodeAddress(i,t)}})),!("edit"==i&&n.hasClass("edit-mode")||"view"==i&&n.hasClass("view-mode"))){e(this).trigger("before_switch_mode",[i,this]),n.find("div.field.buttons").remove();for(var o=[],s=0;s<this.fieldsOrder.length;s+=1){var l=this.fieldsOrder[s];o.push(l);try{var d=this.fieldEditors[l].setMode(i);e(this).trigger("set_mode",[{mode:i,el:n,field_id:l,field:this.fieldEditors[l]}]),a&&n.append(d)}catch(e){console.log("Error initializing field",l,e)}}var c=this;if("edit"==i){n.addClass("edit-mode"),n.removeClass("view-mode"),e("#edit-contact-link").hide(),n.find(".subname").wrapAll('<div class="subname-wrapper"></div>'),n.find(".jobtitle-company").wrapAll('<div class="jobtitle-company-wrapper"></div>');var u=this.inplaceEditorButtons(o,function(i){if(void 0!==i&&!i)return!1;if(void 0!==c.justCreated&&c.justCreated){var a=e("#all-users-sidebar-link .count");throw a.text(1+parseInt(a.text())),new Error("!!! Not implemented because never used. Redirect to contact_id="+c.contact_id)}return c.switchMode("view"),t(0),!1},function(){c.switchMode("view"),t(0)});null===c.contact_id&&u.find(".cancel, .or").remove(),n.append(u),setTimeout(function(){},666)}else n.addClass("view-mode"),n.removeClass("edit-mode"),e("#edit-contact-link").show(),n.find(".subname-wrapper").length&&n.find(".subname").unwrap(),n.find(".jobtitle-company-wrapper").length&&n.find(".jobtitle-company").unwrap();e(this).trigger("after_switch_mode",[i,this])}},saveFields:function(i,n){function r(e,t,i){if(i){for(var a=0;a<i.length;a+=1)if(e[i[a]]&&t[i[a]]&&e[i[a]]!=t[i[a]])return!1}else{for(var n in e)if(e.hasOwnProperty(n)&&e[n]&&t[n]&&e[n]!=t[n])return!1;for(var n in t)if(t.hasOwnProperty(n)&&e[n]&&t[n]&&e[n]!=t[n])return!1}return!0}function o(i){i=void 0===i||i,e.post(c.getSaveUrl(),{data:JSON.stringify(d),type:c.contactType,id:null!=c.contact_id?c.contact_id:0},function(r){if("ok"!=r.status)throw new Exception("AJAX error:",r);var o=c.fieldsValues||{};r=r.data;var l=null;r.data&&r.data.top&&(l=r.data.top),r.data.top=void 0,delete r.data.top,null!=c.contact_id&&c.initFieldEditors(r.data);var d=!1;for(var u in c.fieldEditors)if(void 0!==r.errors[u]){if(c.fieldEditors[u].showValidationErrors(r.errors[u]),!d)for(d=c.fieldEditors[u].domElement;!d.is(":visible");)d=d.parent()}else"edit"==c.fieldEditors[u].currentMode&&c.fieldEditors[u].showValidationErrors(null);return d?void t(d,-100):c.contact_id&&r.data.reload?void(window.profileTab?window.profileTab.rootWindow.location.reload():window.location.reload()):(null===c.contact_id&&(c.justCreated=!0),c.contact_id=r.data.id,!d&&i&&s(o,r),n(!d),void(d||(e(a).trigger("contact_saved",r.data),l&&e(a).trigger("top_fields_updated",{data:l}))))},"json")}function s(t,i){var a=e.storage.get("contacts/last_geocoding")||0;if((new Date).getTime()-a>3600){e.storage.del("contacts/last_geocoding");var n=i.data.address;if(!e.isEmptyObject(n)){for(var s=[],l=[],u=0;u<n.length;u+=1){var p=!0;d.address[u]&&(p=!r(n[u].data,(t.address[u]||{}).data||{},["city","country","region","street","zip"])),p&&(s.push(c.sendGeocodeRequest(n[u].for_map)),l.push(u))}if(s.length){var f=function(t,i){if("OK"===t.status){var a=t.lat||"",n=t.lng||"";d.address[i].value.lat=a,d.address[i].value.lng=n}else"OVER_QUERY_LIMIT"===t.status&&e.storage.set("contacts/last_geocoding",(new Date).getTime()/1e3)};e.when.apply(e,s).then(function(){if(s.length<=1&&"success"===arguments[1])f(arguments[0],l[0]);else for(var e=0;e<arguments.length;e+=1)"success"===arguments[e][1]&&f(arguments[e][0],l[e]);o(!1)})}}}}if(!i){i=[];for(var l in this.fields)this.fields.hasOwnProperty(l)&&i.push(l)}for(var d={},c=this,u=!1,p=0;p<i.length;p++){var f=i[p],h=this.fieldEditors[f].validate();if(h){if(!u)for(u=this.fieldEditors[f].domElement;!u.is(":visible");)u=u.parent();this.fieldEditors[f].showValidationErrors(h)}else this.fieldEditors[f].showValidationErrors(null);d[f]=this.fieldEditors[f].getValue()}if(u)return t(u,-100),void n(!1);o(!0)},createExtSelect:function(t,i){var a="",n=!0;for(var r in t){var o="";t[r]!==i&&r!==i||(o=' selected="selected"',n=!1);var s=this.htmlentities(t[r]);a+='<option value="'+(void 0===t.length?r:s)+'"'+o+">"+s+"</option>"}var l;n?(a+='<option value="%custom" selected="selected">'+$_("other")+"...</option>",l='<input type="text" class="small ext">'):(a+='<option value="%custom">'+$_("other")+"...</option>",l='<input type="text" class="small empty ext">');var d=e('<span><select class="ext">'+a+"</select><span>"+l+"</span></span>"),c=d.children("select");l=d.find("input"),l.val(i),"%custom"!==c.val()&&l.hide(),i=$_("which?");var u=function(){l.val()||l.hasClass("empty")||(l.val(i),l.addClass("empty"))};return l.blur(u),l.focus(function(){l.hasClass("empty")&&(l.val(""),l.removeClass("empty"))}),c.change(function(){var e=c.val();"%custom"===e?(l.hasClass("empty")&&l.val(i),l.show()):(l.hide(),l.addClass("empty"),l.val(e||"")),u()}),l[0].getExtValue=function(){return"%custom"===c.val()&&l.hasClass("empty")?"":l.val()},l[0].setExtValue=function(e){t[e]?c.val(e):c.val("%custom"),l.val(e)},d},inplaceEditorButtons:function(i,a,n){var r=e('<div class="field buttons"><div class="value submit"><em class="errormsg" id="validation-notice"></em></div></div>'),o=this,s=function(){return e(".buttons .loading").show(),o.saveFields(i,function(t){e(".buttons .loading").hide(),a(t)}),!1};e("#tc-contact").off("keyup.contact_save").on("keyup.contact_save",'#contact-info-block.edit-mode input[type="text"]',function(t){13!=t.keyCode||e(t.currentTarget).data("autocomplete")&&e(t.currentTarget).data("contact_id")||s()});var l=e('<input type="submit" class="button green" value="'+$_("Save")+'" />').click(s),o=this,d=e('<a href="javascript:void(0)" class="cancel">'+$_("cancel")+"</a>").click(function(i){return e(".buttons .loading").hide(),"function"!=typeof n?a():n(),o.fieldEditors.name.showValidationErrors(null),t(0),!1});return r.children("div.value.submit").append(l).append('<span class="or"> '+$_("or")+" </span>").append(d).append(e('<i class="icon16 loading" style="margin-left: 16px; display: none;"></i>')),r},destroy:function(){e(this.el).html("")},wrapper:function(t,i,a){a=void 0!==a&&a?" "+a:"";var n=e('<div class="field'+a+'"></div>');return void 0!==i&&i&&n.append('<div class="name">'+e.wa.encodeHTML(i)+"</div>"),"object"==typeof t&&t instanceof jQuery&&!(t.find("div.value").size()<=0)||(t=e('<div class="value"></div>').append(t)),n.append(t),n},htmlentities:function(e){var t=document.createElement("div"),i=document.createTextNode(e);return t.appendChild(i),t.innerHTML},geocodeAddress:function(t,i){var a=this;t[i].data.lat&&t[i].data.lng||this.sendGeocodeRequest(t[i].for_map||t[i].value,function(n){t[i].data.lat=n.lat,t[i].data.lng=n.lng,e.post(a.getSaveGeocoordsUrl(),{id:a.contact_id,lat:n.lat,lng:n.lng,sort:i})})},sendGeocodeRequest:function(t,i){var a=[];"string"==typeof t?a.push(t):t.with_street&&t.without_street&&t.with_street===t.without_street?a.push(t.with_street):(t.with_street&&a.push(t.with_street),t.without_street&&a.push(t.without_street));var n=e.Deferred(),r=this,o=r.geocoding||{};return"google"===o.type&&o.key?function(t){e.ajax({url:"https://maps.googleapis.com/maps/api/geocode/json",data:{sensor:!1,key:t,address:a[0]},dataType:"json",success:function(e){var t,a;if(e)if("OK"===e.status){for(var r=e.results.length,o=!1,s=0;s<r;s+=1)if(!e.results[s].partial_match){t=e.results[s].geometry.location.lat||"",a=e.results[s].geometry.location.lng||"",i instanceof Function&&i({lat:t,lng:a}),o=!0;break}o?n.resolve([{lat:t,lng:a,status:e.status},"success"]):(t=e.results[0].geometry.location.lat||"",a=e.results[0].geometry.location.lng||"",i instanceof Function&&i({lat:t,lng:a}),n.resolve([{lat:t,lng:a,status:e.status},"success"]))}else n.resolve([{status:e.status},"success"]);else n.resolve([{status:"FAIL"},"error"])},error:function(e){n.resolve([{status:e.status},"error"])}})}(o.key):"yandex"===o.type&&o.key?function(t){e.ajax({url:"https://geocode-maps.yandex.ru/1.x/?format=json",data:{apikey:t,geocode:a[0]},dataType:"json",success:function(t){var a,r;t.response&&t.response.GeoObjectCollection&&t.response.GeoObjectCollection.featureMember?(e.each(t.response.GeoObjectCollection.featureMember,function(e,t){if(t.GeoObject&&t.GeoObject.Point&&t.GeoObject.Point.pos&&"string"==typeof t.GeoObject.Point.pos){var o=t.GeoObject.Point.pos.split(" ");if(2===o.length)return r=o[0],a=o[1],i instanceof Function&&i({lat:a,lng:r}),n.resolve([{lat:a,lng:r,status:"OK"},"success"]),!1}}),a&&r||n.resolve([{status:"FAIL"},"error"])):n.resolve([{status:"FAIL"},"error"])},error:function(e){n.resolve([{status:"FAIL"},"error"])}})}(o.key):n.resolve([{geocoding:o},"error"]),n},initCheckboxList:function(t){t=e(t);var i=function(t,i){var a=e(i||this);a.is(":checked")?a.parent().addClass("highlighted"):a.parent().removeClass("highlighted")};return t.find('input[type="checkbox"]').click(i).each(i),t}},i);return e.wa.fieldTypesFactory(a),a},e.wa.contactEditor=e.wa.contactEditorFactory()}(jQuery);var Profile=function(e){return Profile=function(e){var t=this;t.$wrapper=e.$wrapper,t.$tabs=t.$wrapper.find(".t-profile-tabs"),t.$tabContentPlace=t.$wrapper.find(".t-dynamic-content"),t.$calendarPlace=t.$wrapper.find(".t-calendar-place"),t.api_enabled=window.history&&window.history.pushState,t.user=e.user||{id:0},t.photo_dialog_url=e.photo_dialog_url,t.is_own_profile=e.is_own_profile||!1,t.wa_app_url=e.wa_app_url||"",t.backend_url=e.backend_url||"",t.wa_url=e.wa_url||"",t.wa_version=e.wa_version||"",t.webasyst_id_auth_url=e.webasyst_id_auth_url||"",t.is_locked=!1,t.xhr=!1,t.dialogs=[],t.initClass()},Profile.prototype.initClass=function(){var t=this;t.initEditableJobtitle(),t.bindEvents(),e.team&&e.team.sidebar&&e.team.sidebar.selectLink(!1),new ProfileWebasystID({is_own_profile:t.is_own_profile,user:t.user,backend_url:t.backend_url,wa_url:t.wa_url,wa_version:t.wa_version,webasyst_id_auth_url:t.webasyst_id_auth_url})},Profile.prototype.bindEvents=function(){var t=this;t.$tabs.on("click",".t-tab a",function(){return t.changeTab(e(this)),!1}),t.$calendarPlace.on("click",".js-calendar-toggle",function(i){i.preventDefault(),t.calendarToggle(e(this))}),t.$calendarPlace.on("click",".js-show-outer-calendar-manager",function(e){e.stopPropagation(),t.showOuterDialogDialog()}),t.$wrapper.on("photo_updated photo_deleted",function(e,i){t.$wrapper.find(".t-userpic").attr("src",i.url)}),t.$wrapper.find(".photo-change-link a").click(function(){e("#contact-photo-crop-dialog").remove(),e('<div id="contact-photo-crop-dialog">').appendTo(t.$wrapper).waDialog({class:"large",url:t.photo_dialog_url,onLoad:function(t){var i=e(this);i.find(".dialog-buttons-gradient").append(i.find(".dialog-content-indent .buttons"))}})});var i=t.$wrapper.find(".profile-header-links");i.on("click",".edit-link",function(){t.switchToTab("info",function(e){return"function"==typeof e[0].contentWindow.$.wa.contactEditor.switchMode}).then(function(e){e[0].contentWindow.$.wa.contactEditor.switchMode("edit")})}),i.on("click",".delete-link",function(){var i=e(this).find("i");i.is(".loading")||(i.toggleClass("delete loading"),e.team.confirmContactDelete([t.user.id],{onInit:function(){i.toggleClass("delete loading")},onDelete:function(){e.team.content.load(e.team.app_url)}}))});var a=t.$wrapper.find(".t-profile-tabs-iframes"),n=e("#contact-info-top");a.on("contact_saved",function(e,t){var i=n.closest(".t-profile-page"),a=i.find(".profile .details h1").first();a.children(".contact-name:first").text(t.name),a.children(".title:first").text(t.title);var r=a.closest(".details").find(".jobtitle-company");r.children(".company").text(t.company),r.children(".title").text(t.jobtitle)}),a.on("top_fields_updated",function(e,t){for(var i="",a=0;a<t.length;a++){var r=t[a];i+="<li>"+("im"!=r.id&&r.icon?'<i class="icon16 '+r.id+'"></i>':"")+r.value+"</li>"}n.html(i)}),e("#header-customize-groups-link").click(function(){t.switchToTab("access",function(e){return"function"==typeof e[0].contentWindow.ProfileAccessTab}).then(function(e){e[0].contentWindow.$("#form-customize-groups",e[0].contentWindow.body).is(":not(:visible)")&&e[0].contentWindow.$("#open-customize-groups",e[0].contentWindow.body).click()})})},Profile.prototype.switchToTab=function(t,i){function a(){var l=n.children().filter(function(){return t==e(this).data("tab-id")}).first();try{if(!l[0].contentWindow||!i(l))return;setTimeout(function(){o.resolve(l)},0),r.off("tab_content_updated",a),s&&clearInterval(s),s=null}catch(e){}}var n=this.$wrapper.find(".t-profile-tabs-iframes"),r=this.$wrapper.find('.t-tab a[data-tab-id="'+t+'"]'),o=e.Deferred();r.on("tab_content_updated",a);var s=setInterval(a,100);return r.closest(".t-tab").hasClass("is-selected")?a():r.click(),r.length&&e("html, body").animate({scrollTop:r.offset().top},500),o.promise()},Profile.prototype.changeTab=function(e){if(this.api_enabled){var t=e.data("tab-id"),i=window.location.href.match(/^.*\/(id|u)\/[^\/]+/);if(!i||!t)return;var a=i[0]+"/"+t+"/";history.replaceState({reload:!0,content_uri:a},"",a)}},Profile.prototype.calendarToggle=function(e){var t=this,i=e.find(".t-calendar-toggle .text");t.$calendarPlace.hasClass("is-short")?(i.text(e.data("hide-text")),t.$calendarPlace.removeClass("is-short")):(i.text(e.data("show-text")),t.$calendarPlace.addClass("is-short"))},Profile.prototype.showOuterDialogDialog=function(){function t(){e.post(a,n,function(e){new TeamDialog({html:e,onRefresh:t})}).always(function(){i.is_locked=!1})}var i=this,a="?module=schedule&action=settings",n={};i.user.id>0&&(a+="&id="+i.user.id),i.is_locked||(i.is_locked=!0,t())},Profile.prototype.initEditableJobtitle=function(){var t=this,i=t.$wrapper.find(".js-jobtitle-editable").first();i.length&&new TeamEditable({$wrapper:i,onSave:function(i){var a=i.$field.val(),n=!a.length;if(i.text!==a){var r=e.team.app_url+"?module=profile&action=save",o={id:t.user.id,data:JSON.stringify({jobtitle:a})};i.$field.attr("disabled",!0);var s=e('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(i.$field);e.post(r,o,function(){i.$field.attr("disabled",!1),s.remove(),i.is_empty=n,i.text=a,i.$wrapper.text(a),i.toggle("hide"),n&&i.$wrapper.parent().find(".at").hide()})}else i.toggle("hide")}})},Profile}(jQuery),ActivityLazyLoading=function(e){return ActivityLazyLoading=function(t){var i=this;i.list_name=t.names.list,i.items_name=t.names.items,i.pagind_name=t.names.paging,i.user_id=t.user_id,i.$wrapper=t.$wrapper||!1,i.$list=i.$wrapper.find(i.list_name),i.$window=e(window),i.onLoad=t.onLoad||function(){},i.$paging=i.$wrapper.find(i.pagind_name),i.xhr=!1,i.is_locked=!1,i.addWatcher()},ActivityLazyLoading.prototype.addWatcher=function(){function t(){var n=window&&e.contains(document,i.$paging[0]);if(n&&a&&window.frameElement&&(n=e.contains(a.document,window.frameElement)),n)try{i.onScroll()}catch(e){n=!1}n||(i.$window.off("scroll",t),e(a).off("scroll",t))}var i=this,a=window.parent;i.$window.on("scroll",t),a&&window.frameElement&&e(a).on("scroll",t)},ActivityLazyLoading.prototype.onScroll=function(){var t=this,i=t.$window,a=i.scrollTop(),n=i.height(),r=t.$paging.offset().top;if(window.parent&&window.frameElement){var o=e(window.parent);n=o.height(),a+=o.scrollTop(),r+=e(window.frameElement).offset().top}a+n>=r&&(t.is_locked||(t.is_locked=!0,t.loadNextPage()))},ActivityLazyLoading.prototype.loadNextPage=function(){var t=this,i=e.team.app_url+"?module=profile&action=activity",a={max_id:t.$paging.data("max-id"),id:t.user_id,timestamp:t.$list.find(t.items_name).last().data("timestamp")};t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get(i,a,function(i){var a=e(i),n=a.find(t.list_name+" "+t.items_name),r=a.find(t.pagind_name);t.$list.append(n),t.$paging.after(r),t.$paging.remove(),t.$paging=r,t.is_locked=!1,t.onLoad()})},ActivityLazyLoading}(jQuery),OutsideCalendarsDialog=function(e){return OutsideCalendarsDialog=function(e){var t=this;t.$dialogWrapper=e.$wrapper,t.$wrapper=t.$dialogWrapper.find(".t-dialog-block"),t.$form=t.$wrapper.find("form"),t.is_locked=!1,t.xhr=!1,t.initClass()},OutsideCalendarsDialog.prototype.initClass=function(){this.bindEvents()},OutsideCalendarsDialog.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".t-external-calendar-unmount",function(){t.deleteExternalCalendar(e(this).data("id"))}),t.$wrapper.find(".js-add-external-calendar").on("click",function(i){i.preventDefault(),t.close();var a=e(this).attr("href");a&&e.team.content.load(a)})},OutsideCalendarsDialog.prototype.deleteExternalCalendar=function(t){e.get("?module=calendarExternal&action=DeleteConfirm",{id:t},function(t){new TeamDialog({html:t,onOpen:function(t){t.bind("afterDelete",function(){e.team.content.reload()})}})})},OutsideCalendarsDialog.prototype.close=function(){this.$wrapper.trigger("close")},OutsideCalendarsDialog}(jQuery),ProfileStatistic=function(e){var t=function(e){function i(e,t){var i=e.offsetWidth,a=e.offsetHeight;return{outer_width:i,outer_height:a,inner_width:i-t.left-t.right,inner_height:a-t.top-t.bottom}}function a(e,t){for(var i=[],a=0;a<e.length;a++){for(var n=e[a].data,r=[],o=0;o<n.length;o++){var s=n[o],l=t&&e[a].id!==t?0:parseInt(s.value);r.push({date:function(e){var t=e.split("-"),i=parseInt(t[0]),a=parseInt(t[1])-1,n=parseInt(t[2]);return new Date(i,a,n)}(s.date),value:l})}i.push(r)}return d3.layout.stack().offset("zero").values(function(e){return e}).x(function(e){return e.date}).y(function(e){return e.value})(i)}function n(e,t,i){var a=null;if(i+=1,e&&i){a=(e-t*(i-1))/i,a<0&&(a=0)}return a}function r(e,t){for(var i=t[0],a=t[1]||1,n=a-i+1,r=n/(e-1),o=[],s=0;s<e;s++){var l=n>10?Math.round(s*r):parseInt(s*r*10)/10;o.push(l)}return o}return t=function(e){var t=this;t.app_id=e.app_id,t.$wrapper=e.$wrapper,t.$hint=t.$wrapper.find(".t-hint-wrapper"),t.node=t.$wrapper.find(".t-graph")[0],t.d3node=d3.select(t.node),t.show_class="is-shown",t.charts=e.data,t.data=a(t.charts,t.app_id),t.group_by=e.group_by,t.locales=e.locales,t.margin={top:14,right:10,bottom:28,left:34},t.area=i(t.node,t.margin),t.column_indent=4,t.column_width=n(t.area.inner_width,t.column_indent,t.data[0].length),t.svg=!1,t.defs=!1,t.x=!1,t.y=!1,t.xDomain=!1,t.yDomain=!1,t.initGraph()},t.prototype.initGraph=function(){var e=this,t=e.area;e.initGraphCore(),
e.svg=e.d3node.append("svg").attr("width",t.outer_width).attr("height",t.outer_height),e.renderBackground(),e.renderCharts(),e.renderAxis()},t.prototype.initGraphCore=function(){var e=this,t=e.data,i=e.area,a=e.x=d3.time.scale().range([0,i.inner_width]),n=e.y=d3.scale.linear().range([i.inner_height,0]);e.yDomain=function(){var e=d3.min(t,function(e){return d3.min(e,function(e){return e.value})});return e>0&&(e=0),[e,d3.max(t,function(e){return d3.max(e,function(e){return e.value+e.y0})})]}(),e.xDomain=function(){var e,i,a=t[0].length,n=t[0][0].date,r=t[0][1].date,o=t[0][a-1].date,s=parseInt((r.getTime()-n.getTime())/2);return e=new Date(n.getTime()-s),i=new Date(o.getTime()+s),[e,i]}(),a.domain(e.xDomain),n.domain(e.yDomain)},t.prototype.renderAxis=function(){var e=this,t=e.x,i=e.y,a=e.svg,n=d3.svg.axis().scale(t).orient("bottom").ticks(10),o=d3.svg.axis().scale(i).innerTickSize(2).orient("right").tickValues(r(6,e.yDomain)).tickFormat(function(e){return e+""}),s=a.append("g").attr("class","axis");s.append("g").attr("transform","translate(10,"+e.margin.top+")").attr("class","y").call(o),s.append("g").attr("class","x").attr("transform","translate("+e.margin.left+","+(e.area.outer_height-e.margin.bottom)+")").call(n)},t.prototype.renderBackground=function(){var e,t=this,i=t.area.inner_width,a=t.area.inner_height,n=t.svg.append("g").attr("class","background").attr("transform","translate("+t.margin.left+","+t.margin.top+")");for(n.append("rect").attr("width",i).attr("height",a),e=0;e<=5;e++){var r=1+(a-2)/5*e;n.append("line").attr("x1",1).attr("x2",i).attr("y1",r).attr("y2",r)}},t.prototype.renderCharts=function(){function e(e,t,i){a.showHint(d3.event,this,e,a.charts[i])}function t(){a.moveHint(this)}function i(){a.hideHint()}var a=this,n=a.svg,r=a.data,o=n.selectAll(".t-graph-wrapper").data(r);o.enter().append("g").attr("class","t-graph-wrapper").attr("transform","translate("+a.margin.left+","+a.margin.top+")");var s=o.selectAll(".rect").data(function(e){return e});s.enter().append("rect").attr("class","rect").style("fill",function(e,t,i){var n=a.charts[i].color;return n||!1}).on("mouseover",e).on("mousemove",t).on("mouseout",i),s.transition().duration(1e3).attr("x",function(e,t){return a.x(e.date)-a.column_width/2}).attr("y",function(e){return a.y(e.y0)+a.y(e.value)-a.area.inner_height}).attr("height",function(e){return a.area.inner_height-a.y(e.value)}).attr("width",a.column_width),s.exit().remove(),o.exit().remove()},t.prototype.update=function(e){var t=this;t.data=a(t.charts,e),t.initGraphCore();var i=d3.svg.axis().scale(t.y).innerTickSize(2).orient("right").tickValues(r(6,t.yDomain)).tickFormat(function(e){return e+""});t.svg.selectAll(".axis .y").call(i),t.renderCharts()},t.prototype.showHint=function(t,i,a,n){var r=this,o=e(i);if(!(Math.ceil(o.attr("height"))>0))return!1;var s=a.date,l=r.$hint.find(".t-date"),d=r.$hint.find(".t-app"),c=r.$hint.find(".t-value"),u=function(t,i){var a,n=parseInt(t.getMonth());if("months"==i){var o=r.locales.months;o[n]?a=o[n]:(o=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"],a=o[n])}else{var s=t.getDate();s=s<10?"0"+s:s,n+=1,n=n<10?"0"+n:n,a=s+"."+n+"."+t.getFullYear();try{a=e.datepicker.formatDate(r.locales.dateFormat,t)}catch(e){a=s+"."+n+"."+t.getFullYear()}}return a}(s,r.group_by);l.text(u),d.text(n.name),c.text(a.value);var p=function(t){var i=e(window),a=i.width(),n=(i.height(),r.$hint.outerWidth()),o=r.$hint.outerHeight(),s=Math.ceil(t.attr("width")),l=Math.ceil(t.attr("height")),d=r.$wrapper.offset(),c=t.offset(),u={left:c.left-d.left+s+10,top:c.top-d.top+(l<o?l-o-2:2)};return a<u.left+n&&(u.left=c.left-(n+10)),u}(o);r.$hint.css(p).addClass(r.show_class)},t.prototype.moveHint=function(){},t.prototype.hideHint=function(){var e=this;e.$hint.removeAttr("style").removeClass(e.show_class)},t}(jQuery);return ProfileStatistic=function(e){var t=this;t.$wrapper=e.$wrapper,t.$graphWrapper=t.$wrapper.find("#t-graph-wrapper"),t.$header=t.$wrapper.find(".t-header-wrapper"),t.$filters=t.$header.find(".t-filters"),t.graphData=e.graphData,t.app_url=e.app_url,t.app_id=e.app_id,t.group_by=e.group_by,t.timeframe=e.timeframe,t.start_date=e.start_date,t.end_date=e.end_date,t.loading_class="is-loading",t.contact_id=e.contact_id,t.locales=e.locales,t.graph=!1,t.xhr=!1,t.initClass()},ProfileStatistic.prototype.initClass=function(){var e=this;e.bindEvents(),e.initGraph(),e.initDatePicker()},ProfileStatistic.prototype.bindEvents=function(){var t=this;t.$filters.on("click",".dropdown .menu-v a",function(i){i.preventDefault(),t.setFilter(e(this))}),t.$filters.on("click",".t-period-filter .menu-v a",function(i){i.preventDefault(),t.changePeriod(e(this))}),t.$filters.on("click",".t-app-filter .menu-v a",function(i){i.preventDefault();var a=e(this).data("app-id");t.changeApp(a||!1)}),t.$filters.on("click",".js-set-custom-period",function(i){i.preventDefault(),t.changeCustomPeriod(e(this).closest("form"))})},ProfileStatistic.prototype.initGraph=function(){var i=this;i.$graphWrapper.length&&i.graphData&&i.graphData.length&&(i.graph=new t({$wrapper:i.$graphWrapper,data:function(t){function i(e,t){var i=e.split("-"),a=parseInt(i[0]),n=parseInt(i[1])-1,r=parseInt(i[2]),o=new Date(new Date(a,n,r).getTime()+(t?864e5:-864e5)),s=parseInt(o.getFullYear()),l=parseInt(o.getMonth())+1,d=parseInt(o.getDate());return d<10&&(d="0"+d),l<10&&(l="0"+l),[s,l,d].join("-")}return 1===t[0].data.length&&e.each(t,function(e){var a=t[e].data[0],n={value:0,date:i(a.date,!1)},r={value:0,date:i(a.date,!0)};t[e].data=[n,a,r]}),t}(i.graphData),group_by:i.group_by,locales:i.locales,app_id:i.app_id}))},ProfileStatistic.prototype.initDatePicker=function(){this.$wrapper.find(".js-datepicker").each(function(){var t=e(this),i=t.parent().find("input[type='hidden']");t.datepicker({altField:i,altFormat:"yy-mm-dd"})})},ProfileStatistic.prototype.changeApp=function(e){var t=this;t.app_id=e||!1,t.graph.update(t.app_id)},ProfileStatistic.prototype.setFilter=function(e){var t=e.closest("li"),i=t.closest(".menu-v"),a=i.closest(".dropdown"),n=a.find(".t-selected-item");i.find(".selected").removeClass("selected"),t.addClass("selected"),e.trigger("set"),i.hide(),setTimeout(function(){i.removeAttr("style")},500),n.html(e.html())},ProfileStatistic.prototype.changePeriod=function(t){var i=this,a=t.closest(".t-period-filter").find(".t-hidden-part"),n=!t.hasClass("js-show-period-form"),r=i.loading_class;if(n){a.removeClass("is-shown");var o=i.app_url+"?module=profile&action=stats",s={is_update:!0,id:i.contact_id};t.data("timeframe")&&t.data("groupby")&&(s.timeframe=i.timeframe=t.data("timeframe"),s.groupby=i.group_by=t.data("groupby")),i.app_id&&(s.app_id=i.app_id),i.xhr&&(i.xhr.abort(),i.xhr=!1),i.$wrapper.addClass(r),i.xhr=e.post(o,s,function(e){i.$wrapper.replaceWith(e)})}else a.addClass("is-shown")},ProfileStatistic.prototype.changeCustomPeriod=function(t){var i=this,a=i.app_url+"?module=profile&action=stats",n=t.serializeArray();n.push({name:"is_update",value:!0}),n.push({name:"id",value:i.contact_id}),n.push({name:"timeframe",value:"custom"}),i.app_id&&n.push({name:"app_id",value:i.app_id}),function(t){function i(e){var t=e.split("-"),i=parseInt(t[0]),a=parseInt(t[1])-1,n=parseInt(t[2]);return new Date(i,a,n)}var a,n,r,o;e.each(t,function(e,t){var i=t.name;"from"==i&&(a=t.value),"to"==i&&(n=t.value),"groupby"==i&&(o=e,r=t.value)}),"days"==r&&o>=0&&function(e,t){var a=i(e),n=i(t);return Math.abs(n.getTime()-a.getTime())>79488e5}(a,n)&&(t[o].value="months")}(n),i.xhr&&(i.xhr.abort(),i.xhr=!1),i.$wrapper.addClass(i.loading_class),i.xhr=e.post(a,n,function(e){i.$wrapper.replaceWith(e)})},ProfileStatistic.prototype.update=function(){},ProfileStatistic}(jQuery),SettingsPage=function(e){return SettingsPage=function(e){var t=this;t.$wrapper=e.$wrapper,t.$calendarToggle=t.$wrapper.find("#t-calendar-settings"),t.$form=t.$wrapper.find("form"),t.$submitButton=t.$form.find('input[type="submit"]'),t.locales=e.locales,t.$notice=!1,t.is_locked=!1,t.is_form_changed=!1,t.xhr=!1,t.initClass()},SettingsPage.prototype.initClass=function(){var e=this;e.bindEvents(),e.initSortable()},SettingsPage.prototype.bindEvents=function(){function t(){i.is_form_changed||(i.is_form_changed=!0,i.$submitButton.removeClass("green").addClass("yellow"))}var i=this;i.$calendarToggle.on("click",".js-edit-calendar",function(t){t.preventDefault();var a=parseInt(e(this).closest(".t-calendar-item").data("id"));a&&i.showEditDialog(a)}),i.$calendarToggle.on("click",".js-add-calendar",function(e){e.preventDefault(),i.showEditDialog()}),i.$form.on("submit",function(e){e.preventDefault(),i.is_form_changed&&i.save(i.$form)}),i.$form.on("change","input, select, textarea",t)},SettingsPage.prototype.initSortable=function(){var e,t=this;t.$calendarToggle.find("ul").sortable({handle:".t-toggle",items:"> .t-calendar-item",axis:"y",start:function(i,a){e=a.item.index(),t.$notice&&(t.$notice.remove(),t.$notice=!1)},stop:function(i,a){e!=a.item.index()&&t.saveCalendarsSort(a)}})},SettingsPage.prototype.showEditDialog=function(t){var i=this,a=e.team.app_url+"?module=calendar",n={};t&&(n.id=t),i.xhr&&(i.xhr.abort(),i.xhr=!1),i.xhr=e.post(a,n,function(e){i.dialog=new TeamDialog({html:e})})},SettingsPage.prototype.saveCalendarsSort=function(t){function i(t){var i=a.locales.saved||"",n=e('<span class="t-notice"><i class="icon16 yes"></i>'+i+"</span>");return n.appendTo(t),n}var a=this,n=t.item,r=e.team.app_url+"?module=settings&action=calendarsSortSave",o={calendars:function(){var t=[];return a.$calendarToggle.find(".t-calendar-item").each(function(){var i=e(this),a=i.data("id");a&&a>0&&t.push(a)}),t}()};a.xhr&&(a.xhr.abort(),a.xhr=!1),a.$notice=function(t){var i=a.locales.saving||"",n=e('<span class="t-notice"><i class="icon16 loading"></i>'+i+"</span>");return n.appendTo(t),n}(n),a.xhr=e.post(r,o,function(t){a.$notice.remove(),a.$notice=i(n),setTimeout(function(){a.$notice&&e.contains(document,a.$notice[0])&&a.$notice.remove()},1e3),a.xhr=!1})},SettingsPage.prototype.save=function(t){var i=this,a=e.team.app_url+"?module=settings&action=save",n=t.serializeArray(),r=e('<i class="icon16 loading" style="margin: 0 4px;"></i>');r.insertAfter(i.$submitButton),i.is_locked||(i.is_locked=!0,e.post(a,n,function(t){i.is_form_changed=!1,i.$submitButton.removeClass("yellow").addClass("green"),"ok"===t.status&&("google"===t.data.map_info.adapter?e.getScript("https://maps.googleapis.com/maps/api/js?sensor=false&key="+(t.data.map_info.settings.key||"")+"&lang="+t.data.lang):"yandex"===t.data.map_info.adapter&&e.getScript("https://api-maps.yandex.ru/2.1/?lang="+t.data.lang))}).always(function(){r.remove(),i.is_locked=!1}))},SettingsPage}(jQuery),CalendarEditDialog=function(e){return CalendarEditDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.$form=t.$block.find("form"),t.$styleWrapper=t.$block.find(".t-style-wrapper"),t.$limitedToggle=t.$block.find(".t-limited-toggle"),t.$nameField=t.$block.find('input[name="data[name]"]'),t.calendar_id=e.calendar_id,t.selected_class="is-selected",t.hidden_class="is-hidden",t.has_error_class="error",t.locales=e.locales,t.teamDialog=t.$wrapper.data("teamDialog"),t.$selectedStyleButton=t.$styleWrapper.find("."+t.selected_class),t.is_locked=!1,t.xhr=!1,t.initClass()},CalendarEditDialog.prototype.initClass=function(){var e=this;e.bindEvents(),e.initColorPicker()},CalendarEditDialog.prototype.bindEvents=function(){var t=this;t.$block.on("click",".js-delete-calendar",function(e){e.preventDefault(),t.is_locked||t.showDeleteConfirm()}),t.$styleWrapper.on("click",".t-style-item",function(i){i.preventDefault(),t.setStyleToggle(e(this))}),t.$form.on("submit",function(e){e.preventDefault(),t.locked||t.save()}),t.$form.on("change",".t-color-field",function(){t.$selectedStyleButton.length&&(t.$selectedStyleButton.removeClass(t.selected_class),t.$selectedStyleButton=!1)}),t.$form.find("input, textarea").on("mousedown",function(){var i=e(this);i.hasClass(t.has_error_class)&&i.removeClass(t.has_error_class).closest(".value").find(".t-error").remove()}),t.$nameField.on("change keyup",function(){var i=e(this).val();i=i.length?i:t.locales.preview,t.setPreviewName(i)}),t.$limitedToggle.on("change","input:radio",function(){var i=t.$limitedToggle.find(".t-hidden-content");e(this).val().length?i.show():i.hide(),t.teamDialog.resize()})},CalendarEditDialog.prototype.setStyleToggle=function(e){var t=this,i=e.css("background-color"),a=e.css("color");t.$selectedStyleButton.length&&t.$selectedStyleButton.removeClass(t.selected_class),t.setStyleData(i,a),e.addClass(t.selected_class),t.$selectedStyleButton=e},CalendarEditDialog.prototype.setStyleData=function(e,t){function i(e){var t,i;return t=e.split("(")[1].split(")")[0],t=t.split(",").splice(0,3),i=t.map(function(e){return e=parseInt(e).toString(16),1==e.length?"0"+e:e}),"#"+i.join("")}var a=this;e=i(e),t=i(t),a.$form.find('[name="data[bg_color]"]').val(e).trigger("change"),a.$form.find('[name="data[font_color]"]').val(t).trigger("change")},CalendarEditDialog.prototype.showDeleteConfirm=function(){var t=this,i={id:t.calendar_id};t.is_locked=!0,t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get("?module=calendar&action=deleteConfirm",i,function(e){new TeamDialog({html:e}),t.is_locked=!1,t.$wrapper.trigger("close")})},CalendarEditDialog.prototype.initColorPicker=function(){var t=this,i=function(e){return i=function(e){var t=this;t.$wrapper=e.$wrapper,t.$field=t.$wrapper.find(".t-color-field"),t.$icon=t.$wrapper.find(".js-show-color-picker"),t.$colorPicker=t.$wrapper.find(".t-color-picker"),t.is_opened=!1,t.farbtastic=!1,t.initClass()},i.prototype.initClass=function(){var t=this;t.farbtastic=e.farbtastic(t.$colorPicker,function(e){t.$field.val(e).change()}),t.$wrapper.data("colorPicker",t),t.bindEvents()},i.prototype.bindEvents=function(){function i(){a.$wrapper.siblings().each(function(){var t=e(this).data("colorPicker");t&&t.is_opened&&t.displayToggle(!1)})}var a=this;a.$field.on("change keyup",function(){var t=e(this).val();a.$icon.css("background-color",t),a.farbtastic.setColor(t)}),a.$icon.on("click",function(e){e.preventDefault(),i(),a.displayToggle(!a.is_opened)}),a.$wrapper.on("click",function(e){e.preventDefault(),e.stopPropagation()}),a.$field.on("focus",function(){a.is_opened||(i(),a.displayToggle(!0))}),t.$wrapper.find(".t-dialog-background").on("click",function(){a.is_opened&&a.displayToggle(!1)}),t.$block.on("click",function(){a.is_opened&&a.displayToggle(!1)})},i.prototype.displayToggle=function(e){var t=this,i=t.$colorPicker;e?(i.removeClass("is-hidden"),t.is_opened=!0):(i.addClass("is-hidden"),t.is_opened=!1)},i}(jQuery);t.$styleWrapper.find(".t-color-toggle .t-toggle").each(function(){new i({$wrapper:e(this)})})},CalendarEditDialog.prototype.setPreviewName=function(e){this.$styleWrapper.find(".t-style-item").text(e)},CalendarEditDialog.prototype.save=function(){var t=this,i=function(i){var a={},n=[];return e.each(i,function(e,t){a[t.name]=t.value}),a["data[is_limited]"]||delete a["data[is_limited]"],e.trim(a["data[name]"]).length||n.push({field:"data[name]",locale:"empty"}),n.length?(function(i){t.$form.find(".t-error").remove(),e.each(i,function(e,i){var a=t.$form.find("[name='"+i.field+"']");a.length&&a.addClass(t.has_error_class).after('<span class="t-error">'+t.locales[i.locale]+"</span>")})}(n),!1):a}(t.$form.serializeArray());t.is_locked||(t.is_locked=!0,i?e.post("?module=calendar&action=save",i,function(i){"ok"==i.status&&(e.team.content.reload(),e.team.sidebar.reload(),t.is_locked=!1)}):t.is_locked=!1)},CalendarEditDialog}(jQuery),CalendarDeleteDialog=function(e){return CalendarDeleteDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.calendar_id=e.calendar_id,t.is_locked=!1,t.initClass()},CalendarDeleteDialog.prototype.initClass=function(){var e=this;e.$block.on("click",".js-delete-calendar",function(t){t.preventDefault(),e.is_locked||e.delete()})},CalendarDeleteDialog.prototype.delete=function(){var t=this,i={id:t.calendar_id};t.is_locked=!0,e.post("?module=calendar&action=delete",i,function(i){"ok"==i.status&&(e.team.content.reload(),t.$wrapper.trigger("close"))},"json")},CalendarDeleteDialog}(jQuery),Sidebar=function(e){var t=function(){return t=function(t){var i=this;i.$window=e(window),i.$wrapper=t.$wrapper,i.$block=t.$block,i.$content=t.$content,i.top_fix_class="fixed-to-top",i.bottom_fix_class="fixed-to-bottom",i.debug=!1,i.initClass()},t.prototype.log=function(e){this.debug&&console.log(e)},t.prototype.initClass=function(){function t(){e.contains(document,w[0])?d():a()}function i(){e.contains(document,w[0])?u():n()}function a(){v.off("scroll",t)}function n(){v.off("scroll",i)}function r(e){f.log("Manual top scroll position"),w.css("top",e).width(p).removeClass(h).removeClass(m),E=!0,C=D=x=!1}function o(e){f.log("Fixed to top scroll position"),w.removeAttr("style").width(p).removeClass(m).addClass(h),e&&(x=!0,w.css("top",e)),E=D=!1,C=!0}function s(){f.log("Fixed to bottom scroll position"),w.removeAttr("style").width(p).removeClass(h).addClass(m),E=C=x=!1,D=!0}function l(){f.log("Default scroll position"),w.removeAttr("style").removeClass(m).removeClass(h),E=C=D=x=!1}function d(){var e=Math.floor(f.$content.outerHeight()),t=Math.floor(w.outerHeight()),i=Math.floor(g.height()),a=v.scrollTop(),n=Math.floor(w.offset().top),d=T>a?1:-1,u=a-b;if(p=w.width(),!k&&i>_&&y>=760&&!(e&&e<t)){var h=_>t+$,m=a<=b,S=parseInt(n+t-a-_),V=S>0,j=S<=0;if(h)u+$>0?(E||D||!C)&&o($):(E||C||D||x)&&l();else if(m){if(E||D||C)if(x){var M=n<=b;M&&l()}else l()}else if(V)if(d>0){var P=n>=$+a;P&&(E||!C||D)&&($?o($):o())}else(!E||C||D)&&r(n-b);else j?d>0?(!E||C||D)&&r(n-b):(E||C||!D)&&s():(!E||C||D)&&r(n-b)}else k?c(a,t):l();T=a}function c(e,t){var i=Math.floor(g.height()),a=Math.floor(g.offset().top),n=i+a-_-e,r=t-_;k=!1,i>t&&e>b&&(r<n?o($):s())}function u(){y=Math.floor(v.width()),_=Math.floor(v.height()),l(),v.trigger("scroll")}var p,f=this,h=f.top_fix_class,m=f.bottom_fix_class,v=f.$window,g=f.$wrapper,w=f.$block,y=Math.floor(v.width()),_=Math.floor(v.height()),b=w.offset().top,$=0,k=!0,E=!1,D=!1,C=!1,x=!1,T=0;v.on("scroll",t).on("resize",i)},t}();return Sidebar=function(e){var t=this;t.$wrapper=e.$wrapper,t.$groupsWrapper=t.$wrapper.find(".t-groups-list"),t.$groups=t.$groupsWrapper.find("> li"),t.$locationsWrapper=t.$wrapper.find(".t-locations-list"),t.$locations=t.$locationsWrapper.find("> li"),t.$searchForm=t.$wrapper.find(".t-search-form"),t.app_url=e.app_url,t.selected_class="selected",t.storage_count_name="team/sidebar_counts",t.can_sort=e.can_sort,t.link_count_update_date=!1,t.$activeMenuItem=t.$wrapper.find("li."+t.selected_class+":first")||!1,t.counters={},t.storageCount=!1,t.is_locked=!1,t.xhr=!1,t.timer=0,t.initClass()},Sidebar.prototype.initClass=function(){var e=this;e.bindEvents(),e.setCounts(),e.initElasticBlock(),e.initUpdater(),e.can_sort&&e.initSortable(),e.initDroppable(),e.$activeMenuItem.length||e.selectLink()},Sidebar.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click","li > a",function(i){t.onLinkClick(e(this))}),t.$wrapper.on("click",".js-add-user-group",function(e){e.preventDefault(),t.showGroupDialog()}),t.$wrapper.on("click",".js-add-user-location",function(e){e.preventDefault(),t.showGroupDialog(!0)}),t.$searchForm.on("submit",function(i){i.preventDefault();var a=e.trim(t.$searchForm.find(".t-search-field").val());a&&t.showSearch(a)}),e("#t-new-user-link").on("click",function(e){e.preventDefault(),e.stopPropagation(),t.showInviteDialog()})},Sidebar.prototype.onLinkClick=function(t){var i=this,a=t.attr("href");a&&"javascript:"!=a.substr(0,11)&&!t.hasClass("js-no-highlight")&&(i.setItem(t.closest("li")),e.team.setTitle(t.text()))},Sidebar.prototype.setItem=function(e){var t=this;if(t.$activeMenuItem&&t.$activeMenuItem[0]==e[0])return!1;t.$activeMenuItem&&t.$activeMenuItem.removeClass(t.selected_class),e.addClass(t.selected_class),t.$activeMenuItem=e},Sidebar.prototype.selectLink=function(t){var i,a=this;if(t)i=a.$wrapper.find('a[href="'+t+'"]:first');else if(!1===t)return a.$activeMenuItem&&(a.$activeMenuItem.removeClass(a.selected_class),a.$activeMenuItem=null),!1;if(i&&i.length)a.setItem(i.closest("li"));else{var n=a.$wrapper.find("a[href^='"+a.app_url+"']"),r=location.pathname,o=0,s=0;n.each(function(t){var i=e(this),a=i.attr("href"),n=a.length;r.indexOf(a)>=0&&n>o&&(o=n,s=t)}),(s||0===s)&&(i=n.eq(s),a.setItem(i.closest("li")))}},Sidebar.prototype.reload=function(){var t=this,i=t.app_url,a=i+"?module=sidebar";clearTimeout(t.timer),t.xhr&&t.xhr.abort(),t.xhr=e.get(a,function(e){t.xhr=!1,t.$wrapper.replaceWith(e)})},Sidebar.prototype.showInviteDialog=function(){var t=this;t.is_locked||(t.is_locked=!0,e.get(e.team.app_url+"?module=users&action=inviteform",function(e){t.is_locked=!1,new TeamDialog({html:e})}))},Sidebar.prototype.showGroupDialog=function(t){var i=this,a=e.team.app_url+"?module=group&action=edit",n={type:t?"location":"group"};i.is_locked||(i.is_locked=!0,e.get(a,n,function(e){new TeamDialog({html:e}),i.is_locked=!1}))},Sidebar.prototype.setCounts=function(){function t(t,i,n,r){if(t.indexOf(a.app_url)>=0){var o=a.$wrapper.find('a[href="'+t+'"]');if(o.length){var s=i-n,l=e('<strong class="small highlighted t-indicator '+(s>=0?"is-green":"is-red")+'">'+s+"</strong>");s>=0&&(o.append(l),o.one("click",function(n){n.preventDefault(),l.remove(),a.saveCount(t,i),a.link_count_update_date=r,e(document).one("wa_loaded",function(){a.link_count_update_date=!1})}))}}}function i(){var e=new Date,t=parseInt(e.getUTCDate()),i=parseInt(e.getUTCMonth())+1,a=parseInt(e.getUTCFullYear()),n=parseInt(e.getUTCHours()),r=parseInt(e.getUTCMinutes()),o=parseInt(e.getUTCSeconds());return result={year:a,month:i,day:t,hours:n,minutes:r,seconds:o}}var a=this,n=function(){var t={},n=a.$wrapper.find("li .js-count"),r=i();return n.each(function(){var i=e(this),n=parseInt(i.text()),o=i.closest("li"),s=o.find("> a");n>=0&&(a.counters[s.attr("href")]=i,t[s.attr("href")]={count:n,date:r})}),t}(),r=function(e){var t={},i=localStorage.getItem(e);return i&&(t=JSON.parse(i)),t}(a.storage_count_name);a.storageCount=e.extend(!0,{},n),r&&e.each(r,function(e,i){var r=e in n,o=r&&n[e].count>=0,s=o&&n[e].count!=i.count;i.count>=0&&s&&(a.storageCount[e].count=i.count,a.storageCount[e].date=i.date,t(e,n[e].count,i.count,i.date))}),a.setStorage()},Sidebar.prototype.saveCount=function(e,t){var i=this;e in i.storageCount&&(i.storageCount[e].count=t),i.setStorage()},Sidebar.prototype.updateCount=function(e,t){var i,a=this;if(!e||!t&&0!==t)return!1;i=a.counters[e]||!1,a.saveCount(e,t),i.length?i.text(t):a.reload()},Sidebar.prototype.setStorage=function(){var e=this;localStorage.setItem(e.storage_count_name,JSON.stringify(e.storageCount))},Sidebar.prototype.initElasticBlock=function(){var i=this;e(document).ready(function(){new t({$wrapper:e("#wa-app"),$block:i.$wrapper,$content:e("#t-content")});var a=e(window);a.scrollTop()>0&&a.trigger("scroll")})},Sidebar.prototype.initUpdater=function(){var t=this;t.timer=setTimeout(function(){e.contains(document,t.$wrapper[0])&&t.reload()},3e5)},Sidebar.prototype.initSortable=function(){function t(t){var i=[];return t.find("> li").each(function(){var t=e(this),a=t.data("group-id");a&&a>0&&i.push(a)}),i}function i(t,i){c&&(c.abort(),c=!1),c=e.post(t,i,function(){c=!1})}var a,n=this,r=n.$groupsWrapper,o=n.$groups,s=n.$locationsWrapper,l=n.$locations,d=n.app_url+"?module=group&action=sortSave",c=!1;o.length>1&&r.sortable({items:"> li",axis:"y",delay:200,tolerance:"pointer",start:function(e,t){a=t.item.index()},stop:function(n,o){if(o.item.removeAttr("style"),a!=o.item.index()){var s=t(r),l=[];e.each(s,function(e,t){l.push({name:"groups[]",value:t})}),i(d,l)}}}),l.length>1&&s.sortable({items:"> li",axis:"y",delay:200,tolerance:"pointer",start:function(e,t){a=t.item.index()},stop:function(e,n){if(n.item.removeAttr("style"),a!=n.item.index()){var r=t(s);i(d,{locations:r})}}})},Sidebar.prototype.initDroppable=function(){function t(t,i){var n,r=parseInt(t.data("group-id")),o=parseInt(i.data("user-id")),s=e.team.app_url+"?module=group&action=userAdd";if(!(r>0&&o>0))return!1;n={user_id:o,group_id:r},a&&a.abort(),a=e.post(s,n,function(t){"ok"==t.status&&e.team.sidebar.reload(),a=!1})}var i=this,a=!1;i.$groups.each(function(){var i=e(this);i.hasClass("js-drop-place")&&i.droppable({tolerance:"pointer",hoverClass:"is-hovered",over:function(e,t){t.draggable.hasClass("ui-draggable")||i.removeClass("is-hovered")},drop:function(i,a){t(e(this),a.draggable)}})}),i.$locations.each(function(){var i=e(this);i.hasClass("js-drop-place")&&i.droppable({tolerance:"pointer",hoverClass:"is-hovered",over:function(e,t){t.draggable.hasClass("ui-draggable")||i.removeClass("is-hovered")},drop:function(i,a){t(e(this),a.draggable)}})})},Sidebar.prototype.showSearch=function(t){var i=this;t=encodeURIComponent(t);var a=i.app_url+"search/"+t+"/";e.team.content.load(a)},Sidebar}(jQuery);!function(e){e.team={app_url:!1,content:!1,sidebar:!1,calendar:!1,title_pattern:"Team — %s",init:function(t){"is_debug|app_url|locales".split("|").forEach(function(i){e.team[i]=t[i]}),e(document).ajaxSend(function(e,t,i){if(!i.crossDomain&&"POST"===(i.type||"").toUpperCase()){var a=document.cookie.match(new RegExp("(?:^|; )_csrf=([^;]*)")),n=a?decodeURIComponent(a[1]):"";i.data=i.data||"","string"==typeof i.data?-1==i.data.indexOf("_csrf=")&&(i.data+=(i.data.length>0?"&":"")+"_csrf="+n,t.setRequestHeader("Content-type","application/x-www-form-urlencoded")):"object"==typeof i.data&&(i.data._csrf=n)}}),e.team.content=new ContentRouter({$content:e("#t-content")}),e.team.setSync()},setTitle:function(t){if(t){var i=history.state;i&&(i.title=t),document.title=e.team.title_pattern.replace("%s",t)}},confirmContactDelete:function(t,i){e.post("?module=users&action=prepareDelete",{id:t},function(e){var t=new TeamDialog({html:e});i&&i.onInit&&i.onInit(),i&&i.onCancel&&t.$wrapper.on("close",i.onCancel),(i.onCancel||i.onDelete)&&t.$wrapper.on("contacts_deleted",function(e,a){i&&i.onCancel&&t.$wrapper.off("close",i.onCancel),i&&i.onDelete&&i.onDelete(a)})})},setSync:function(){function t(){console.log("send sync request"),e.post(e.team.app_url+"?module=calendarExternal&action=sync").always(function(){i=null,a=setTimeout(t,r)}).error(function(){return!1})}var i,a,n=Math.floor(100*Math.random())/100,r=3e4+3e4*n;setTimeout(t,e.team.is_debug?100:r/2)}}}(jQuery);var ContentRouter=function(e){return ContentRouter=function(t){var i=this;i.$window=e(window),i.$content=t.$content,i.api_enabled=window.history&&window.history.pushState,i.xhr=!1,i.is_enabled=!0,i.initClass()},ContentRouter.prototype.initClass=function(){this.bindEvents()},ContentRouter.prototype.bindEvents=function(){var t=this,i=window.location.origin+e.team.app_url;e(document).on("click","a",function(e){var a=t.is_enabled&&this.href.substr(0,i.length)==i;e.ctrlKey||e.shiftKey||e.metaKey||a&&(e.preventDefault(),t.load(this.href))}),e("#wa-app-team").on("click","a",function(e){e.stopPropagation()}),t.api_enabled&&(window.onpopstate=function(e){e.stopPropagation(),t.onPopState(e)})},ContentRouter.prototype.load=function(t,i){var a=this;if(!(t.indexOf(e.team.app_url)>=0))return alert("Determine the path error"),!1;a.animate(!0),a.xhr&&a.xhr.abort(),e(document).trigger("wa_before_load",{content_uri:t}),a.xhr=e.get(t,function(n){!i&&a.api_enabled&&history.pushState({reload:!0,content_uri:t},"",t),a.setContent(n),a.animate(!1),a.xhr=!1,e(document).trigger("wa_loaded")})},ContentRouter.prototype.reload=function(){var e=this,t=!!(e.api_enabled&&history.state&&history.state.content_uri)&&history.state.content_uri;t&&e.load(t,!0)},ContentRouter.prototype.setContent=function(e){this.$content.html(e)},ContentRouter.prototype.onPopState=function(t){var i=this,a=t.state||!1;if(a){if(!a.content_uri)return alert("Determine the path error"),!1;e(document).trigger("wa_before_load",{content_uri:a.content_uri}),a.reload?i.reload(a.content_uri):a.content&&i.setContent(a.content),a.title&&e.team.setTitle(a.title),e.team.sidebar.selectLink(a.content_uri),e(document).trigger("wa_loaded")}else location.reload()},ContentRouter.prototype.animate=function(t){var i=this,a=i.$content;if(e(".router-loading-indicator").remove(),t){var n=a.find(".t-content-header h1");n.length&&n.append('<i class="icon16 loading router-loading-indicator"></i>')}},ContentRouter}(jQuery),TeamDialog=function(e){return TeamDialog=function(t){var i=this;i.$wrapper=e(t.html),i.$block=!1,i.is_full_screen=i.$wrapper.hasClass("is-full-screen"),i.is_full_screen&&(i.$block=i.$wrapper.find(".t-dialog-block")),i.position=t.position||!1,i.is_closed=!1,i.userPosition=t.setPosition||!1,i.onBgClick=t.onBgClick||!1,i.onOpen=t.onOpen||function(){},i.onClose=t.onClose||function(){},i.onRefresh=t.onRefresh||!1,i.onResize=t.onResize||!1,i.initClass()},TeamDialog.prototype.initClass=function(){var e=this;e.$wrapper.data("teamDialog",e),e.show(),e.bindEvents()},TeamDialog.prototype.bindEvents=function(){var t=this,i=e(document),a=t.$block?t.$block:t.$wrapper;setTimeout(function(){function n(){t.is_closed||t.close(),i.off("click",n),i.off("wa_before_load",n)}function r(){e.contains(document,t.$wrapper[0])?t.resize():e(window).off("resize",r)}i.on("click",n),i.on("wa_before_load",n),t.$wrapper.on("close",n),t.is_full_screen&&t.$wrapper.on("click",".t-dialog-background",function(e){t.onBgClick?t.onBgClick(e):e.stopPropagation()}),a.on("click",function(e){e.stopPropagation()}),e(document).on("keyup",function(e){27===e.keyCode&&t.close()}),a.on("click",".js-close-dialog",function(){n()}),t.is_full_screen&&e(window).on("resize",r)},0)},TeamDialog.prototype.show=function(){var t=this;e("body").append(t.$wrapper),t.setPosition(),t.onOpen(t.$wrapper,t)},TeamDialog.prototype.setPosition=function(){function t(e){return{left:parseInt((r-e.width)/2),top:parseInt((o-e.height)/2)}}var i,a=this,n=e(window),r=n.width(),o=a.is_full_screen?n.height():e(document).height(),s=a.$block?a.$block:a.$wrapper,l=s.outerWidth(),d=s.outerHeight();if(a.position)i=a.position;else{i=(a.userPosition?a.userPosition:t)({width:l,height:d})}if(i.left>0&&i.left+l>r&&(i.left=r-l-10),i.top>0)i.top+d>o&&(i.top=o-d-10);else if(i.top=10,a.is_full_screen){var c=s.find(".t-dialog-content");c.hide();var u=s.outerHeight(),p=o-u-20;c.height(p).addClass("is-long-content").show()}s.css(i)},TeamDialog.prototype.close=function(){var e=this;e.is_closed=!0,e.$wrapper.remove(),e.onClose(e.$wrapper,e)},TeamDialog.prototype.refresh=function(){var e=this;e.onRefresh&&(e.onRefresh(),e.close())},TeamDialog.prototype.resize=function(){var e=this;e.$block.addClass("is-animated"),e.setPosition(),e.onResize&&e.onResize(e.$wrapper,e)},TeamDialog}(jQuery),TeamEditable=function(e){return TeamEditable=function(e){var t=this;t.$wrapper=e.$wrapper,t.save=e.onSave||function(){},t.render=e.onRender||!1,t.is_empty=t.$wrapper.hasClass("is-empty"),t.text=t.is_empty?"":t.$wrapper.text(),t.$field=!1,t.is_edit=!1,t.initClass()},TeamEditable.prototype.initClass=function(){var e=this;e.$field=e.renderField(),e.bindEvents()},TeamEditable.prototype.bindEvents=function(){var e=this;e.$wrapper.on("click",function(){e.toggle()}),e.$field.on("blur",function(){e.save(e)}),e.$field.on("keyup",function(t){var i=13===t.keyCode,a=27===t.keyCode;i?e.save(e):a&&(e.$field.val(e.text),e.toggle("hide"))})},TeamEditable.prototype.renderField=function(){var t=this,i=t.$wrapper.text(),a=e('<input class="bold" type="text" name="" />');t.is_empty||a.val(i);var n,r=t.$wrapper.parent().width(),o=t.$wrapper.width();return n=r>600?600:r-50,n=o>n?o:n,a.width(n).hide(),t.$wrapper.after(a),t.render&&t.render(t,a),a},TeamEditable.prototype.toggle=function(e){var t=this,i="hide"!==e;i?(t.$wrapper.hide(),t.$field.show().focus()):(t.$wrapper.show(),t.$field.hide()),t.is_edit=i},TeamEditable}($),UserList=function(e){return UserList=function(e){var t=this;t.$wrapper=e.$wrapper,t.$items=t.$wrapper.find(".t-user-wrapper"),t.is_locked=!1,t.xhr=!1,t.initClass()},
UserList.prototype.initClass=function(){var e=this;e.initHightlight(),e.bindEvents()},UserList.prototype.bindEvents=function(){var t=this,i=!1;t.$wrapper.find(".js-move-user").draggable({helper:"clone",delay:200,cursorAt:{top:10,left:20},start:function(t,a){a.helper.addClass("is-clone"),i=e.team.sidebar.$wrapper.find(".js-drop-block"),i.length&&i.addClass("t-drop-here")},stop:function(e,t){var a=t.helper,n=a.clone();n.insertAfter(a).fadeOut(270),setTimeout(function(){n.remove()},300),i.length&&i.removeClass("t-drop-here")}})},UserList.prototype.initHightlight=function(){function t(e){var t=e.split(" "),i=t[0].split("-"),a=t[1].split(":");return{year:parseInt(i[0]),month:parseInt(i[1]),day:parseInt(i[2]),hours:parseInt(a[0]),minutes:parseInt(a[1]),seconds:parseInt(a[2])}}function i(e){return new Date(e.year,e.month-1,e.day,e.hours,e.minutes,e.seconds)}var a=this,n=e.team.sidebar.link_count_update_date;n&&(n=i(n),a.$items.each(function(){var a=e(this),r=a.data("update-datetime");if(r&&r.length){i(t(r))>n&&a.addClass("highlighted")}}))},UserList}(jQuery),WelcomePage=function(e){return WelcomePage=function(e){var t=this;t.$wrapper=e.$wrapper,t.$inviteWrapper=t.$wrapper.find("#t-invite-wrapper"),t.$inviteList=t.$inviteWrapper.find(".t-invite-list"),t.locales=e.locales,t.error_class="error",t.is_locked=!1,t.initClass()},WelcomePage.prototype.initClass=function(){var t=this;e(document).on("ready",function(){e.team.content.is_enabled=!1}),t.$inviteList.find("input:checkbox").each(function(){t.initIButton(e(this))}),t.bindEvents()},WelcomePage.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".js-skip-page",function(e){e.stopPropagation()}),t.$wrapper.on("click",".js-send-invites",function(e){e.preventDefault(),t.is_locked||t.sendInvites()}),t.$inviteWrapper.on("click",".js-add-invite",function(e){e.preventDefault(),t.addNewInvite()}),t.$inviteWrapper.on("click",".js-remove-invite",function(t){t.preventDefault(),e(this).closest("li").remove()}),t.$inviteWrapper.on("click","."+t.error_class,function(){t.removeErrors(e(this))})},WelcomePage.prototype.initIButton=function(e){e.iButton({labelOn:"",labelOff:"",classContainer:"t-ibutton ibutton-container mini"})},WelcomePage.prototype.addNewInvite=function(){var t=this,i=t.$inviteWrapper.find(".t-invite-template").clone().html(),a=e("<li>"+i+"</li>");t.$inviteList.append(a);var n=a.find("input:checkbox");t.initIButton(n)},WelcomePage.prototype.sendInvites=function(){function t(t){var a=[];e.each(t,function(e,t){var n=t.name,r=t.text,o=parseInt(n.replace("data[","").replace("][email]","")),s=i.$inviteList.find(".t-invite-item").eq(o).find(".t-field");s.length&&a.push({$field:s,locale:r})}),i.displayErrors(a)}var i=this,a=e.team.app_url+"?module=welcome&action=save",n=function(){function t(e){return e.match(".+@.+")}var a=[],n=i.$inviteList.find(".t-invite-item"),r=[];return n.each(function(n){var o=e(this).find("input:text"),s=e(this).find("input:checkbox"),l=o.val(),d="checked"==s.attr("checked");if(e.trim(l).length){t(l)?(a.push({name:"data["+n+"][email]",value:l}),a.push({name:"data["+n+"][access]",value:d})):r.push({$field:o,locale:i.locales.incorrect})}}),r.length?(i.displayErrors(r),!1):!!a.length&&a}();i.is_locked=!0,n?e.post(a,n,function(i){i.errors&&i.errors.length?t(i.errors):location.href=e.team.app_url}).always(function(){i.is_locked=!1}):i.is_locked=!1},WelcomePage.prototype.removeErrors=function(e){var t=this,i=t.error_class;e?(e.removeClass(i),e.parent().find(".t-error").remove()):(t.$inviteList.find(".t-error").remove(),t.$inviteList.find("."+i).removeClass(i))},WelcomePage.prototype.displayErrors=function(t){var i=this,a=i.error_class;i.removeErrors(),e.each(t,function(e,t){var i='<span class="t-error">'+t.locale+"</span>";t.$field.addClass(a).before(i)})},WelcomePage}(jQuery);
//# sourceMappingURL=team.min.js.map
