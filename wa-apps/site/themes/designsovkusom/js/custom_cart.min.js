function clog(t) {
    window.console && console.log(t)
}
function showCart() {
    $("body").addClass("freeze"), $("#fast_cart_view").overlay().load(), $("#cart_fast_info").html("<div class='loading'></div>"), $.get("/cart/", function (t) {
        var i = $($.parseHTML(t)).find("#cart_content");
        makeCart(i)
    })
}
function makeCart(t) {
    $("#cart_fast_info").html(t), cartInit($("#cart_fast_info"))
}
function cartInit(t) {
    basicAuthFormInit(t), t.find("a.deleteico").click(function () {
        var t = $(this).closest("tr");
        return t.find("td").wrapInner('<div class="temp overflow_hidden" />'), t.find("td").animate({
            "padding-top": 0,
            "padding-bottom": 0
        }, 500), t.find(".temp").animate({height: 0}, 500, function () {
            t.remove()
        }), $.ajax({
            url: "/cart/delete/",
            type: "POST",
            data: {id: t.data("id")},
            dataType: "json",
            success: function (i) {
                t.remove(), updatesCart(i.data)
            }
        }), !1
    }), t.find("input.qty").change(function () {
        var t = $(this);
        if (t.val() > 0) {
            var i = t.closest("tr");
            t.val() && (i.find(".cols_fullprice").text(i.data("price") * t.val() + " руб."), $.post("cart/save/", {
                html: 0,
                id: i.data("id"),
                quantity: t.val()
            }, function (i) {
                i.data.q && t.val(i.data.q), i.data.error ? alert(i.data.error) : t.removeClass("error"), updatesCart(i.data)
            }, "json"))
        } else t.val(1)
    })
}
function basicAuthFormInit(t) {
    clog("basicAuthFormInit"), setPhoneValidator('input[name="customer[phone]"]'), $("#order_create").click(function () {
        return createOrder(t), !1
    })
}
function setPhoneValidator(t) {
    $(t).msk("+7 (999) 999-99-99", {empty_string: "7 ___ _______"})
}
function createOrder(t) {
    clog("createOrder start");
    var i = t.find("#cart_form"), e = "/cart/", a = i.serialize() + "&checkout=1", o = t.find("#checkout_block").find("form"), n = o.serialize(), c = $("#cart_content").detach();
    $.post(e, a, function (i) {
        var e = $($.parseHTML(i)), a = e.filter("#cart_content"), o = e.find("#checkout_block");
        a.length > 0 ? (clog("error in cart data"), makeCart(a)) : o.length > 0 && (clog("save basic data"), $.post("/checkout/", n, function (i) {
            var e = $($.parseHTML(i)), a = e.find("#checkout_address"), o = e.find("#checkout_block");
            a.length > 0 && (clog("data saved, init address form"), makeAddress(a)), o.length > 0 && (clog("error in basic data"), $("#cart_fast_info").html(c), $("#basicauth_block").html(o), basicAuthFormInit(t))
        }))
    }), t.html("<div class='loading'></div>")
}
function makeAddress(t) {
    clog("makeAddress"), $("#cart_fast_info").html(t), $(".address_form").after("<div class='checkout_right'><div class='checkout_fast'><div class='checkout_shipping'></div><div class='checkout_billing'></div><div class='checkout_shipping_text hint'></div></div><div class='checkout_order_info'></div><div class='checkout_final'></div></div>"), $("input[name='customer[address.shipping][region]']").change(function () {
        updateRegion(t)
    }), updateRegion(t), $(".cart_return").click(function () {
        showCart()
    })
}
function updateRegion(t) {
    clog("updateRegion");
    var i = $('input[name="order[shipping_date]"]');
    i.hasClass("pickme") || (i.pickmeup({
        format: "d.m.Y", min: new Date, change: function (t) {
            i.val(t).pickmeup("hide")
        }
    }), i.addClass("pickme"));
    var e = $("#region_name").data("id");
    "" == $("#address_form #region").val() && $("#address_form #region").val(e), Kladr();
    var a = $("#address_form #city").val();
    $("#address_form .field_dynamic").each(function () {
        var t = !1;
        $(this).hasClass("field_region_all") && (t = !0), $(this).hasClass("field_region_not_" + a) && (t = !1), $(this).hasClass("field_region_" + a) && (t = !0), t ? $(this).show() : $(this).hide()
    }), loadShipping(t)
}
function putShipmentDate(t) {
    t.datepicker({gotoCurrent: !0, minDate: 0}), t.focus(function () {
        var i = t.offset().top, e = i - $(window).scrollTop();
        $("#ui-datepicker-div").css("top", e + 25)
    })
}
function loadShipping(t) {
    clog("loadShipping");
    var i = $("#address_form"), e = "/checkout/address/", a = i.serialize();
    $.post(e, a, function () {
        clog("data posted"), $.get("/checkout/shipping/", function (i) {
            clog("data got");
            var e = $($.parseHTML(i)).find("#shipping_content");
            if (e.length > 0) {
                $(".checkout_shipping").first().html(e), $("input[type=radio]").click(function () {
                    selectShipping(t)
                });
                var a = $("input[type=radio]").first();
                a.prop("checked", !0), a.click()
            } else clog("error in shipping data")
        })
    })
}
function selectShipping(t) {
    clog("selectShipping");
    var i = $("#shipping_form"), e = "/checkout/shipping/", a = i.serialize(), o = i.find("input[type=radio]:checked").first().closest(".shipping_option").find(".shipping_description").html();
    $(".checkout_shipping_text").html(o), $.post(e, a, function (i) {
        clog("shipping saved"), Kladr();
        var e = $($.parseHTML(i)).find("#payment_content"), a = $($.parseHTML(i)).find("#order_summary");
        if (e.length > 0) {
            $(".checkout_billing").html(e);
            var o = e.find("input[type=radio]").first();
            o.prop("checked", !0), $(".checkout_final").html("<div class='order_final'><input type='button' class='rv-button button orange-button' value='Подтвердить заказ'></div>"), $(".checkout_order_info").html(a), $(".checkout_final").find(".order_final").click(function () {
                finalizeOrder(t)
            })
        } else clog("error in saving shipping")
    })
}
function finalizeOrder(t) {
    clog("finalizeOrder");
    var i = $("#address_form"), e = $("#shipping_form"), a = "/checkout/address/", o = i.serialize();
    $.post(a, o, function (t) {
        clog("data posted");
        {
            var i = $($.parseHTML(t)).find("#checkout_address");
            $($.parseHTML(t)).find("#shipping_content")
        }
        if (i.length > 0)clog("error in address"), makeAddress(i); else {
            var a = "/checkout/shipping/", o = e.serialize() + "&place_order=1";
            $.post(a, o, function (t) {
                var i = $($.parseHTML(t)).find("#payment_form"), e = "/checkout/payment/", a = i.serialize();
                $.post(e, a, function (t) {
                    var i = $($.parseHTML(t)).find("#checkout_success");
                    $("#cart_fast_info").html(i)
                })
            })
        }
    }), t.html("<div class='loading'></div>")
}
function infoHoverInit() {
    var t = $(".info_hover"), i = $(".b2c_cities");
    t.live("mouseover", function () {
        i.show(), $(this).addClass("hovered");
        var t = i.outerHeight() / 2 - 8;
        clog(t), i.css("top", -t)
    }), t.live("mouseout", function () {
        i.hide(), i.html(""), $(this).removeClass("hovered")
    })
}
function closeCart() {
    $("#fast_cart_view").overlay().close(), $("body").removeClass("freeze")
}
function updatesCart(t) {
    $(".cart-total.align-right.total.bold.nowrap").html(t.total), $(".price.nowrap.cart-total").html(t.total), $(".cart-count").html(t.count), $(".align-right.nowrap.cart_discount").html("&minus; " + t.discount);
    var i = Math.round(100 * t.discount_numeric / (t.discount_numeric + t.total_numeric));
    $(".discount_percent").html("Ваша скидка " + i + "% "), t.count > 0 ? $("#cart-summary").removeClass("empty") : ($("#cart-summary").addClass("empty"), $("#order_create").addClass("inactive"), closeCart()), t.discount_numeric > 0 ? $(".discount_block").show() : $(".discount_block").hide()
}
$(document).ready(function () {
    $(".cartheader").click(function () {
        return $("#cart-summary").hasClass("empty") || showCart(), !1
    }), $(".cart-tot").click(function () {
        return $("#cart-summary").hasClass("empty") || showCart(), !1
    }), $("#fast_cart_view").overlay({
        top: 0,
        closeOnClick: !1,
        oneInstance: !1,
        load: !1,
        mask: {color: "#000", loadSpeed: 200, opacity: .6, zIndex: 2540},
        onClose: function () {
            closeCart()
        }
    }), infoHoverInit()
});